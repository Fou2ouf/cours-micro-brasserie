<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Physico-chimie du brassage — Quiz</title>
  <style>
    :root {
      --bg: #0d1117;
      --accent: #58a6ff;
      --text: #e6edf3;
      --correct: #3fb950;
      --incorrect: #f85149;
      --card-bg: #161b22;
      --border: #30363d;
      --muted: #8b949e;
      --scrollnav-offset: 0px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body.has-scroll-nav {
      padding-bottom: var(--scrollnav-offset);
    }

    /* Style commun premium pour TOUS les boutons (garde la couleur d'origine) */
    button {
      border: none;
      border-radius: 12px;
      box-shadow:
        0 14px 32px rgba(0, 0, 0, 0.35),
        inset 0 1px 0 rgba(255, 255, 255, 0.14);
      position: relative;
      overflow: hidden;
      transition: transform 0.15s ease, box-shadow 0.2s ease, filter 0.2s ease;
    }

    button::after {
      content: "";
      position: absolute;
      top: -35%;
      left: -70%;
      width: 70%;
      height: 170%;
      transform: skewX(-18deg);
      background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.22) 45%, transparent 80%);
      opacity: 0;
      pointer-events: none;
    }

    button:hover {
      transform: translateY(-1px);
      filter: brightness(1.06);
      box-shadow:
        0 18px 42px rgba(0, 0, 0, 0.45),
        inset 0 1px 0 rgba(255, 255, 255, 0.16);
    }

    button:hover::after {
      opacity: 1;
      animation: ui-btn-shine 0.85s ease forwards;
    }

    button:active {
      transform: translateY(0);
      filter: brightness(1);
      box-shadow:
        0 10px 24px rgba(0, 0, 0, 0.35),
        inset 0 2px 10px rgba(0, 0, 0, 0.28);
    }

    button:focus-visible {
      outline: none;
      box-shadow:
        0 18px 42px rgba(0, 0, 0, 0.48),
        0 0 0 4px rgba(255, 255, 255, 0.18),
        inset 0 1px 0 rgba(255, 255, 255, 0.16);
    }

    @keyframes ui-btn-shine {
      0% { transform: translateX(0) skewX(-18deg); }
      100% { transform: translateX(220%) skewX(-18deg); }
    }

    @media (prefers-reduced-motion: reduce) {
      button { transition: none; }
      button:hover::after { animation: none; }
    }

    header {
      background: linear-gradient(135deg, #0d1117 0%, #1f6feb 100%);
      padding: 2rem;
      text-align: center;
      border-bottom: 2px solid var(--accent);
    }

    header h1 { font-size: 2em; color: var(--text); }

    #nav {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      padding: 1.5rem;
      background: var(--card-bg);
      border-bottom: 1px solid var(--accent);
      min-height: 1px;
    }

    .category-group {
      width: 100%;
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.08) 0%, rgba(59, 130, 246, 0.12) 100%);
      border-radius: 8px;
      border-left: 4px solid var(--accent);
      box-shadow: 0 2px 10px rgba(37, 99, 235, 0.15);
    }

    .category-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      flex-wrap: nowrap;
      margin-bottom: 0.75rem;
      background: linear-gradient(90deg, #a78bfa, #c4b5fd);
      padding: 0.6rem 0.75rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(167, 139, 250, 0.4);
      width: 100%;
    }

    .category-title {
      font-size: 1.1em;
      color: #fff;
      font-weight: 700;
      margin: 0;
      padding: 0.25rem 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      flex: 1;
      min-width: 180px;
    }

    .category-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: nowrap;
      margin-left: auto;
    }

    .category-action-btn {
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 8px;
      font-weight: 700;
      font-size: 0.95em;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.2s, filter 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .category-action-btn:hover {
      transform: translateY(-1px) scale(1.01);
      filter: brightness(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.28);
    }

    .category-action-btn.rev { background: #a78bfa; color: #000; }
    .category-action-btn.formulas { background: #22c55e; color: #000; }
    .category-action-btn.stats { background: #f59e0b; color: #000; }
    .category-action-btn.export { background: #3fb950; color: #fff; }
    .category-action-btn.summary { background: var(--accent); color: #000; }

    .category-action-btn.summary.has-quiz-ongoing,
    .category-action-btn.summary.has-quiz-completed {
      position: relative;
      padding-right: 2.15rem;
    }

    .category-action-btn.summary.has-quiz-ongoing::after,
    .category-action-btn.summary.has-quiz-completed::after {
      content: "";
      position: absolute;
      top: 6px;
      right: 8px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.25), 0 6px 16px rgba(0,0,0,0.25);
    }

    .category-action-btn.summary.has-quiz-ongoing::after {
      background: #f59e0b;
      animation: quiz-dot-pulse 1.35s ease-in-out infinite;
    }

    .category-action-btn.summary.has-quiz-completed::after {
      background: #22c55e;
      animation: none;
    }

    .category-action-btn.summary.has-quiz-ongoing::before,
    .category-action-btn.summary.has-quiz-completed::before {
      content: attr(data-quiz-progress);
      position: absolute;
      bottom: 6px;
      right: 6px;
      font-size: 0.72em;
      font-weight: 900;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.35);
      color: #fff;
      letter-spacing: 0.01em;
    }

    @keyframes quiz-dot-pulse {
      0%, 100% { transform: scale(1); filter: brightness(1); }
      50% { transform: scale(1.25); filter: brightness(1.2); }
    }

    @media (max-width: 768px) {
      .category-header { flex-wrap: wrap; }
      .category-actions { flex-wrap: wrap; width: 100%; justify-content: flex-start; }
      .category-title { flex-basis: 100%; }
      .category-action-btn { flex: 1 1 calc(50% - 0.5rem); justify-content: center; }
    }

    .category-themes {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      width: 100%;
      margin-top: 0.5rem;
    }

    .category-group .theme-btn {
      flex: 1;
      min-width: 180px;
    }

    .theme-btn {
      padding: 0.5rem 0.65rem;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.88em;
      transition: transform 0.2s;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
      position: relative;
      min-height: 44px;
    }

    .theme-btn:hover { transform: scale(1.02); }
    .theme-btn.active { background: var(--correct); }

    .theme-btn.started::before {
      content: "🚀";
      position: absolute;
      top: 4px;
      right: 8px;
      font-size: 1.05em;
      color: #fbbf24;
      text-shadow: 0 0 8px rgba(251, 191, 36, 0.65);
      animation: rocket-wiggle 1.6s ease-in-out infinite;
    }

    @keyframes rocket-wiggle {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      25% { transform: translateY(-1px) rotate(-6deg); }
      50% { transform: translateY(1px) rotate(6deg); }
      75% { transform: translateY(-1px) rotate(-4deg); }
    }

    .theme-btn.completed::before {
      content: "🎉";
      position: absolute;
      top: 4px;
      right: 8px;
      font-size: 1.05em;
      color: #22c55e;
      text-shadow: 0 0 10px rgba(34, 197, 94, 0.55);
      animation: confetti-pop 1.8s ease-in-out infinite;
    }

    @keyframes confetti-pop {
      0%, 100% { transform: scale(1) rotate(0deg); }
      15% { transform: scale(1.15) rotate(-5deg); }
      30% { transform: scale(1.05) rotate(6deg); }
      45% { transform: scale(1.12) rotate(-4deg); }
      60% { transform: scale(1.02) rotate(3deg); }
      75% { transform: scale(1.08) rotate(-2deg); }
    }

    .theme-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .theme-container .theme-btn {
      flex: 1;
      margin: 0;
    }

    .reset-btn {
      padding: 0.5rem 0.8rem;
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.8em;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .reset-btn:hover { background: #c82333; }

    #controls,
    #nav {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 1rem;
      border-bottom: 1px solid var(--accent);
    }

    label { font-weight: 600; }

    select {
      padding: 0.6rem;
      background: var(--bg);
      border: 1px solid var(--accent);
      color: var(--text);
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      appearance: none;
    }

    button {
      padding: 0.7rem 1.5rem;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      box-sizing: border-box;
    }

    button:hover { opacity: 0.8; }

    /* Barre d'actions (quiz) : plus compacte + centrée en hauteur */
    #controls {
      padding: 0.4rem 0.6rem;
      gap: 0.45rem;
    }

    #controls label {
      display: inline-flex;
      align-items: center;
      padding: 0 0.15rem;
    }

    #controls select {
      padding: 0.4rem 0.65rem;
      line-height: 1.1;
    }

    #controls button {
      padding: 0.45rem 1rem;
      font-size: 0.92em;
      line-height: 1.1;
    }

    #resetQuiz {
      background: #dc3545;
      color: #fff;
    }

    #resetQuiz:hover {
      opacity: 1;
      background: #c82333;
    }

    #fiche {
      padding: 2rem;
      background: var(--card-bg);
      margin: 2rem;
      border-radius: 8px;
    }

    #fiche h2 { color: var(--accent); margin-bottom: 1.5rem; }

    .section {
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: var(--bg);
      border-radius: 6px;
    }

    .section h3 { color: #b1baf8; margin-bottom: 0.7rem; }
    .section ul { list-style: none; padding-left: 1rem; }
    .section li { margin-bottom: 0.5rem; color: var(--text); }
    .section li strong { color: var(--accent); }

    #quizContainer { padding: 2rem; }

    .question {
      background: var(--card-bg);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border-radius: 8px;
    }

    .question h3 { margin-bottom: 1rem; }

    .options { display: grid; gap: 0.7rem; }

    .option {
      padding: 1rem;
      background: #1c2128;
      border: 2px solid #30363d;
      text-align: left;
      border-radius: 6px;
      transition: all 0.2s;
      color: #e6edf3;
      font-weight: 500;
    }

    .option:hover {
      border-color: var(--accent);
      background: #21262d;
      cursor: pointer;
    }

    .option.correct {
      background: var(--correct);
      color: #000;
      font-weight: 600;
      border-color: var(--correct);
    }

    .option.incorrect {
      background: var(--incorrect);
      color: #fff;
      font-weight: 600;
      border-color: var(--incorrect);
    }

    .explanation {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg);
      border-left: 3px solid var(--accent);
      border-radius: 4px;
      font-size: 0.9em;
    }

    #progress {
      font-weight: 600;
      color: var(--accent);
      margin-left: auto;
    }

    .scroll-nav {
      display: none;
      gap: 0.75rem;
      padding: 0.25rem;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;

      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(12px + env(safe-area-inset-bottom, 0px));
      width: min(980px, calc(100vw - 24px));
      z-index: 10000;

      /* Plus de gros rectangle de fond */
      background: transparent;
      border: none;
      box-shadow: none;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;

      transition: opacity 0.18s ease, transform 0.18s ease;
    }

    .scroll-nav.is-auto-hide.is-hidden {
      opacity: 0;
      transform: translateX(-50%) translateY(10px);
      pointer-events: none;
    }

    .scroll-nav.is-auto-hide:not(.is-hidden) {
      opacity: 1;
      pointer-events: auto;
    }

    .scroll-nav button {
      flex: 1 1 220px;
      max-width: 280px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.55rem;
      min-height: 42px;
      padding: 0.6rem 0.9rem;
      border-radius: 12px;
      font-weight: 800;
      font-size: 0.95em;
      letter-spacing: 0.01em;

      position: relative;
      overflow: hidden;
      user-select: none;

      color: #e6edf3;
      border: 1px solid rgba(255, 255, 255, 0.10);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.06) 0%, rgba(33, 38, 45, 0.86) 40%, rgba(13, 17, 23, 0.98) 100%);
      box-shadow:
        0 16px 38px rgba(0, 0, 0, 0.45),
        inset 0 1px 0 rgba(255, 255, 255, 0.07);
      transition: transform 0.15s ease, box-shadow 0.2s ease, border-color 0.2s ease, filter 0.2s ease;
    }

    .scroll-nav button::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(600px 120px at 50% 0%, rgba(255, 255, 255, 0.18), transparent 55%);
      opacity: 0.65;
      pointer-events: none;
    }

    .scroll-nav button::after {
      content: "";
      position: absolute;
      top: -30%;
      left: -70%;
      width: 70%;
      height: 160%;
      transform: skewX(-18deg);
      background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.22) 45%, transparent 80%);
      opacity: 0;
      pointer-events: none;
    }

    #backToFicheBtn {
      border-color: rgba(88, 166, 255, 0.35);
      background:
        radial-gradient(900px 220px at 20% 0%, rgba(88, 166, 255, 0.35), transparent 55%),
        linear-gradient(180deg, rgba(88, 166, 255, 0.22) 0%, rgba(33, 38, 45, 0.88) 40%, rgba(13, 17, 23, 0.98) 100%);
      box-shadow:
        0 18px 42px rgba(0, 0, 0, 0.48),
        0 0 0 1px rgba(88, 166, 255, 0.12),
        0 0 26px rgba(88, 166, 255, 0.16),
        inset 0 1px 0 rgba(255, 255, 255, 0.07);
    }

    #backToFicheBtn_summaryModal {
      border-color: rgba(88, 166, 255, 0.35);
      background:
        radial-gradient(900px 220px at 20% 0%, rgba(88, 166, 255, 0.35), transparent 55%),
        linear-gradient(180deg, rgba(88, 166, 255, 0.22) 0%, rgba(33, 38, 45, 0.88) 40%, rgba(13, 17, 23, 0.98) 100%);
      box-shadow:
        0 18px 42px rgba(0, 0, 0, 0.48),
        0 0 0 1px rgba(88, 166, 255, 0.12),
        0 0 26px rgba(88, 166, 255, 0.16),
        inset 0 1px 0 rgba(255, 255, 255, 0.07);
    }

    #backToThemesBtn {
      border-color: rgba(167, 139, 250, 0.38);
      background:
        radial-gradient(900px 220px at 20% 0%, rgba(167, 139, 250, 0.34), transparent 55%),
        linear-gradient(180deg, rgba(167, 139, 250, 0.20) 0%, rgba(33, 38, 45, 0.88) 40%, rgba(13, 17, 23, 0.98) 100%);
      box-shadow:
        0 18px 42px rgba(0, 0, 0, 0.48),
        0 0 0 1px rgba(167, 139, 250, 0.12),
        0 0 26px rgba(167, 139, 250, 0.18),
        inset 0 1px 0 rgba(255, 255, 255, 0.07);
    }

    #backToThemesBtn_summaryModal {
      border-color: rgba(167, 139, 250, 0.38);
      background:
        radial-gradient(900px 220px at 20% 0%, rgba(167, 139, 250, 0.34), transparent 55%),
        linear-gradient(180deg, rgba(167, 139, 250, 0.20) 0%, rgba(33, 38, 45, 0.88) 40%, rgba(13, 17, 23, 0.98) 100%);
      box-shadow:
        0 18px 42px rgba(0, 0, 0, 0.48),
        0 0 0 1px rgba(167, 139, 250, 0.12),
        0 0 26px rgba(167, 139, 250, 0.18),
        inset 0 1px 0 rgba(255, 255, 255, 0.07);
    }

    .scroll-nav button:hover {
      transform: translateY(-2px);
      filter: brightness(1.06);
      box-shadow:
        0 18px 42px rgba(0, 0, 0, 0.48),
        0 0 0 3px rgba(255, 255, 255, 0.10),
        inset 0 1px 0 rgba(255, 255, 255, 0.07);
    }

    .scroll-nav button:hover::after {
      opacity: 1;
      animation: scrollnav-shine 0.85s ease forwards;
    }

    #backToFicheBtn:hover {
      border-color: rgba(88, 166, 255, 0.85);
      box-shadow:
        0 24px 56px rgba(0, 0, 0, 0.56),
        0 0 0 3px rgba(88, 166, 255, 0.18),
        0 0 40px rgba(88, 166, 255, 0.28),
        inset 0 1px 0 rgba(255, 255, 255, 0.08);
    }

    #backToFicheBtn_summaryModal:hover {
      border-color: rgba(88, 166, 255, 0.85);
      box-shadow:
        0 24px 56px rgba(0, 0, 0, 0.56),
        0 0 0 3px rgba(88, 166, 255, 0.18),
        0 0 40px rgba(88, 166, 255, 0.28),
        inset 0 1px 0 rgba(255, 255, 255, 0.08);
    }

    #backToThemesBtn:hover {
      border-color: rgba(167, 139, 250, 0.90);
      box-shadow:
        0 24px 56px rgba(0, 0, 0, 0.56),
        0 0 0 3px rgba(167, 139, 250, 0.18),
        0 0 42px rgba(167, 139, 250, 0.30),
        inset 0 1px 0 rgba(255, 255, 255, 0.08);
    }

    #backToThemesBtn_summaryModal:hover {
      border-color: rgba(167, 139, 250, 0.90);
      box-shadow:
        0 24px 56px rgba(0, 0, 0, 0.56),
        0 0 0 3px rgba(167, 139, 250, 0.18),
        0 0 42px rgba(167, 139, 250, 0.30),
        inset 0 1px 0 rgba(255, 255, 255, 0.08);
    }

    .scroll-nav button:active {
      transform: translateY(0);
      filter: brightness(1);
      box-shadow:
        0 10px 24px rgba(0, 0, 0, 0.35),
        inset 0 2px 10px rgba(0, 0, 0, 0.35);
    }

    .scroll-nav button:focus-visible {
      outline: none;
      box-shadow:
        0 18px 42px rgba(0, 0, 0, 0.48),
        0 0 0 4px rgba(255, 255, 255, 0.18),
        inset 0 1px 0 rgba(255, 255, 255, 0.07);
      border-color: rgba(255, 255, 255, 0.28);
    }

    #backToFicheBtn:focus-visible {
      box-shadow:
        0 18px 42px rgba(0, 0, 0, 0.48),
        0 0 0 4px rgba(88, 166, 255, 0.26),
        0 0 0 1px rgba(88, 166, 255, 0.12),
        inset 0 1px 0 rgba(255, 255, 255, 0.07);
      border-color: rgba(88, 166, 255, 0.75);
    }

    #backToFicheBtn_summaryModal:focus-visible {
      box-shadow:
        0 18px 42px rgba(0, 0, 0, 0.48),
        0 0 0 4px rgba(88, 166, 255, 0.26),
        0 0 0 1px rgba(88, 166, 255, 0.12),
        inset 0 1px 0 rgba(255, 255, 255, 0.07);
      border-color: rgba(88, 166, 255, 0.75);
    }

    #backToThemesBtn:focus-visible {
      box-shadow:
        0 18px 42px rgba(0, 0, 0, 0.48),
        0 0 0 4px rgba(167, 139, 250, 0.26),
        0 0 0 1px rgba(167, 139, 250, 0.12),
        inset 0 1px 0 rgba(255, 255, 255, 0.07);
      border-color: rgba(167, 139, 250, 0.78);
    }

    #backToThemesBtn_summaryModal:focus-visible {
      box-shadow:
        0 18px 42px rgba(0, 0, 0, 0.48),
        0 0 0 4px rgba(167, 139, 250, 0.26),
        0 0 0 1px rgba(167, 139, 250, 0.12),
        inset 0 1px 0 rgba(255, 255, 255, 0.07);
      border-color: rgba(167, 139, 250, 0.78);
    }

    @keyframes scrollnav-shine {
      0% { transform: translateX(0) skewX(-18deg); }
      100% { transform: translateX(220%) skewX(-18deg); }
    }

    @media (prefers-reduced-motion: reduce) {
      .scroll-nav button { transition: none; }
      .scroll-nav button:hover::after { animation: none; }
      .scroll-nav { transition: none; }
    }

    @media (max-width: 640px) {
      .scroll-nav { padding: 0.9rem; }
      .scroll-nav button { flex-basis: 100%; max-width: none; }
    }

    /* Modales (stats / export) */
    .modal-backdrop,
    .cat-stats-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 9999;
    }

    .modal,
    .cat-stats-card {
      width: min(900px, 95vw);
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
      padding: 1.25rem;
    }

    .cat-stats-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.9rem;
    }

    .cat-stats-title {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 800;
      color: var(--text);
    }

    .cat-stats-badge {
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: rgba(88, 166, 255, 0.15);
      color: var(--accent);
      font-weight: 700;
      font-size: 0.9rem;
    }

    .cat-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .cat-stat-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.9rem 1rem;
    }

    .cat-stat-label {
      color: var(--muted);
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
    }

    .cat-stat-value {
      font-size: 1.25rem;
      font-weight: 800;
      color: var(--text);
    }

    .cat-stat-sub {
      color: var(--muted);
      font-size: 0.8rem;
    }

    .cat-bar {
      height: 10px;
      border-radius: 999px;
      background: #1f2937;
      overflow: hidden;
      margin-top: 0.35rem;
    }

    .cat-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--correct), #2ea043);
      border-radius: 999px;
    }

    .cat-stats-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 0.5rem;
    }

    .cat-close-btn {
      background: var(--incorrect);
      color: #fff;
      border: none;
      padding: 0.55rem 1rem;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
    }

    /* Résumé de catégorie */
    .cat-summary-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 10000;
    }

    .cat-summary-card {
      width: min(1100px, 96vw);
      max-height: 90vh;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .cat-summary-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem 1.25rem;
      background: linear-gradient(90deg, rgba(167, 139, 250, 0.25), rgba(88, 166, 255, 0.18));
      border-bottom: 1px solid var(--border);
    }

    .cat-summary-title {
      margin: 0;
      font-size: 1.15rem;
      font-weight: 900;
      color: var(--text);
      letter-spacing: 0.02em;
      flex: 1;
    }

    .cat-summary-badge {
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: rgba(88, 166, 255, 0.15);
      color: var(--accent);
      font-weight: 800;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .cat-summary-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .cat-summary-actions button {
      padding: 0.6rem 0.9rem;
      border-radius: 8px;
      font-weight: 800;
      border: none;
      cursor: pointer;
    }

    .cat-summary-fullscreen {
      background: rgba(88, 166, 255, 0.18);
      color: var(--text);
      border: 1px solid rgba(88, 166, 255, 0.25);
    }

    .cat-summary-export {
      background: #3fb950;
      color: #fff;
    }

    .cat-summary-start {
      background: var(--correct);
      color: #000;
    }

    .cat-summary-start.is-resume {
      background: #fbbf24;
      color: #000;
    }

    .cat-summary-close {
      background: var(--incorrect);
      color: #fff;
    }

    .cat-summary-backdrop.is-fullscreen,
    .cat-formulas-backdrop.is-fullscreen {
      padding: 0;
    }

    .cat-summary-card.is-fullscreen,
    .cat-formulas-card.is-fullscreen {
      width: 100vw;
      height: 100vh;
      max-height: 100vh;
      border-radius: 0;
    }

    .cat-summary-body {
      padding: 1rem 1.25rem 5.75rem;
      overflow: auto;
    }

    /* Boutons flottants dans le résumé (mêmes boutons que la page principale, mais dans le modal) */
    .cat-summary-scroll-nav {
      display: flex;
      gap: 0.75rem;
      padding: 0.25rem;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;

      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 12px;
      width: min(980px, calc(100% - 24px));
      z-index: 6;

      background: transparent;
      border: none;
      box-shadow: none;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }

    .cat-summary-scroll-nav button {
      flex: 1 1 220px;
      max-width: 280px;
    }

    @media (max-width: 640px) {
      .cat-summary-scroll-nav { padding: 0.35rem; }
      .cat-summary-scroll-nav button { flex-basis: 100%; max-width: none; }
    }

    .cat-summary-clear {
      background: rgba(248, 81, 73, 0.16);
      color: #fff;
      border: 1px solid rgba(248, 81, 73, 0.28);
    }

    .cat-summary-clear[disabled] {
      opacity: 0.45;
      cursor: not-allowed;
      filter: grayscale(0.3);
    }

    .cat-summary-note {
      margin: 0.75rem 0 1rem;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .cat-summary-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin: 0.75rem 0 1rem;
    }

    .cat-summary-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.3rem 0.6rem;
      border-radius: 999px;
      background: rgba(88, 166, 255, 0.12);
      border: 1px solid rgba(88, 166, 255, 0.25);
      color: var(--text);
      font-weight: 700;
      font-size: 0.9rem;
    }

    .cat-summary-theme {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px dashed rgba(88, 166, 255, 0.25);
    }

    .cat-summary-theme h4 {
      margin: 0 0 0.6rem;
      color: var(--accent);
      font-weight: 900;
    }

    .cat-summary-section {
      margin: 0.75rem 0;
      padding: 0.75rem;
      background: rgba(13, 17, 23, 0.6);
      border: 1px solid rgba(48, 54, 61, 0.8);
      border-radius: 10px;
    }

    .cat-summary-section h5 {
      margin: 0 0 0.5rem;
      font-size: 1rem;
      color: #c4b5fd;
      font-weight: 900;
    }

    .cat-summary-section ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
      display: grid;
      gap: 0.35rem;
    }

    .cat-summary-section li {
      color: var(--text);
      line-height: 1.5;
    }

    .cat-summary-section.is-definitions ul {
      gap: 0.6rem;
    }

    .cat-summary-section.is-definitions li {
      padding: 0.55rem 0.6rem;
      border-radius: 10px;
      background: rgba(88, 166, 255, 0.06);
      border: 1px solid rgba(88, 166, 255, 0.18);
    }

    .cat-summary-section.is-definitions .def-row {
      display: grid;
      grid-template-columns: minmax(180px, 0.42fr) 1fr;
      gap: 0.75rem;
      align-items: start;
    }

    .cat-summary-section.is-definitions .def-term {
      font-weight: 950;
      color: #c4b5fd;
      line-height: 1.35;
    }

    .cat-summary-section.is-definitions .def-def {
      color: var(--text);
      line-height: 1.5;
    }

    body.watch-mode .cat-summary-section.is-definitions .def-row {
      grid-template-columns: 1fr;
      gap: 0.35rem;
    }

    /* Glossaire (modal) */
    .glossary-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 10010;
    }
    .glossary-card {
      width: min(1100px, 96vw);
      max-height: 90vh;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .glossary-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem 1.25rem;
      background: linear-gradient(90deg, rgba(88, 166, 255, 0.2), rgba(63, 185, 80, 0.12));
      border-bottom: 1px solid var(--border);
    }
    .glossary-title {
      margin: 0;
      font-size: 1.15rem;
      font-weight: 950;
      color: var(--text);
      letter-spacing: 0.02em;
      flex: 1;
    }
    .glossary-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .glossary-actions button {
      padding: 0.6rem 0.9rem;
      border-radius: 8px;
      font-weight: 900;
      border: none;
      cursor: pointer;
    }
    .glossary-close {
      background: var(--incorrect);
      color: #fff;
    }
    .glossary-body {
      padding: 1rem 1.25rem;
      overflow: auto;
      display: grid;
      gap: 0.75rem;
    }
    .glossary-search {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .glossary-tools {
      display: flex;
      gap: 0.6rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .glossary-tools button {
      padding: 0.6rem 0.85rem;
      border-radius: 10px;
      font-weight: 900;
      cursor: pointer;
      border: 1px solid rgba(88, 166, 255, 0.25);
      background: rgba(88, 166, 255, 0.12);
      color: var(--text);
    }

    .glossary-tools button.secondary {
      border: 1px solid rgba(63, 185, 80, 0.25);
      background: rgba(63, 185, 80, 0.12);
    }

    .glossary-tools button.danger {
      border: 1px solid rgba(248, 81, 73, 0.35);
      background: rgba(248, 81, 73, 0.14);
    }

    .glossary-panel {
      border: 1px solid rgba(88, 166, 255, 0.18);
      background: rgba(88, 166, 255, 0.06);
      border-radius: 12px;
      padding: 0.9rem;
      display: grid;
      gap: 0.6rem;
    }

    .glossary-panel .row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.35rem;
    }

    .glossary-panel label {
      color: var(--muted);
      font-weight: 800;
      font-size: 0.9em;
    }

    .glossary-panel input,
    .glossary-panel textarea {
      width: 100%;
      padding: 0.75rem;
      background: var(--bg);
      border: 1px solid rgba(88, 166, 255, 0.25);
      color: var(--text);
      border-radius: 10px;
      outline: none;
      font-size: 1em;
    }

    .glossary-panel textarea {
      min-height: 90px;
      resize: vertical;
      line-height: 1.4;
    }

    .glossary-mini {
      color: var(--muted);
      font-size: 0.9em;
      line-height: 1.35;
    }

    .glossary-missing-item {
      padding: 0.85rem 1rem;
      border-radius: 12px;
      background: rgba(248, 81, 73, 0.06);
      border: 1px solid rgba(248, 81, 73, 0.18);
    }

    .glossary-missing-item .top {
      display: flex;
      gap: 0.6rem;
      align-items: baseline;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 0.35rem;
    }

    .glossary-missing-item .term {
      font-weight: 950;
      color: #ffd7d7;
    }

    .glossary-missing-item .count {
      color: var(--muted);
      font-weight: 800;
      font-size: 0.9em;
    }

    .glossary-missing-item .snippet {
      color: var(--text);
      opacity: 0.92;
      line-height: 1.45;
    }
    .glossary-search input {
      flex: 1;
      min-width: 260px;
      padding: 0.8rem;
      background: var(--bg);
      border: 2px solid rgba(88, 166, 255, 0.35);
      color: var(--text);
      border-radius: 10px;
      font-size: 1em;
      outline: none;
    }
    .glossary-list {
      display: grid;
      gap: 0.6rem;
    }
    .glossary-item {
      padding: 0.9rem 1rem;
      border-radius: 12px;
      background: rgba(88, 166, 255, 0.08);
      border: 1px solid rgba(88, 166, 255, 0.18);
      cursor: pointer;
    }
    .glossary-item:hover {
      filter: brightness(1.05);
    }
    .glossary-item .term {
      font-weight: 950;
      color: #c4b5fd;
      margin-bottom: 0.35rem;
    }
    .glossary-item .def {
      color: var(--text);
      line-height: 1.5;
    }
    .glossary-item .meta {
      margin-top: 0.4rem;
      color: var(--muted);
      font-size: 0.9em;
    }
    body.watch-mode .glossary-card {
      width: 98vw;
      max-height: 92vh;
    }

    .cat-summary-toggle {
      margin-top: 0.75rem;
      width: 100%;
      background: rgba(88, 166, 255, 0.14);
      color: var(--text);
      border: 1px solid rgba(88, 166, 255, 0.25);
      border-radius: 10px;
      padding: 0.75rem 1rem;
      font-weight: 900;
      cursor: pointer;
    }

    .cat-summary-toggle:hover {
      filter: brightness(1.06);
    }

    .key-strong {
      background: rgba(167, 139, 250, 0.28);
      border: 1px solid rgba(167, 139, 250, 0.35);
      padding: 0 0.25rem;
      border-radius: 4px;
    }

    .key-hl {
      background: rgba(88, 166, 255, 0.2);
      border: 1px solid rgba(88, 166, 255, 0.25);
      padding: 0 0.25rem;
      border-radius: 4px;
      font-weight: 800;
    }

    /* Formules (catégorie LEVURE) */
    .cat-formulas-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 10001;
    }

    .cat-formulas-card {
      width: min(980px, 96vw);
      max-height: 90vh;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .cat-formulas-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem 1.25rem;
      background: linear-gradient(90deg, rgba(34, 197, 94, 0.22), rgba(88, 166, 255, 0.18));
      border-bottom: 1px solid var(--border);
    }

    .cat-formulas-title {
      margin: 0;
      font-size: 1.15rem;
      font-weight: 900;
      color: var(--text);
      letter-spacing: 0.02em;
      flex: 1;
    }

    .cat-formulas-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .cat-formulas-actions button {
      padding: 0.6rem 0.9rem;
      border-radius: 8px;
      font-weight: 900;
      border: none;
      cursor: pointer;
    }

    .cat-formulas-fullscreen {
      background: rgba(88, 166, 255, 0.18);
      color: var(--text);
      border: 1px solid rgba(88, 166, 255, 0.25);
    }

    .cat-formulas-close {
      background: var(--incorrect);
      color: #fff;
    }

    .cat-formulas-body {
      padding: 1rem 1.25rem;
      overflow: auto;
    }

    .formula-accordion {
      display: grid;
      gap: 0.9rem;
    }

    .formula-pane {
      border: 1px solid rgba(48, 54, 61, 0.9);
      border-radius: 14px;
      background: rgba(13, 17, 23, 0.35);
      overflow: hidden;
    }

    .formula-pane-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.9rem;
      padding: 0.9rem 1rem;
      cursor: pointer;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.05), rgba(13, 17, 23, 0.10));
    }

    .formula-pane-header:focus-visible {
      outline: none;
      box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.22);
    }

    .formula-pane-title {
      font-weight: 1100;
      color: var(--text);
      letter-spacing: 0.01em;
    }

    .formula-pane-formula {
      margin-top: 0.25rem;
      color: var(--muted);
      font-weight: 900;
      font-size: 0.95rem;
      line-height: 1.35;
    }

    .formula-pane-right {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      flex: 0 0 auto;
    }

    .formula-pane-chevron {
      width: 34px;
      height: 34px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      border: 1px solid rgba(88, 166, 255, 0.20);
      background: rgba(88, 166, 255, 0.10);
      color: var(--text);
      font-weight: 1100;
      transition: transform 0.18s ease;
    }

    .formula-pane.is-open .formula-pane-chevron {
      transform: rotate(180deg);
    }

    .formula-pane-body {
      display: none;
      padding: 0.9rem 1rem 1rem;
    }

    .formula-pane.is-open .formula-pane-body {
      display: block;
    }

    .formula-hero {
      background: rgba(13, 17, 23, 0.6);
      border: 1px solid rgba(88, 166, 255, 0.25);
      border-left: 5px solid var(--accent);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .formula-hero h4 {
      margin: 0 0 0.6rem;
      font-size: 1.2rem;
      font-weight: 1000;
      color: var(--accent);
    }

    .formula-eq {
      color: var(--text);
      font-weight: 900;
      line-height: 1.5;
      margin-bottom: 0.75rem;
    }

    .formula-eq.is-active {
      color: #ffffff;
      text-shadow: 0 0 16px rgba(88, 166, 255, 0.25);
    }

    .formula-eq.is-muted {
      color: var(--muted);
      opacity: 0.85;
    }

    .formula-note {
      color: var(--muted);
      font-weight: 800;
      font-size: 0.9rem;
      margin-top: 0.25rem;
    }

    .formula-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.75rem;
    }

    .formula-field {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(48, 54, 61, 0.9);
      border-radius: 10px;
      padding: 0.75rem;
    }

    .formula-field label {
      display: block;
      color: var(--muted);
      font-weight: 900;
      margin-bottom: 0.35rem;
      font-size: 0.9rem;
    }

    .formula-field input {
      width: 100%;
      padding: 0.6rem 0.65rem;
      border-radius: 8px;
      border: 1px solid rgba(88, 166, 255, 0.25);
      background: var(--bg);
      color: var(--text);
      font-weight: 900;
      outline: none;
    }

    .formula-out {
      margin-top: 0.85rem;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.75rem;
    }

    .formula-kpi {
      background: rgba(34, 197, 94, 0.12);
      border: 1px solid rgba(34, 197, 94, 0.25);
      border-radius: 10px;
      padding: 0.85rem;
    }

    .formula-kpi.warn {
      background: rgba(245, 158, 11, 0.12);
      border-color: rgba(245, 158, 11, 0.25);
    }

    .formula-kpi .k {
      color: var(--muted);
      font-size: 0.85rem;
      font-weight: 1000;
      margin-bottom: 0.25rem;
    }

    .formula-kpi .v {
      font-size: 1.25rem;
      font-weight: 1100;
      color: var(--text);
      line-height: 1.2;
    }

    .formula-kpi .s {
      color: var(--muted);
      font-size: 0.85rem;
      margin-top: 0.25rem;
    }

    .formula-explain {
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(13, 17, 23, 0.55);
      border: 1px solid rgba(48, 54, 61, 0.9);
      border-radius: 12px;
    }

    .formula-explain h4 {
      margin: 0 0 0.75rem;
      color: #c4b5fd;
      font-weight: 1100;
      font-size: 1.15rem;
    }

    .formula-explain .line {
      margin: 0.35rem 0;
      color: var(--text);
      font-weight: 800;
    }

    .formula-explain .line strong {
      color: var(--accent);
    }

    @media (max-width: 900px) {
      .formula-grid, .formula-out { grid-template-columns: 1fr; }
    }

    /* Croix pour effacer la recherche (globale + dans thème) */
    .search-input-wrap {
      position: relative;
      display: inline-flex;
      align-items: center;
    }

    .search-clear-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 32px;
      height: 32px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(255, 255, 255, 0.08);
      color: rgba(255, 255, 255, 0.92);
      font-weight: 900;
      line-height: 1;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease, transform 0.15s ease, background 0.15s ease, border-color 0.15s ease;
    }

    .search-clear-btn.is-visible {
      opacity: 1;
      pointer-events: auto;
    }

    .search-clear-btn:hover {
      background: rgba(248, 81, 73, 0.18);
      border-color: rgba(248, 81, 73, 0.35);
      transform: translateY(-50%) scale(1.03);
    }

    .search-clear-btn:focus-visible {
      outline: none;
      box-shadow: 0 0 0 4px rgba(88, 166, 255, 0.22);
      border-color: rgba(88, 166, 255, 0.45);
    }

    /* Barre de recherche compacte (bureau) */
    #searchBarContainer {
      padding: 0.95rem 1.1rem !important;
      gap: 0.65rem !important;
      flex-wrap: nowrap !important;
    }

    #searchBarContainer .search-input-wrap {
      flex: 1 1 auto;
      min-width: 200px;
    }

    #searchBarContainer input#searchBar {
      min-width: 0 !important;
      padding: 0.65rem 0.85rem !important;
      padding-right: 2.6rem !important;
      font-size: 0.95em !important;
    }

    #searchBarContainer button {
      padding: 0.6rem 0.95rem !important;
      font-size: 0.92em !important;
      border-radius: 10px !important;
    }

    @media (max-width: 1050px) {
      #searchBarContainer {
        flex-wrap: wrap !important;
      }
      #searchBarContainer .search-input-wrap {
        flex-basis: 100%;
      }
    }

    /* Mode recherche: n'afficher que la barre + les résultats */
    body.search-only-mode header,
    body.search-only-mode #nav,
    body.search-only-mode #controls,
    body.search-only-mode #themeSearchContainer,
    body.search-only-mode #fiche,
    body.search-only-mode #quizContainer,
    body.search-only-mode #scrollNav,
    body.search-only-mode #statsPanel,
    body.search-only-mode #statsChart {
      display: none !important;
    }

    body.search-only-mode #searchBarContainer {
      position: sticky;
      top: 0;
      z-index: 10001;
      border-bottom: 1px solid var(--accent);
    }

    body.search-only-mode #searchBarContainer > button:not(#searchModeToggle) {
      display: none !important;
    }

    body.search-only-mode #searchResults {
      max-height: none !important;
      overflow: visible !important;
    }

    /* Mode montre (Galaxy Watch / petits écrans quasi carrés)
       Objectif : lisible + cliquable sans changer téléphone/PC.
       Déclenchement : petite taille + aspect ratio ~ 1:1 (évite les téléphones).
    */
    @media (max-width: 480px) and (max-height: 480px) and (min-aspect-ratio: 9/10) and (max-aspect-ratio: 10/9) {
      header { padding: 0.85rem; }
      header h1 { font-size: 1.1em; line-height: 1.2; }

      #searchBarContainer {
        padding: 0.65rem !important;
        gap: 0.5rem !important;
      }

      #searchBar {
        min-width: 0 !important;
        padding: 0.55rem 0.65rem !important;
        font-size: 0.9em !important;
      }

      .search-clear-btn {
        right: 8px;
        width: 28px;
        height: 28px;
        border-radius: 10px;
      }

      #searchBarContainer button {
        padding: 0.55rem 0.75rem !important;
        font-size: 0.88em !important;
      }

      #nav {
        padding: 0.75rem;
        gap: 0.5rem;
      }

      .category-group {
        padding: 0.65rem;
        margin-bottom: 0.85rem;
      }

      .category-header {
        padding: 0.45rem 0.55rem;
        gap: 0.5rem;
      }

      .category-title {
        font-size: 0.92em;
        min-width: 0;
        padding: 0.2rem 0.5rem;
      }

      .category-actions {
        gap: 0.4rem;
        flex-wrap: wrap;
      }

      .category-action-btn {
        padding: 0.45rem 0.75rem;
        font-size: 0.82em;
        border-radius: 10px;
      }

      .category-themes {
        gap: 0.45rem;
      }

      .category-group .theme-btn {
        flex: 1 1 100%;
        min-width: 0;
      }

      .theme-btn {
        min-height: 40px;
        padding: 0.5rem 0.6rem;
        font-size: 0.82em;
      }

      #controls {
        padding: 0.35rem 0.5rem;
        gap: 0.35rem;
        justify-content: center;
      }

      #controls select {
        padding: 0.35rem 0.55rem;
        font-size: 0.85em;
      }

      #controls button {
        padding: 0.4rem 0.6rem;
        font-size: 0.82em;
        flex: 1 1 calc(50% - 0.35rem);
      }

      #themeSearchContainer {
        padding: 0.65rem !important;
      }

      #themeSearchBar {
        padding: 0.55rem 0.65rem !important;
        font-size: 0.9em !important;
      }

      .course-content {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
      }

      .scroll-nav {
        width: calc(100vw - 16px);
        bottom: calc(8px + env(safe-area-inset-bottom, 0px));
      }

      .scroll-nav button {
        min-height: 38px;
        padding: 0.5rem 0.75rem;
        font-size: 0.88em;
        max-width: none;
      }

      .cat-summary-card,
      .cat-formulas-card,
      .cat-stats-card,
      .modal {
        width: calc(100vw - 16px);
        padding: 0.85rem;
        border-radius: 12px;
      }

      .cat-summary-header h2,
      .cat-formulas-header h2,
      .cat-stats-header h2 {
        font-size: 1.05rem;
      }
    }

    @media (shape: round) and (max-width: 480px) and (max-height: 480px) {
      /* Même traitement pour écrans ronds (si supporté) */
      header { padding: 0.85rem; }
      header h1 { font-size: 1.08em; line-height: 1.2; }
      #nav { padding: 0.75rem; }
      .scroll-nav { width: calc(100vw - 18px); }
    }

    /* Mode montre MANUEL (activé via JS + localStorage) */
    body.watch-mode header { padding: 0.85rem; }
    body.watch-mode header h1 { font-size: 1.1em; line-height: 1.2; }

    body.watch-mode #searchBarContainer {
      padding: 0.65rem !important;
      gap: 0.5rem !important;
    }

    body.watch-mode #searchBar {
      min-width: 0 !important;
      padding: 0.55rem 0.65rem !important;
      font-size: 0.9em !important;
    }

    body.watch-mode #searchBarContainer button {
      padding: 0.55rem 0.75rem !important;
      font-size: 0.88em !important;
    }

    body.watch-mode #nav {
      padding: 0.75rem;
      gap: 0.5rem;
    }

    body.watch-mode .category-group {
      padding: 0.65rem;
      margin-bottom: 0.85rem;
    }

    body.watch-mode .category-header {
      padding: 0.45rem 0.55rem;
      gap: 0.5rem;
    }

    body.watch-mode .category-title {
      font-size: 0.92em;
      min-width: 0;
      padding: 0.2rem 0.5rem;
    }

    body.watch-mode .category-actions {
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    body.watch-mode .category-action-btn {
      padding: 0.45rem 0.75rem;
      font-size: 0.82em;
      border-radius: 10px;
    }

    body.watch-mode .category-group .theme-btn {
      flex: 1 1 100%;
      min-width: 0;
    }

    body.watch-mode .theme-btn {
      min-height: 40px;
      padding: 0.5rem 0.6rem;
      font-size: 0.82em;
    }

    body.watch-mode #controls {
      padding: 0.35rem 0.5rem;
      gap: 0.35rem;
      justify-content: center;
    }

    body.watch-mode #controls select {
      padding: 0.35rem 0.55rem;
      font-size: 0.85em;
    }

    body.watch-mode #controls button {
      padding: 0.4rem 0.6rem;
      font-size: 0.82em;
      flex: 1 1 calc(50% - 0.35rem);
    }

    body.watch-mode #themeSearchContainer {
      padding: 0.65rem !important;
    }

    body.watch-mode #themeSearchBar {
      padding: 0.55rem 0.65rem !important;
      font-size: 0.9em !important;
    }

    body.watch-mode .scroll-nav {
      width: calc(100vw - 16px);
      bottom: calc(8px + env(safe-area-inset-bottom, 0px));
    }

    body.watch-mode .scroll-nav button {
      min-height: 38px;
      padding: 0.5rem 0.75rem;
      font-size: 0.88em;
      max-width: none;
    }

    body.watch-mode .cat-summary-card,
    body.watch-mode .cat-formulas-card,
    body.watch-mode .cat-stats-card,
    body.watch-mode .modal {
      width: calc(100vw - 16px);
      padding: 0.85rem;
      border-radius: 12px;
    }

    body.watch-mode .cat-summary-header h2,
    body.watch-mode .cat-formulas-header h2,
    body.watch-mode .cat-stats-header h2 {
      font-size: 1.05rem;
    }

    @media (shape: round) {
      body.watch-mode .scroll-nav { width: calc(100vw - 18px); }
    }

    /* Téléphones : barre sticky moins gênante (plus petite + plus transparente) */
    @media (max-width: 900px) and (hover: none) and (pointer: coarse) {
      .scroll-nav {
        width: calc(100vw - 16px);
        bottom: calc(6px + env(safe-area-inset-bottom, 0px));
      }

      .scroll-nav button {
        min-height: 36px;
        padding: 0.45rem 0.7rem;
        font-size: 0.85em;
        max-width: 220px;
      }

      #backToFicheBtn,
      #backToThemesBtn {
        background: rgba(13, 17, 23, 0.32) !important;
        border-color: rgba(255, 255, 255, 0.14) !important;
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35) !important;
      }

      .scroll-nav button::before { opacity: 0.25; }
      .scroll-nav button::after { content: none; }
    }

    /* Fiabilise l’appui long (évite sélection/zoom contextuel) */
    #courseTitle {
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      touch-action: manipulation;
    }

    /* Petit toast discret (utilisé uniquement lors du toggle mode montre) */
    .watch-toast {
      position: fixed;
      left: 50%;
      top: 12px;
      transform: translateX(-50%);
      z-index: 10001;
      padding: 0.55rem 0.75rem;
      background: rgba(13, 17, 23, 0.72);
      border: 1px solid rgba(255, 255, 255, 0.10);
      color: var(--text);
      border-radius: 999px;
      font-weight: 800;
      font-size: 0.9em;
      box-shadow: 0 14px 32px rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease, transform 0.18s ease;
    }

    .watch-toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  </style>
</head>
<body>
  <header>
    <h1 id="courseTitle" style="cursor: pointer; transition: opacity 0.2s;">🍺 Physico-chimie du brassage <span id="toggleIcon" style="margin-left: 1rem; font-size: 0.7em;">▼</span><span style="float: right; font-size: 0.5em; font-weight: normal; color: rgba(255,255,255,0.7);">Nicolas Lambert</span></h1>
  </header>

  <!-- Barre de recherche -->
  <div id="searchBarContainer" class="course-content" style="padding: 1.5rem; background: var(--card-bg); border-bottom: 1px solid var(--accent); display: flex; flex-wrap: wrap; gap: 1rem; align-items: center;">
    <div class="search-input-wrap" style="flex: 1; min-width: 200px;">
      <input type="text" id="searchBar" placeholder="🔍 Rechercher un thème..." style="width: 100%; padding: 0.8rem; padding-right: 2.6rem; background: var(--bg); border: 2px solid var(--accent); color: var(--text); border-radius: 6px; font-size: 1em;">
      <button type="button" id="clearSearchBar" class="search-clear-btn" aria-label="Effacer la recherche" title="Effacer">✕</button>
    </div>
    <button id="searchModeToggle" style="background: rgba(245, 158, 11, 0.15); color: #fff; border: 1px solid rgba(245, 158, 11, 0.35); padding: 0.8rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 900; white-space: nowrap; font-size: 1em; transition: all 0.2s;">🔎 Mode recherche</button>
    <button id="glossaryBtn" style="background: rgba(88, 166, 255, 0.18); color: #fff; border: 1px solid rgba(88, 166, 255, 0.35); padding: 0.8rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 800; white-space: nowrap; font-size: 1em; transition: all 0.2s;">📚 Glossaire</button>
    <button id="statsBtn" style="background: #f59e0b; color: #000; border: none; padding: 0.8rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 700; white-space: nowrap; font-size: 1em; transition: all 0.2s;">📊 Statistiques</button>
    <button id="exportAllThemes" style="background: #3fb950; color: #fff; border: none; padding: 0.8rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap; font-size: 1em; transition: all 0.2s;">📦 Exporter tous</button>
    <button id="globalRevisionBtn" style="background: #a78bfa; color: #000; border: none; padding: 0.8rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 700; white-space: nowrap; font-size: 1em; transition: all 0.2s;">📚 Revisions Totales</button>
    <button id="resetAllData" style="background: #dc3545; color: #fff; border: none; padding: 0.8rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap; font-size: 1em; transition: all 0.2s;">🔄 Tout réinitialiser</button>
  </div>

  <!-- Résultats de recherche -->
  <div id="searchResults" class="course-content" style="display: none; padding: 1.5rem; background: var(--card-bg); border-bottom: 1px solid var(--accent); max-height: 400px; overflow-y: auto;">
    <h3 style="color: var(--accent); margin-bottom: 1rem; font-size: 1.1em;">📋 Résultats de recherche</h3>
    <div id="searchResultsContent"></div>
  </div>

  <!-- Panneau de statistiques globales -->
  <div id="statsPanel" class="course-content" style="display: none; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; padding: 1.5rem; background: var(--card-bg); border-bottom: 1px solid var(--accent);">
    <div class="stat-card" style="background: linear-gradient(135deg, #1f6feb 0%, #0d1117 100%); padding: 1.5rem; border-radius: 8px; text-align: center;">
      <div style="font-size: 2em; font-weight: bold; color: #58a6ff;">0</div>
      <div style="font-size: 0.9em; color: rgba(255,255,255,0.7);">Thèmes démarrés</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, #3fb950 0%, #0d1117 100%); padding: 1.5rem; border-radius: 8px; text-align: center;">
      <div style="font-size: 2em; font-weight: bold; color: #3fb950;">0</div>
      <div style="font-size: 0.9em; color: rgba(255,255,255,0.7);">Thèmes terminés</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, #a78bfa 0%, #0d1117 100%); padding: 1.5rem; border-radius: 8px; text-align: center;">
      <div style="font-size: 2em; font-weight: bold; color: #a78bfa;">0%</div>
      <div style="font-size: 0.9em; color: rgba(255,255,255,0.7);">Taux de réussite</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, #f85149 0%, #0d1117 100%); padding: 1.5rem; border-radius: 8px; text-align: center;">
      <div style="font-size: 2em; font-weight: bold; color: #f85149;">0</div>
      <div style="font-size: 0.9em; color: rgba(255,255,255,0.7);">Questions ratées</div>
    </div>
  </div>

  <!-- Graphiques circulaires de progression -->
  <div id="statsChart" class="course-content" style="display: none; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 2rem; padding: 2rem; background: var(--card-bg); border-bottom: 1px solid var(--accent);">
    <div style="text-align: center;">
      <canvas id="completedChart" width="150" height="150"></canvas>
      <div style="margin-top: 1rem; color: var(--text); font-weight: 600;">Terminés</div>
    </div>
    <div style="text-align: center;">
      <canvas id="startedChart" width="150" height="150"></canvas>
      <div style="margin-top: 1rem; color: var(--text); font-weight: 600;">Démarrés</div>
    </div>
    <div style="text-align: center;">
      <canvas id="notStartedChart" width="150" height="150"></canvas>
      <div style="margin-top: 1rem; color: var(--text); font-weight: 600;">Non démarrés</div>
    </div>
  </div>
  
  <nav id="nav" class="course-content"></nav>
  
  <div id="controls" class="course-content">
    <label for="questionCount">Questions :</label>
    <select id="questionCount">
      <option value="5">5 questions</option>
      <option value="10">10 questions</option>
      <option value="15">15 questions</option>
      <option value="20">20 questions</option>
      <option value="25">25 questions</option>
      <option value="30" selected>30 questions</option>
    </select>
    <button id="startQuiz">Démarrer</button>
    <button id="toggleFiche">👁️ Masquer la fiche</button>
    <button id="revisionMode" style="background: #a78bfa; color: #000;">🔄 Mode révision</button>
    <button id="fullscreenBtn">🖥️ Plein écran</button>
    <button id="exportThemeBtn" style="background: #3fb950; color: #fff;">📄 Exporter thème</button>
    <button id="resetAllBtn" style="background: #dc3545; color: #fff;">🔄 Réinitialiser tout</button>
    <span id="progress">—</span>
  </div>

  <!-- Barre de recherche dans le thème -->
  <div id="themeSearchContainer" class="course-content" style="padding: 1rem; background: var(--card-bg); border-bottom: 1px solid var(--border); margin-bottom: 0;">
    <div class="search-input-wrap" style="width: 100%;">
      <input type="text" id="themeSearchBar" placeholder="🔍 Rechercher dans ce thème..." style="width: 100%; padding: 0.8rem; padding-right: 2.6rem; background: var(--bg); border: 2px solid var(--accent); color: var(--text); border-radius: 6px; font-size: 1em;">
      <button type="button" id="clearThemeSearchBar" class="search-clear-btn" aria-label="Effacer la recherche dans ce thème" title="Effacer">✕</button>
    </div>
    <div id="themeSearchResults" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg); border-radius: 6px; max-height: 300px; overflow-y: auto;">
      <div id="themeSearchResultsContent"></div>
    </div>
  </div>

  <div id="fiche" class="course-content">
    <h2 id="ficheTitle"></h2>
    <div id="ficheContent"></div>
  </div>
  
  <div id="quizContainer" class="course-content"></div>

  <div id="scrollNav" class="course-content scroll-nav">
    <button id="backToFicheBtn">⬆️ Revenir à la fiche</button>
    <button id="backToThemesBtn">⬆️ Revenir aux thèmes</button>
  </div>

<script>
function q(question, options, correctIndex, explanation) {
  return { question, options, correctIndex, explanation };
}

const THEMES = [
  {
    id: "specificationsMalt",
    category: "MALT",
    title: "1. Spécifications du malt",
    ficheRich: [
      { title: "Humidité du malt", items: ["**Humidité optimale: 4–6%** pour un stockage à long terme stable et prévention des moisissures.", "L'eau > 8% favorise la dégradation enzymatique et le développement microbien (Fusarium, moisissures).", "Stockage optimal: température < 15°C + obscurité améliore la stabilité. À 20°C, perte ~1% qualité/mois.", "Mesurée par **titrage Karl Fischer**, méthode standard analytique avec précision ±0.1%."] },
      { title: "Protéines brutes et FAN", items: ["**FAN (Free Amino Nitrogen): 150–180 mg/L** source d'azotes libres essentiels pour la levure dans le moût final. Insuffisant → fermentation lente, diacétyle.", "**FAN pale malt spécifique: 120–150 mg/L** (valeur typique pour le malt de base lui-même), tandis que le niveau optimal général dans le moût est de 150–180 mg/L pour la fermentation.", "Les protéines structurent le grain et contribuent à la **mousse de bière** (stabilisent les bulles via complexes protéine-polyphénol).", "**Indice de Kolbach (IK) = FAN/Protéines Totales (%)** : 40–50% optimal. IK < 35% = modification insuffisante. IK > 45% = mousse faible.", "Protéines + polyphénols → complexe protéine-tanin → **casse chaude** (70°C clarification) ou **casse froide** (5°C défaut)."] },
      { title: "Couleur EBC et mesure", items: ["**Pale malt: 3–8 EBC** très clair, amidon maximisé pour la conversion enzymatique complète. **Usage: 60–100% de la recette** comme malt de base fournissant l'essentiel des sucres fermentescibles et des enzymes de conversion.", "**Munich: 10–25 EBC** repos prolongé 75–85°C, protéines élevées, mélanoïdines intermédiaires. **Usage typique: 20–50%** dans les Lagers de type Oktoberfest ou Munich Dunkel, apportant une couleur ambrée et des arômes maltés prononcés.", "**Caramel: 20–200 EBC** sucres résiduels figés dans le grain (saccharification in-grain), douceur résiduelle.", "**Chocolat/Noir: 800–1500 EBC** torréfaction > 200°C, sucres brûlés, notes café/cacao, acidité (↓ pH). Usage < 5% (Black) ou < 10% (Chocolat)."] },
      { title: "Densité d'extraction", items: ["Rendement des sucres fermentescibles **80–90%** de la masse du malt. Facteurs : amidon (70%), protéines (11%), β-glucanes (5%).", "Dépend de: type de malt (2RP vs 6RW), finesse du broyage (75–150 microns), température d'empâtage (62–73°C), durée repos enzymatique (45–90 min), pH moût (5.4–5.8)."] },
      { title: "Paramètres Clés de Qualité", items: ["**Extrait Fine Grind (Min 80.5%)**: Potentiel maximum sucres fermentescibles après saccharification complète. Lié à teneur amidon.", "**Différence Fin/Gros (Max 2.0%)**: Indicateur **modification** du grain. Faible différence = endosperme bien dégradé = conversion facile.", "**Friabilité (Min 80.0%)**: Mesure **vitrosité** (dureté). Friabilité élevée = grain tendre = meilleure hydratation, conversion rapide.", "**Viscosité (Max 1.60 mPas)**: Directement liée aux **β-glucanes**. Viscosité élevée → risque colmatage filtre lors filtration."] },
      { title: "Impact sur le Brassage", items: ["**Humidité excessive** → perte rendement financier, développement mycotoxines (DON), conservation médiocre.", "**Extrait faible** → rendement insuffisant, bière moins riche, volume insuffisant pour recette cible.", "**Modification insuffisante** → nécessite palier protéinique long pour convertir amidon, risque colmatage.", "**FAN insuffisant** → fermentation lente, levure sous stress, diacétyle (saveur beurre rancide), alcool incomplet.", "**Kolbach trop élevé** → protéines dégradées excessives → mousse faible ou collapse rapide."] },
      { title: "Définition Centrale", items: ["Les **types de malts** se classent en deux grandes catégories : les **malts enzymatiques** (pouvoir diastasique) qui fournissent l'extrait et les enzymes, et les **malts inertes** (couleur, saveur, corps) qui ne convertissent pas l'amidon mais enrichissent la bière."] },
      { title: "Malts de Base (Enzymatiques)", items: ["**Pilsener / Pale Ale**: Font 80-100% de la grist. **Touraillés à basse T** (60-65°C) pour maximiser la survie des enzymes. **Pouvoir Diastasique élevé**, **Kolbach idéal**.", "**Caractéristiques**: Grain accessible, peu de vitrosité, conversion rapide (30-45 min d'empâtage suffisent)."] },
      { title: "Malts Caramel/Crystal (Caractère)", items: ["**Processus**: Grain humidifié → étuvage (T interne 65-70°C) → saccharification interne → touraillage (caramélisation).", "**Résultat**: **Dextrines vitrifiées** (sucres non fermentescibles) bloquées dans le grain. **Zéro activité enzymatique**.", "**Impacts**: Augmentation du **corps**, de la **tenue de mousse**, et des saveurs de caramel/toffee. Couleur EBC varie : CaraPils (5-10°EBC) à CaraMunich (40-80°EBC).", "**Usage**: Jamais plus de 40-50% sans malt de base."] },
      { title: "Malts Torréfiés et Spéciaux", items: ["**Malts Torréfiés (Black, Chocolat)**: Très haute T (> 200°C) = sucres brûlés. Notes de **café/cacao**, acidité (↓ pH). **Usage strict** : < 5% (Black) ou < 10% (Chocolat).", "**Malts Spéciaux (Munich, Vienna)**: T intermédiaire (75-85°C touraillage) = **mélanoïdines intermédiaires**. Conservent une activité enzymatique partielle. Pouvoir diastasique encore exploitable (peuvent faire jusqu'à 60% de la grist).", "**Règle d'Or**: Tout malt sans enzymes doit être associé à un **malt de base enzymatique** dans l'empâtage."] }
    ],
    questions: [
      q("Quelle est l'humidité optimale du malt?", ["2–3% pour stockage court", "4–6% pour stockage sûr", "8–10% sans ventilation", "12–14% juste séché"], 1, "4–6% permet un stockage stable à long terme."),
      q("Que signifie FAN?", ["Filtre aromatique neutre", "Free Amino Nitrogen pour nourrir la levure", "Facteur alcool négatif", "Fermentation acide naturelle"], 1, "FAN = azotes libres essentiels pour la fermentation."),
      q("Quel est le niveau optimal de FAN (mg/L)?", ["90–120 mg/L", "150–180 mg/L", "210–240 mg/L", "300–330 mg/L"], 1, "150–180 mg/L optimal pour la fermentation."),
      q("Qu'est-ce que l'indice de Kolbach?", ["Indice de couleur EBC", "Ratio de solubilisation des protéines", "Densité d'extraction", "Mesure IBU"], 1, "Mesure le degré d'hydrolyse des protéines."),
      q("Quelle est la couleur EBC du pale malt?", ["1–2 EBC très pâle", "3–8 EBC base claire", "20–50 EBC ambré", "200+ EBC torréfié"], 1, "3–8 EBC très clair."),
      q("Si l'humidité du malt dépasse 8%, quelle conséquence principale?", ["Stockage amélioré", "Moisissures et dégradation accélérée", "Plus d'enzymes disponibles", "Aucun effet notable"], 1, "L'eau catalyse les réactions de dégradation."),
      q("Quelle est la température idéale de stockage du malt?", ["20–25°C en silo ouvert", "Moins de 15°C et à l'abri de la lumière", "Séchage à 40°C", "Congélation systématique"], 1, "Le froid ralentit les réactions de dégradation."),
      q("Quel est le rôle principal des protéines dans la mousse de bière?", ["Les lipides maintiennent la mousse", "Les protéines colloïdales stabilisent la mousse", "Les sucres créent la mousse", "Les acides gras renforcent la mousse"], 1, "Les protéines viscoélastiques forment l'écume stable."),
      q("Quel est le pourcentage optimal pour l'indice de Kolbach?", ["25–35%", "40–50%", "60–70%", "80–90%"], 1, "40–50% représente une dégradation protéique équilibrée."),
      q("Quel est le rendement typique d'extraction du malt (densité)?", ["60–70%", "70–75%", "80–90%", "Plus de 95%"], 2, "80–90% de rendement en sucres fermentescibles."),
      q("Quelle est la cause principale du brunissement du malt?", ["Oxydation des acides gras", "Réaction de Maillard sucres/acides aminés", "Fermentation par la levure", "Apport d'humidité"], 1, "La réaction de Maillard = polymérisation créant la couleur brune."),
      q("Quelle est la méthode standard de mesure de la couleur EBC?", ["Panel sensoriel", "Spectrophotométrie visible à 430 nm", "Analyse olfactive", "Observation à l'œil nu"], 1, "Analyse spectrophotométrique standardisée internationalement."),
      q("Quelle est la température de repos pendant le touraillage du malt Munich?", ["55–60°C", "65–70°C prolongé", "75–85°C", "95°C et plus"], 2, "Repos prolongé à 75–85°C pour développer les mélanoïdines."),
      q("D'où proviennent les sucres résiduels du malt Caramel?", ["Fermentation ultérieure", "Saccharification interne figée par la chaleur", "Ajout de sucre de candi", "Chauffage sans enzymes"], 1, "Saccharification in-grain = sucres figés dans le grain."),
      q("Quelle est la proportion typique de pale malt dans une recette?", ["15–25% pour la couleur", "60–80% comme base", "100% dans tous les cas", "Jamais utilisé"], 1, "60–80% de pale malt constitue la base de la plupart des recettes."),
      q("Qu'est-ce que le titrage Karl Fischer?", ["Mesure des protéines", "Dosage précis de l'humidité", "Mesure de la couleur", "Mesure des IBU"], 1, "Dosage de l'eau avec précision extrême."),
      q("Quelle est la différence entre le FAN et les protéines totales?", ["Moins de 10% des protéines", "Environ 20–30% des protéines totales", "Identiques", "Supérieurs aux protéines"], 1, "FAN est une fraction soluble des azotes libres."),
      q("Quel est l'impact de la lumière sur le stockage du malt?", ["Impact nul", "Oxydation accélérée et perte de qualité", "Améliore la qualité", "Rend le malt inutilisable"], 1, "La lumière = oxydation et dégradation rapide."),
      q("Quelle est l'intensité de la réaction de Maillard dans le malt Caramel?", ["Très légère", "Intense grâce à la saccharification interne", "Nulle", "Juste modérée"], 1, "Réaction intense créant des sucres caramélisés figés."),
      q("À quelle température les protéases sont-elles actives?", ["25–35°C", "Autour de 50°C pour l'hydrolyse", "75–80°C", "Au-dessus de 95°C"], 1, "Environ 50°C : les protéases hydrolysent les protéines."),
      q("Quel est le niveau de FAN typique pour le pale malt?", ["80–100 mg/L", "120–150 mg/L", "180–200 mg/L", "260–300 mg/L"], 1, "120–150 mg/L est le niveau standard pour le pale malt."),
      q("Qu'est-ce que mesure l'indice de Kolbach?", ["Conversion de l'amidon", "Hydrolyse/solubilité des protéines", "Sucre fermentescible", "Activation enzymatique"], 1, "Mesure l'hydrolyse protéique."),
      q("À quel usage le malt Munich est-il destiné?", ["Très rarement utilisé", "5–20% en soutien", "20–50% pour les lagers maltées", "80–100% exclusif"], 2, "20–50% dans les Lagers Oktoberfest."),
      q("Quelle est la couleur EBC du malt Chocolat?", ["40–90 EBC", "400–600 EBC", "800–1500 EBC", "1800+ EBC"], 2, "800–1500 très sombre noir."),
      q("Quel est l'impact de la température du séchage du malt?", ["Aucun impact notable", "Basse température sans réaction", "Haute température = Maillard et couleur", "Effet indifférent"], 2, "Haute T° = réaction de Maillard."),
      q("Le pale malt est-il obligatoire en base?", ["10–20% maximum", "40–50% seulement", "60–100% comme fondation", "Jamais nécessaire"], 2, "60–100% pour la base de recettes."),
      q("Quelle est la relation protéine/amidon?", ["L'amidon n'est pas présent", "Protéines et amidon coexistent dans le grain", "Le sucre remplace l'amidon", "Enzymes uniquement"], 1, "Le grain = protéine + amidon."),
      q("Que se passe-t-il si l'humidité de stockage dépasse 12%?", ["Stockage idéal", "Dégradation rapide avec moisissures", "Effet neutre", "Saveur maltée améliorée"], 1, "Dégradation catalysée par l'excès d'eau."),
      q("Quelle est la différence entre l'indice de Kolbach et le FAN?", ["Valeur identique", "FAN en mg/L vs Kolbach en % d'hydrolyse", "Inverse exact", "Aucun lien"], 1, "FAN mesure une quantité absolue, Kolbach un ratio en pourcentage."),
      q("Quel est l'impact de la fraîcheur du malt sur la qualité?", ["Le malt ne bouge pas", "Oxydation progressive et perte de qualité", "La qualité monte avec le temps", "Peu ou pas d'effet"], 1, "Fraîcheur = meilleure qualité, moins d'oxydation.")
    ]
  },
  {
    id: "turbidite",
    category: "MALT",
    title: "2. Turbidité",
    ficheRich: [
      { title: "Colloïdes et complexes", items: ["**Complexe protéine-polyphénol** macromolécules colloïdales.", "Le chauffage du moût crée des liaisons entre protéines (hordéines) et tannins.", "Casse colloïdale = trouble visible dans la bière."] },
      { title: "NTU - Mesure du trouble", items: ["**Nephelometric Turbidity Unit (NTU)** diffusion à 90°.", "**ISO 7027** spectrophotométrie standard.", "Unité: mg SiO₂/L équivalent.", "Cible brasserie: < 2–5 NTU pour la clarté."] },
      { title: "Casse chaude vs froide", items: ["**Casse chaude**: Précipitation ~70°C (clarification).", "**Casse froide**: Trouble ~5°C (défaut)."] },
      { title: "Impact sensoriel", items: ["Trouble élevé = bière trouble, saveur astringente.", "0–2 NTU = brillant et transparent.", "2–10 NTU = légèrement trouble.", "> 20 NTU = inacceptable."] }
    ],
    questions: [
      q("Quelle est la cause principale de la turbidité dans la bière?", ["Les sucres simples dissous", "Complexes protéine-polyphénol colloïdaux", "Levures viables en suspension", "Pigments de couleur du malt"], 1, "Colloïdes protéine-polyphénol forment le trouble."),
      q("Que signifie l'abréviation NTU?", ["Neutral Turbidity Unit", "Nephelometric Turbidity Unit (mesure à 90°)", "Natural Trouble Unit", "Nitrogen Total Unit"], 1, "NTU mesure la diffusion de la lumière pour quantifier le trouble."),
      q("À quel angle la lumière est-elle mesurée pour déterminer le NTU?", ["45 degrés", "90 degrés", "180 degrés", "0 degré"], 1, "90° est l'angle standard de diffusion nephelométrique."),
      q("À quelle température se produit la casse chaude?", ["40–50°C", "Environ 65–75°C", "85–95°C", "Au-dessus de 100°C"], 1, "Environ 70°C : précipitation protéine-polyphénol bénéfique."),
      q("À quelle température se produit la casse froide?", ["Inférieur à 5°C", "15–20°C", "40–50°C", "80–90°C"], 0, "Environ 5°C lors du refroidissement : trouble indésirable."),
      q("Qu'est-ce qu'un polyphénol dans la bière?", ["Un type de sucre simple", "Des tannins colloïdaux provenant du malt", "Une enzyme de dégradation", "Un lipide du houblon"], 1, "Polyphénols = tannins du malt et houblon."),
      q("Quelle est la cible professionnelle de turbidité (NTU) pour une bière claire?", ["Inférieur à 50 NTU", "Inférieur à 2–5 NTU", "10–20 NTU", "Supérieur à 50 NTU"], 1, "Moins de 5 NTU = bière excellemment claire."),
      q("Dans quel contexte recherche-t-on la casse chaude?", ["C'est un défaut à éviter absolument", "C'est une clarification souhaitable pendant l'ébullition", "Pendant la fermentation", "Pendant le stockage"], 1, "Casse chaude = clarification bénéfique à 70°C."),
      q("Quel niveau de NTU correspond à une turbidité légère?", ["0–2 NTU (transparent)", "10–20 NTU", "Plus de 50 NTU", "Immesurable"], 1, "10-20 NTU représente une turbidité légère visible."),
      q("Quelle est la source principale des protéines causant la turbidité?", ["La levure", "Les hordéines du malt d'orge", "Le houblon", "L'eau de brassage"], 1, "Le malt est la source principale des protéines."),
      q("Quelle est la source de polyphénol?", ["Levure", "Pellicule du malt et résine du houblon", "Sucre", "Enzyme"], 1, "Malt pellicule + houblon."),
      q("La casse froide affecte quelle saveur?", ["Sucré", "Astringent et tannique", "Fruité", "Acide"], 1, "Astringence off-flavour."),
      q("Quel est le standard ISO 7027?", ["Couleur EBC", "Turbidité NTU", "IBU", "Densité"], 1, "Standard trouble international."),
      q("Un trouble > 50 NTU est-il acceptable?", ["Excellent", "Inacceptable", "Bon", "Moyen"], 1, "> 50 NTU rejeté."),
      q("Quel type de liaisons forment le complexe protéine-polyphénol?", ["Hydrogène faible", "Liaisons covalentes fortes", "Électrostatique", "Aucune"], 1, "Liaisons chimiques stables."),
      q("À quelle température la protéase agit?", ["20–30°C", "~50°C hydrolyse", "75–80°C", "> 95°C"], 1, "~50°C les protéases sont actives."),
      q("Les colloïdes ont quelle consistance?", ["Liquide cristallin", "Suspension opaque", "Gaz vapeur", "Solide"], 1, "Suspension colloïdale opaque."),
      q("Quel instrument mesure NTU?", ["Goût par panel", "Spectrophotomètre à 90°", "Odeur", "Œil"], 1, "Spectrophotomètre est l'instrument."),
      q("La casse protéine-tannin est-elle souhaitable?", ["Jamais", "Chauffage ~70°C clarification", "Fermentation", "Froid"], 1, "70°C ébullition clarification."),
      q("Quelle est l'apparence d'une bière sans trouble?", ["Trouble opaque", "Cristallin et transparent", "Blanc laiteux", "Brunâtre"], 1, "Cristallin transparent."),
      q("Qu'est-ce que l'hordéine?", ["Sucre", "Protéine du malt de type gluten", "Enzyme", "Lipide"], 1, "Protéine du grain d'orge."),
      q("Quelle est la taille des macromolécules colloïdales?", ["< 1 nm", "1–100 nm micron", "> 1 mm", "Invisible"], 1, "Taille colloïdale nanoparticules."),
      q("La casse chaude est-elle bénéfique?", ["Non problème", "Oui clarification souhaitable", "Rarement", "Jamais"], 1, "Oui clarification bénéfique."),
      q("La turbidité affecte-t-elle le goût?", ["Zéro impact", "Saveur astringente désagréable", "Améliore", "Indifférent"], 1, "Astringence sensation négative."),
      q("Comment se forment les complexes?", ["Oxydation simple", "Liaisons polyphénol-protéine par chauffage", "Fermentation levure", "Dilution eau"], 1, "Liaisons chimiques formation."),
      q("Les colloïdes légères sont-elles visibles?", ["Très visible trouble", "Invisible cristallin", "Partiellement légèrement", "Blanc opaque"], 1, "Invisible bière claire."),
      q("Pourquoi mesure-t-on à 90°?", ["Angle standard meilleure sensibilité", "Angle arbitraire", "Zéro raison", "Meilleur prix"], 1, "Standard meilleure sensibilité angle."),
      q("Quelle est la source principale de tannin?", ["Levure fermentation", "Pellicule du malt et résine du houblon", "Sucre ajouté", "Minéraux de l'eau"], 1, "Malt et houblon sources tannins."),
      q("Quand se produit la casse froide?", ["Pendant l'ébullition", "Refroidissement ~5°C", "Après fermentation", "Stockage chaud"], 1, "Refroidissement à température basse."),
      q("Comment se stabilisent les colloïdes?", ["Spontanément", "Protéines viscoélastiques stabilisent les bulles", "Sucres seul", "Zéro stabilisation"], 1, "Protéines stabilisent les suspensions.")
    ]
  },
    // ...objet supprimé: formeHoublon
  {
    id: "orgeVarietes",
    category: "MALT",
    title: "3. Variétés d'orge (2RP/6RW)",
    ficheRich: [
      { title: "Orge à 2 Rangées (2RP - Spring Barley / Printemps)", items: [
        "**Saison de semis**: Semée au **printemps** (mars-avril), récoltée en été. Cycle court de croissance.",
        "**Caractéristiques**: Le grain est plus gros, mieux rempli d'amidon, ce qui se traduit par un **rendement en extrait plus élevé**. La teneur en protéines est naturellement **plus faible** (bas Azote), menant à un meilleur contrôle du IK et une meilleure clarté.",
        "**Usage**: C'est l'orge standard pour le maltage en Europe et la fabrication de bières où la saveur maltée fine et la clarté sont recherchées (Pils, Lager, Pale Ale)."
      ]},
      { title: "Orge à 6 Rangées (6RW - Winter Barley / Hiver)", items: [
        "**Saison de semis**: Semée en **automne/hiver** (octobre-novembre), récoltée au printemps suivant. Cycle plus long.",
        "**Caractéristiques**: Le grain est plus petit, mais la plante produit **davantage d'enzymes** (Diastasique Power très élevé). La teneur en protéines est généralement **plus élevée** (haut Azote). Les enveloppes sont plus épaisses.",
        "**Usage**: Indispensable lors de l'utilisation d'**adjoints non maltés** (riz, maïs, blé cru) dans la recette. Le surplus d'enzymes qu'elle fournit permet de compenser le manque de pouvoir diastasique de ces adjoints. Les pailles plus épaisses sont aussi bénéfiques pour la filtration."
      ]},
      { title: "Relation Modification/Enzymes", items: [
        "Les malts 2RP sont souvent naturellement mieux modifiés que les 6RW, car le grain est plus homogène. L'orge 6RW nécessite souvent des ajustements de palier protéinique pour gérer son taux d'azote plus élevé et sa dégradation protéique."
      ]}
    ],
    questions: [
      q("L'orge 2 rangées (2RP) contient quoi comparé à la 6RW?", ["Plus de protéines et moins d'amidon", "Moins de protéines et plus d'amidon", "Plus d'enzymes disponibles", "Moins d'amidon exploitable"], 1, "2RP favorise l'extrait amylacé (plus d'amidon, moins d'azote)."),
      q("L'orge 6 rangées (6RW) est idéale pour quoi?", ["Convertir les adjoints non maltés", "Fermenter à très basse T", "Brasser sans houblon", "Acidifier le moût"], 0, "L'excès d'enzymes de la 6RW permet de convertir riz, maïs, etc."),
      q("Quelle est la caractéristique de l'enveloppe de la 6RW?", ["Fine et fragile", "Épaisse et filtrante", "Moyennement épaisse", "Toujours identique"], 1, "Enveloppe épaisse = avantage pour la filtration du moût."),
      q("Quelle est la taille des grains de l'orge 2RP?", ["Plutôt petits", "Grains larges et remplis", "Taille moyenne", "Très variables"], 1, "Grains plus gros = plus d'amidon stocké."),
      q("Quel est le rendement en extrait de l'orge 2RP?", ["Plutôt faible", "Intermédiaire", "Élevé", "Inconstant"], 2, "Grain bien rempli = rendement élevé."),
      q("Quelle est la teneur en azote de la 6RW?", ["Plutôt basse", "Modérée", "Élevée", "Exceptionnelle"], 2, "Teneur en protéines (azote) élevée dans la 6RW."),
      q("Quelle est la production enzymatique de la 6RW?", ["Limitée", "Standard", "Haute", "Très haute"], 3, "Production enzymatique très élevée, essentielle pour les adjuvants."),
      q("La clarté de la bière avec l'orge 2RP est comment?", ["Voile marqué", "Bonne clarté naturelle", "Toujours cristalline", "Très variable"], 1, "Faible teneur en protéines = meilleure clarté."),
      q("La modification du grain de la 6RW est comment?", ["Rapide et régulière", "Très lente", "Standard", "Plus hétérogène"], 3, "Grain plus hétérogène = modification variable."),
      q("Le palier protéinique est-il nécessaire avec la 6RW?", ["Jamais nécessaire", "Optionnel uniquement", "Souvent recommandé", "Toujours critique"], 2, "Recommandé pour gérer la haute teneur en azote."),
      q("L'orge 2RP est typiquement utilisée pour quel style?", ["IPA uniquement", "Pilsner et Lager principalement", "Stout uniquement", "Porter uniquement"], 1, "2RP = base traditionnelle des lagers européennes."),
      q("Quels adjuvants sont typiques avec la 6RW?", ["Seigle cru", "Riz et maïs", "Blé malté", "Avoine roulée"], 1, "Riz et maïs = céréales non maltées classiques."),
      q("L'indice de Kolbach de la 2RP est comment?", ["Généralement bas", "Plutôt idéal", "Très haut", "Totalement variable"], 1, "Modification naturelle idéale de la 2RP."),
      q("L'indice de Kolbach de la 6RW est comment?", ["Faible", "Idéal", "Souvent élevé", "Toujours constant"], 2, "Protéolyse souvent prononcée."),
      q("L'orge 2RP est semée à quelle saison?", ["Printemps (barley de printemps)", "Automne", "Hiver", "Été"], 0, "2-row spring barley = semée au printemps."),
      q("Saison 6RW…", ["Printemps", "Automne", "Hiver", "Été"], 2, "6-row Winter."),
      q("2RP/6RW impact recette…", ["Couleur finale", "Profil de saveur", "Fermentescibilité et enzymes", "IBU cible"], 2, "Profil moût."),
      q("Homogénéité 2RP…", ["Hétérogène", "Plutôt homogène", "Toujours parfaite", "Extrêmement variable"], 1, "Grain uniforme."),
      q("Homogénéité 6RW…", ["Moins homogène", "Très homogène", "Parfaitement régulière", "Identique à 2RP"], 0, "Moins uniforme."),
      q("Rendement final 2RP…", ["Autour de 65%", "Autour de 70%", "Autour de 75%", "Autour de 80%"], 3, "Environ comparatif."),
      q("Densité grain 2RP…", ["Très léger", "Intermédiaire", "Plutôt dense", "Extrêmement dense"], 2, "Grain rempli amidon."),
      q("Sélection orge brasseur…", ["Uniquement pour le pH", "Uniquement pour le style", "Plan d'adjoints/enzymes", "Toujours sans critère"], 2, "Paramètres."),
      q("2RP pour Pale Ale?", ["Non recommandé", "Très bon choix", "Choix moyen", "Jamais pertinent"], 1, "2RP idéal Pale Ale."),
      q("6RW coût production?", ["Plutôt moins cher", "Plus coûteux", "Identique partout", "Toujours variable"], 0, "Rendement moindre mais enzyme élevée."),
      q("2RP protéines brassage?", ["Demande un long palier", "Palier court ou inutile", "Palier très complexe", "Palier impossible"], 1, "Faible protéines = simple."),
      q("6RW filtration avantage?", ["Enveloppes épaisses formant le lit", "Filtration instantanée", "Aucun avantage particulier", "Filtration plus lente"], 0, "Pailles épaisses aident filtration."),
      q("Usage 2RP moderne?", ["Plutôt rare", "Standard mondial actuel", "Obsolète", "Purement régional"], 1, "2RP = standard actuel."),
      q("6RW adjunct beer type?", ["Light Lager américaine", "IPA fortement houblonnée", "Stout torréfié", "Bière acide"], 0, "Riz/maïs Light Lager."),
      q("Conversion enzyme 2RP?", ["Suffit pour un mash tout-malt", "Toujours insuffisante", "Très faible", "Nulle"], 0, "2RP suffit pour tout-malt."),
      q("Température maltage 2RP vs 6RW?", ["2RP beaucoup plus basse", "Globalement similaire", "6RW nettement plus basse", "Toujours différente"], 1, "Paramètres similaires.")
    ]
  },
  {
    id: "maillardMelanoidines",
    category: "MALT",
    title: "4. Réactions de Maillard et mélanoïdines",
    ficheRich: [
      { title: "Chimie de la Réaction", items: [
        "**Définition**: C'est une réaction de **brunissement non enzymatique** fondamentale. Elle implique la condensation entre le **groupement carbonyle** (C=O) d'un **sucre réducteur** (glucose, maltose, xylose) et le **groupement aminé** (NH2) d'un acide aminé ou d'une protéine.",
        "**Note importante sur les sucres**: Seuls les **sucres réducteurs** (avec carbonyle libre) participent à la réaction. Le **saccharose** (sucre de table) n'est PAS un sucre réducteur car son carbonyle est bloqué dans la liaison glycosidique, donc il ne réagit PAS dans Maillard.",
        "**Conditions**: Accélérée par la **chaleur** (touraillage, ébullition), un **pH élevé** et une faible teneur en eau (faible activité de l'eau).",
        "**Températures de touraillage**: Pale malt 80–85°C (légère réaction), Munich 85–105°C (modérée, mélanoïdines), Malts foncés/torréfiés 120–150°C (réaction intense = couleur sombre et arômes café/cacao prononcés).",
        "**Étapes Clés**: 1) Condensation → 2) Réarrangement d'Amadori → 3) Dégradations (fragmentation des sucres) → 4) Dégradation de Strecker (production d'aldéhydes aromatiques) → 5) Polymérisation."
      ]},
      { title: "Produits et Impacts", items: [
        "**Couleur (EBC)**: La polymérisation finale produit des pigments bruns foncés appelés **Mélanoïdines**.",
        "**Arômes/Saveurs**: La fragmentation et la dégradation de Strecker créent des arômes de **malt, pain grillé, caramel, toffee** et de **cacao/café** (selon l'intensité de la chaleur).",
        "**Mélanoïdines**: Ces polymères de haute masse moléculaire sont essentiels pour le **corps** et la **sensation en bouche** des bières maltées (Bock, Munich Dunkel). Elles agissent aussi comme de puissants **antioxydants**.",
        "**Consommation de FAN**: La réaction consomme des acides aminés libres (FAN), diminuant la quantité de nutriments pour la levure, surtout si la réaction est très intense (longue ébullition ou malts très torréfiés)."
      ]}
    ],
    questions: [
      q("Entre quels composants se produit la réaction de Maillard?", ["Amidon et CO2", "Sucres réducteurs et acides aminés", "Eau et houblon", "Enzymes et pH"], 1, "Réaction chimique essentielle au développement des saveurs maltées."),
      q("Les mélanoïdines apportent principalement quoi?", ["Amertume franche", "Couleur brune et corps", "Acidité marquée", "Viscosité seule"], 1, "Mélanoïdines = couleur profonde + sensation en bouche."),
      q("Quelle est la première étape de la réaction de Maillard?", ["Condensation sucre + amine", "Réarrangement d'Amadori", "Fragmentation des sucres", "Polymérisation finale"], 0, "Condensation entre carbonyle du sucre et amine."),
      q("Le réarrangement d'Amadori est quelle étape?", ["Étape initiale", "Deuxième étape", "Troisième étape", "Étape finale"], 1, "Deuxième étape après la condensation initiale."),
      q("La réaction de Maillard est accélérée par quoi?", ["Refroidissement", "Humidité élevée seulement", "Chaleur + pH élevé + faible eau", "Ajout d'alcool"], 2, "Conditions optimales : chaleur, pH basique, faible eau."),
      q("Que produit la fragmentation des sucres dans Maillard?", ["Simple glucose", "Aldéhydes aromatiques (Strecker)", "Hydrolyse sans arômes", "Fermentation"], 1, "Dégradation de Strecker crée des aldéhydes aromatiques."),
      q("Quel est le résultat final sur l'échelle EBC de la réaction de Maillard?", ["Couleur très pâle", "Couleur ambrée", "Couleur brun foncé à noire", "Aucune coloration"], 2, "Pigments polymérisés = brun foncé."),
      q("Quels arômes développe la réaction de Maillard lors du touraillage?", ["Sucre neutre", "Malt, pain grillé, caramel, cacao", "Acide lactique", "Floral léger"], 1, "Profil aromatique typique du malt torréfié."),
      q("Quelle est la masse moléculaire des mélanoïdines?", ["Faible", "Élevée (polymères)", "Intermédiaire", "Très variable"], 1, "Polymères de haute masse moléculaire."),
      q("Les mélanoïdines agissent comme quoi?", ["Houblons de substitution", "Levures sauvages", "Antioxydants naturels", "Sources d'enzymes"], 2, "Défense contre le vieillissement oxydatif."),
      q("FAN consommé par Maillard…", ["Quasi aucun", "Faiblement", "Modérément", "Beaucoup"], 3, "Limite nutriment levure."),
      q("Intensité Maillard…", ["Faible à basse T courte", "Forte à haute T prolongée", "Seulement selon le sucre", "Seulement selon l'eau"], 1, "Paramètres."),
      q("Couleur EBC Pils…", ["5–10 EBC clair", "15–25 EBC ambre", "30–40 EBC brun", "50+ EBC noir"], 0, "Pale typical."),
      q("Couleur EBC Munich…", ["5–10 EBC clair", "20–40 EBC ambré", "50–70 EBC brun", "80+ EBC noir"], 1, "Foncé mélanoïdines."),
      q("Polymérisation finale…", ["Troisième étape", "Quatrième étape", "Cinquième étape", "Sixième étape"], 2, "Dernier stade."),
      q("Condensation sucre-amino…", ["Hydrolyse simple", "Formation d'hémiacétal", "Formation d'un aldéhyde lié", "Réaction avec amine"], 2, "Type réaction."),
      q("Perte eau Maillard…", ["Accélère la réaction", "Ralentit la réaction", "N'influe pas", "Inverse la réaction"], 0, "Eau basse = Maillard ↑"),
      q("Caféine dans Maillard…", ["Créée par Maillard", "Détruite par Maillard", "Peu impactée", "Transformée"], 2, "Non pertinent."),
      q("Saveur toffee/caramel…", ["Provenant des sucres simples", "Provenant des mélanoïdines", "Provenant des houblons", "Provenant des levures"], 1, "Polymères colorés."),
      q("Bock/Munich Dunkel…", ["Profil Maillard faible", "Profil Maillard intense", "Profil Maillard moyen", "Aucun Maillard"], 1, "Malt foncé."),
      q("Maillard vs Caramélisation…", ["Processus identiques", "Processus distincts", "Même résultat exact", "Processus inverses"], 1, "Réactions distinctes."),
      q("Température touraillage Maillard?", ["40–60°C très faible", "80–100°C modérée", "120–150°C intense", "200°C et plus"], 2, "Haute T = Maillard intense."),
      q("pH optimal Maillard?", ["Acide <5", "Neutre ≈7", "Basique >8", "Très acide <3"], 2, "pH élevé accélère."),
      q("Sucre non réducteur Maillard?", ["Glucose réagit", "Saccharose ne réagit pas", "Maltose réagit", "Fructose réagit"], 1, "Saccharose pas carbonyle libre."),
      q("Acide aminé essentiel Maillard?", ["Tous équivalents", "Lysine très réactive", "Aucun ne réagit", "Tryptophane seul"], 1, "Lysine réactive."),
      q("Temps ébullition impact?", ["Aucun effet", "Plus long = plus de Maillard", "Plus court = meilleur", "Effet neutre"], 1, "Temps = intensité."),
      q("Mélanoïdines stabilité?", ["Très instables", "Polymères assez stables", "Fragiles", "Réversibles facilement"], 1, "Polymères stables."),
      q("Corps bière mélanoïdines?", ["Sensation très légère", "Corps rond et plein", "Texture aqueuse", "Gaz ajouté"], 1, "Sensation bouche."),
      q("Maillard arrêt réaction?", ["Refroidissement rapide", "pH abaissé", "Dilution massive", "Tous ces facteurs"], 0, "Froid stoppe."),
      q("Couleur finale dépend?", ["Temps + température + pH", "Choix du houblon", "Souche de levure", "Minéraux seuls"], 0, "Paramètres Maillard.")
    ]
  },
  {
    id: "enzymesPalier",
    category: "MALT",
    title: "5. Enzymes et paliers d'empâtage",
    ficheRich: [
      { 
        title: "Bêta-Amylase (β-Amylase)", 
        items: [
          "**Température optimale** : 60-65°C (zone fermentescibilité)",
          "**pH optimal** : 5,4-5,6",
          "**Action** : Coupe l'amidon par les extrémités (exo-enzyme), liaisons α-1,4",
          "**Produit** : Maltose (disaccharide fermentescible), 50-70% des sucres",
          "**Thermolabilité** : Détruite au-dessus de 70°C",
          "**Impact** : Basse température (62-65°C) = bière sèche et alcoolisée"
        ]
      },
      { 
        title: "Alpha-Amylase (α-Amylase)", 
        items: [
          "**Température optimale** : 68-75°C (zone dextrinisation)",
          "**pH optimal** : 5,6-5,8",
          "**Action** : Coupe l'amidon aléatoirement à l'intérieur (endo-enzyme)",
          "**Produit** : Dextrines (non fermentescibles), maltotriose, maltose",
          "**Thermostabilité** : Résiste jusqu'à 75-78°C",
          "**Cofacteur** : Nécessite Ca²⁺ pour stabilité",
          "**Impact** : Haute température (70-73°C) = bière avec corps et douceur"
        ]
      },
      { 
        title: "Paliers de saccharification", 
        items: [
          "**Palier Bêta (62-65°C)** : Favorise maltose → bière sèche, fermentescible (75-85% atténuation)",
          "**Palier Alpha (70-73°C)** : Favorise dextrines → bière douce, corps plein (65-75% atténuation)",
          "**Monopalier (66-68°C)** : Compromis équilibré, standard moderne (70-78% atténuation)",
          "**Durée standard** : 60 min pour conversion complète",
          "**Test d'iode** : Noir-bleu = amidon résiduel, jaune = conversion OK"
        ]
      },
      { 
        title: "Palier protéinique (50-55°C)", 
        items: [
          "**Enzymes** : Protéases et peptidases actives",
          "**Objectif** : Augmenter FAN (nutrition levure), dégrader β-glucanes",
          "**Durée** : 15-30 min (court = ↑FAN, long = ↓mousse)",
          "**Utilité** : Malts sous-modifiés, adjuvants (blé, avoine, seigle)",
          "**Malts modernes** : Souvent inutile (si Kolbach > 42%)",
          "**Risque** : Trop long détruit protéines de mousse"
        ]
      },
      { 
        title: "Autres paliers", 
        items: [
          "**Mash-out (75-78°C)** : Arrêt enzymatique, améliore filtration (5-10 min, optionnel)",
          "**Décoction (méthode traditionnelle allemande)** : Technique où une portion (30-40%) de la maische est retirée, portée à ébullition (100°C) pendant 10-20 min, puis réincorporée pour augmenter la température du reste. **Avantages** : Maximise l'extraction avec malts sous-modifiés, développe arômes maltés intenses par réaction de Maillard pendant l'ébullition. **Usage moderne** : Optionnel avec malts bien modifiés d'aujourd'hui, principalement utilisé pour styles traditionnels (Bock, Doppelbock, Pilsner tchèque) ou pour authenticité historique.",
          "**Palier β-glucanes (40-45°C)** : Réduit viscosité, améliore filtration (rare, malts bien modifiés)",
          "**Palier acide (35-45°C)** : Acidification par phytase (obsolète, remplacé par acide lactique)"
        ]
      },
      { 
        title: "Facteurs clés", 
        items: [
          "**Température** : Principal facteur, chaque enzyme a un optimum étroit",
          "**pH** : 5,2-5,6 optimal, > 6,0 réduit activité drastiquement",
          "**Temps** : 90% conversion en 30 min, 95% en 60 min",
          "**Ratio eau/grain** : Épais (2,5-3 L/kg) = rapide, dilué (3,5-4 L/kg) = lent",
          "**Calcium** : Essentiel pour α-amylase, stabilise enzymes"
        ]
      },
      { 
        title: "Exemples programmes selon styles", 
        items: [
          "**Pilsner/IPA (sèche)** : 63-64°C/60min",
          "**Pale Ale (équilibrée)** : 67°C/60min (monopalier)",
          "**Stout (corps)** : 70°C/60min",
          "**Weizen (blé)** : 45°C/15min → 63°C/40min → 72°C/20min",
          "**Standard moderne** : Monopalier 66-67°C/60min convient 90% des recettes"
        ]
      }
    ],
    questions: [
      q("La bêta-amylase produit majoritairement quel sucre?", ["Dextrines résiduelles", "Maltose fermentescible", "Glucose libre", "Amidon intact"], 1, "Le maltose est le principal sucre fermentescible produit."),
      q("La plage de température 68-75°C favorise quelle enzyme?", ["Bière très sèche", "Alpha-amylase pour le corps", "Palier protéinique", "Extraction d'amertume"], 1, "L'alpha-amylase crée des dextrines pour le corps."),
      q("Quelle est la température optimale de la bêta-amylase?", ["50–55°C", "60–65°C", "70–75°C", "80–85°C"], 1, "Température optimale d'activité bêta-amylase."),
      q("Quelle est la température optimale de l'alpha-amylase?", ["50–55°C", "60–65°C", "68–75°C", "80–90°C"], 2, "Température supérieure à la bêta-amylase."),
      q("À quelle température la bêta-amylase est-elle détruite?", ["Autour de 60°C", "Autour de 65°C", "Au-delà de 70°C", "Vers 80°C"], 2, "Thermolabilité : détruite au-dessus de 70°C."),
      q("L'alpha-amylase a quelle thermostabilité?", ["Très fragile", "Fragile", "Assez résistante", "Quasi indestructible"], 2, "Elle survit plus longtemps que la bêta-amylase."),
      q("Comment la bêta-amylase coupe-t-elle l'amidon?", ["Coupures internes aléatoires", "Coupures par les extrémités", "Coupures multiples aléatoires", "Coupures sur les lipides"], 1, "Coupure spécifique par les extrémités de la chaîne."),
      q("Les dextrines sont-elles fermentescibles?", ["Entièrement fermentées", "Non fermentées par levures classiques", "Fermentées partiellement", "Toujours selon la levure"], 1, "Les dextrines apportent le corps et la douceur résiduelle."),
      q("Le palier bêta (62–65°C) donne quel profil de bière?", ["Bière sèche et plus alcoolisée", "Bière avec douceur et corps", "Bière très équilibrée", "Bière acide"], 0, "Beaucoup de maltose = bière sèche et alcoolisée."),
      q("Le palier alpha (70–73°C) donne quel profil?", ["Bière très sèche", "Bière ronde avec douceur résiduelle", "Bière neutre", "Bière très acide"], 1, "Beaucoup de dextrines = corps et rondeur."),
      q("Un monopalier (66–68°C) donne quel résultat?", ["Profil très sec", "Profil très doux", "Profil équilibré", "Profil acide"], 2, "Compromis entre corps et fermentescibilité."),
      q("Quelle est la température du palier protéinique?", ["30–40°C", "50–55°C pour les protéases", "60–65°C", "70–75°C"], 1, "50–55°C pour activer les protéases et peptidases."),
      q("Quel est le rôle des protéases et peptidases?", ["Créer de l'amidon", "Découper les protéines en peptides", "Hydrolyser les graisses", "Oxydation des polyphénols"], 1, "Conversion de haut poids moléculaire vers bas poids."),
      q("Les β-glucanes sont dégradés par quelle enzyme?", ["Amylase", "Protéase", "Glucanase dédiée", "Lipase"], 2, "Enzyme spécifique pour les bêta-glucanes."),
      q("Dans quel palier augmente-t-on le FAN?", ["Palier bêta", "Palier alpha", "Palier protéinique 50–55°C", "Monopalier"], 2, "Libération des acides aminés libres."),
      q("Palier Protéinique long…", ["Renforce la mousse", "Réduit la tenue de mousse", "N'influence pas", "Améliore seulement la clarté"], 1, "Dégrade protéines structures."),
      q("Palier 52°C typique durée…", ["5–10 min", "15–30 min", "45–60 min", "90+ min"], 1, "Standard industrie."),
      q("Saccharification optim pH…", ["5.0–5.2", "5.4–5.6", "6.0–6.2", "6.5–6.8"], 1, "Amylases."),
      q("pH > 6.0 sur amylases…", ["Augmente l'activité", "Réduit fortement l'activité", "Neutre", "Inactive totalement"], 1, "Enzyme sensibilité."),
      q("Enzyme dénatur T…", ["55°C", "65°C", "75°C", "Au-delà de 85°C"], 3, "Destruction totale."),
      q("Iode test amidon…", ["Mesure les sucres", "Indique l'amidon résiduel", "Mesure les protéines", "Mesure la levure"], 1, "Vérification."),
      q("Conversion amidon efficacité…", ["Dépend du palier", "Dépend de la température", "Dépend du temps", "Dépend de tous ces facteurs"], 3, "Paramètres."),
      q("Limite dextrinisation Alpha-Amylase?", ["20% environ", "30% environ", "40% limité par ramifications", "100% complet"], 2, "Branches alpha-1,6 résistent."),
      q("Mash-out température?", ["70°C", "75–78°C pour arrêter", "85°C", "95°C"], 1, "Stop conversion."),
      q("Temps palier Bêta optimal?", ["10–20 min", "30–45 min", "60–90 min complet", "120+ min"], 2, "Extraction maltose."),
      q("Palier acid rest 40–45°C?", ["Augmente le pH", "Réduit le pH via phytase", "Effet neutre", "Détruit les enzymes"], 1, "Acidification naturelle."),
      q("Ratio eau/grain impact?", ["Aucun impact", "Maische épaisse = enzymes concentrées", "Maische diluée = meilleur", "Impact négligeable"], 1, "Concentration enzyme."),
      q("Decoction bénéfice?", ["Extraction max sur malt sous-modifié", "Procédé plus rapide", "Toujours moins cher", "Option purement moderne"], 0, "Méthode traditionnelle."),
      q("Enzyme endogène vs exogène?", ["Issue du malt vs ajoutée", "Strictement identiques", "Levure vs malt", "Bactérie vs levure"], 0, "Source enzyme."),
      q("Paliers multiples nécessité?", ["Toujours nécessaires", "Souvent inutiles avec malt bien modifié", "Jamais utiles", "Toujours optimaux"], 1, "Moderne skip possible.")
    ]
  },
  {
    id: "sucres",
    category: "GÉNÉRAL",
    title: "6. Sucres (amidon, candi, miel…)",
    ficheRich: [
      { title: "Sucres Issus du Maltage et Structure", items: [
        "**Amidon**: Polymère de glucose, composé d'**Amylose** (chaînes linéaires) et d'**Amylopectine** (chaînes ramifiées, majoritaires). C'est la source énergétique principale du moût.",
        "**Maltose**: Disaccharide (glucose-glucose) très facilement fermentescible. Il représente 50-70 % des sucres totaux après une saccharification typique.",
        "**Maltotriose**: Trisaccharide, plus long, fermenté plus lentement que le Maltose par Saccharomyces cerevisiae. Sa consommation influence la densité finale.",
        "**Dextrines**: Polysaccharides de plus de 3 molécules de glucose. Non fermentescibles par les levures de bière classiques, elles sont vitales pour le **corps, la viscosité et la douceur** résiduelle."
      ]},
      { title: "Sucres d'Adjonction (Adjuvants)", items: [
        "**Sucre de Candi / Saccharose**: Sucre de table (glucose-fructose). Il est presque 100 % fermentescible. Son ajout est souvent fait à l'ébullition pour **augmenter la densité initiale (DI)** sans ajouter de corps, ce qui conduit à une bière **sèche et alcoolisée** (typique des Dubbel/Tripel belges).",
        "**Dextrose / Glucose**: Sucre simple (monosaccharide), immédiatement fermentescible par la levure. Il est couramment utilisé pour l'**embouteillage** (refermentation en bouteille).",
        "**Lactose**: Disaccharide (galactose-glucose) non fermentescible par Saccharomyces cerevisiae (manque de l'enzyme bêta-galactosidase). Il est utilisé pour apporter une **douceur non alcoolique** et du corps (Sweet Stout, Milk Stout)."
      ]}
    ],
    questions: [
      q("Le sucre de candi sert à…", ["Baisser le pH", "Augmenter l'alcool sans alourdir le corps", "Épaissir la bière", "Clarifier le moût"], 1, "Il est presque totalement fermentescible, allégeant le corps."),
      q("Le lactose est ajouté pour…", ["↑ FAN", "Amertume", "Corps et Douceur", "Couleur"], 2, "Il est non fermentescible et apporte de la douceur."),
      q("Quelle est la composition de l'amidon?", ["Amylose (linéaire) + Amylopectine (ramifiée)", "Glucose seul", "Maltose uniquement", "Dextrine simple"], 0, "Deux composants structuraux de l'amidon."),
      q("Quelle est la structure de l'amylose?", ["Chaîne ramifiée", "Chaîne linéaire de glucose", "Structure cyclique", "Structure aléatoire"], 1, "Chaînes linéaires de glucose."),
      q("Quelle est la structure de l'amylopectine?", ["Chaîne ramifiée (majoritaire dans l'amidon)", "Chaîne linéaire", "Structure cyclique", "Hélice"], 0, "Chaînes ramifiées, composant majoritaire."),
      q("Quelle est la composition du maltose?", ["Glucose-Glucose (disaccharide)", "Glucose-Fructose", "Glucose-Galactose", "Glucose-Mannose"], 0, "Disaccharide formé de deux glucose."),
      q("Le maltotriose est composé de combien d'unités?", ["Deux unités (di-sucre)", "Trois unités de glucose (tri-sucre)", "Polysaccharide long", "Sucre simple"], 1, "Trois unités de glucose."),
      q("Les dextrines sont-elles fermentescibles?", ["100% fermentescibles", "50% fermentescibles", "0% (non fermentescibles)", "Dépend de la levure"], 2, "Les levures typiques ne fermentent pas les dextrines."),
      q("Le saccharose est composé de quoi?", ["Sucre de table complet", "Glucose + Fructose", "Glucose + Galactose", "Maltose"], 1, "Sucre de table classique."),
      q("Quel pourcentage du saccharose est fermentescible?", ["50%", "75%", "100% (complètement fermentescible)", "0%"], 2, "Fermentation complète par la levure."),
      q("Quel est l'impact du saccharose sur la bière?", ["Augmente le corps", "Neutre sur le corps / bière sèche finale", "Diminue le corps", "Astringence"], 1, "Augmente l'alcool sans ajouter de corps."),
      q("Le dextrose est égal à quoi?", ["Fructose", "Glucose (sucre simple)", "Saccharose", "Maltose"], 1, "Dextrose = glucose monosaccharide."),
      q("Dextrose usage…", ["Bouteille carbonatation", "Empâtage", "Refroidissement", "Whirlpool"], 0, "Embouteille standard."),
      q("Lactose source…", ["Maltage", "Levure", "Lait", "Amidon"], 2, "Sucre laitier."),
      q("Lactose enzyme…", ["β-galactosidase", "Sucrase", "Maltase", "Invertase"], 0, "Manquante à levure."),
      q("Lactose % douceur…", ["Léger", "Moyen", "Élevé", "Intense"], 2, "Moût + final."),
      q("Miel composition…", ["Glucose/Fructose", "Sucre pure", "Protéine", "Lipides"], 0, "Sucres majoritaires."),
      q("Miel brassage impact…", ["Stérilisation obligatoire", "Direct OK", "Refroidissement hygiène", "Pasteurisation"], 2, "Microbes naturels."),
      q("Sirop maïs HFCS…", ["Naturel", "Complètement artificiel", "Transformation maïs", "Synthèse chimique"], 2, "Glucose/Fructose."),
      q("Sucres adjoint % total…", ["1–5%", "5–15%", "15–30%", "30–50%"], 2, "Variabilité brasseur."),
      q("Densité finale faible…", ["Sucres non-fermentescibles bas", "Fermentation trop sèche", "Malt faible", "Tous"], 1, "Profil sec."),
      q("Densité finale élevée…", ["Dextrines résiduelles", "Lactose/Sucre non-ferment", "Sucres insuffisant consommés", "Tous"], 3, "Douceur reste."),
      q("Invert sugar avantage?", ["Moins cher", "Fermentation rapide prédigéré", "Plus sucré", "Couleur"], 1, "Glucose+fructose séparés."),
      q("Candi belge couleur?", ["Blanc clair", "Ambre caramélisé", "Noir foncé", "Tous"], 3, "Variétés multiples."),
      q("Turbinado/Demerara?", ["Sucre raffiné", "Sucre brut mélasse résiduelle", "Sucre artificiel", "Édulcorant"], 1, "Moins raffiné."),
      q("Mélasse ajout?", ["Couleur + saveur forte", "Neutre", "Clarification", "Houblon substitute"], 0, "Saveur profonde."),
      q("Honey malt?", ["Malt au miel", "Malt caramel saveur miel", "Miel cristallisé", "Aucun"], 1, "Type spécialité."),
      q("Adjuncts % maximum safe?", ["10%", "20%", "40% fermentescibilité OK", "80%"], 2, "Équilibre important."),
      q("Carapils/Dextrine malt?", ["Fermentescible", "Corps sans fermentation", "Sucré", "Amer"], 1, "Dextrines ajoutées."),
      q("Treacle britannique?", ["Mélasse sombre", "Sucre blanc", "Miel", "Sirop érable"], 0, "Saveur intense stout.")
    ]
  },
  {
    id: "gluten",
    category: "GÉNÉRAL",
    title: "7. Gluten et bières sans gluten",
    ficheRich: [
      { title: "Chimie et Pathologie", items: [
        "**Gluten**: Complexe protéique composé de **gluélinines** (élasticité) et de **prolamines** (viscosité). Dans l'orge, la prolamine est la **Hordéine**.",
        "**Impact Brassicole**: Les protéines du gluten et ses précurseurs (polypeptides) jouent un rôle majeur dans la **formation et la stabilité de la mousse** et le corps de la bière.",
        "**Cœliaque**: La maladie est déclenchée par la réponse immunitaire à certains fragments peptidiques du gluten. Le seuil légal de sécurité pour la certification 'sans gluten' est de **moins de 20 ppm** (20 mg/kg) en Europe et au Canada."
      ]},
      { title: "Méthodes de Production", items: [
        "**Méthode 1: Céréales sans gluten**: Utilisation de céréales alternatives comme le millet, le riz, le maïs, le sorgho, ou le sarrasin (qui est une pseudocéréale). Ces bières ont un profil de saveur différent et une tenue de mousse souvent inférieure.",
        "**Méthode 2: Dé-glutéinisation**: Brassage avec du malt d'orge conventionnel, puis ajout d'une enzyme, souvent la **Prolyl Endopeptidase (PE)** (nom commercial **Brewers Clarex®**), en début de fermentation.",
        "**Rôle de l'enzyme**: La PE coupe spécifiquement les liaisons peptidiques contenant des prolines. Elle fragmente les grosses protéines de gluten en très petits fragments qui ne sont plus reconnus par le système immunitaire des cœliaques (sous le seuil de 20 ppm).",
        "**Vérification**: La conformité au < 20 ppm doit être confirmée par la méthode d'analyse **ELISA** R5 (Enzyme-Linked Immunosorbent Assay) validée."
      ]}
    ],
    questions: [
      q("Le seuil de certification 'sans gluten' est de…", ["100 ppm", "20 ppm", "5 ppm", "50 ppm"], 1, "20 ppm est le seuil légal en Europe."),
      q("L'enzyme Brewers Clarex® sert à…", ["Augmenter l'IBU", "Dégrader le gluten", "Réduire la couleur", "Augmenter la viscosité"], 1, "C'est une enzyme utilisée pour réduire la teneur en gluten."),
      q("Quelle est la différence entre gluélines et prolamines?", ["Ce sont identiques", "Élasticité vs Viscosité (composants du gluten)", "Sucre vs Protéine", "Enzyme vs Inhibiteur"], 1, "Deux composants complémentaires du gluten."),
      q("L'hordéine est quoi exactement?", ["Gluten du blé", "Prolamine spécifique de l'orge", "Gluten du seigle", "Protéine de l'avoine"], 1, "Protéine clé de l'orge responsable du gluten."),
      q("Quel est l'impact du gluten sur la mousse?", ["Réduit la mousse", "Amplifie la stabilité de la mousse", "Effet neutre", "Détruit la mousse"], 1, "Protéines structurelles stabilisent les bulles."),
      q("Quelle est la cause de la maladie cœliaque?", ["Infection par levure sauvage", "Réaction immunitaire aux fragments peptidiques du gluten", "Mycotoxines", "Alcool trop élevé"], 1, "Réponse immunitaire anormale au gluten."),
      q("Quelles céréales pour bière sans gluten?", ["Orge modifiée", "Riz / Maïs / Sorgho / Millet", "Blé à gluten réduit", "Extrait de malt"], 1, "Céréales alternatives naturellement sans gluten."),
      q("Pseudocéréales sans gluten…", ["Riz", "Maïs", "Sarrasin", "Avoine"], 2, "Pas vraies céréales."),
      q("Bière sans gluten saveur…", ["Identique", "Différente/Mousse faible", "Sucrée", "Amère"], 1, "Profil distinct."),
      q("Prolyl Endopeptidase (PE) cible…", ["Amidon", "Protéines prolines", "Lipides", "Minéraux"], 1, "Liaisons spécifiques."),
      q("PE coupe liaison…", ["N-N", "Proline-spécifique", "C-C", "S-S"], 1, "Peptidique proline."),
      q("Fragment peptide après PE…", ["Gros > 20ppm", "Petit < 20ppm", "Amidon", "Sucre"], 1, "Sous seuil."),
      q("PE activation…", ["Avant empâtage", "Début fermentation", "Après ébullition", "Fin maturation"], 1, "Fermentation active."),
      q("ELISA R5 test…", ["Goût", "Détecte gluten immunologique", "Coloration", "Densité"], 1, "Analyse validation."),
      q("Température PE optimale…", ["15-20°C (fermentation)", "37°C", "55°C", "80°C"], 0, "Température de fermentation, pas corporelle."),
      q("Céréales alternatives mousse…", ["Bonne", "Faible/Instable", "Excellente", "Variable"], 1, "Protéines moins."),
      q("Riz gluten…", ["Contient", "Zéro gluten naturel", "Trace only", "Élevé"], 1, "Naturellement sans."),
      q("Maïs gluten…", ["Contient trace", "Aucun", "Peu", "Élevé"], 1, "Naturellement sans."),
      q("Certification sans gluten…", ["Test simple", "ELISA R5 obligatoire", "Visuel", "Goût"], 1, "Analyse pointue."),
      q("Hordéine structure…", ["Chaîne linéaire", "Polymère complexe", "Sucre", "Lipide"], 1, "Protéine gluten."),
      q("Bière sans gluten brasserie…", ["Procédé identique", "Séparation ligne production", "Même équipement", "Sans précaution"], 1, "Contamination risque."),
      q("Dé-glutéinisation efficacité…", ["Partielle", "Complète < 20ppm", "Nulle", "80–90%"], 1, "Enzymatique."),
      q("Avoine gluten contenu?", ["Aucun naturel", "Trace pure non contaminée", "Élevé", "Modéré"], 1, "Contamination croisée risque."),
      q("Quinoa bière?", ["Céréale", "Pseudocéréale sans gluten", "Contient traces", "Impossible brasser"], 1, "Alternative valide."),
      q("Gluten extraction maltage?", ["Complet", "Partiel résidus", "Aucun", "Augmente"], 1, "Protéines persistent."),
      q("Bière gluten-reduced vs gluten-free?", ["Même", "Reduced > 20ppm, Free < 20ppm", "Inverse", "Marketing"], 1, "Distinction légale."),
      q("Brewers Clarex dosage?", ["1–3 g/hL", "5–10 g/hL", "15–20 g/hL", "Selon fabricant protocole"], 3, "Instructions spécifiques."),
      q("Ligne production contamination?", ["Négligeable", "Critique séparation absolue", "Rinçage suffit", "Optionnel"], 1, "Traces suffisent cœliaque."),
      q("PE origine enzyme?", ["Bactérie Aspergillus", "Levure", "Plante", "Synthèse"], 0, "Enzyme microbienne."),
      q("Test terrain gluten?", ["Kits rapides < fiables", "ELISA seul certifié", "Goût suffit", "Visuel"], 1, "Laboratoire requis.")
    ]
  },
  {
    id: "histoire",
    category: "GÉNÉRAL",
    title: "8. Histoire de la bière",
    ficheRich: [
      { title: "Antiquité : Bière Aliment et Fermentation Spontanée", items: [
        "**Mésopotamie (Sumer)**: Les plus anciennes preuves de brassage (4000 av. J.-C.) montrent une boisson épaisse, riche en nutriments, fermentée à partir de galettes d'orge. La bière était un aliment de base, souvent consommée à la paille pour éviter les résidus.",
        "**Égypte ancienne**: La bière (bouza) était cruciale. Le processus reposait entièrement sur le **microbiote ambiant** (levures sauvages et bactéries), d'où une qualité très variable et un goût souvent acide.",
        "**Innovation**: Le processus d'empâtage (mash) est une étape clé de l'histoire, permettant l'extraction des sucres fermentescibles."
      ]},
      { title: "Moyen Âge : Monastères et Houblon", items: [
        "**Gruit**: Le **Gruit** était le mélange d'herbes aromatiques utilisé avant le houblon (*Myrica gale*, Armoise, etc.). Il servait à masquer les défauts et à conférer de faibles propriétés de conservation.",
        "**Adoption du Houblon (XIIe - XIVe siècles)**: L'utilisation du *Humulus lupulus* s'est généralisée depuis les monastères allemands (Bavière). Le houblon a révolutionné la bière grâce à ses qualités aromatiques supérieures et, surtout, à ses propriétés **antibactériennes** (défense contre les bactéries lactiques et acétiques) et **antioxydantes**, améliorant la conservation."
      ]},
      { title: "L'Ère Moderne : Science et Industrie", items: [
        "**Reinheitsgebot (Édit de Pureté Bavarois, 1516)**: Décrété par le Duc Guillaume IV de Bavière, il stipulait que la bière ne devait être faite qu'avec l'**eau, le malt d'orge et le houblon**. Le but initial était d'assurer l'approvisionnement en blé pour le pain et de garantir une qualité minimale.",
        "**Louis Pasteur (XIXe siècle)**: Ses travaux (Théorie des germes) ont prouvé le rôle des levures (*Saccharomyces*) dans la fermentation. Il a permis d'isoler des souches pures, conduisant à la **pasteurisation** et au contrôle microbiologique.",
        "**Carlsberg (Emil Christian Hansen)**: Isola la première souche de levure de lager pure (*Saccharomyces carlsbergensis*) au Danemark en 1883."
      ]}
    ],
    questions: [
      q("Le Reinheitsgebot date de…", ["1857", "1516", "1200", "4000 av. J.-C."], 1, "L'édit de pureté bavarois."),
      q("Le houblon a remplacé quel ingrédient principal ?", ["Le blé", "Le gruit", "L'orge", "Le sucre"], 1, "Le gruit était un mélange d'herbes aromatiques."),
      q("Quand date le brassage de Sumer (Mésopotamie)?", ["Moderne", "Environ 4000 av. J.-C.", "Époque médiévale", "Époque Renaissance"], 1, "Plus anciennes preuves archéologiques de brassage."),
      q("Quel était le statut de la bière en Mésopotamie?", ["Boisson de luxe rare", "Aliment de base nutritif", "Médicament uniquement", "Boisson rituelle"], 1, "Aliment crucial et nutritif pour la population."),
      q("Pourquoi buvait-on la bière à la paille en Antiquité?", ["Question d'hygiène", "Éviter les résidus de grains", "Mode époque", "Tradition religieuse"], 1, "Éviter les impuretés et résidus solides."),
      q("Comment était la qualité de la bière égyptienne (bouza)?", ["Consistante et stable", "Variable avec goût souvent acide", "Très sucrée", "Forte en alcool"], 1, "Fermentation sauvage = qualité variable."),
      q("Quels étaient les composants du gruit médiéval?", ["Orge uniquement", "Mélange d'herbes (Myrica gale, Armoise)", "Levure pure", "Eau filtrée"], 1, "Mélange d'herbes aromatiques avant le houblon."),
      q("Quel était le rôle principal du gruit?", ["Activer la fermentation", "Arôme / masquer défauts / conservation faible", "Ajouter de la couleur", "Stabiliser la bière"], 1, "Saveur herbacée et légère conservation."),
      q("À quelle époque le houblon fut-il adopté?", ["IXe siècle", "XIIe–XIVe siècles", "XVe siècle", "XVIIe siècle"], 1, "Adoption depuis les monastères allemands."),
      q("Quelle est la propriété clé du houblon?", ["Ajoute du sucre", "Antibactérien + antioxydant", "Source d'enzyme", "Agent de levain"], 1, "Propriété de conservation majeure."),
      q("Humulus lupulus désigne quoi?", ["Herbe aromatique générale", "Nom scientifique de la plante houblon", "Levure sauvage", "Bactérie lactique"], 1, "Nom scientifique du houblon."),
      q("Quels étaient les ingrédients du Reinheitsgebot?", ["Eau / Malt / Houblon uniquement", "Eau / Malt / Sucre", "Eau / Orge / Levure", "Tous ingrédients"], 0, "Loi de pureté bavaroise stricte."),
      q("Reinheitsgebot but…", ["Qualité", "Blé pain + qualité", "Prévention", "Export"], 1, "Politique économique."),
      q("Pasteur théorie…", ["Spontanée", "Germes (levures)", "Chimique", "Naturelle"], 1, "Fermentation source."),
      q("Pasteur isolement…", ["Levures pures", "Bactéries", "Enzymes", "Protéines"], 0, "Souches contrôlées."),
      q("Pasteurisation impact…", ["Saveur", "Microbes tués/Stabilité", "Couleur", "IBU"], 1, "Stabilité."),
      q("Carlsberg Hansen…", ["Levure ale", "Levure lager pure Saccharomyces carlsbergensis", "Malt hybride", "Houblon"], 1, "1883 Danemark."),
      q("Saccharomyces cerevisiae…", ["Lager", "Ale/Fermentation haute T", "Basse T", "Hybride"], 1, "Levure classique."),
      q("Fermentation température…", ["Pasteur contrôlait", "Variable sauvage avant", "Toujours identique", "Inconnue"], 1, "Variabilité historique."),
      q("Monastères rôle…", ["Production", "Brassage perfectionné", "Distribution", "Médecine"], 1, "Moyen Âge."),
      q("Bière antique durée conservation…", ["Mois", "Jours à semaines", "Années", "Infinie"], 1, "Peu durable sauvage."),
      q("Houblon acides…", ["Alpha (amertume)", "Bêta (conservation)", "Huiles (arôme)", "Tous"], 3, "Multiples."),
      q("IPA origine historique?", ["Belgique", "Inde coloniale britannique longue conservation", "Allemagne", "USA"], 1, "Export houblonné."),
      q("Prohibition USA bière?", ["Augmentation", "1920–1933 interdiction alcool", "Jamais", "Encouragement"], 1, "Loi sèche."),
      q("Révolution industrielle brassage?", ["Manuelle", "Mécanisation production masse", "Déclin", "Interdite"], 1, "Échelle commerciale."),
      q("Porter style origine?", ["Allemagne", "Londres XVIIIe travailleurs", "Belgique", "USA"], 1, "Bière robuste."),
      q("Lager fermentation basse origine?", ["Angleterre", "Bavière caves fraîches", "Belgique", "Écosse"], 1, "Température contrôle."),
      q("Levure spontanée Lambic?", ["Inoculation", "Air ambiant vallée Senne", "Laboratoire", "Commerciale"], 1, "Tradition belge."),
      q("Trappiste certification?", ["Marketing", "Monastère authentique production", "Goût", "Pays"], 1, "Label strict."),
      q("Bière bouteille invention?", ["Antiquité", "Moyen Âge", "XVIIe s. verre + bouchon", "XXe s."], 2, "Conservation améliorée."),
      q("Réfrigération artificielle impact?", ["Aucun", "Lager toute année production", "Réduit qualité", "Optionnel"], 1, "Contrôle température.")
    ]
  },
  {
    id: "houblonIBU",
    category: "HOUBLON",
    title: "9. Houblon, amertume, IBU & BU:GU",
      ficheRich: [
        { title: "Chimie de l'amertume et IBU", items: [
          "L'amertume provient des acides alpha (humulones) du houblon, peu solubles et peu amers à l'état brut.",
          "L'isomérisation (chauffage >60°C) transforme les humulones en iso-alpha-acides, solubles et responsables de l'amertume.",
          "Rendement maximal après 60-90 min d'ébullition, influencé par le pH (acide = meilleur) et la densité du moût.",
          "1 IBU = 1 mg d'iso-alpha-acide par litre de bière, mesuré par spectrophotométrie UV à 275 nm.",
          "L'IBU ne prend pas en compte les polyphénols oxydés ou acides bêta oxydés (amertume perçue ≠ IBU mesuré).",
          "Acides bêta (lupulones) : peu amers sauf oxydation, contribuent à l'amertume dure avec le vieillissement."
        ]},
        { title: "Facteurs de rendement IBU", items: [
          "Temps d'ébullition : rendement faible avant 20 min; optimum 60-90 min, puis plateau.",
          "pH plus bas et densité plus faible améliorent l'extraction/isomérisation des acides alpha.",
          "Agitation/whirlpool : améliore le contact mais peut entraîner des pertes par trub.",
          "Forme et fraîcheur du houblon : pellets/extraits stabilisent l'amertume; houblon oxydé = amertume dure (acides bêta oxydés)."
        ]},
        { title: "Pratique de calcul IBU (terrain)", items: [
          "Utilisation dépend de la gravité d'ébullition : plus le moût est dense, plus le rendement chute.",
          "Les additions tardives (≤15 min) apportent peu d'IBU mais beaucoup d'huiles; compter un rendement faible.",
          "Les pertes dans le trub/whirlpool réduisent l'IBU final mesuré; prévoir une marge de sécurité."
        ]},
        { title: "Qualité d'amertume (perception)", items: [
          "À IBU égal, l'amertume peut sembler plus **tranchante** ou plus **ronde** selon le profil d'eau (sulfates/chlorures) et le corps.",
          "Certaines variétés (cohumulone) peuvent donner une amertume perçue plus âpre.",
          "BU:GU aide à vérifier l'équilibre amertume/corps (IBU vs densité initiale)."
        ]}
        ,{ title: "BU:GU (équilibre amertume/densité)", items: [
          "**BU:GU = IBU / Unités de Gravité (OG-1000)** : compare l'amertume à la densité initiale.",
          "**Interprétation** : < 0,5 malté/sucré, 0,5–0,8 équilibré, > 0,8 houblonné/sec.",
          "**Limites** : ne tient pas compte de la DF, du corps, des polyphénols ou de l'eau (sulfates/chlorures)."
        ]}
      ],
      questions: [
        q("Quelle est la source principale de l'amertume dans la bière?", ["Huiles essentielles", "Iso-alpha-acides isomérisés", "Sucres", "CO2"], 1, "L'amertume vient des iso-alpha-acides."),
        q("Que signifie 1 IBU?", ["1 g/L de houblon", "1 mg/L d'iso-alpha-acides", "1 % d'alcool", "1 unité EBC"], 1, "Définition : 1 mg/L d'iso-alpha-acides."),
        q("L'IBU est classiquement mesuré par…", ["Chromatographie", "Spectrophotométrie UV à 275 nm", "Mesure NTU", "Mesure EBC"], 1, "Méthode UV standard."),
        q("Comment se crée l'amertume à partir des acides alpha?", ["À froid", "Isomérisation à chaud (>60°C)", "Par la levure", "Par le CO2"], 1, "La chaleur isomérise les humulones."),
        q("Quel temps donne le meilleur rendement IBU?", ["0-5 min", "60-90 min", "Après fermentation", "24 h"], 1, "Plateau autour de 60-90 min."),
        q("Quel facteur réduit le rendement d'isomérisation?", ["Moût très dense (high gravity)", "pH plus bas", "Refroidissement rapide", "Whirlpool"], 0, "La densité élevée limite l'extraction."),
        q("Quel effet a un pH plus bas?", ["Réduit le rendement", "Améliore le rendement", "Aucun effet", "Annule l'IBU"], 1, "pH acide = meilleure solubilité."),
        q("Que se passe-t-il en whirlpool 80-90°C?", ["Aucune isomérisation", "Isomérisation résiduelle faible", "IBU maximal", "Fermentation"], 1, "Le moût chaud continue un peu l'isomérisation."),
        q("Quel effet d'un refroidissement très rapide après flameout?", ["Augmente l'IBU", "Réduit l'isomérisation résiduelle", "Double l'IBU", "Aucun effet"], 1, "Moins de temps chaud = moins d'IBU."),
        q("Quel effet d'une forte évaporation (boil-off)?", ["Diminue l'IBU", "Concentre le moût (IBU peut monter)", "Supprime l'amertume", "Aucun effet"], 1, "Moins de volume = concentration."),
        q("Pourquoi l'IBU calculé peut être plus haut que le réel?", ["Aucune perte", "Pertes trub/whirlpool et adsorption", "Le pH annule tout", "Le CO2 détruit les AA"], 1, "Pertes process et adsorption."),
        q("La fermentation peut faire baisser l'IBU parce que…", ["Levure crée des iso-alpha", "Iso-alpha adsorbés sur levure/trub", "pH monte", "Malt absorbe tout"], 1, "Adsorption sur biomasse."),
        q("Le dry hopping apporte-t-il beaucoup d'IBU?", ["Oui", "Non (pas d'isomérisation à froid)", "Toujours >50", "Autant qu'un 60 min"], 1, "À froid, l'isomérisation est négligeable."),
        q("Pourquoi le no-chill peut augmenter l'IBU?", ["Il refroidit plus vite", "Stand chaud prolongé = isomérisation résiduelle", "Supprime les AA", "Baisse le pH"], 1, "Temps chaud prolongé."),
        q("Quel composé donne une amertume dure au vieillissement?", ["Huiles", "Acides bêta oxydés", "Lactose", "CO2"], 1, "Lupulones oxydées."),
        q("La cohumulone est surtout associée à…", ["Amertume plus âpre", "Plus de sucre", "Plus de couleur", "Moins d'arôme"], 0, "Profil plus tranchant."),
        q("Quel profil d'eau rend l'amertume plus tranchante?", ["Chlorures élevés", "Sulfates élevés", "Fer élevé", "Aucun effet"], 1, "Les sulfates accentuent la netteté."),
        q("Quelle est la formule du BU:GU?", ["Densité / IBU", "IBU / (OG–1000)", "IBU × OG", "Temps d'ébullition"], 1, "Ratio amertume/densité."),
        q("Un BU:GU de 0.2 indique une bière plutôt…", ["Amère", "Équilibrée", "Maltée/sucrée", "Alcoolisée"], 2, "Dominante maltée."),
        q("Quel est le BU:GU typique d'une Pale Ale?", ["0.2", "0.6–0.8", "1.2", "0.1"], 1, "Équilibre classique."),
        q("Quel est le BU:GU typique d'une American IPA?", ["0.5", "0.9–1.2+", "0.2", "0.7"], 1, "Houblonnée et sèche."),
        q("Le BU:GU est-il parfaitement objectif?", ["Oui", "Non (guide approximatif)", "Identique à l'IBU", "Inverse"], 1, "Guide, pas absolu."),
        q("Pourquoi une Barley Wine supporte-t-elle 80+ IBU?", ["Ne supporte pas", "Densité haute abaisse BU:GU", "Trop amère", "Impossible"], 1, "OG élevé masque l'amertume."),
        q("Pourquoi dépasser ~100 IBU est difficile?", ["Le malt bloque", "Plateau de rendement/solubilité + pertes", "CO2 détruit les AA", "pH tombe"], 1, "Limites physico-chimiques."),
        q("Quel est l'effet typique d'un ajout à 5 min?", ["IBU maximal", "IBU faible, arôme élevé", "Aucun arôme", "IBU nul"], 1, "Peu d'isomérisation, beaucoup d'huiles."),
        q("Quel paramètre doit être mis à jour à chaque lot de houblon?", ["EBC", "% acides alpha (AA%)", "ABV", "NTU"], 1, "AA% varie par récolte."),
        q("Pourquoi un hop bag peut réduire un peu l'IBU?", ["Plus de contact", "Surface de contact réduite", "Augmente l'IBU", "Change l'EBC"], 1, "Extraction légèrement moindre."),
        q("Quel effet d'une dilution après ébullition sur l'IBU?", ["Augmente", "Diminue", "Aucun effet", "Double"], 1, "Plus de volume = IBU dilué."),
        q("Quel ajout permet d'ajuster l'amertume après fermentation?", ["Cônes", "Extraits isomérisés", "Malt caramel", "Levure"], 1, "Iso-extraits = IBU dosable."),
        q("Quel effet de l'altitude sur l'IBU?", ["Aucun effet", "Ébullition plus basse → rendement réduit", "IBU double", "IBU nul"], 1, "Température d'ébullition plus basse." )
      ]
  },
      {
        id: "formesHoublonFusion",
        category: "HOUBLON",
        title: "Formes et choix des houblons (fusion)",
        ficheRich: [
          { title: "Cônes (Fleurs Entières)", items: [
            "**Description** : Cônes de houblon séchés intacts, forme naturelle, profil aromatique frais, moins d'impuretés.",
            "**Avantages** : Qualité aromatique excellente, huiles volatiles préservées, moins de trub fin en moût.",
            "**Inconvénients** : Faible rendement d'utilisation (acides moins accessibles), très volumineux, forte absorption de moût, dosage imprécis, oxydation rapide.",
            "**Stockage** : Congélation –18°C sous vide essentielle."
          ]},
          { title: "Pellets (Granulés T90)", items: [
            "**Processus** : Cônes séchés, moulus, puis compressés. T90 = 90% de la matière première conservée; le broyage libère la lupuline.",
            "**Rendement** : 50-60% d'extraction; 5-15% de rendement IBU de plus que les cônes grâce à la surface accrue.",
            "**Avantages** : Dosage précis, compacts, stables, polyvalents (bittering + arôme), pertes de bière réduites.",
            "**Perte lupuline** : ~10% lors de la compression (acceptable).",
            "**Usage** : Forme standard (≈90% du marché)."
          ]},
          { title: "Pellets T45 / Cryo (Lupulin Powder)", items: [
            "**Processus** : Séparation à froid de la lupuline (–196°C pour Cryo) avec moins de matière végétale.",
            "**Rendement** : 75-85% d'extraction; 2-3x plus d'huiles et d'acides alpha par masse vs T90.",
            "**Avantages** : Arômes très intenses, réduction du trub ~50%, idéal pour dry hop massif/NEIPA.",
            "**Points de vigilance** : Coût plus élevé, filtration plus fine (particules fines), ajuster la dose (≈50% de T90).",
            "**Stockage** : Même exigences que T90 (froid, vide/azote)."
          ]},
          { title: "Classification fonctionnelle", items: [
            "**Houblons Amérisants (High Alpha)**: 10–17% AA, faible huiles spécifiques, pour rendement IBU (Magnum, Target, Warrior).",
            "**Houblons Aromatiques (Low Alpha)**: 3–7% AA, riches en huiles fines (Humulène, Linalool), ajout tardif ou à cru (Saaz, Tettnanger, Fuggles).",
            "**Houblons Dual-Purpose**: 7–10% AA équilibrés, polyvalents amertume/arôme (Cascade, Centennial, Simcoe)."
          ]},
          { title: "Familles aromatiques (terroir)", items: [
            "**Nobles (Européens)**: Épicés/floraux/terreux, faible Myrcène (Hallertau Mittelfrüh, Saaz, Tettnanger).",
            "**Américains (C-Hops)**: Myrcène élevé, agrumes/pin/résine (Cascade, Centennial, Chinook).",
            "**Nouveau Monde**: Profils tropicaux 'juicy' ou vin blanc (Nelson Sauvin, Galaxy, Citra, Mosaic)."
          ]},
          { title: "Tips du brasseur", items: [
            "**Ratio AA/Huiles**: bas = bittering robuste; élevé = arôme préservé.",
            "**SMASH**: Single Malt And Single Hop pour isoler un profil.",
            "**Fraîcheur/HSI**: vérifier récolte et HSI pour choisir un lot."
          ]}
        ],
        questions: [
          q("Quel est le rendement en extraction des cônes frais?", [">60% (excellent)", "30–40% (modéré)", "<20% (faible)", "Nul"], 1, "Rendement modéré de 30–40% pour les cônes."),
          q("Que représentent les pellets T90?", ["Cônes entiers", "≈90% de la matière compressée", "70% concentré", "Poudre"], 1, "T90 = 90% de la masse compressée."),
          q("Rendement des pellets T90 vs cônes?", ["Identique", "50–60% vs 30–40% pour cônes", "Cônes meilleurs", "Variable"], 1, "Pellets offrent un meilleur rendement."),
          q("Le dosage des pellets T90 est-il précis?", ["Très difficile", "Facile et précis", "Impossible", "Balance spéciale requise"], 1, "Dosage simple."),
          q("Quelle forme est la plus stable?", ["Cônes frais", "Pellets T90", "Extraits CO₂ (très stables)", "Identique"], 2, "Extraits et pellets sont stables."),
          q("Les cônes ont-ils une bonne qualité aromatique?", ["Excellente", "Modérée", "Faible", "Aucune"], 0, "Arôme frais supérieur."),
          q("Que sont les extraits de houblon CO₂?", ["Cônes séchés", "Résine concentrée de houblon", "Pellets", "Poudre de malt"], 1, "Résine extraite au CO₂ supercritique."),
          q("Le dosage des extraits est-il précis?", ["Difficile", "Très précis", "Impossible", "Approximatif"], 1, "Concentration connue."),
          q("Les extraits ont-ils des qualités aromatiques?", ["Excellentes", "Modérées", "Aucune (surtout bittering)", "Dégradées"], 2, "Ils servent surtout au bittering."),
          q("À quoi servent principalement les extraits?", ["Arôme uniquement", "Bittering avec contrôle précis des IBU", "Usage généraliste", "Jamais"], 1, "Contrôle IBU précis."),
          q("Les cônes sont-ils volumineux?", ["Compacts", "Volumineux", "Très compacts", "Énormes"], 1, "Volume de stockage important."),
          q("Quel ordre d'efficacité?", ["Cônes > T90 > Extraits", "Cônes < T90 < Extraits", "Identique", "Variable"], 1, "Cônes < T90 < Extraits."),
          q("Pellets T45 c'est quoi?", ["Résidu standard", "Lupuline concentrée (~45% masse)", "45°C", "45 jours"], 1, "Pellets concentrés en lupuline."),
          q("Cryo hops : avantage?", ["Moins cher", "Lupuline concentrée, moins de matière végétale", "Plus d'amertume", "Conservation nulle"], 1, "Arôme intense, peu de trub."),
          q("Extraits isomérisés servent à?", ["Arôme final", "Ajuster l'amertume post-fermentation", "Whirlpool", "Dry hop"], 1, "IBU immédiat à froid."),
          q("Stockage optimal des pellets?", ["Ambiant", "Froid + vide/azote", "Humide", "En plein soleil"], 1, "Froid et sans O2."),
          q("Oxydation des cônes produit?", ["Fromage/chaussette", "Fruité", "Floral", "Neutre"], 0, "Off-flavour acide isovalérique."),
          q("Pourquoi les pellets extraient-ils mieux?", ["Surface accrue libérant la lupuline", "Parce qu'ils flottent", "Ils sont chauffés", "Ils sont sucrés"], 0, "Surface et broyage."),
          q("Les cônes absorbent combien de moût?", ["Négligeable", "Jusqu'à 2-3× leur poids", "10%", "Aucune"], 1, "Pertes volumétriques."),
          q("Forme la plus compacte à stocker?", ["Cônes", "Pellets", "Même volume", "Cônes compressés"], 1, "Pellets prennent peu de place."),
          q("Type préféré en dry hop artisanal?", ["Extraits liquides", "Pellets (praticité/rendement)", "Cônes uniquement", "Poudre T45"], 1, "Compromis efficacité."),
          q("Quel ratio AA/Huiles pour bittering?", ["Élevé", "Faible ratio huiles/AA (amérisant)", "Toujours haut", "Sans effet"], 1, "Peu d'huiles à brûler."),
          q("Que signifie SMASH?", ["Marque", "Single Malt And Single Hop", "Double houblon", "Sans malt"], 1, "Outil pédagogique."),
          q("Les houblons nobles européens se caractérisent par…", ["AA élevé", "Faible AA + arôme épicé/floral fin", "Nouveau Monde", "Américain"], 1, "Finesse aromatique."),
          q("Cascade est quel type de houblon?", ["Pur Américain", "Dual-purpose 7–9% AA agrumes", "Noble", "High Alpha"], 1, "Polyvalent."),
          q("Simcoe est quel type?", ["Bas AA", "Dual-purpose ~11% AA pin/fruit", "Aromatique pur", "Noble"], 1, "Polyvalent moderne."),
          q("Nelson Sauvin vient de…", ["Europe", "Nouvelle-Zélande (profil vin blanc)", "USA", "Allemagne"], 1, "Terroir NZ."),
          q("Galaxy est…", ["Bas AA", "Aromatique australien intensément fruité", "Dual", "High"], 1, "Tropical australien."),
          q("Citra se caractérise par…", ["Alpha faible", "Aromatique US agrumes/thiols", "Dual noble", "Bêta"], 1, "Profil moderne."),
          q("Pourquoi vérifier la fraîcheur/HSI?", ["Inutile", "HSI bas = fraîcheur et arômes préservés", "HSI haut meilleur", "Aucun lien"], 1, "Qualité de lot.")
        ]
      },
  {
    id: "aromatique",
    category: "HOUBLON",
    title: "10. Houblonnage aromatique & Dry hopping",
    ficheRich: [
      { title: "Volatilité des huiles essentielles", items: [
        "**Myrcène**: Terpène majeur très volatil (résine/pin/épicé). Fortement perdu par une longue ébullition.",
        "**Humulène**: Moins volatil; profil boisé/terreux/épicé, typique des houblons nobles.",
        "**Linalool & Géraniol**: Précurseurs floraux/agrumes, convertibles par la levure (biotransformation)."
      ]},
      { title: "Fenêtres d'ajout chaud (arôme)", items: [
        "**Houblonnage tardif (1-15 min)**: Limite la volatilisation et stérilise le houblon.",
        "**Flameout**: Ajout juste après la coupure de chauffe; extraction d'huiles maximale pour un IBU faible.",
        "**Whirlpool (70-90°C)**: Température idéale pour dissoudre les huiles sans isomériser fortement les acides alpha."
      ]},
      { title: "Dry hopping à froid", items: [
        "Ajout à froid en fermentation ou maturation pour extraire arômes/thiols sans presque d'IBU.",
        "Doses courantes 2-5 g/L; styles intensifs (NEIPA) >10 g/L (saturation possible).",
        "Contact 3-7 jours; au-delà, risque d'arômes herbacés/astringents et de particules en suspension."
      ]},
      { title: "Biotransformation levure-houblon", items: [
        "Fenêtre optimale: fermentation active 3-5 jours (levure vivante).",
        "**Bêta-lyase** des levures libère les thiols volatils (passion/pamplemousse/goyave).",
        "Conversion **Géraniol → Citronellol**: notes rose/agrumes, dépendantes de la souche (NEIPA)."
      ]},
      { title: "Stratégies de timing", items: [
        "Dry hop tôt: favorise la biotransformation (arômes fondus).",
        "Dry hop tardif/post-fermentation: arômes plus 'verts'/huiles pures, moins de conversion par la levure.",
        "Extraction à froid = huiles/thiols sans isomérisation (IBU quasi nul)."
      ]}
    ],
    questions: [
      q("Pourquoi le houblonnage tardif favorise-t-il l'arôme?", ["Pour maximiser l'IBU", "Les huiles sont très volatiles et se perdent en ébullition longue", "Pour réduire le pH", "Pour le Hop Creep"], 1, "Les huiles s'évaporent vite à chaud."),
      q("Quelle est la température optimale pour le whirlpool?", ["100°C", "70-90°C (huiles solubles, sous seuil isomérisation)", "20°C", "Fluctuante"], 1, "Extraction aromatique sans trop d'IBU."),
      q("Quand se fait le dry hopping?", ["Pendant l'ébullition", "Pendant ou après la fermentation (à froid)", "Avant l'empâtage", "Après filtration uniquement"], 1, "Ajout à froid pour préserver les huiles."),
      q("Le dry hopping apporte-t-il de l'IBU?", ["Oui beaucoup", "Non ou très peu (pas d'isomérisation à froid)", "Autant qu'un ajout 60 min", "Inverse"], 1, "Température trop basse pour isomériser."),
      q("Quelle dose de dry hop pour une NEIPA?", ["0.5 g/L", "10+ g/L pour arôme intense", "0.1 g/L", "2 g/L maximum"], 1, "Les styles 'juicy' sont très chargés."),
      q("Quelle est la durée typique du dry hopping?", ["1-2 heures", "3-7 jours", "3 semaines", "Instantané"], 1, "Macération froide contrôlée."),
      q("Quelle est la fenêtre optimale de biotransformation?", ["Toujours", "Fermentation active 3-5 jours", "Post-fermentation froide", "Avant empâtage"], 1, "Besoin d'une levure en activité."),
      q("Quel rôle joue la bêta-lyase de la levure?", ["Isomérise les acides alpha", "Libère les thiols volatils à partir de précurseurs", "Oxydation du myrcène", "Aucun"], 1, "Elle libère les thiols aromatiques."),
      q("Comment le géraniol est-il converti par la levure?", ["Il reste stable", "En citronellol (notes rose/agrumes)", "En acide valérianique", "En CO2"], 1, "Conversion aromatique clé."),
      q("Quelle différence entre un dry hop tôt et tardif?", ["Même profil", "Tôt: biotransformation, Tardif: huiles plus 'vertes'", "Tôt: plus d'IBU", "Tardif: plus d'IBU"], 1, "Le timing change le profil."),
      q("Pourquoi éviter un contact trop long en dry hop?", ["Aucun risque", "Risque herbacé/astringent et particules", "Augmente l'IBU", "Dissout le malt"], 1, "Extraction de composés herbacés."),
      q("Quel type de composé est le myrcène?", ["Acide alpha", "Terpène (huile essentielle) très volatile", "Sucre", "Protéine"], 1, "Terpène majeur du houblon."),
      q("Quelle méthode maximise l'extraction d'huiles avec IBU faible?", ["60 min d'ébullition", "Flameout/Whirlpool 70-90°C", "Empâtage", "Fermentation"], 1, "Chaud mais sous isomérisation."),
      q("Pourquoi faire plusieurs ajouts de dry hop?", ["Interdit", "Superposer des couches aromatiques", "Augmenter l'amertume", "Clarifier la bière"], 1, "Layering aromatique possible."),
      q("Que se passe-t-il avec une dose excessive de dry hop?", ["Toujours mieux", "Notes herbacées/astringentes (tannins)", "Aucun effet", "La bière devient sucrée"], 1, "Excès = off-flavours possibles."),
      q("Quel terpène est le plus volatil dans la fiche?", ["Humulène", "Myrcène", "Thiols", "Citronellol"], 1, "Le myrcène est très volatil."),
      q("Quel composé est plutôt associé au profil boisé/terreux/épicé?", ["Myrcène", "Humulène", "Iso-alpha-acides", "Dextrines"], 1, "Humulène = notes boisées/terreuses."),
      q("Linalool et géraniol sont surtout…", ["Des sucres", "Des terpènes précurseurs floraux/agrumes", "Des acides bêta", "Des protéines"], 1, "Précurseurs aromatiques convertibles."),
      q("Comment s'appelle l'ajout juste après la coupure de chauffe?", ["Empâtage", "Flameout", "Dry hop", "Fermentation"], 1, "Flameout = après arrêt de chauffe."),
      q("Pourquoi le whirlpool est souvent mené à 70-90°C?", ["Pour maximiser l'IBU", "Pour extraire les huiles sans trop d'isomérisation", "Pour acidifier", "Pour sucrer"], 1, "Extraction d'huiles avec IBU faible."),
      q("Le dry hop tôt (début fermentation) favorise surtout…", ["L'isomérisation", "La biotransformation", "La caramélisation", "La filtration"], 1, "Levure active = conversion."),
      q("Le dry hop tardif/post-fermentation donne plutôt…", ["Arômes plus verts/huiles pures", "Plus d'IBU", "Moins d'arôme", "Plus de sucre"], 0, "Moins de conversion par la levure."),
      q("Quelle fenêtre est citée pour la biotransformation?", ["0-12 h", "3-5 jours", "2-3 semaines", "60-90 min"], 1, "Fenêtre fermentation active."),
      q("La bêta-lyase sert surtout à…", ["Isomériser les acides alpha", "Libérer des thiols volatils", "Clarifier la bière", "Augmenter l'EBC"], 1, "Libération des thiols."),
      q("Les thiols sont associés à quels arômes?", ["Chocolat/café", "Passion/pamplemousse/goyave", "Caramel", "Fumée"], 1, "Arômes tropicaux/citronnés."),
      q("Quel couple de molécules est cité comme converti par la levure?", ["Myrcène → humulène", "Géraniol → citronellol", "Alpha → bêta", "CO2 → O2"], 1, "Conversion aromatique clé."),
      q("Pourquoi faire un layering aromatique en dry hop?", ["Augmenter l'IBU", "Superposer des couches aromatiques", "Augmenter la densité", "Réduire le CO2"], 1, "Ajouts successifs = complexité."),
      q("Quel est l'objectif principal d'un ajout à froid?", ["Isomériser les acides alpha", "Préserver les huiles/thiols", "Augmenter l'alcool", "Baisser l'EBC"], 1, "À froid on protège l'aromatique."),
      q("Quel est un effet courant d'un dry hop trop long?", ["Arômes herbacés/astringence", "IBU maximal", "Coloration forte", "Densité qui monte"], 0, "Sur-extraction herbacée/astringente."),
      q("Quel ordre de dose est cité comme courant en dry hop?", ["0.1-0.5 g/L", "2-5 g/L", "20-30 g/L", "50 g/L"], 1, "Doses courantes 2-5 g/L.")
    ]
  },
  {
    id: "hopCreep",
    category: "HOUBLON",
    title: "11. Hop Creep (Refermentation)",
    ficheRich: [
      { title: "Définition du Hop Creep", items: [
        "**Hop Creep**: Une refermentation **imprévue et lente** qui se produit souvent après un *dry hopping* intensif. Il affecte principalement les bières conditionnées (fûts, canettes, bouteilles) qui ne sont pas pasteurisées.",
        "**Cause**: Le houblon (surtout sous forme de pellet) contient des traces d'**enzymes diastasiques** résiduelles (Amylase et Glucoamylase) provenant du cône frais qui n'ont pas été désactivées par l'ébullition (puisqu'ajouté à froid)."
      ]},
      { title: "Mécanisme de Refermentation", items: [
        "**Saccharification à froid**: Les enzymes du houblon sont réintroduites dans la bière et commencent à hydrolyser les **dextrines** (sucres non fermentescibles) résiduelles, les transformant en sucres simples (maltose, glucose).",
        "**Conséquences**: La levure dormante ou résiduelle (même en très faible quantité) consomme ces nouveaux sucres, provoquant une **baisse de la densité finale** et un dégagement non contrôlé de **CO2** (Dioxyde de Carbone), ce qui mène au risque majeur de **surpression, de gushing ou d'explosion** des contenants."
      ]},
      { title: "Prévention", items: [
        "Pour les brasseurs industriels : **Pasteurisation** du produit après le *dry hop* pour désactiver les enzymes du houblon. Pour les brasseurs artisanaux : S'assurer que la bière est **entièrement exempte de levure viable** avant l'embouteillage, ou utiliser des inhibiteurs de levure/enzymes."
      ]}
    ],
    questions: [
      q("Qu'est-ce que le Hop Creep?", ["Excès de sucre de candi", "Refermentation imprévue due aux enzymes du houblon", "Trop de protéines", "pH trop bas"], 1, "Les amylases du houblon libèrent des sucres fermentescibles."),
      q("Risque principal du Hop Creep?", ["Gushing léger", "Surpression des bouteilles (explosion)", "Trouble à froid", "Amertume faible"], 1, "La refermentation crée du CO2 sous pression."),
      q("Action de l'amylase du houblon?", ["Enzyme pectique", "Hydrolyse des dextrines en maltose/glucose", "Protéase", "Lipase"], 1, "Saccharification à froid."),
      q("Rôle de la glucoamylase du houblon?", ["Protéine", "Libère du glucose à partir des dextrines", "Bactérie", "Levure"], 1, "Hydrolyse complète des polymères."),
      q("Les dextrines après ébullition sont-elles fermentescibles?", ["Fermentescibles", "Non fermentescibles (PM élevé)", "Toujours consommées", "Instables"], 1, "Architecture maltose-polymère complexe."),
      q("Source de la refermentation Hop Creep?", ["Aucun sucre", "Sucres libérés par enzymes + levure dormante", "Levure morte", "Bactérie acétique"], 1, "Reprise de fermentation inattendue."),
      q("CO2 lors du gushing?", ["Dégagement lent", "Surpression rapide (risque explosion)", "Zéro gaz", "Négatif"], 1, "Danger lors du stockage."),
      q("Évolution de la densité finale avec Hop Creep?", ["Inchangée", "Baisse (sucres consommés)", "Augmente", "Nulle"], 1, "Disparition des sucres par fermentation."),
      q("Qu'est-ce que la levure dormante?", ["Morte", "Vivante mais inactive (basse T) réactivable", "Hyperactive", "Mutante"], 1, "Viabilité latente."),
      q("Origine des enzymes diastasiques du houblon?", ["Synthèse nouvelle", "Résidus du cône (pellets non bouillis)", "Synthèse par levure", "Destruction"], 1, "Survivance enzymatique."),
      q("Pellets vs cônes : risque Hop Creep?", ["Cônes plus risque", "Pellets plus risque (surface libérée)", "Identique", "Cônes seule cause"], 1, "Surface de contact augmentée."),
      q("La pasteurisation règle-t-elle le Hop Creep?", ["Aucun effet", "Oui, désactive enzymes et tue levure", "Aggrave", "Stimule"], 1, "Traitement thermique préventif."),
      q("Qu'est-ce qu'un inhibiteur enzymatique?", ["Sucre", "Molécule qui bloque amylase/glucoamylase", "Booster de levure", "pH-dépendant"], 1, "Chimie de contrôle."),
      q("Quand se manifeste le Hop Creep?", ["Immédiatement", "Jours/semaines après embouteillage", "Avant brassage", "Pendant fermentation primaire"], 1, "Cinétique lente et différée."),
      q("Comment détecter la levure viable?", ["Couleur", "Comptage/viabilité (tests biochimiques)", "Odeur", "pH"], 1, "Microscopie et culture."),
      q("Température où la levure devient dormante?", ["10°C très active", "0–4°C (activité ralentie)", "30°C idéal", "Chauffée"], 1, "Physiologie de conservation."),
      q("Durée de saccharification des dextrines?", ["Minutes", "Heures/jours (cinétique lente)", "Instantané", "Jamais"], 1, "Réaction biochimique progressive."),
      q("Précaution à l'embouteillage?", ["Aucune", "Éliminer/neutraliser la levure (pasteurisation/centrifugation)", "Levure obligatoire", "Ajouter enzymes"], 1, "Prévention du gushing."),
      q("Qu'est-ce que l'acide valérianique?", ["Arôme agréable", "Off-flavour d'oxydation (fromage/chaussettes)", "Sucre", "Levure"], 1, "Décomposition aromatique."),
      q("Hop Creep plus fréquent à froid ou à chaud?", ["Chaud uniquement", "À froid (enzymes + levure acclimatée)", "DH épargné", "Inverse"], 1, "Levure basse température."),
      q("Pourquoi les pellets favorisent-ils le Hop Creep?", ["Moins d'enzymes", "Broyage expose enzymes (surface ↑)", "Protège enzymes", "Aucune différence"], 1, "Structure cellulaire rompue."),
      q("La centrifugation prévient-elle le Hop Creep?", ["Non", "Oui, retire la levure résiduelle", "Aggrave", "Sans effet"], 1, "Séparation physique de la levure."),
      q("Les enzymes du houblon sont-elles thermostables?", ["Totalement", "Non (détruites à l'ébullition)", "Partiellement", "Augmentent avec chaleur"], 1, "Dénaturation thermique."),
      q("Le Hop Creep affecte-t-il l'alcool?", ["Non", "Oui, légère hausse (sucres fermentés)", "Diminue", "Aucun lien"], 1, "Fermentation supplémentaire = éthanol."),
      q("Les bières pasteurisées risquent-elles le Hop Creep?", ["Oui fortement", "Non (enzymes + levure désactivées)", "Partiellement", "Toujours"], 1, "Stabilité microbiologique."),
      q("Peut-on mesurer le Hop Creep?", ["Impossible", "Oui (densité finale + pression CO2)", "Uniquement visuellement", "Par goût"], 1, "Monitoring analytique."),
      q("Dry hopping intensif (>10 g/L) augmente-t-il le risque?", ["Non", "Oui (plus d'enzymes introduites)", "Diminue le risque", "Sans corrélation"], 1, "Relation dose-effet."),
      q("Les NEIPA sont-elles sensibles au Hop Creep?", ["Non", "Oui (DH massif + pas de pasteurisation)", "Moins sensibles", "Immunisées"], 1, "Pratiques à risque combinées."),
      q("L'ajout d'azote à l'embouteillage prévient-il le Hop Creep?", ["Totalement", "Non (n'inactive pas les enzymes)", "Partiellement", "Aggrave"], 1, "Atmosphère inerte ≠ inactivation enzymatique."),
      q("Température optimale de l'amylase du houblon?", ["0°C", "18-22°C (fermentation)", "60°C", "100°C"], 1, "Optimum enzymatique à température ambiante.")
    ]
  },
  {
    id: "stockageHoublon",
    category: "HOUBLON",
    title: "12. Stockage du houblon (HSI)",
    ficheRich: [
      { title: "Facteurs de Dégradation (Oxydation)", items: [
        "Le houblon est chimiquement très instable. Les facteurs de dégradation principaux sont l'**oxygène** (O2), la **chaleur** et la **lumière**.",
        "**Perte d'Amertume**: L'oxydation des acides alpha les transforme en composés moins amers ou amers avec un profil désagréable. Une perte de 30-50 % d'acides alpha peut se produire en un an à température ambiante.",
        "**Création d'Off-Flavours**: L'oxydation du Myrcène et des acides bêta produit de l'**acide isovalérique**, responsable d'un arôme d'**acidité butyrique, de fromage rance ou de chaussettes** (off-flavour majeur)."
      ]},
      { title: "Méthodes de Stockage Optimal", items: [
        "**Température**: Stockage au **congélateur (idéalement -20°C)** pour ralentir au maximum les réactions chimiques d'oxydation.",
        "**Oxygène**: Conditionnement sous **vide** ou purge à l'**Azote** pour éliminer l'oxygène résiduel (dans des sacs multicouches/métallisés).",
        "**Lumière**: Protéger absolument de la lumière (UV et visible), qui catalyse des réactions de dégradation (notamment la création de l'off-flavour 'Skunky' ou 'mouffette')."
      ]},
      { title: "HSI (Hop Storage Index)", items: [
        "**Indice HSI**: Un indicateur spectrophotométrique utilisé pour évaluer la qualité et la fraîcheur. Il mesure le ratio des produits d'oxydation sur les acides alpha/bêta restants.",
        "**Interprétation**: Un **HSI élevé** indique que le houblon est **âgé ou mal conservé**. Les brasseurs utilisent le HSI pour ajuster les taux d'ajout ou déterminer la durée de vie commerciale du houblon."
      ]}
    ],
    questions: [
      q("Comment stocker le houblon?", ["Au chaud et à l'air libre", "Au frais/sous vide et à l'abri de la lumière", "En pleine lumière", "À pH neutre"], 1, "Froid, vide et obscurité sont essentiels."),
      q("Que mesure l'indice HSI?", ["Teneur en huile", "Taux d'humidité", "Degré d'oxydation/dégradation du houblon", "Isomérisation"], 2, "Indicateur de perte de qualité."),
      q("Oxydation des acides alpha → ?", ["Stabilité", "Perte d'amertume (composés moins agréables)", "Hausse IBU", "Réaction protéique"], 1, "Dégradation chimique."),
      q("Arôme de l'acide isovalérique?", ["Fruité", "Fromage rance/chaussette", "Sucré", "Vanille"], 1, "Signature off-flavour de la bière oxydée."),
      q("Perte d'acides alpha en un an (ambiante)?", ["5%", "30–50%", "<1%", "100%"], 1, "Instabilité du houblon."),
      q("Oxydation du myrcène produit…", ["Stabilité", "Acide valérianique (off-flavour)", "Plus d'arôme", "Du sucre"], 1, "Dégradation du terpène."),
      q("Température idéale de stockage?", ["–5°C", "≈ –20°C", "0°C", "20°C"], 1, "Ralentit fortement l'oxydation."),
      q("Pourquoi le vide?", ["Expose l'O2", "Élimine l'O2, freine l'oxydation", "Air meilleur", "Inchangé"], 1, "Chimie oxydoréductive."),
      q("Purge à l'azote : rôle?", ["Nourrir la levure", "Remplacer l'O2 par N2 inerte", "Tuer les arômes", "Acidifier"], 1, "Atmosphère inerte protectrice."),
      q("Effet de la lumière UV?", ["Bénéfique", "Dégradation photochimique (skunky)", "Neutre", "Améliore arômes"], 1, "Photochimie destructive."),
      q("Pourquoi des sacs métallisés?", ["Esthétique", "Barrière lumière + O2", "Plastique clair suffit", "Tissu"], 1, "Emballage protecteur."),
      q("Calcul du HSI?", ["Couleur", "Ratio d'absorbance oxydation/acides restants", "Poids", "Temps"], 1, "Mesure spectro."),
      q("HSI élevé signifie…", ["Fraîcheur", "Houblon âgé/mal conservé", "Jeune", "Excellent stock"], 1, "Indicateur inverse de qualité."),
      q("Dégradation vs température?", ["Linéaire", "Exponentielle (plus chaud = plus rapide)", "Nulle", "Négative"], 1, "Cinétique accélérée."),
      q("Pourquoi la date de récolte compte?", ["Sans importance", "Essentielle pour fraîcheur/HSI", "Peu relevante", "Oubliable"], 1, "Traçabilité."),
      q("Durée de conservation optimale?", ["Ambiante", "Congélateur + vide + obscurité", "Frigo simple", "Lumière"], 1, "Protocole pro."),
      q("Oxydation des acides bêta → ?", ["Jamais", "Amertume dure/végétale", "Améliore", "Aucun effet"], 1, "Vieillissement du houblon."),
      q("Pourquoi contrôler l'humidité?", ["Inutile", "Limiter dégradation/microbes", "Maximale", "Élevée préférable"], 1, "Prévenir moisissures et réactions."),
      q("Le houblon compressé conserve-t-il mieux?", ["Non", "Oui (moins de surface d'O2 exposée)", "Oxydation accrue", "Inchangé"], 1, "Optimisation empaquetage."),
      q("HSI > 50% indique…", ["Neuf", "Vieux ou mal stocké", "Moyen", "Parfait"], 1, "Seuil de qualité."),
      q("Puissance amérisante des AA oxydés?", ["Identique", "Réduite et moins agréable", "Augmentée", "Nulle"], 1, "Modification chimique."),
      q("Régénérer un houblon oxydé?", ["Facile", "Impossible (oxydation irréversible)", "Avec chauffage", "Sous vide"], 1, "Réaction irréversible."),
      q("Houblons nobles : dégradation?", ["Non", "Oui (faibles AA → sensibles)", "Moins vite", "Identique"], 1, "Vulnérabilité."),
      q("Azote sans froid suffit-il?", ["Oui", "Non (froid + inertage nécessaires)", "Parfois", "Toujours"], 1, "Combinaison requise."),
      q("Durée de vie à température ambiante?", ["2 ans", "Quelques mois", "5 ans", "Indéfinie"], 1, "Stabilité limitée."),
      q("Pellets se dégradent-ils plus vite que cônes?", ["Non", "Oui (surface exposée ↑)", "Identique", "Moins vite"], 1, "Structure rompue."),
      q("Off-flavour 'skunky' causé par?", ["Oxydation seule", "Lumière + houblon", "Fermentation", "Levure"], 1, "Lightstruck."),
      q("HSI bas est-il préférable?", ["Non", "Oui (fraîcheur/qualité)", "Identique", "Pire"], 1, "Indicateur de qualité."),
      q("Les extraits de houblon sont-ils plus stables?", ["Non", "Oui (process stabilise)", "Identique", "Moins stables"], 1, "Avantage technologique."),
      q("Gaz utilisé pour purger les emballages?", ["Oxygène", "Azote (inerte)", "CO2", "Hydrogène"], 1, "Atmosphère protectrice standard.")
    ]
  },
  {
    id: "epices",
    category: "ÉPICES",
    title: "13. Les Épices en brassage",
    ficheRich: [
      { title: "Épices Courantes et Profils", items: [
        "**Coriandre (graines)**: Profil citronné, épicé, légèrement poivré. Utilisée dans les Witbier belges. Dosage typique: 10-20 g/hL, ajout à 5-10 min d'ébullition ou flameout.",
        "**Écorce d'orange (Curaçao)**: Notes d'agrumes, amertume légère. Complémente la coriandre dans les Witbier. Dosage: 5-15 g/hL, ajout tardif (5-10 min).",
        "**Gingembre frais**: Piquant, chaleureux, citronné. Utilisé dans les bières d'hiver et Ginger Beer. Dosage: 20-50 g/hL, ajout flameout ou fermentation.",
        "**Cannelle (bâtons)**: Chaude, sucrée, épicée. Pour bières de Noël, Pumpkin Ale. Dosage: 5-10 g/hL, ajout fin d'ébullition ou maturation.",
        "**Clou de girofle**: Très puissant, médicinal à haute dose. Notes chaudes, épicées. Dosage: 1-3 g/hL, ajout avec parcimonie.",
        "**Cardamome**: Complexe, citronné, mentholé, épicé. Dosage: 3-8 g/hL, ajout flameout.",
        "**Poivre (noir, rose)**: Épicé, piquant. Dosage: 5-15 g/hL, ajout tardif pour préserver arômes volatils.",
        "**Vanille (gousses)**: Notes sucrées, vanillées, crémeuses. Dosage: **2-4 gousses par hectolitre**. Ajout en macération froide (fermentation secondaire) pendant 1-2 semaines pour extraction optimale des arômes complexes sans apporter d'astringence."
      ]},
      { title: "Timing et Extraction", items: [
        "**Ébullition longue (30-60 min)**: Extraction maximale mais perte d'arômes volatils. Réservé aux épices dont on veut l'amertume/profondeur (cannelle, gingembre sec).",
        "**Flameout/Whirlpool (0-10 min)**: Compromis idéal. Extraction des composés aromatiques sans trop de volatilisation (coriandre, orange, cardamome).",
        "**Fermentation/Maturation**: Macération à froid pour épices très volatiles ou délicates. Permet extraction douce sans cuisson (vanille, cannelle en bâton, gingembre frais).",
        "**Teinture alcoolique**: Macération d'épices dans alcool neutre (vodka), puis ajout contrôlé à l'embouteillage. Permet dosage précis et évite contamination."
      ]},
      { title: "Considérations Techniques", items: [
        "**Forme de l'épice**: Entière (lente extraction, profil subtil) vs Moulue (extraction rapide, intense, risque de sur-épicage).",
        "**Huiles essentielles**: Très volatiles. Sensibles à la chaleur et à l'oxydation. Préférer ajouts tardifs.",
        "**Équilibre**: Les épices peuvent dominer facilement. Toujours commencer avec dosages conservateurs et ajuster progressivement.",
        "**Interaction levure**: Certaines épices (clou de girofle, cannelle haute dose) peuvent inhiber la levure ou créer stress fermentaire."
      ]}
    ],
    questions: [
      q("Quelle épice est caractéristique de la Witbier belge?", ["Cannelle", "Coriandre + écorce d'orange", "Vanille", "Gingembre"], 1, "Duo classique des bières blanches belges."),
      q("Quel est le dosage typique de coriandre?", ["1-2 g/hL", "10-20 g/hL (arôme marqué)", "100 g/hL", "Traces"], 1, "Dose pour profil aromatique caractéristique."),
      q("Quand ajouter la coriandre?", ["60 min d'ébullition", "5-10 min fin ébullition ou flameout (préserve arômes)", "Empâtage", "Embouteillage"], 1, "Timing optimal extraction/préservation."),
      q("L'écorce d'orange apporte quel profil?", ["Floral sucré", "Agrumes + légère amertume", "Épicé piquant", "Terreux"], 1, "Caractère citrique typique."),
      q("Le gingembre frais est ajouté quand?", ["Empâtage", "Flameout ou fermentation (préserve piquant)", "60 min ébullition", "Jamais"], 1, "Composés volatils sensibles chaleur."),
      q("Pourquoi le clou de girofle doit être dosé avec parcimonie?", ["Pas puissant", "Très puissant, médicinal à haute dose (1-3 g/hL max)", "Neutre", "Inefficace"], 1, "Intensité aromatique extrême."),
      q("La cannelle en bâton vs moulue?", ["Identiques", "Bâton = extraction lente/subtile, Moulue = rapide/intense", "Inverse", "Bâton inefficace"], 1, "Cinétique d'extraction différente."),
      q("Quel dosage pour la cannelle?", ["50 g/hL", "5-10 g/hL (chaleur épicée)", "100+ g/hL", "1 g/hL"], 1, "Dose équilibrée pour profil hivernal."),
      q("La cardamome apporte quel profil?", ["Uniquement sucré", "Complexe: citronné/mentholé/épicé", "Amer fort", "Neutre"], 1, "Complexité aromatique multicouche."),
      q("L'ajout d'épices en ébullition longue cause quoi?", ["Optimal", "Perte arômes volatils (extraction composés lourds)", "Plus d'arôme", "Neutre"], 1, "Volatilisation thermique."),
      q("Qu'est-ce qu'une teinture d'épices?", ["Infusion eau", "Macération dans alcool neutre puis dosage contrôlé", "Poudre sèche", "Ébullition"], 1, "Technique de dosage précis."),
      q("Avantage d'une teinture alcoolique?", ["Moins efficace", "Dosage précis + évite contamination (ajout post-fermentation)", "Plus lente", "Interdit"], 1, "Contrôle et hygiène."),
      q("Les épices moulues vs entières: extraction?", ["Identique", "Moulues = rapide/intense, Entières = lente/subtile", "Inverse", "Entières plus rapides"], 1, "Surface de contact déterminante."),
      q("Pourquoi débuter avec dosages conservateurs?", ["Économie", "Épices peuvent dominer facilement (ajustement progressif)", "Tradition", "Réglementation"], 1, "Équilibre sensoriel délicat."),
      q("Certaines épices peuvent inhiber quoi?", ["Houblon", "Levure (stress fermentaire à haute dose)", "Enzymes du malt", "Eau"], 1, "Toxicité microbienne potentielle."),
      q("Le poivre est ajouté quand?", ["Empâtage", "Ajout tardif (préserve piquant aromatique)", "60 min", "Jamais en bière"], 1, "Volatilité des composés pipérinés."),
      q("La vanille est généralement ajoutée…", ["Ébullition", "Maturation/fermentation secondaire (macération froide)", "Empâtage", "Flameout"], 1, "Extraction délicate arômes complexes."),
      q("Les bâtons de vanille sont macérés combien de temps?", ["1 heure", "1-2 semaines en fermentation secondaire", "5 minutes", "Instantané"], 1, "Extraction lente composés aromatiques."),
      q("Le dosage de vanille (gousses) est typiquement…", ["1 gousse/100L", "2-4 gousses/hL (profil marqué)", "20 gousses/hL", "Traces"], 1, "Intensité aromatique désirée."),
      q("Les huiles essentielles d'épices sont…", ["Stables chaleur", "Très volatiles et sensibles chaleur/oxydation", "Résistantes", "Inertes"], 1, "Fragilité thermochimique."),
      q("Quel style utilise typiquement gingembre + agrumes?", ["Stout", "Witbier ou Bière d'été", "IPA classique", "Porter"], 1, "Profil rafraîchissant caractéristique."),
      q("Les Pumpkin Ales utilisent quelles épices?", ["Houblon seul", "Cannelle, muscade, gingembre, clou de girofle (pumpkin spice)", "Coriandre seule", "Vanille seule"], 1, "Mélange épices automnal typique."),
      q("La muscade est dosée comment?", ["50 g/hL", "1-3 g/hL (très puissante, notes chaudes)", "100 g/hL", "Traces négligeables"], 1, "Intensité aromatique forte."),
      q("L'anis étoilé apporte quel profil?", ["Agrumes", "Réglisse/anisé (2-5 g/hL)", "Floral", "Amer"], 1, "Caractère réglissé distinctif."),
      q("Les épices peuvent-elles créer du trouble?", ["Non", "Oui, particules en suspension (filtration parfois nécessaire)", "Jamais", "Clarifient"], 1, "Matière particulaire résiduelle."),
      q("Le cacao (fèves) est ajouté quand?", ["Empâtage", "Maturation froide (évite extraction tannins amers)", "60 min ébullition", "Flameout"], 1, "Prévention astringence."),
      q("Les piments (chili) apportent…", ["Douceur", "Piquant/chaleur capsaïcine (1-5 g/hL)", "Amertume houblon", "Acidité"], 1, "Sensation trigéminale brûlante."),
      q("Le timing optimal pour épices délicates?", ["Ébullition 60 min", "Flameout ou fermentation (préservation maximale)", "Empâtage", "Jamais"], 1, "Protection arômes volatils."),
      q("Les épices peuvent-elles oxyder?", ["Non jamais", "Oui, oxydation modifie profil aromatique (stockage sous vide)", "Impossible", "S'améliorent"], 1, "Dégradation oxydative arômes."),
      q("Comment tester un nouveau dosage d'épice?", ["Directement dans brassin", "Teinture test sur échantillon (ajustement avant production)", "Au hasard", "Maximum dose"], 1, "Validation sensorielle préventive.")
    ]
  },
  {
    id: "fruits",
    category: "ÉPICES",
    title: "14. Les Fruits en brassage",
    ficheRich: [
      { title: "Formes de Fruits", items: [
        "**Fruits frais**: Saveur authentique, mais apportent eau, pectine (trouble), levures/bactéries sauvages (risque contamination). Nécessitent pasteurisation ou ajout en fermentation active (alcool + CO2 protègent).",
        "**Purée aseptique**: Pasteurisée, sans pectine ajoutée. Pratique et sûre microbiologiquement. Concentration aromatique constante. Dosage: 10-30% du volume final.",
        "**Concentré de fruit**: Très concentré, stable. Permet dosage précis. Mais parfois profil 'artificiel' si mal choisi. Dosage: 2-5% volume.",
        "**Extraits/arômes**: Dosage très précis (mL/hL). Profil constant mais moins 'naturel'. Ajout à l'embouteillage. Utile pour ajustements fins.",
        "**Fruits lyophilisés**: Déshydratés, légers, longue conservation. Arômes concentrés. Réhydratation en fermentation. Dosage: 0.5-2 kg/hL."
      ]},
      { title: "Timing et Techniques", items: [
        "**Fermentation primaire active**: Idéal pour fruits frais. L'activité fermentaire et l'alcool protègent contre contamination. CO2 purge oxygène. Inconvénient: perte d'arômes volatils par fermentation.",
        "**Fermentation secondaire**: Après fermentation principale. Macération froide (~5-10 jours). Préserve mieux les arômes frais/délicats. Nécessite fruits pasteurisés ou purée aseptique.",
        "**Embouteillage/Packaging**: Extraits uniquement (dosage contrôlé, pas de refermentation)."
      ]},
      { title: "Considérations Techniques", items: [
        "**Refermentation**: Les fruits apportent des sucres fermentescibles (fructose, glucose). Calculer l'atténuation supplémentaire et la production de CO2 pour éviter surpression.",
        "**Pectine**: Polysaccharide des fruits. Cause trouble persistant (voile pectique). Solution: **enzymes pectinases** (ajout avant/pendant macération) pour hydrolyser la pectine.",
        "**Acidité**: Les fruits acidifient la bière (acide citrique, malique). Peut être souhaité (Berliner Weisse aux fruits, Sour) ou nécessiter équilibrage.",
        "**Couleur**: Les fruits rouges/noirs peuvent colorer intensément. Tenir compte dans formulation (dilution couleur possible).",
        "**Oxydation**: Fruits frais exposent à l'oxygène. Ajouter en fermentation active (CO2 protège) ou purger à l'azote."
      ]}
    ],
    questions: [
      q("Quel est le risque principal des fruits frais?", ["Aucun", "Contamination microbiologique (levures/bactéries sauvages)", "Trop chers", "Couleur fade"], 1, "Flore microbienne naturelle des fruits."),
      q("Comment protéger contre la contamination des fruits frais?", ["Impossible", "Ajout en fermentation active (alcool + CO2 protègent)", "Ébullition 60 min", "Ignorer"], 1, "Environnement hostile aux contaminants."),
      q("Qu'est-ce que la purée aseptique?", ["Fruit cru", "Purée pasteurisée, stable microbiologiquement", "Jus concentré", "Lyophilisé"], 1, "Traitement thermique sécurisant."),
      q("Quel dosage typique pour purée de fruits?", ["1%", "10-30% du volume final (intensité aromatique)", "50%", "Traces"], 1, "Proportion pour profil marqué."),
      q("Les fruits apportent quels sucres?", ["Lactose", "Fructose et glucose (fermentescibles)", "Dextrines", "Aucun"], 1, "Sucres simples fermentés par levure."),
      q("Qu'est-ce que la refermentation fruitée?", ["Impossible", "Levure consomme sucres fruits → alcool + CO2 supplémentaires", "Arrêt fermentation", "Contamination"], 1, "Fermentation secondaire des sucres fruits."),
      q("Comment calculer l'impact des fruits sur l'alcool?", ["Ignorer", "Estimer sucres ajoutés (°Brix) et atténuation levure", "Impossible", "Au hasard"], 1, "Prédiction densité finale ajustée."),
      q("Qu'est-ce que la pectine?", ["Sucre", "Polysaccharide des fruits (cause trouble persistant)", "Protéine", "Levure"], 1, "Source de voile pectique."),
      q("Comment éliminer le trouble pectique?", ["Filtration seule", "Enzymes pectinases (hydrolysent pectine)", "Impossible", "Chauffage"], 1, "Hydrolyse enzymatique ciblée."),
      q("Quand ajouter les pectinases?", ["Après embouteillage", "Avant/pendant macération fruits (prévention trouble)", "Jamais", "Empâtage"], 1, "Traitement préventif optimal."),
      q("Les fruits acidifient-ils la bière?", ["Non", "Oui, acides organiques (citrique, malique) abaissent pH", "Alcalinisent", "Neutre"], 1, "Contribution acide naturelle."),
      q("Quel style utilise typiquement fruits + acidité?", ["Stout", "Berliner Weisse, Gose, Lambic aux fruits", "IPA", "Lager"], 1, "Styles acides/sour avec fruits."),
      q("Les fruits rouges/noirs peuvent…", ["Éclaircir", "Colorer intensément la bière", "Pas d'effet", "Clarifier"], 1, "Pigments anthocyanes puissants."),
      q("Quand ajouter fruits en fermentation primaire?", ["Avant levure", "Pendant activité fermentaire (2-3 jours après pitch)", "Fin fermentation", "Jamais"], 1, "Protection maximale CO2 et alcool."),
      q("Quand ajouter fruits en fermentation secondaire?", ["Jamais", "Après fermentation principale (macération froide 5-10 jours)", "Pendant ébullition", "Embouteillage"], 1, "Préservation arômes délicats."),
      q("Quel avantage de la fermentation secondaire pour fruits?", ["Aucun", "Préserve arômes frais/délicats (pas de blow-off)", "Plus rapide", "Moins cher"], 1, "Rétention aromatique maximale."),
      q("Les fruits frais apportent-ils de l'oxygène?", ["Non", "Oui, risque oxydation (ajouter en fermentation active)", "Jamais", "Réduisent O2"], 1, "Exposition atmosphérique lors ajout."),
      q("Comment doser les extraits de fruits?", ["Kg/hL", "mL/hL (dosage précis goutte à goutte)", "%, volume", "Au jugé"], 1, "Concentration élevée = micro-dosage."),
      q("Les extraits peuvent être ajoutés quand?", ["Ébullition", "Embouteillage/packaging (dosage final contrôlé)", "Empâtage", "Fermentation primaire"], 1, "Ajustement post-fermentation."),
      q("Quel est l'avantage des fruits lyophilisés?", ["Moins aromatiques", "Légers, stables, arômes concentrés (longue conservation)", "Frais uniquement", "Interdits"], 1, "Praticité et stabilité."),
      q("Dosage typique fruits lyophilisés?", ["10 kg/hL", "0.5-2 kg/hL (concentration élevée)", "Traces", "50 kg/hL"], 1, "Déshydratation = concentration."),
      q("Peut-on ajouter fruits à l'ébullition?", ["Idéal", "Possible mais perte arômes volatils + extraction pectine/tannins", "Obligatoire", "Interdit"], 1, "Dégradation thermique aromatique."),
      q("Les framboises apportent quel profil?", ["Neutre", "Fruité intense, acidité naturelle (acide éllagique)", "Sucré seul", "Amer"], 1, "Caractère acide-fruité typique."),
      q("Les cerises (griottes) sont utilisées dans…", ["IPA", "Kriek (Lambic belge aux cerises)", "Stout uniquement", "Lager"], 1, "Style traditionnel belge."),
      q("La mangue apporte quel profil?", ["Acide fort", "Tropical fruité intense (esters naturels)", "Amer", "Neutre"], 1, "Arôme exotique caractéristique."),
      q("Le fruit de la passion contient…", ["Peu de saveur", "Acidité marquée + arômes tropicaux intenses", "Neutre", "Uniquement sucre"], 1, "Intensité aromatique et acide."),
      q("Les myrtilles peuvent causer…", ["Clarification", "Coloration violette intense + trouble pectique", "Éclaircissement", "Aucun effet"], 1, "Pigmentation anthocyanique forte."),
      q("Comment pasteuriser des fruits?", ["Ébullition 60 min", "Chauffage 70-80°C pendant 15-30 min (tue microbes)", "Congélation", "Impossible"], 1, "Traitement thermique modéré."),
      q("La congélation des fruits aide-t-elle?", ["Aucun effet", "Oui, rompt cellules (facilite extraction) + réduit charge microbienne", "Détruit arômes", "Interdit"], 1, "Rupture membranaire et hygiène."),
      q("Quel fruit est typique des Lambics belges?", ["Banane", "Framboise, cerise, pêche (fermentation spontanée + fruits)", "Ananas", "Pomme verte"], 1, "Tradition brassicole belge fruité.")
    ]
  },

  // 22. Pathologie du grain (Fusarium)

  // 23. Introduction à l'hygiène en brasserie
  {
    id: "hygieneBrasserie",
    category: "CIP",
    title: "15. Introduction à l'hygiène en brasserie",
    ficheRich: [
      {
        title: "Contexte et Importance",
        items: [
          "**L'hygiène est le pilier fondamental** de la production de bière de qualité. Une bière infectée ne correspondra jamais aux attentes du brasseur, peu importe la qualité des ingrédients ou la maîtrise du processus de brassage.",
          "**Principe de Conservation**: Le produit doit pouvoir se conserver dans le temps et rester tel que désiré. Si une bière est infectée, elle ne sera plus ce que vous avez voulu faire et offrir au client.",
          "**Prévention > Traitement**: Les micro-organismes sont partout et se développent rapidement. La prévention est toujours plus efficace que le traitement d'une contamination établie."
        ]
      },
      {
        title: "Bière 'Clean' vs Bière 'Wild' (Sauvage)",
        items: [
          "**Bière Clean**: Fermentée uniquement avec des **levures sélectionnées** (*Saccharomyces*). Goût **maîtrisé et reproductible**. C'est l'objectif standard de la majorité des brasseries commerciales.",
          "**Bière Wild/Sauvage**: Fermentée avec des **micro-organismes sauvages** (intentionnellement ou non). Profil aromatique complexe, souvent 'funky', acidité spontanée. Exemples : Lambics belges, Gueuze, certains Sours artisanaux.",
          "**Distinction Critique**: La différence est **l'intentionnalité** et le **contrôle**. Une bière sauvage est voulue et maîtrisée. Une bière clean infectée est un défaut."
        ]
      },
      {
        title: "Micro-organismes Impliqués",
        items: [
          "**Saccharomyces cerevisiae** (Levure eucaryote) : Levure principale de fermentation. Possède un **noyau** (eucaryote). Fermentation alcoolique contrôlée. Production éthanol + CO₂.",
          "**Brettanomyces** (Levure sauvage) : Donne des arômes **'funky', cuir, ferme, phénoliques**. Parfois recherchés (Lambics, Saisons), souvent indésirables dans bières clean.",
          "**Lactobacilles** (Bactéries lactiques) : Produisent **acide lactique** → acidité douce, tangy. Utilisés intentionnellement (Berliner Weisse, Gose) ou contamination.",
          "**Pédocoques** (Bactéries lactiques) : Contamination généralement **indésirable**. Production acide lactique + diacétyle (beurre rancide). Croissance lente mais persistante.",
          "**Acétobactères** (Bactéries acétiques) : Produisent **acide acétique** (vinaigre) en présence d'oxygène. Défaut majeur → bière imbuvable. Indicateur de mauvaise hygiène ou exposition à l'air."
        ]
      },
      {
        title: "Équipements Concernés (Post-Ébullition)",
        items: [
          "**Zone Critique**: Tout équipement en contact avec le **moût froid** (post-ébullition) ou la **bière** doit être **aseptique**.",
          "**Équipements à risque**: Cuves de refroidissement, échangeurs de chaleur, **fermenteurs**, tuyaux et raccords, vannes, pompes, embouteillage/conditionnement.",
          "**Pré-ébullition**: Les cuves de brassage et d'ébullition sont stérilisées par la chaleur (> 100°C). Hygiène importante mais risque moindre.",
          "**Nettoyage vs Désinfection**: Nettoyage = élimination saleté/résidus. Désinfection = destruction micro-organismes. Les deux sont nécessaires séquentiellement."
        ]
      }
    ],
    questions: [
      q("L'hygiène en brasserie, c'est...?", ["Optionnelle", "Le pilier de la qualité", "Secondaire", "Esthétique"], 1, "Base essentielle de la production de bière réussie."),
      q("Une bière 'clean' fermente avec...?", ["Micro-organismes sauvages", "Levures sélectionnées Saccharomyces", "Bactéries lactiques", "Un mélange aléatoire"], 1, "Contrôle strict pour reproductibilité."),
      q("Une bière 'wild' se caractérise par...?", ["Goût standardisé", "Fermentation avec micro-organismes sauvages", "Production industrielle", "Sans levure"], 1, "Complexité aromatique volontairement recherchée."),
      q("Saccharomyces cerevisiae est...?", ["Une bactérie", "Une levure eucaryote", "Un virus", "Un champignon filamenteux"], 1, "Levure principale de fermentation."),
      q("Brettanomyces produit des arômes...", ["Fruité doux", "Funky/cuir/phénoliques", "Neutre", "Floral"], 1, "Signature aromatique de cette levure sauvage."),
      q("Les lactobacilles produisent...?", ["De l'éthanol", "De l'acide lactique", "De l'acide acétique", "Du CO₂ uniquement"], 1, "Bactéries lactiques créant de l'acidité."),
      q("Les pédocoques sont...?", ["Toujours recherchés", "Généralement indésirables (acide lactique + diacétyle)", "Bénéfiques", "Neutres"], 1, "Défaut de qualité fréquent."),
      q("Les acétobactères produisent...?", ["De l'alcool", "De l'acide acétique (vinaigre)", "Des sucres", "De la mousse"], 1, "Défaut majeur en présence d'oxygène."),
      q("Conséquence d'une infection de bière?", ["Amélioration", "Goût changé irrémédiablement", "Aucun effet", "Stabilisation"], 1, "Perte totale du contrôle du produit."),
      q("Prévention ou traitement : meilleur choix?", ["Traitement", "Prévention", "Égalité", "Incomparable"], 1, "Approche proactive de l'hygiène."),
      q("Où se trouvent les micro-organismes?", ["Absents", "Partout", "Rares", "Totalement contrôlables"], 1, "Risque de contamination constant."),
      q("Équipement propre = ?", ["Esthétique", "Base d'une bière réussie", "Marketing", "Optionnel"], 1, "Qualité fondamentale en brasserie."),
      q("Zone critique de contamination?", ["Avant ébullition", "Après ébullition (moût froid/bière)", "Empâtage", "Mouture"], 1, "Absence de stérilisation thermique."),
      q("Effet de l'ébullition sur les microbes?", ["Aucun", "Stérilise (>100°C)", "Les favorise", "Variable"], 1, "Barrière thermique efficace."),
      q("Hygiène du fermenteur?", ["Peu importante", "Critique", "Optionnelle", "Visuelle"], 1, "Risque de contamination très élevé."),
      q("Nettoyage = ?", ["Détruire microbes", "Retirer saletés/résidus", "Désinfection", "Stérilisation"], 1, "Première étape du protocole."),
      q("Désinfection = ?", ["Nettoyage physique", "Détruire micro-organismes", "Rinçage", "Séchage"], 1, "Élimination biologique des microbes."),
      q("Séquence correcte?", ["Désinfection puis nettoyage", "Nettoyage puis désinfection", "Simultané", "Aléatoire"], 1, "Protocole standard en brasserie."),
      q("Le Brettanomyces dans un Lambic est...?", ["Une contamination", "Intentionnel", "Une erreur", "Accidentel"], 1, "Style traditionnel belge volontaire."),
      q("Le diacétyle (beurre) est produit par...?", ["Une levure saine", "Pédocoques/levure stressée", "Le houblon", "Le malt"], 1, "Off-flavour caractéristique d'une contamination."),
      q("Les acétobactères ont-ils besoin d'oxygène?", ["Non", "Oui (bactéries aérobies)", "Variable", "Jamais"], 1, "Métabolisme acétique aérobie."),
      q("Les lactobacilles d'une Berliner Weisse sont...?", ["Une contamination", "Utilisés intentionnellement", "À éviter", "Interdits"], 1, "Contrôle volontaire pour les Sour beers."),
      q("Conservation d'une bière infectée?", ["Normale", "Impossible, les défauts évoluent", "Mieux qu'une bière saine", "Sans impact"], 1, "Instabilité microbiologique progressive."),
      q("Hygiène des vannes/raccords?", ["Négligeable", "Critique (zones mortes/biofilm)", "Automatique", "Inutile"], 1, "Points de contamination très fréquents."),
      q("Nettoyage des tuyaux?", ["Extérieur seulement", "Intérieur (surface en contact produit)", "Optionnel", "Visuel suffisant"], 1, "Surface de contact direct avec la bière."),
      q("Un biofilm, c'est...?", ["Un résidu de malt", "Communauté de microbes adhérents", "De la mousse", "De la levure seule"], 1, "Structure résistante au nettoyage."),
      q("Température de stockage de la bière?", ["Élevée", "Froide", "Ambiante", "Variable"], 1, "Conservation microbiologique optimale."),
      q("Impact d'un pH bas (<4.5)?", ["Neutre", "Inhibe de nombreux microbes", "Les favorise", "Sans effet"], 1, "Barrière naturelle de protection."),
      q("Le houblon est-il antimicrobien?", ["Aucune", "Oui (acides alpha/iso-alpha)", "Négatif", "Mythe"], 1, "Défense naturelle partielle de la bière."),
      q("Effet de l'éthanol sur les microbes?", ["Les favorise", "Les inhibe", "Neutre", "Variable"], 1, "Barrière alcoolique protectrice.")
    ]
  },
  {
    id: "cip",
    category: "CIP",
    title: "16. Le système CIP/SIP et les paramètres TACCT",
    ficheRich: [
      {
        title: "Définitions",
        items: [
          "CIP - Clean In Place (Nettoyage En Place / NEP) : Système permettant de nettoyer l'intérieur des équipements sans les démonter, par circulation de solutions de nettoyage.",
          "SIP - Sanitizing In Place : Système permettant de désinfecter l'intérieur des équipements sans les démonter."
        ]
      },
      {
        title: "Les 5 paramètres TACCT",
        items: [
          "T - Time to clean (Temps de nettoyage) : Durée de contact entre le produit nettoyant et la surface. Plus le temps est long, plus le nettoyage est efficace. Valeur typique : **15-30 minutes** pour la soude en CIP standard (30-60 minutes pour encrassements lourds ou cuves de grande capacité).",
          "A - Action impact (Action mécanique et chimique) : Force mécanique exercée par le liquide sur les surfaces (pression, débit, turbulence). Décolle les salissures adhérentes. Équipement : boules d'arrosage, pompes propulseuses.",
          "C - Coverage (Surface couverte) : Pourcentage de surface atteinte par le liquide nettoyant. Objectif : 100% de couverture. Problèmes : zones mortes, angles, soudures mal conçues.",
          "C - Chemical concentration (Concentration chimique) : Quantité de produit actif dans la solution. Contrôle par sonde de concentration et conductivimètre. Valeur typique soude : 2% NaOH (~100 mS/cm).",
          "T - Temperature (Température) : Température de la solution de nettoyage. La chaleur améliore l'efficacité chimique. Valeur typique : 60-80°C pour la soude."
        ]
      },
      {
        title: "Cercle de Sinner",
        items: [
          "Principe : Si on diminue un paramètre, il faut compenser en augmentant un ou plusieurs autres.",
          "Les 4 facteurs interdépendants : Temps, Chimie, Mécanique, Température.",
          "Points clés : Les 5 paramètres TACCT sont interdépendants, aucun ne doit être négligé, le contrôle (sondes, conductivimètre) est essentiel, la conception de l'équipement influence la couverture."
        ]
      }
    ],
    questions: [
      q("CIP signifie...?", ["Clean In Process", "Clean In Place (Nettoyage en place)", "Chemical In Process", "Cold In Place"], 1, "Système de nettoyage sans démontage."),
      q("SIP signifie...?", ["Sanitizing In Process", "Sanitizing In Place", "Sterilizing In Process", "System In Place"], 1, "Système de désinfection sans démontage."),
      q("Atout majeur du CIP?", ["Coût réduit", "Nettoyer sans démonter", "Plus rapide", "Moins de produit"], 1, "Gain de temps et efficacité opérationnelle."),
      q("Premier T de TACCT?", ["Température", "Time to clean (temps de contact)", "Turbulence", "Traitement"], 1, "Durée de contact avec la solution nettoyante."),
      q("A de TACCT?", ["Alcalinité", "Action impact (mécanique/chimique)", "Automatisation", "Acidité"], 1, "Force mécanique exercée par le liquide."),
      q("Premier C de TACCT?", ["Chemical concentration", "Coverage (surface couverte)", "Contrôle", "Conductivité"], 1, "Pourcentage de surface atteinte."),
      q("Deuxième C de TACCT?", ["Coverage", "Chemical concentration", "Contrôle", "Chaleur"], 1, "Quantité de produit actif dans la solution."),
      q("Deuxième T de TACCT?", ["Temps", "Turbulence", "Température", "Traçabilité"], 1, "Température de la solution de nettoyage."),
      q("Temps de contact standard du détergent CIP?", ["5-10 min", "15-30 min", "30-60 min (cas lourds)", "2-3 h"], 1, "Temps standard CIP. 30-60 min pour encrassements lourds."),
      q("Temps trop court → ?", ["Aucun effet", "Meilleure efficacité", "Nettoyage incomplet", "Économies de produit"], 2, "Temps insuffisant pour éliminer les salissures."),
      q("Action mécanique dépend de...?", ["Couleur du liquide", "Pression, débit, turbulence", "pH uniquement", "Odeur"], 1, "Forces physiques de décollement."),
      q("Équipement pour l'action mécanique?", ["Filtres", "Boules d'arrosage/pompes", "Thermomètres", "pH-mètres"], 1, "Dispositifs générant la pression et le flux."),
      q("Objectif de couverture en CIP?", ["50% suffit", "75% minimum", "100% de la surface", "90%"], 2, "Toute la surface doit être nettoyée."),
      q("Problèmes typiques de couverture?", ["Température trop haute", "Zones mortes, angles, soudures mal conçues", "Débit trop fort", "Produit trop concentré"], 1, "Zones difficiles à atteindre par le liquide."),
      q("Comment suivre la concentration chimique?", ["À l'œil", "Sonde/conductivimètre", "Par le temps", "Par la température"], 1, "Mesure électrique de la conductivité."),
      q("Sous-dosage = ?", ["Corrosion", "Nettoyage inefficace", "Coût élevé", "Rinçage difficile"], 1, "Concentration insuffisante pour nettoyer."),
      q("Surdosage = ?", ["Nettoyage incomplet", "Corrosion, coût, rinçage difficile", "Aucun risque", "Temps réduit"], 1, "Effets négatifs de l'excès de chimie."),
      q("Concentration typique de soude?", ["0.5%", "1%", "2%", "5%"], 2, "Dosage standard pour le nettoyage alcalin."),
      q("Conductivité pour 2% NaOH?", ["10 mS/cm", "50 mS/cm", "100 mS/cm", "200 mS/cm"], 2, "Mesure électrique correspondant à 2% NaOH."),
      q("Température typique soude CIP?", ["20-30°C", "40-50°C", "60-80°C", "90-100°C"], 2, "Température optimale pour l'efficacité alcaline."),
      q("Effet de la température sur le nettoyage?", ["Aucun effet", "Améliore l'efficacité chimique", "Réduit l'efficacité", "Variable selon les produits"], 1, "Accélération des réactions chimiques."),
      q("Précaution sur la température?", ["Toujours maximale", "Respecter les limites des matériaux et joints", "Pas d'importance", "Plus froid possible"], 1, "Protection des équipements contre la dégradation."),
      q("Cercle de Sinner = ?", ["Un équipement CIP", "L'interdépendance des paramètres de nettoyage", "Une marque de détergent", "Un type de cuve"], 1, "Modèle conceptuel du nettoyage."),
      q("Combien de facteurs dans le cercle de Sinner?", ["2", "3", "4 (Temps, Chimie, Mécanique, Température)", "5"], 2, "4 paramètres interdépendants."),
      q("Principe du cercle de Sinner?", ["Tous égaux toujours", "Si un paramètre baisse, les autres doivent compenser", "Indépendants", "Seule la température compte"], 1, "Compensation nécessaire entre facteurs."),
      q("Si on réduit le temps de nettoyage...?", ["Rien", "Augmenter température et/ou concentration et/ou action mécanique", "Réduire la température", "Arrêter le CIP"], 1, "Équilibre par compensation des autres paramètres."),
      q("Pourquoi les 5 paramètres TACCT sont-ils liés?", ["Par hasard", "Ils contribuent tous à l'efficacité globale", "Indépendants en réalité", "Seuls 2 sont liés"], 1, "Synergie nécessaire pour un nettoyage optimal."),
      q("Quel paramètre peut-on négliger?", ["Uniquement le temps", "Uniquement la température", "Aucun des 5 paramètres", "Seule la chimie"], 2, "Tous les paramètres sont essentiels."),
      q("Pourquoi contrôler en temps réel (sondes/conductivimètre)?", ["Pour la documentation", "Garantir concentration et température correctes", "Pour le coût", "Optionnel"], 1, "Vérification continue des paramètres critiques."),
      q("Impact du design équipement sur CIP?", ["Aucun", "Conception hygiénique améliore couverture et réduit zones mortes", "Complique le nettoyage", "Purement esthétique"], 1, "Design facilitant l'accès du liquide partout."),
    ]
  },
  {
    id: "materiaux",
    category: "CIP",
    title: "17. Les matériaux utilisés en brasserie",
    ficheRich: [
      {
        title: "Vue d'ensemble",
        items: [
          "Le choix du matériau pour les cuves et équipements est crucial car il influence : la résistance à la corrosion, la facilité de nettoyage, la durabilité, le goût de la bière, et le coût."
        ]
      },
      {
        title: "L'Acier avec revêtement",
        items: [
          "**Avantage** : Moins cher que l'inox.",
          "**Inconvénient majeur** : Si déchirure du revêtement → nid à bactéries qui s'installent et sont impossibles à déloger.",
          "**Problème** : Les micro-fissures dans le revêtement sont invisibles et créent des sources d'infections récurrentes.",
          "**Durabilité** : Moyenne à faible.",
          "**Recommandation** : ⚠️ À éviter pour usage professionnel intensif."
        ]
      },
      {
        title: "L'Aluminium",
        items: [
          "**Neutralité** : N'affecte pas le goût de la bière.",
          "**Protection** : Forme une couche d'oxyde protectrice en surface.",
          "**Coût** : Relativement économique.",
          "**Résistance aux acides** : Faible - les acides forts l'attaquent.",
          "**Résistance mécanique** : Mou, se déforme facilement.",
          "**Résistance au vide** : Mauvaise → risque de collapse (implosion).",
          "**Trous au niveau de la base** : Création de points d'infection.",
          "**Santé** : ⚠️ Liens suspectés entre aluminium et maladie d'Alzheimer.",
          "**Verdict** : ❌ Non recommandé pour un usage professionnel."
        ]
      },
      {
        title: "L'Inox (Acier inoxydable)",
        items: [
          "**Composition** : Acier allié contenant 17-20% de Chrome, 8-13% de Nickel, 2-3% de Molybdène.",
          "**Principe de protection** : La couche d'oxyde de chrome (film microscopique protecteur) se forme spontanément au contact de l'air et se régénère automatiquement si endommagée.",
          "**Inox 304** : Standard, alimentaire, le plus courant en brasserie.",
          "**Inox 316** : Contient Titane + Niobium, usage pharmaceutique, résistance accrue à la corrosion.",
          "**Entretien en cas de dommage** : Passivation mécanique (ponçage zone chauffée) ou passivation chimique (acide nitrique).",
          "**Signes de problème** : Changement de couleur (bleu, jaune) autour des soudures ou traces de rouille (contamination par du fer).",
          "**Danger du chlore chaud** : Crée des piqûres (pitting) → respecter température, pH, temps de contact, concentration.",
          "**Danger du fer** : Les éclats de fer font rouiller l'inox par contact → ne jamais utiliser d'outils en acier carbone sur l'inox.",
          "**Verdict** : ✅ Matériau de référence pour la brasserie professionnelle."
        ]
      },
      {
        title: "Tableau comparatif",
        items: [
          "**Résistance corrosion** : Acier revêtu ⭐, Aluminium ⭐⭐, Inox 304 ⭐⭐⭐⭐, Inox 316 ⭐⭐⭐⭐⭐",
          "**Facilité nettoyage** : Acier revêtu ⭐⭐, Aluminium ⭐⭐⭐, Inox 304 ⭐⭐⭐⭐⭐, Inox 316 ⭐⭐⭐⭐⭐",
          "**Durabilité** : Acier revêtu ⭐⭐, Aluminium ⭐⭐, Inox 304 ⭐⭐⭐⭐⭐, Inox 316 ⭐⭐⭐⭐⭐",
          "**Coût** : Acier revêtu ⭐⭐⭐⭐⭐, Aluminium ⭐⭐⭐⭐, Inox 304 ⭐⭐⭐, Inox 316 ⭐⭐",
          "**Recommandation** : Acier revêtu ❌, Aluminium ❌, Inox 304 ✅, Inox 316 ✅✅"
        ]
      }
    ],
    questions: [
      q("Impact du matériau choisi?", ["Esthétique seulement", "Corrosion/nettoyage/durabilité/goût/coût", "Aucun", "Secondaire"], 1, "Le matériau affecte la qualité et les coûts."),
      q("Inconvénient clé de l'acier revêtu?", ["Trop cher", "Déchirure = nid à bactéries", "Impossible à nettoyer", "Rouille vite"], 1, "Micro-fissures piégeant les microbes."),
      q("Pourquoi l'acier revêtu infecte facilement?", ["Poreux", "Micro-fissures invisibles abritent bactéries", "Pas de risque", "Trop lisse"], 1, "Fissures irrécurables."),
      q("Recommandation pour l'acier revêtu?", ["Excellent", "À privilégier", "À éviter en pro", "Standard"], 2, "Risque trop élevé."),
      q("Atout principal de l'aluminium?", ["Très résistant", "Neutre au goût", "Inusable", "Facile à souder"], 1, "Neutralité partielle."),
      q("Gros défaut de l'aluminium?", ["Prix", "Peu résistant aux acides et déformable", "Trop lourd", "Rare"], 1, "Faible tenue chimique/mécanique."),
      q("Aluminium et vide?", ["Aucun", "Risque d'implosion", "Expansion", "Corrosion"], 1, "Structure faible sous dépression."),
      q("Problème à la base en alu?", ["Rouille", "Trous/points d'infection", "Fuite immédiate", "Porosité"], 1, "Faiblesses mécaniques."),
      q("Lien santé évoqué pour l'alu?", ["Allergie", "Soupçons Alzheimer", "Aucun", "Gastrique"], 1, "Préoccupation santé publique."),
      q("Verdict sur l'aluminium?", ["Recommandé", "Non recommandé en pro", "Neutre", "À tester"], 1, "Désavantages > avantages."),
      q("Composition clé de l'inox?", ["Fer pur", "Chrome/Nickel/Molybdène", "Cuivre/étain", "Carbone"], 1, "Alliage protecteur."),
      q("Rôle du chrome dans l'inox?", ["Dureté", "Couche passivée anti-corrosion", "Couleur", "Coût"], 1, "Film protecteur."),
      q("Couche passivée = ?", ["Peinture", "Oxyde de chrome auto-régénérant", "Revêtement ajouté", "Soudure"], 1, "Barrière naturelle."),
      q("Formation de la passivation?", ["Manuelle", "Spontanée à l'air", "Revêtement chimique", "Chauffage"], 1, "Formation continue."),
      q("Si la passivation est abîmée?", ["Rouille définitive", "Se régénère à l'air", "Remplacement", "Expansion"], 1, "Auto-régénération."),
      q("Inox le plus courant?", ["Inox 304", "Inox 316", "Inox 410", "Inox 430"], 0, "Standard alimentaire."),
      q("Inox le plus résistant à la corrosion?", ["304", "316", "410", "201"], 1, "316 pour milieux corrosifs."),
      q("Passivation mécanique = ?", ["Produits chimiques", "Ponçage abrasif fin", "Peinture", "Chlore"], 1, "Restauration mécanique."),
      q("Passivation chimique = ?", ["Ponçage", "Traitement acide nitrique", "Peinture", "Chauffage"], 1, "Régénération chimique."),
      q("Signe d'une passivation défaillante?", ["Couleur normale", "Bleu/jaune ou rouille", "Aspect lisse", "Brillance"], 1, "Couleur anormale."),
      q("Fer sur l'inox cause…", ["Rien", "Rouille par contact", "Plus de brillance", "Moins de corrosion"], 1, "Rupture de passivation."),
      q("Chlore chaud sur inox → ?", ["Aucun", "Piqûres (pitting)", "Brillance", "Passivation"], 1, "Chlore attaque le film."),
      q("Précautions avec chlore?", ["Aucune", "Contrôler T°, pH, temps, concentration", "Utiliser concentré", "Pas de limite"], 1, "Paramètres stricts."),
      q("Outils acier carbone sur inox?", ["OK", "Non (rouille par contact)", "Optionnel", "Seulement ponçage"], 1, "Éviter contamination fer."),
      q("Matériau de référence?", ["Acier revêtu", "Aluminium", "Inox 304/316", "Acier carbone"], 2, "Standard pro."),
      q("Inox à choisir en milieu corrosif?", ["304", "316", "Acier revêtu", "Aluminium"], 1, "316 plus robuste."),
      q("Meilleur compromis coût/perf?", ["Acier revêtu", "Inox 304", "Inox 316", "Aluminium"], 1, "Bon ratio qualité-prix."),
      q("Étoiles corrosion Inox 304?", ["2", "3", "4", "5"], 2, "Très bonne résistance."),
      q("Étoiles corrosion Inox 316?", ["2", "3", "4", "5"], 3, "Excellente résistance."),
      q("Pourquoi 316 coûte plus que 304?", ["Extraction", "Alliage Ti+Nb plus résistant", "Poids", "Rareté"], 1, "Alliage plus performant."),
    ]
  },
  {
    id: "joints",
    category: "CIP",
    title: "18. Les joints et raccords",
    ficheRich: [
      {
        title: "Les joints d'étanchéité - Problématique",
        items: [
          "Les joints sont des points critiques car : ils sont en contact avec la bière, ils peuvent se dégrader avec le temps, les craquelures deviennent des nids à bactéries, ils peuvent donner un mauvais goût à la bière."
        ]
      },
      {
        title: "Types de joints",
        items: [
          "**Bleu (NBR - Nitrile)** : Bonne résistance aux huiles et graisses.",
          "**Noir (EPDM)** : Bonne résistance aux produits chimiques et températures.",
          "**Rouge (Silicone)** : Excellente résistance aux températures extrêmes."
        ]
      },
      {
        title: "Critères de choix des joints",
        items: [
          "**Résistance aux produits de nettoyage** : ⭐⭐⭐⭐⭐ - Critique",
          "**Résistance aux températures** : ⭐⭐⭐⭐⭐ - Critique",
          "**Résistance à l'usure** : ⭐⭐⭐⭐ - Très important",
          "**Compatibilité alimentaire** : ⭐⭐⭐⭐⭐ - Critique"
        ]
      },
      {
        title: "Bonnes pratiques pour les joints",
        items: [
          "✅ Inspecter régulièrement les joints pour détecter l'usure.",
          "✅ Remplacer dès les premiers signes d'usure.",
          "✅ Avoir des joints de rechange pour toutes les vannes.",
          "✅ L'acide péracétique dégrade les joints → rincer soigneusement après utilisation.",
          "✅ De plus en plus remplacés par des tuyaux inox ou plastique pour éviter les points faibles."
        ]
      },
      {
        title: "Les raccords - Standards de raccords",
        items: [
          "**SMS (Suédois)** : Très répandu, filetage fin.",
          "**DIN 11851 (Allemand)** : Standard européen, robuste, le plus utilisé en Europe.",
          "**MACON** : Connexion rapide."
        ]
      },
      {
        title: "Norme DIN 11851",
        items: [
          "**Standard le plus utilisé en Europe** pour la brasserie.",
          "**Conçu spécifiquement pour l'industrie alimentaire.**",
          "**Facilité de démontage** pour le nettoyage CIP.",
          "**Étanchéité fiable** garantie par design robuste.",
          "Critères de sélection : Compatibilité (tous du même standard), État de surface lisse, Facilité de nettoyage et démontage, Étanchéité adaptée au type."
        ]
      }
    ],
    questions: [
      q("Pourquoi les joints sont-ils critiques en brasserie?", ["Purement esthétiques", "Sont en contact avec la bière et peuvent créer des nids à bactéries", "Pas d'importance", "Secondaires"], 1, "Points faibles majeurs du circuit."),
      q("Quel problème les craquelures des joints créent-elles?", ["Aucun", "Deviennent des nids à bactéries impossibles à déloger", "Amélioration de l'étanchéité", "Augmentent la durabilité"], 1, "Source d'infection récurrente."),
      q("Quel impact l'usure des joints a-t-elle sur la bière?", ["Aucun", "Peut donner un mauvais goût à la bière", "Améliore le goût", "Impact minime"], 1, "Transmission de saveurs indésirables."),
      q("Quelle couleur représente le NBR (Nitrile)?", ["Noir", "Bleu", "Rouge", "Vert"], 1, "Code couleur standard pour joints."),
      q("Quel matériau est le NBR (Nitrile)?", ["Silicone", "EPDM", "Nitrile (NBR)", "Caoutchouc naturel"], 2, "Type le plus courant."),
      q("Qu'est-ce que le NBR offre comme résistance?", ["À l'alcool", "Aux huiles et graisses", "Aux températures extrêmes", "Au chlore"], 1, "Avantage principal du NBR."),
      q("Quelle couleur représente l'EPDM?", ["Bleu", "Noir", "Rouge", "Blanc"], 1, "Code couleur pour EPDM."),
      q("Quel matériau est l'EPDM?", ["Nitrile", "EPDM (éthylène-propylène)", "Silicone", "Caoutchouc butyle"], 1, "Résistance chimique et thermique."),
      q("À quoi l'EPDM est-il particulièrement résistant?", ["Aux huiles", "Aux produits chimiques et températures", "À l'usure", "Au chlore"], 1, "Avantages principaux de l'EPDM."),
      q("Quelle couleur représente le Silicone?", ["Bleu", "Noir", "Rouge", "Jaune"], 2, "Code couleur pour le silicone."),
      q("À quoi le silicone est-il particulièrement résistant?", ["Aux acides", "Aux températures extrêmes", "Aux huiles", "Au sel"], 1, "Avantage majeur du silicone."),
      q("Quel est le critère le plus important pour les joints?", ["Couleur", "Résistance aux produits de nettoyage et températures", "Coût", "Disponibilité"], 1, "Sécurité microbiologique."),
      q("Combien d'étoiles pour 'Résistance aux produits de nettoyage'?", ["2 étoiles", "3 étoiles", "5 étoiles", "4 étoiles"], 2, "Critique pour l'hygiène."),
      q("Combien d'étoiles pour 'Résistance aux températures'?", ["2 étoiles", "3 étoiles", "5 étoiles", "4 étoiles"], 2, "Critique pour la durabilité."),
      q("Combien d'étoiles pour 'Résistance à l'usure'?", ["2 étoiles", "3 étoiles", "5 étoiles", "4 étoiles"], 3, "Très important pour la longévité."),
      q("Combien d'étoiles pour 'Compatibilité alimentaire'?", ["2 étoiles", "3 étoiles", "5 étoiles", "4 étoiles"], 2, "Critique pour la sécurité alimentaire."),
      q("Quelle est la recommandation pour l'inspection des joints?", ["Jamais", "Régulièrement pour détecter l'usure", "Une fois par an", "Optionnel"], 1, "Maintenance préventive."),
      q("Quand faut-il remplacer les joints?", ["Jamais", "Dès les premiers signes d'usure", "Quand ils cassent", "Après 5 ans"], 1, "Avant que le problème n'aggrave."),
      q("Pourquoi avoir des joints de rechange?", ["Économies", "Réduction des temps d'arrêt de maintenance", "Esthétique", "Obligation légale"], 1, "Continuité opérationnelle."),
      q("Quel produit dégrade les joints?", ["La soude", "L'acide nitrique", "L'acide péracétique", "L'eau chaude"], 2, "Requiert rinçage soigné après."),
      q("Que faire après utilisation d'acide péracétique?", ["Rien", "Rincer soigneusement les joints", "Désinfecter à nouveau", "Laisser sécher"], 1, "Prévention de la dégradation."),
      q("Quelle est la tendance concernant les joints?", ["Augmentation de l'usage", "Remplacement par tuyaux inox ou plastique", "Plus de qualité", "Utilisation accrue"], 1, "Modernisation du design hygiénique."),
      q("Que signifie l'acronyme SMS?", ["Standard Manufacturing System", "Standard Mondial Suédois", "SMS - Standard de raccord suédois", "System Management Standard"], 2, "Origine suédoise."),
      q("Que signifie DIN 11851?", ["German Standard", "Norme alimentaire allemande pour raccords", "Data Information Network", "Dynamic Industrial Norm"], 1, "Standard européen."),
      q("Quel est le standard le plus utilisé en Europe?", ["SMS", "DIN 11851", "MACON", "ISO 1216"], 1, "Référence européenne."),
      q("Quel standard de raccord offre une connexion rapide?", ["SMS", "DIN 11851", "MACON", "Instantané"], 2, "Spécialité du MACON."),
      q("Pour quel secteur DIN 11851 a-t-il été conçu?", ["Chimie", "Industrie alimentaire", "Pétrole", "Construction"], 1, "Spécificités hygiéniques garanties."),
      q("Quel avantage DIN 11851 offre-t-il pour le nettoyage?", ["Pas de démontage", "Facilité de démontage pour nettoyage CIP", "Augmente la surface", "Réduit l'efficacité"], 1, "Accessibilité pour l'hygiène."),
      q("Qu'est-ce qui assure l'étanchéité en DIN 11851?", ["La pression", "Le design robuste et le joint adapté", "La température", "Le matériau seul"], 1, "Combinaison design-joint."),
      q("Quel est le critère critique lors du choix des raccords?", ["La couleur", "La compatibilité (tous du même standard)", "Le coût minimal", "L'esthétique"], 1, "Évite les incompatibilités.")
    ]
  },
  {
    id: "agentsNettoyage",
    category: "CIP",
    title: "19. Les agents de nettoyage",
    ficheRich: [
      {
        title: "Objectif du nettoyage",
        items: [
          "Retirer de la surface à traiter : résidus de brassage, dépôts (tartre, pierre de bière), protéines coagulées, résines de houblon, huiles et graisses, sels minéraux."
        ]
      },
      {
        title: "Principe fondamental",
        items: [
          "Passer à l'eau sous pression, idéalement chaude, le plus vite possible après la vidange de la cuve.",
          "Notamment pour les vannes qui ne peuvent pas être facilement nettoyées par CIP."
        ]
      },
      {
        title: "Caractéristiques d'un bon agent de nettoyage",
        items: [
          "**Haute solubilité** : Se dissout facilement dans l'eau.",
          "**Bon pouvoir nettoyant** : Efficace contre les salissures.",
          "**Efficace à basse température** : Économie d'énergie.",
          "**Haut pouvoir mouillant** : Additif diminuant la tension superficielle de l'eau.",
          "**Facilement rinçable** : Pas de résidus après rinçage.",
          "**Ne réagit pas avec les sels de l'eau** : Évite les dépôts calcaires.",
          "**Pas corrosif pour les cuves** : Préserve l'équipement.",
          "**Pas cher** : Économiquement viable.",
          "**Facile à utiliser** : Manipulation simple.",
          "**Ne pollue pas l'environnement** : Biodégradable.",
          "**Stable à l'oxygène** : Ne se dégrade pas au stockage."
        ]
      },
      {
        title: "Formes disponibles",
        items: [
          "**Poudre** : Stockage facile, longue conservation. Inconvénient : dosage moins précis.",
          "**Pâte** : Concentration élevée. Inconvénient : dissolution plus lente.",
          "**Liquide** : ✅ Dosage précis, dissolution immédiate. Inconvénient : plus volumineux à stocker.",
          "**Recommandation** : Le liquide est préféré car il se dose mieux et se dissout immédiatement."
        ]
      },
      {
        title: "Les nettoyants BASIQUES (alcalins)",
        items: [
          "**Produit principal** : Soude caustique (NaOH).",
          "**Concentration typique** : 2%.",
          "**Conductivité cible** : ~100 mS/cm.",
          "**Action** : Saponification des graisses, dissolution des protéines.",
          "**Efficacité** : Excellente contre les matières organiques.",
          "**Utilisation** : Peut être employée plusieurs fois, filtrer pour retirer les dépôts, ajouter de la soude concentrée quand la conductivité diminue."
        ]
      },
      {
        title: "Les nettoyants ACIDES",
        items: [
          "**Acide phosphorique** : Détartrage, élimination des dépôts minéraux.",
          "**Acide nitrique** : Passivation de l'inox, détartrage.",
          "**Action** : Dissolution des dépôts minéraux (tartre, pierre de bière), neutralisation des résidus de soude, passivation de l'inox."
        ]
      },
      {
        title: "Cycle de nettoyage recommandé",
        items: [
          "**Soude (2%)** : Élimine les matières organiques (graisses, protéines).",
          "**Acide** : Élimine les dépôts minéraux (tartre, pierre de bière).",
          "**Alternance recommandée** : Pour un nettoyage complet et régénération de la passivation."
        ]
      }
    ],
    questions: [
      q("Quel est l'objectif principal du nettoyage en brasserie?", ["Esthétique", "Retirer résidus, dépôts, protéines, résines, huiles et sels", "Améliorer le goût", "Stockage"], 1, "Hygiène et qualité microbiologique."),
      q("Qu'est-ce que le nettoyage doit retirer?", ["Uniquement la saleté visible", "Résidus, dépôts, protéines coagulées, résines, huiles, sels minéraux", "La couleur du malt", "La mousse"], 1, "Élimination complète des contaminants."),
      q("Quel est le principe fondamental du nettoyage?", ["Utiliser un produit chimique fort", "Eau sous pression, idéalement chaude, le plus vite possible après vidange", "Laisser reposer longtemps", "Température très basse"], 1, "Rapidité et efficacité thermique."),
      q("Pourquoi passer l'eau rapidement après la vidange?", ["Pas de raison", "Pour éviter que les résidus se dessèchent et collent", "Pour économiser de l'eau", "Obligation légale"], 1, "Prévention de l'adhésion des dépôts."),
      q("Pour quels équipements le nettoyage rapide est-il particulièrement important?", ["Grandes cuves", "Vannes qui ne peuvent pas être nettoyées par CIP", "Tout pareil", "Tuyaux seulement"], 1, "Points difficiles d'accès."),
      q("Qu'est-ce que la 'haute solubilité' d'un agent de nettoyage?", ["Couleur claire", "Se dissout facilement dans l'eau", "Odeur forte", "Prix bas"], 1, "Caractéristique essentielle."),
      q("Qu'est-ce que le 'pouvoir mouillant'?", ["La capacité à chauffer", "Additif diminuant la tension superficielle de l'eau", "La couleur du produit", "La conservation"], 1, "Améliore la pénétration."),
      q("Pourquoi un agent doit-il être 'facilement rinçable'?", ["Optionnel", "Pour éviter les résidus qui contaminent la bière", "Pour économiser de l'eau", "Esthétique"], 1, "Prévention de la contamination."),
      q("Quel problème peut créer un agent 'réactif avec les sels'?", ["Aucun", "Formation de dépôts calcaires (tartre)", "Augmente l'efficacité", "Améliore la rincibilité"], 1, "Encrassement résiduel."),
      q("Pourquoi un agent ne doit-il pas être 'corrosif'?", ["Pas de raison", "Pour préserver l'équipement (inox, joints)", "C'est une obligation légale", "Économie de produit"], 1, "Protection des investissements."),
      q("Qu'est-ce qu'un agent 'stable à l'oxygène'?", ["Résiste à la chaleur", "Ne se dégrade pas au stockage", "Coûte moins cher", "Se dissout mieux"], 1, "Longévité en stock."),
      q("Quel est l'avantage de la forme 'poudre'?", ["Dosage précis", "Stockage facile et longue conservation", "Dissolution immédiate", "Volume réduit"], 1, "Logistique avantageuse."),
      q("Quel est l'inconvénient de la forme 'poudre'?", ["Trop volumineuse", "Dosage moins précis", "Se dissout trop vite", "Trop cher"], 1, "Imprécision dosage."),
      q("Quel est l'avantage de la forme 'pâte'?", ["Dissolution immédiate", "Concentration élevée", "Dosage facile", "Pas de volume"], 1, "Densité chimique."),
      q("Quel est l'inconvénient de la forme 'pâte'?", ["Trop chère", "Dissolution plus lente", "Trop diluée", "Instable"], 1, "Temps de dissolution."),
      q("Quel est l'avantage principal de la forme 'liquide'?", ["Moins cher", "Dosage précis et dissolution immédiate", "Longue conservation", "Faible volume"], 1, "Praticité opérationnelle."),
      q("Quel est l'inconvénient de la forme 'liquide'?", ["Cher", "Plus volumineux à stocker", "Se solidifie", "Difficile à doser"], 1, "Logistique encombrante."),
      q("Quelle forme de nettoyant est recommandée?", ["Poudre", "Pâte", "Liquide (dosage précis et dissolution immédiate)", "Toutes égales"], 2, "Meilleure efficacité pratique."),
      q("Quel est le nettoyant basique principal?", ["Acide citrique", "Soude caustique (NaOH)", "Acide phosphorique", "Savon"], 1, "Standard alcalin de référence."),
      q("Quelle est la concentration typique de soude en nettoyage?", ["0.5%", "2%", "5%", "10%"], 1, "Dosage standard."),
      q("Quelle est la conductivité cible pour la soude?", ["50 mS/cm", "100 mS/cm", "150 mS/cm", "200 mS/cm"], 1, "Mesure de concentration."),
      q("Quel est l'effet de la soude sur les graisses?", ["Aucun", "Saponification (conversion en savons)", "Les durcit", "Les dissout partiellement"], 1, "Réaction chimique de nettoyage."),
      q("Quel est l'effet de la soude sur les protéines?", ["Les préserve", "Les dissout et les élimine", "Les durcit", "Les colore"], 1, "Dénaturation protéique."),
      q("Combien de fois peut-on utiliser la soude?", ["Une seule", "Plusieurs fois (filtrer et réutiliser)", "Jamais", "Dépend du malt"], 1, "Réutilisabilité économique."),
      q("Que faire quand la conductivité de la soude diminue?", ["Ajouter de l'eau", "Ajouter de la soude concentrée pour restaurer la concentration", "Remplacer complètement", "Continuer sans ajustement"], 1, "Maintenance du dosage."),
      q("Quel acide est utilisé pour le détartrage?", ["Acide acétique", "Acide phosphorique ou nitrique", "Acide sulfurique", "Acide citrique"], 1, "Standards de détartrage."),
      q("Quel est l'effet des acides sur les dépôts minéraux?", ["Aucun", "Dissolution des tartre et pierre de bière", "Renforcement", "Coloration"], 1, "Chimie acide-base."),
      q("Quel acide permet la passivation de l'inox?", ["Phosphorique", "Nitrique", "Acétique", "Citrique"], 1, "Régénération du film d'oxyde."),
      q("Pourquoi alterner soude et acide?", ["Pas de raison", "Soude élimine matière organique, acide élimine minéraux et régénère inox", "Obligation légale", "Économie de produit"], 1, "Nettoyage complet et entretien."),
      q("Qu'élimine la soude dans le cycle de nettoyage?", ["Tartre", "Matières organiques (graisses, protéines)", "Sels minéraux", "Couleur"], 1, "Cibles du nettoyant alcalin."),
      q("Qu'élimine l'acide dans le cycle de nettoyage?", ["Graisses", "Dépôts minéraux (tartre, pierre de bière)", "Protéines", "Mousse"], 1, "Cibles du nettoyant acide.")
    ]
  },
  {
    id: "agentsDesinfection",
    category: "CIP",
    title: "20. Les agents de désinfection",
    ficheRich: [
      {
        title: "Différence nettoyage vs désinfection",
        items: [
          "**Nettoyage** : Objectif = retirer les salissures. Cible = matière organique et minérale. Ordre = en premier. Surface = sale → propre.",
          "**Désinfection** : Objectif = tuer les micro-organismes. Cible = bactéries, levures, virus, spores. Ordre = après le nettoyage. Surface = propre → stérile.",
          "⚠️ **On ne désinfecte pas une surface sale !** Le nettoyage doit toujours précéder la désinfection."
        ]
      },
      {
        title: "Caractéristiques d'un bon désinfectant",
        items: [
          "Mêmes caractéristiques qu'un agent de nettoyage.",
          "PLUS : doit détruire tous les micro-organismes présents.",
          "Spectre d'action le plus large possible (bactéries, levures, virus, champignons, spores)."
        ]
      },
      {
        title: "Les HALOGÈNES (Chlorés)",
        items: [
          "**Produit principal** : Hypochlorite de soude (eau de Javel).",
          "**Mode d'action** : Pénètre les cellules et détruit les acides aminés essentiels.",
          "**Spectre** : Très large (bactéries, levures, virus, champignons, spores).",
          "**Avantages** : Très efficace, économique, large spectre.",
          "**Inconvénients** : ⚠️ Le chlore chaud crée des piqûres (pitting) dans l'inox, odeur forte, peut laisser des résidus."
        ]
      },
      {
        title: "Les OXYDANTS",
        items: [
          "**Produit principal** : Acide péracétique.",
          "**Concentration typique** : 0.1 - 0.5%.",
          "**Mode d'action** : Réagit avec l'oxygène et détruit les parois cellulaires.",
          "**Dégradation** : En acide acétique, oxygène et eau (inoffensifs).",
          "**Avantages** : Très efficace, se dégrade en produits inoffensifs, pas de rinçage obligatoire (à faible concentration), efficace à froid.",
          "**Inconvénients** : ⚠️ Dégrade les joints à force de contact répété, odeur de vinaigre, plus cher que la Javel."
        ]
      },
      {
        title: "Les AMMONIUMS QUATERNAIRES",
        items: [
          "**Type** : Tensioactifs cationiques.",
          "**Mode d'action** : Bactéricide de surface.",
          "**Spectre** : Plus limité que halogènes et oxydants.",
          "**Avantages** : Pas de corrosion, action résiduelle.",
          "**Inconvénients** : Spectre plus étroit, moins efficace contre les spores."
        ]
      },
      {
        title: "Tableau comparatif des désinfectants",
        items: [
          "**Hypochlorite** : Efficacité ⭐⭐⭐⭐⭐, Spectre très large, Corrosion inox ⚠️ À chaud, Impact joints ✅ Faible, Coût ⭐⭐⭐⭐⭐, Rinçage obligatoire.",
          "**Acide péracétique** : Efficacité ⭐⭐⭐⭐⭐, Spectre très large, Corrosion inox ✅ Faible, Impact joints ⚠️ Dégradation, Coût ⭐⭐⭐, Rinçage optionnel.",
          "**Ammonium quaternaire** : Efficacité ⭐⭐⭐, Spectre moyen, Corrosion inox ✅ Non, Impact joints ✅ Faible, Coût ⭐⭐⭐⭐, Rinçage obligatoire."
        ]
      },
      {
        title: "Points d'attention - Questions à poser",
        items: [
          "**Quel est le but du produit ?** → Nettoyer OU désinfecter",
          "**Quelle est la concentration ?** → Respecter les dosages",
          "**Quelle est la température ?** → Adapter selon le produit",
          "**Quel matériau sera en contact ?** → Vérifier la compatibilité",
          "**Y a-t-il des interactions néfastes ?** → Ne pas mélanger les produits"
        ]
      }
    ],
    questions: [
      q("Quel est l'objectif du nettoyage?", ["Tuer les microbes", "Retirer les salissures", "Colorer la surface", "Améliorer l'odeur"], 1, "Élimination mécanique et chimique."),
      q("Quel est l'objectif de la désinfection?", ["Retirer la saleté", "Tuer les micro-organismes", "Rincer l'équipement", "Chauffer la surface"], 1, "Destruction biologique."),
      q("Quel est le résultat du nettoyage?", ["Surface stérile", "Surface propre", "Surface brillante", "Surface lisse"], 1, "Propreté visuelle et matérielle."),
      q("Quel est le résultat de la désinfection?", ["Surface propre", "Surface stérile (propre + sans microbes)", "Surface sèche", "Surface chaude"], 1, "Absence microbiologique."),
      q("En quel ordre faire nettoyage et désinfection?", ["Désinfection d'abord", "Nettoyage d'abord, puis désinfection", "Simultané", "N'importe quel ordre"], 1, "Séquence logique obligatoire."),
      q("Peut-on désinfecter une surface sale?", ["Oui, c'est équivalent", "Non, le nettoyage doit précéder la désinfection", "Seulement avec chlore", "Optionnel"], 1, "Fondamental de l'hygiène."),
      q("Pourquoi ne pas désinfecter une surface sale?", ["Coût élevé", "Le désinfectant est inactivé par la matière organique", "C'est interdit", "Sans raison particulière"], 1, "Chimie inorganique des interactions."),
      q("Quel est le spectre d'action du nettoyage?", ["Bactéries uniquement", "Matière organique et minérale", "Virus seulement", "Spores"], 1, "Cibles du nettoyant."),
      q("Quel est le spectre d'action de la désinfection?", ["Graisses", "Bactéries, levures, virus, champignons, spores", "Tartre seul", "Minéraux"], 1, "Cibles du désinfectant."),
      q("Qu'est-ce que l'hypochlorite de soude?", ["Acide fort", "Eau de Javel (désinfectant chloré)", "Détergent", "Savon"], 1, "Halogène le plus courant."),
      q("Quel est le mode d'action du chlore?", ["Dilution", "Pénètre les cellules et détruit les acides aminés essentiels", "Chauffage", "Absorption"], 1, "Mécanisme du désinfectant."),
      q("Quel est le spectre du chlore?", ["Limité", "Très large (bactéries, levures, virus, champignons, spores)", "Seulement bactéries", "Uniquement virus"], 1, "Large couverture antimicrobienne."),
      q("Quel est un avantage du chlore?", ["Très cher", "Très efficace, économique, large spectre", "Corrosif toujours", "Mauvais goût"], 1, "Efficacité et coût."),
      q("Quel est un inconvénient majeur du chlore chaud?", ["Inefficace", "Crée des piqûres (pitting) dans l'inox", "Trop cher", "Pas d'odeur"], 1, "Corrosion spécifique."),
      q("Quel autre inconvénient a le chlore?", ["Trop efficace", "Odeur forte et résidus possibles", "Pas de couleur", "Gratuit"], 1, "Effets secondaires désagréables."),
      q("Quel est le produit oxydant principal?", ["Eau de Javel", "Acide péracétique", "Ammonium quaternaire", "Alcool"], 1, "Standard des oxydants."),
      q("Quelle est la concentration typique d'acide péracétique?", ["1-2%", "0.1-0.5%", "5%", "10%"], 1, "Dosage standard."),
      q("Quel est le mode d'action de l'acide péracétique?", ["Acide fort", "Réagit avec l'oxygène et détruit les parois cellulaires", "Chaleur", "Électrolyse"], 1, "Mécanisme oxydatif."),
      q("En quoi se dégrade l'acide péracétique?", ["Chlore", "Acide acétique, oxygène et eau (inoffensifs)", "Alcool", "Peroxyde"], 1, "Produits finaux bénins."),
      q("Quel est un avantage de l'acide péracétique?", ["Très bon marché", "Très efficace, biodégradable, efficace à froid, pas de rinçage obligatoire", "Odeur agréable", "Corrosif"], 1, "Efficacité et sécurité."),
      q("Quel inconvénient l'acide péracétique a-t-il avec les joints?", ["Aucun", "Dégrade les joints à force de contact répété", "Renforce les joints", "Imperceptible"], 1, "Problème d'usure."),
      q("Qu'est-ce qu'un ammonium quaternaire?", ["Sel acide", "Tensioactif cationique", "Oxydant fort", "Halogène"], 1, "Classification chimique."),
      q("Quel est le mode d'action des ammoniums quaternaires?", ["Pénétration cellulaire", "Bactéricide de surface", "Oxydation", "Acidification"], 1, "Action superficielle."),
      q("Quel est le spectre des ammoniums quaternaires?", ["Très large", "Plus limité que autres désinfectants", "Seulement levures", "Uniquement bactéries"], 1, "Couverture restreinte."),
      q("Quel avantage les ammoniums quaternaires offrent-ils?", ["Très bon marché", "Pas de corrosion, action résiduelle", "Forte odeur", "Rapides à agir"], 1, "Non-corrosif et persistant."),
      q("Quel inconvénient majeur ont les ammoniums quaternaires?", ["Cher", "Spectre étroit, moins efficace contre spores", "Trop efficace", "Dangereux"], 1, "Efficacité limitée."),
      q("Combien d'étoiles pour efficacité hypochlorite?", ["2", "3", "5 étoiles", "4"], 2, "Très efficace."),
      q("Combien d'étoiles pour efficacité acide péracétique?", ["2", "3", "5 étoiles", "4"], 2, "Très efficace."),
      q("Combien d'étoiles pour efficacité ammonium quaternaire?", ["2", "3 étoiles", "5", "4"], 1, "Efficacité moyenne."),
      q("Quel désinfectant ne provoque pas de corrosion?", ["Chlore chaud", "Acide péracétique et ammonium quaternaire", "Tous corrosifs", "Aucun"], 1, "Non-corrosifs."),
      q("Quel point d'attention est crucial avant d'utiliser un produit?", ["La couleur", "Quel est le but (nettoyer OU désinfecter)?", "Le prix", "L'odeur"], 1, "Usage correct du produit.")
    ]
  },
  {
    id: "cipInstallation",
    category: "CIP",
    title: "21. Le système CIP - Installation et fonctionnement",
    ficheRich: [
      {
        title: "Composants d'une installation CIP",
        items: [
          "**Cuve NEP/CIP** : Stocke les solutions de nettoyage (centrale).",
          "**Sonde de niveau** : Contrôle le volume de liquide (sécurité).",
          "**Sonde de concentration** : Mesure la concentration en produit (qualité).",
          "**Pompe propulseuse** : Envoie le liquide vers la cuve (pression).",
          "**Boule d'arrosage** : Projette le liquide sur toutes les surfaces (couverture).",
          "**Vanne vidange cuve** : Permet l'évacuation (contrôle).",
          "**Conductivimètre** : Vérifie le rinçage par conductivité de l'eau (contrôle qualité).",
          "**Pompe retour** : Récupère le liquide pour recyclage (économie).",
          "**Ligne égout** : Évacuation des eaux usées (sortie)."
        ]
      },
      {
        title: "Configuration du circuit fermé CIP",
        items: [
          "La cuve NEP/CIP stocke les solutions.",
          "La sonde de niveau contrôle le remplissage.",
          "La sonde de concentration mesure le dosage.",
          "La pompe propulseuse envoie le liquide par la ligne envoi.",
          "La boule d'arrosage projette le liquide sur la cuve à nettoyer.",
          "Le liquide usé retourne par la ligne retour via la pompe retour.",
          "Le conductivimètre contrôle la qualité du rinçage.",
          "Évacuation final par la ligne égout."
        ]
      },
      {
        title: "Méthodes de nettoyage",
        items: [
          "**Circuit fermé (CIP classique)** : Le liquide circule en boucle. Peut être 'mou' (basse pression) ou 'dur' (haute pression). Économique en eau et produits.",
          "**Cuve de trempage** : Pour les petites pièces (vannes, joints, raccords). Attention : changer le bain tous les 15 jours ou en cas de doute. Bien rincer les pièces avant remise en service.",
          "**Acide péracétique en trempage** : Prévoir des joints de rechange car l'acide péracétique les dégrade."
        ]
      },
      {
        title: "Étapes d'un cycle CIP standard",
        items: [
          "**Étape 1 - Rinçage initial** (5 min, eau chaude + froide) : Éliminer les gros résidus, économiser le détergent.",
          "**Étape 2 - Vidange complète** : Évacuer l'eau de rinçage.",
          "**Étape 3 - Détergent nettoyant** (30-60 min, soude 2%) : Dissoudre les matières organiques.",
          "**Étape 4 - Rinçage à l'eau** (5-10 min) : Éliminer le détergent.",
          "**Étape 5 - Désinfection + vidange** (15 min) : Tuer les micro-organismes restants."
        ]
      },
      {
        title: "Paramètres critiques du CIP",
        items: [
          "**Température** : Eau chaude rinçage initial et détergent (améliore efficacité).",
          "**Concentration du détergent** : 2% NaOH (~100 mS/cm conductivité).",
          "**Durée détergent** : 30-60 minutes pour dissolution complète.",
          "**Couverture** : 100% de la surface via boule d'arrosage bien positionnée.",
          "**Pression/débit** : Adapté selon circuit (mou ou dur) et équipement.",
          "**Rinçage final** : Vérifier conductivité < 10 mS/cm pour élimination complète des résidus."
        ]
      }
    ],
    questions: [
      q("Quel est le rôle de la cuve NEP/CIP?", ["Nettoyage des cuves", "Stockage des solutions de nettoyage", "Fermentation", "Refroidissement"], 1, "Centrale du système."),
      q("Quelle sonde contrôle le volume de liquide?", ["Température", "Sonde de niveau", "Conductivité", "Pression"], 1, "Sécurité du remplissage."),
      q("Quelle sonde mesure la concentration en produit?", ["Niveau", "Température", "Sonde de concentration", "pH"], 2, "Qualité du nettoyage."),
      q("Quel est le rôle de la pompe propulseuse?", ["Filtre le liquide", "Envoie le liquide vers la cuve à nettoyer", "Refroidit", "Mesure"], 1, "Circulation principale."),
      q("Quel est le rôle de la boule d'arrosage?", ["Filtre", "Projette le liquide sur toutes les surfaces", "Mesure concentration", "Vidange"], 1, "Couverture et action mécanique."),
      q("Quel est le rôle du conductivimètre en CIP?", ["Chauffer", "Vérifie le rinçage par conductivité de l'eau", "Filtrer", "Mixer"], 1, "Contrôle qualité du rinçage."),
      q("Quel est le rôle de la pompe retour?", ["Chauffer", "Récupère le liquide pour recyclage", "Filtrer", "Mixer"], 1, "Réutilisation économique."),
      q("Qu'est-ce qu'un circuit fermé en CIP?", ["Eau unique", "Liquide circule en boucle (mou ou dur)", "Ouvert à l'air", "Sans recyclage"], 1, "Configuration classique."),
      q("Quel est l'avantage du circuit fermé?", ["Haute température", "Économique en eau et produits", "Très rapide", "Silencieux"], 1, "Efficacité financière."),
      q("Qu'est-ce qu'un nettoyage 'mou' en CIP?", ["Température basse", "Basse pression", "Sans détergent", "Rapide"], 1, "Configuration douce."),
      q("Qu'est-ce qu'un nettoyage 'dur' en CIP?", ["Température élevée", "Haute pression", "Avec acide", "Concentration forte"], 1, "Configuration vigoureuse."),
      q("Pour quoi utilise-t-on une cuve de trempage?", ["Grandes cuves", "Petites pièces (vannes, joints, raccords)", "Tuyaux", "Filtres"], 1, "Pièces difficiles d'accès."),
      q("Combien de temps conserver le bain de trempage?", ["1 mois", "15 jours ou en cas de doute", "3 mois", "Indéfiniment"], 1, "Efficacité du bain."),
      q("Que faire avec les pièces après trempage?", ["Les mettre directement en production", "Bien les rincer avant remise en service", "Les sécher à l'air", "Les stocker"], 1, "Élimination des résidus."),
      q("Quel produit dégrade les joints lors du trempage?", ["Soude", "Acide péracétique", "Chlore", "Alcool"], 1, "Usure matériau."),
      q("Quelle précaution prendre avec l'acide péracétique?", ["Augmenter concentration", "Prévoir des joints de rechange", "Utiliser plus longtemps", "Température maximale"], 1, "Maintenance préventive."),
      q("Combien de temps dure le rinçage initial?", ["15 minutes", "5 minutes", "30 minutes", "1 minute"], 1, "Étape 1 du cycle."),
      q("Quel est l'objectif du rinçage initial?", ["Désinfecter", "Éliminer gros résidus et économiser détergent", "Détartrer", "Chauffer"], 1, "Préparation efficace."),
      q("Quelle est la durée typique du détergent en CIP standard?", ["10 minutes", "15-30 minutes", "2 heures", "5 minutes"], 1, "Standard industriel brassicole."),
      q("Quelle concentration de soude utiliser en CIP?", ["0.5%", "2%", "5%", "10%"], 1, "Standard de nettoyage."),
      q("Quelle conductivité cible pour 2% NaOH?", ["50 mS/cm", "100 mS/cm", "150 mS/cm", "200 mS/cm"], 1, "Mesure de concentration."),
      q("Combien de temps pour le rinçage à l'eau?", ["1-3 minutes", "5-10 minutes", "20 minutes", "30 minutes"], 1, "Élimination du détergent."),
      q("Combien de temps pour la désinfection?", ["5 minutes", "15 minutes", "45 minutes", "1 heure"], 1, "Stérilisation finale."),
      q("Quel est l'ordre correct du cycle CIP?", ["Détergent, rinçage, désinfection", "Rinçage, détergent, rinçage, désinfection", "Désinfection, détergent, rinçage", "Variable"], 1, "Séquence logique."),
      q("Pourquoi commencer par un rinçage?", ["Optionnel", "Élimine gros résidus et économise détergent", "Obligation légale", "Améliore odeur"], 1, "Économie et efficacité."),
      q("Quel paramètre influence le plus l'efficacité?", ["Couleur", "Température, concentration, durée, couverture, pression", "Odeur", "Coût"], 1, "Facteurs multiples critiques."),
      q("Quelle conductivité indique fin du rinçage?", ["100 mS/cm", "< 10 mS/cm", "50 mS/cm", "200 mS/cm"], 1, "Pureté de l'eau de rinçage."),
      q("Quelle température utiliser au rinçage initial?", ["Froide uniquement", "Chaude + froide", "Brûlante", "Ambiante"], 1, "Efficacité thermique."),
      q("Quel est l'objectif du cycle CIP complet?", ["Rapidité", "Nettoyage complet + désinfection", "Économies", "Volume maximum"], 1, "Hygiène complète."),
      q("Peut-on sauter une étape du cycle CIP?", ["Oui", "Non, toutes les étapes sont nécessaires", "Seulement la désinfection", "Seulement le rinçage"], 1, "Intégrité du protocole.")
    ]
  },
  {
    id: "protocoleFermenteur",
    category: "CIP",
    title: "22. Protocole de nettoyage d'un fermenteur",
    ficheRich: [
      {
        title: "Contexte d'importance critique",
        items: [
          "Le fermenteur est l'équipement le plus critique en termes d'hygiène car :",
          "La bière y séjourne longtemps (fermentation active 7-14 jours).",
          "Les levures y sont actives et peuvent être contaminées.",
          "Le contact prolongé augmente les risques d'infection.",
          "Une contamination du fermenteur affecte toute la production ultérieure."
        ]
      },
      {
        title: "Étape 1 : Pré-rinçage à l'eau chaude",
        items: [
          "**Température** : 80°C.",
          "**Source** : Cuve d'empâtage (eau chaude de brassage).",
          "**Durée** : 5 minutes.",
          "**Méthode** : Envoi par pompe dans le fermenteur.",
          "**Objectif** : Ramollir et éliminer les résidus de levure et de houblon."
        ]
      },
      {
        title: "Étape 2 : Nettoyage à la soude",
        items: [
          "**Produit** : Soude caustique (NaOH).",
          "**Concentration** : 2%.",
          "**Durée** : 20 minutes.",
          "**Circulation** : 100% du circuit (fermenteur et tuyauterie).",
          "**Objectif** : Dissoudre les protéines, graisses et résidus organiques."
        ]
      },
      {
        title: "Étape 3 : Vidange",
        items: [
          "**Méthode** : Par le fond du fermenteur (via vanne de vidange).",
          "**Vérification** : S'assurer que tout le liquide est évacué complètement.",
          "**Objectif** : Éliminer la soude et les salissures dissoutes."
        ]
      },
      {
        title: "Étape 4 : Rinçage à l'eau froide",
        items: [
          "**Température** : Froide (eau de ville).",
          "**Durée** : Minimum 5 minutes (adapter selon conductivité).",
          "**Critère d'arrêt** : Ne plus sentir la soude.",
          "**Contrôle** : Conductivimètre pour retour à conductivité eau normale.",
          "**Objectif** : Éliminer totalement les résidus de soude."
        ]
      },
      {
        title: "Étape 5 : Désinfection",
        items: [
          "**Produit** : Acide péracétique.",
          "**Concentration** : 0.1-0.5%.",
          "**Température** : 20°C (eau froide).",
          "**Durée** : 15 minutes.",
          "**Objectif** : Éliminer tous les micro-organismes restants (bactéries, levures sauvages, virus)."
        ]
      },
      {
        title: "Point important : l'échangeur à plaques",
        items: [
          "**L'échangeur à plaques** et **le tuyau de remplissage** vers le fermenteur doivent être mis dans la boucle CIP.",
          "Laisser l'échangeur **rempli de désinfectant** jusqu'à ce que la bière soit refroidie.",
          "**Garantie** : Tout le circuit est stérile au moment du transfert du moût.",
          "**Timing critique** : L'échangeur remplit d'acide péracétique protège le circuit pendant le refroidissement."
        ]
      },
      {
        title: "Schéma simplifié de la brasserie",
        items: [
          "**Empâtage → Filtration → Fermentation/Maturation**",
          "Chaque section nécessite son propre protocole de nettoyage adapté.",
          "Empâtage : Nettoyage du moût résiduel, cuivre/équipement.",
          "Filtration : Nettoyage du filtre à chaud rapidement, plaques de filtration.",
          "Fermentation : Protocole détaillé ci-dessus (5 étapes), échangeur critique."
        ]
      }
    ],
    questions: [
      q("Pourquoi le fermenteur est-il critique en hygiène?", ["Grande capacité", "La bière y séjourne longtemps avec levures actives", "Petit volume", "Facilité de nettoyage"], 1, "Contact prolongé = risque élevé."),
      q("Combien de temps la bière séjourne-t-elle en fermenteur?", ["2-3 jours", "7-14 jours (fermentation active)", "1 mois", "3 mois"], 1, "Période critique."),
      q("Quelle est la température du pré-rinçage?", ["20°C", "60°C", "80°C", "100°C"], 2, "Eau chaude de brassage."),
      q("D'où provient l'eau chaude du pré-rinçage?", ["Cuve de refroidissement", "Cuve d'empâtage", "Cuve de désinfection", "Cuve de stockage"], 1, "Récupération d'énergie."),
      q("Combien de temps dure le pré-rinçage?", ["2 minutes", "5 minutes", "10 minutes", "20 minutes"], 1, "Étape 1 du protocole."),
      q("Quel est l'objectif du pré-rinçage?", ["Désinfecter", "Ramollir et éliminer résidus levure et houblon", "Refroidir", "Changer la couleur"], 1, "Préparation du fermenteur."),
      q("Quel produit utilise-t-on pour le nettoyage fermenteur?", ["Acide péracétique", "Soude caustique (NaOH)", "Chlore", "Alcool"], 1, "Nettoyant basique standard."),
      q("Quelle concentration de soude pour le fermenteur?", ["1%", "2%", "5%", "10%"], 1, "Dosage standard de nettoyage."),
      q("Combien de temps circule la soude?", ["10 minutes", "20 minutes", "30 minutes", "1 heure"], 1, "Étape 2 du protocole."),
      q("Quel pourcentage du circuit doit être couvert par soude?", ["50%", "75%", "100% (fermenteur + tuyauterie)", "Variable"], 2, "Couverture complète."),
      q("Quel est l'effet de la soude sur les protéines?", ["Les renforce", "Les dissout et les élimine", "Les colore", "Les préserve"], 1, "Nettoyage efficace."),
      q("Quel est l'effet de la soude sur les graisses?", ["Les augmente", "Les saponifie et les élimine", "Les durcit", "Aucun"], 1, "Chimie alcaline."),
      q("Comment s'effectue la vidange du fermenteur?", ["Par le haut avec siphon", "Par le fond via vanne de vidange", "Par la tuyauterie", "Par débordement"], 1, "Évacuation complète."),
      q("Quel est l'objectif de la vidange?", ["Remplir le réservoir", "Éliminer soude et salissures dissoutes", "Refroidir", "Agiter le contenu"], 1, "Étape 3 du protocole."),
      q("Quelle est la température du rinçage à l'eau froide?", ["Ambiante", "Eau de ville (froide)", "80°C", "60°C"], 1, "Rinçage économique."),
      q("Quel est le critère d'arrêt du rinçage?", ["5 minutes fixes", "Ne plus sentir la soude, conductivité normale", "10 minutes", "À l'odeur"], 1, "Vérification complète."),
      q("Quel outil mesure la fin du rinçage?", ["Thermomètre", "Conductivimètre", "pH-mètre", "Turbidimètre"], 1, "Conductivité eau < soude."),
      q("Quelle conductivité indique fin du rinçage?", ["100 mS/cm", "Retour à conductivité eau normale", "50 mS/cm", "200 mS/cm"], 1, "Pureté de l'eau."),
      q("Quel désinfectant utilise-t-on pour fermenteur?", ["Eau de Javel", "Acide péracétique", "Ammonium quaternaire", "Alcool"], 1, "Oxydant de référence."),
      q("Quelle concentration d'acide péracétique?", ["0.05%", "0.1-0.5%", "1%", "2%"], 1, "Dosage désinfection."),
      q("Quelle température pour la désinfection?", ["Chaude", "Froide (eau froide, 20°C)", "Tiède", "Variable"], 1, "Économie énergétique."),
      q("Combien de temps dure la désinfection?", ["5 minutes", "15 minutes", "30 minutes", "1 heure"], 1, "Étape 5 du protocole."),
      q("Quel est l'objectif de la désinfection?", ["Refroidissement", "Éliminer tous micro-organismes restants", "Rinçage", "Stockage"], 1, "Stérilisation finale."),
      q("Pourquoi l'échangeur à plaques est-il critique?", ["Trop cher", "Doit être rempli de désinfectant jusqu'au refroidissement du moût", "Facile à nettoyer", "Optionnel"], 1, "Stérilité du transfert."),
      q("Comment traiter le tuyau de remplissage vers fermenteur?", ["Ignorer", "Mettre dans la boucle et remplir de désinfectant", "Nettoyer après", "Inspecter visuellement"], 1, "Inclusion dans CIP."),
      q("Combien de temps laisser désinfectant en échangeur?", ["Pendant chauffage", "Jusqu'au refroidissement du moût", "5 minutes", "Immédiatement après"], 1, "Couverture de la période critique."),
      q("Quel est le résultat d'une bonne désinfection échangeur?", ["Apparence brillante", "Circuit stérile au transfert du moût", "Odeur agréable", "Couleur claire"], 1, "Hygiène garantie."),
      q("Quel équipement brasse-t-on?", ["Filtration uniquement", "Empâtage, Filtration, Fermentation", "Fermentation seulement", "Refroidissement seul"], 1, "Schéma complet brasserie."),
      q("Nécessite-t-on le même protocole pour tous?", ["Oui exactement", "Non, chaque section a son propre protocole adapté", "Variable", "Un seul suffit"], 1, "Protocoles spécifiques."),
      q("Quel est le risque d'une contamination du fermenteur?", ["Peu important", "Affecte toute la production ultérieure de bière", "Minime", "Seulement un batch"], 1, "Cascade d'infection.")
    ]
  },
  {
    id: "bonnesPratiquesCIP",
    category: "CIP",
    title: "23. Points de vigilance et bonnes pratiques CIP",
    ficheRich: [
      {
        title: "Danger 1 : Ne pas mélanger les produits",
        items: [
          "**Soude + Acide** : Réaction violente, risque de projections.",
          "**Javel + Acide** : Dégagement de chlore gazeux (toxique - ⚠️ DANGER MORTEL).",
          "**Différents désinfectants** : Neutralisation, inefficacité du nettoyage.",
          "✅ **RÈGLE D'OR** : Toujours rincer entre deux produits différents."
        ]
      },
      {
        title: "Danger 2 : Réaction Soude + CO₂",
        items: [
          "**Phénomène** : La soude réagit avec le CO₂ résiduel du fermenteur.",
          "**Conséquence** : Création d'un vide (dépression dans la cuve).",
          "**Risque majeur** : Implosion de la cuve (collapse) - ⚠️ DANGER.",
          "**Solutions de prévention** : Vider le CO₂ du fermenteur (laisser ouvert 24h avant CIP), utiliser le casse-vide (si fonctionnel).",
          "**Vigilance** : Attention si le casse-vide est défectueux."
        ]
      },
      {
        title: "Danger 3 : Vanne de surpression",
        items: [
          "**Lors du remplissage** : Utiliser obligatoirement la vanne de surpression.",
          "**Risque** : Surpression pouvant endommager ou déformer la cuve.",
          "**Maintenance** : Vérifier le fonctionnement régulier de la vanne."
        ]
      },
      {
        title: "Checklist avant le CIP",
        items: [
          "✓ Identifier les CCP (Points de Contrôle Critiques).",
          "✓ Vérifier les CCP à chaque nettoyage.",
          "✓ S'assurer que les solutions sont bien séparées (pas de cross-contamination).",
          "✓ Vérifier le dimensionnement des pompes/boules CIP (capacité).",
          "✓ Vérifier l'intégrité des joints et raccords."
        ]
      },
      {
        title: "Checklist pendant le CIP",
        items: [
          "✓ Contrôler le débit des pompes (suffisant et régulier).",
          "✓ Vérifier que les boules CIP ne sont pas bouchées.",
          "✓ Surveiller les températures (atteinte des consignes).",
          "✓ Contrôler les concentrations (conductivimètre).",
          "✓ Vérifier absence de fuites."
        ]
      },
      {
        title: "Équipements à nettoyer spécifiquement",
        items: [
          "**Boules CIP** : Points de projection critique, vérifier absence obstruction.",
          "**Casse-vide** : Éliminer dépression résiduelle, entretien régulier.",
          "**Vannes de surpression** : Vérifier ouverture/fermeture, nettoyage.",
          "**Barboteur** : Points de stagnation possible, trempage recommandé.",
          "**Prises d'échantillons** : Zones mortes potentielles, nettoyage spécifique.",
          "**Toutes les vannes** : Nettoyage et désinfection individuels si nécessaire."
        ]
      },
      {
        title: "Entretien de la station CIP",
        items: [
          "**Rinçage régulier** : Après chaque cycle pour éviter cristallisation.",
          "**Passage à l'acide** : Régulièrement pour éliminer tartre et dépôts.",
          "**Vérification des sondes** : Calibrage, nettoyage, remplacement si défectueux.",
          "**Maintenance pompes** : Contrôle usure, joints, débits.",
          "**Inspection tuyauterie** : Recherche de fuites, dépôts, encrassement."
        ]
      },
      {
        title: "Zones mortes - Problème critique",
        items: [
          "**Définition** : Partie du circuit où le liquide de nettoyage ne circule pas ou stagne.",
          "**Causes principales** : Mauvais dimensionnement pompes, boules CIP mal positionnées, angles morts conception, tuyaux trop longs sans circulation.",
          "**Conséquences graves** : Accumulation de bactéries, contamination récurrente, inefficacité nettoyage.",
          "**Solutions** : Bien dimensionner pompes et boules CIP, conception hygiénique des équipements, vérification régulière de la couverture (100%)."
        ]
      }
    ],
    questions: [
      q("Quel est le résultat du mélange Soude + Acide?", ["Nettoyage optimisé", "Réaction violente et projections", "Aucun effet", "Amélioration efficacité"], 1, "Chimie dangereuse."),
      q("Quel mélange produit du chlore gazeux toxique?", ["Soude + Acide", "Javel + Acide", "Chlore + eau", "Savon + chlore"], 1, "Risque mortel."),
      q("Qu'est-ce qu'une zone morte en CIP?", ["Endroit gelé", "Zone où le liquide ne circule pas ou stagne", "Air chaud", "Désinfectant en excès"], 1, "Problème hygiénique."),
      q("Quel est le risque principal d'une zone morte?", ["Amélioration du nettoyage", "Accumulation de bactéries et contamination", "Augmentation débit", "Température élevée"], 1, "Source d'infection."),
      q("Quel phénomène se produit avec Soude + CO₂?", ["Chauffage rapide", "Création d'un vide (dépression)", "Augmentation de pression", "Coloration du moût"], 1, "Réaction dangereuse."),
      q("Quel est le risque du vide créé par Soude + CO₂?", ["Lenteur du nettoyage", "Implosion de la cuve (collapse)", "Fuite", "Surpression"], 1, "Danger structurel."),
      q("Comment prévenir la création de vide?", ["Ajouter CO₂", "Vider le CO₂ avant (laisser ouvert 24h) et utiliser casse-vide", "Utiliser plus de soude", "Augmenter température"], 1, "Prévention essentielle."),
      q("À quoi sert le casse-vide?", ["Créer pression", "Éliminer dépression/vide dans la cuve", "Chauffer le moût", "Agiter"], 1, "Sécurité contre collapse."),
      q("Quel risque pose la vanne de surpression?", ["Aucun", "Sans utilisation: surpression pouvant endommager cuve", "Sous-pression", "Fuites"], 1, "Contrôle de pression."),
      q("Quand utiliser la vanne de surpression?", ["Toujours", "Lors du remplissage", "Pendant détergent", "Jamais"], 1, "Timing critique."),
      q("Qu'est-ce qu'un CCP en brasserie?", ["Cuve à Cuivre Principal", "Point de Contrôle Critique", "Cercle Complet Process", "Cycle de Circulation"], 1, "Contrôle qualité."),
      q("Que faire avant chaque CIP?", ["Rien de spécial", "Identifier et vérifier les CCP", "Remplir les cuves", "Attendre"], 1, "Étape préalable."),
      q("Comment doivent être séparées les solutions?", ["Ensemble", "Bien séparées pour éviter cross-contamination", "N'importe comment", "Mélangées progressivement"], 1, "Sécurité chimique."),
      q("Quel équipement à vérifier avant CIP?", ["La couleur", "Le dimensionnement des pompes/boules CIP", "La date", "L'étiquette"], 1, "Capacité opérationnelle."),
      q("Quel est le critère pendant le CIP?", ["Silence", "Contrôler débit pompes et concentration", "Attendre", "Observer couleur"], 1, "Monitoring en temps réel."),
      q("Que vérifier sur les boules CIP?", ["Taille", "Absence d'obstruction/bouchage", "Couleur", "Poids"], 1, "Couverture complète."),
      q("Quel équipement contient souvent des zones mortes?", ["Grands tuyaux", "Barboteur, prises d'échantillons, vannes", "Pompes", "Boules"], 1, "Points d'attention critiques."),
      q("Comment nettoyer le barboteur?", ["CIP standard", "Trempage avec circulations spécifiques", "Une seule fois par an", "Non nécessaire"], 1, "Équipement sensible."),
      q("Quelle est l'importance des sondes?", ["Décoratives", "Critiques pour mesurer concentration et température", "Optionnelles", "Peu importantes"], 1, "Monitoring de qualité."),
      q("Que faire des sondes défectueuses?", ["Continuer ainsi", "Remplacement obligatoire", "Ignorer", "Nettoyer seulement"], 1, "Fiabilité des mesures."),
      q("Combien de fois passer l'acide en station CIP?", ["Une seule", "Régulièrement pour éliminer tartre", "Jamais", "Hebdomadaire"], 1, "Maintenance préventive."),
      q("Pourquoi rincer après chaque cycle?", ["Obligation légale", "Pour éviter cristallisation et accumulation dépôts", "Gaspillage d'eau", "Sans importance"], 1, "Conservation de l'équipement."),
      q("Qu'est-ce qu'une bonne couverture CIP?", ["Visible", "100% de la surface", "50% suffit", "Variable"], 1, "Nettoyage complet."),
      q("Quelle cause crée les zones mortes?", ["Trop de pression", "Mauvais dimensionnement pompes, mauvaise position boules", "Eau froide", "Détergent faible"], 1, "Origine du problème."),
      q("Comment éliminer les zones mortes?", ["Accepter", "Bien dimensionner pompes, boules CIP, conception hygiénique", "Utiliser plus de produit", "Augmenter temps"], 1, "Solution par le design."),
      q("Quel résultat apporte vérification régulière couverture?", ["Aucun", "Assurance 100% efficacité nettoyage", "Gaspillage", "Ralentissement"], 1, "Validité du process."),
      q("Que faire si boule CIP est bouchée?", ["Continuer", "Déboucher ou remplacer", "Augmenter pression", "Laisser"], 1, "Maintenance immédiate."),
      q("Quel est l'ordre de rinçage/produit?", ["Produit directement", "Rincer systématiquement entre produits différents", "Optionnel", "Mélanger progressivement"], 1, "Sécurité chimique absolue."),
      q("Combien de temps laisser ouvert fermenteur avant CIP?", ["1 heure", "24 heures (pour vider CO₂)", "1 minute", "Immédiatement"], 1, "Élimination du gaz."),
      q("Quel est l'impact d'une boule CIP défectueuse?", ["Pas d'impact", "Zones mortes et nettoyage incomplet", "Meilleur nettoyage", "Plus rapide"], 1, "Efficacité compromise.")
    ]
  },
  {
    id: "epi",
    category: "CIP",
    title: "24. Protection du personnel (EPI)",
    ficheRich: [
      {
        title: "Contexte – produits dangereux",
        items: [
          "**Soude caustique (pH ~14)** → brûlures chimiques graves.",
          "**Acides** (phosphorique, nitrique, péracétique) → brûlures, irritations.",
          "**Températures élevées (60–80°C)** → brûlures thermiques."
        ]
      },
      {
        title: "EPI obligatoires – Protection de la peau",
        items: [
          "**Gants** : Protection contre les brûlures chimiques (type recommandé : **nitrile** ou **néoprène**).",
          "**Tablier** : Protection contre les **projections**.",
          "**Manches longues** : Limiter le **contact accidentel** sur la peau."
        ]
      },
      {
        title: "EPI – Protection des yeux",
        items: [
          "**Lunettes de protection** : contre les **projections de liquide**.",
          "**Écran facial** : pour les **projections importantes**.",
          "Risques : **brûlure chimique**, **brûlure thermique**, **diphtérie oculaire** (infection grave).",
          "⚠️ **Les projections oculaires sont des urgences médicales !**"
        ]
      },
      {
        title: "EPI – Protection du corps",
        items: [
          "**Vêtement de travail** : **résistant aux acides**.",
          "**Combinaison** : pour les **opérations à risque** (fortes projections, produits concentrés)."
        ]
      },
      {
        title: "EPI – Protection des pieds",
        items: [
          "**Chaussures de sécurité** : **antidérapantes**.",
          "**Bottes** : pour **zones humides**.",
          "Risques : **sol mouillé et glissant**, **projections de produits**, **chutes**."
        ]
      },
      {
        title: "Tableau récapitulatif des EPI",
        items: [
          "**Mains** → Gants chimiques : **Brûlures chimiques**.",
          "**Yeux** → Lunettes/Écran : **Projections**.",
          "**Corps** → Tablier/Combinaison : **Contact chimique**.",
          "**Pieds** → Chaussures antidérapantes : **Glissades**."
        ]
      },
      {
        title: "Consignes de sécurité générales",
        items: [
          "Peau : **rincer abondamment 15–20 min**, retirer vêtements contaminés, **consulter** si brûlure.",
          "Yeux : **rincer immédiatement 15–20 min**, **ne pas frotter**, **urgence médicale**.",
          "Inhalation : **quitter la zone**, respirer **air frais**, **consulter** si symptômes."
        ]
      }
    ],
    questions: [
      q("Pourquoi les EPI sont-ils indispensables en brasserie?", ["Esthétique", "Produits chimiques dangereux (soude, acides) et chaleur", "Optionnel", "Confort"], 1, "Risque chimique et thermique."),
      q("Quel est le pH de la soude caustique?", ["~7", "~10", "~14", "~3"], 2, "Soude très basique et corrosive."),
      q("Quels acides sont cités comme risques?", ["Citrique uniquement", "Phosphorique, nitrique, péracétique", "Acide lactique", "Acide ascorbique"], 1, "Principaux acides utilisés."),
      q("Quelle plage de température crée un risque de brûlure thermique?", ["10–20°C", "60–80°C", "0–5°C", "90–100°C"], 1, "Liquides chauds de nettoyage."),
      q("Quels gants sont recommandés?", ["Coton", "Nitrile ou néoprène", "Laine", "Vinyle"], 1, "Résistants aux produits chimiques."),
      q("Les gants protègent contre…", ["La poussière", "Les brûlures chimiques", "Le froid", "Le bruit"], 1, "Protection cutanée."),
      q("Le tablier sert à…", ["Décorer", "Protéger des projections", "Tenir chaud", "Réduire le bruit"], 1, "Barrière anti-projection."),
      q("Les manches longues réduisent…", ["La transpiration", "Le contact accidentel avec produits", "Le coût", "La visibilité"], 1, "Couverture de la peau."),
      q("Les lunettes de protection protègent de…", ["La poussière sonore", "Projections de liquide", "La chaleur ambiante", "La lumière"], 1, "Barrière oculaire."),
      q("L'écran facial est utile pour…", ["La vision nocturne", "Projections importantes", "Le confort", "Le stockage"], 1, "Grande surface de protection."),
      q("Une projection oculaire est…", ["Banale", "Une urgence médicale", "Optionnelle", "Sans danger"], 1, "Risque majeur immédiat."),
      q("Parmi ces risques oculaires, lequel est cité?", ["Myopie", "Brûlure chimique/thermique, diphtérie oculaire", "UV uniquement", "Fatigue"], 1, "Gravité des projections."),
      q("Un vêtement de travail doit être…", ["Décoratif", "Résistant aux acides", "Transparent", "Jetable"], 1, "Protection corporelle."),
      q("La combinaison est utilisée…", ["Toujours", "Pour les opérations à risque", "Jamais", "Uniquement en bureau"], 1, "Expositions élevées."),
      q("Les chaussures de sécurité doivent être…", ["Souples", "Antidérapantes", "Ouvertes", "Sans embout"], 1, "Prévention des chutes."),
      q("Les bottes sont utiles…", ["Au bureau", "En zones humides", "En montagne", "Jamais"], 1, "Protection en sol mouillé."),
      q("Quel risque est lié au sol mouillé?", ["Bruit", "Glissade et chute", "Allergie", "Chaleur"], 1, "Accident de travail."),
      q("Associer 'Mains' au bon EPI", ["Lunettes", "Gants chimiques", "Chaussures", "Écran facial"], 1, "Protection cutanée."),
      q("Associer 'Yeux' au bon EPI", ["Gants", "Lunettes/Écran", "Chaussures", "Tablier"], 1, "Protection oculaire."),
      q("Associer 'Corps' au bon EPI", ["Chaussures", "Tablier/Combinaison", "Lunettes", "Gants"], 1, "Protection corporelle."),
      q("Associer 'Pieds' au bon EPI", ["Gants", "Chaussures antidérapantes", "Lunettes", "Écran facial"], 1, "Antichute."),
      q("Premier geste en cas de contact peau?", ["Essuyer", "Rincer 15–20 min à l'eau", "Attendre", "Appliquer chaleur"], 1, "Dilution immédiate."),
      q("Que faire des vêtements contaminés?", ["Les garder", "Les retirer", "Les laver plus tard", "Les sécher"], 1, "Supprimer source chimique."),
      q("Quand consulter un médecin (peau)?", ["Jamais", "Si brûlure", "Après une semaine", "Seulement si douleur"], 1, "Évaluation médicale."),
      q("Premier geste en cas de projection oculaire?", ["Fermer les yeux", "Rincer immédiatement 15–20 min", "Regarder la lumière", "Mettre des lunettes"], 1, "Urgence vitale."),
      q("Que ne faut-il pas faire pour les yeux?", ["Rincer", "Ne pas frotter", "Appeler le médecin", "Retirer lentilles"], 1, "Éviter aggravation."),
      q("Que faire en cas d'inhalation de vapeurs?", ["Rester sur place", "Quitter la zone et respirer air frais", "Boire de l'eau", "Augmenter la ventilation"], 1, "Éloignement immédiat."),
      q("Quand consulter après inhalation?", ["Jamais", "Si symptômes", "Toujours", "Après 1 mois"], 1, "Suivi médical."),
      q("Quel EPI n'est pas pour les yeux?", ["Lunettes", "Écran facial", "Bottes", "Visière"], 2, "Protection pieds ≠ yeux."),
      q("Quel EPI réduit le risque de glissade?", ["Gants", "Chaussures antidérapantes", "Lunettes", "Tablier"], 1, "Adhérence au sol.")
    ]
  },
  {
    id: "introductionLevure",
    category: "LEVURE",
    title: "25. Introduction à la levure",
    ficheRich: [
      {
        title: "Classification biologique - Place dans le monde vivant",
        items: [
          "**MONDE VIVANT** → Cellulaire (Eucaryotes et Procaryotes) / Acellulaire (Virus)",
          "**EUCARYOTES** (avec noyau) → Plantes, Animaux, Protistes, FUNGI (Champignons)",
          "**FUNGI** → Comprend les levures et champignons",
          "**LEVURES** → Champignons unicellulaires eucaryotes"
        ]
      },
      {
        title: "Caractéristiques de la levure",
        items: [
          "**Règne**: Fungi (champignons)",
          "**Type cellulaire**: Eucaryote (possède un noyau)",
          "**Taille**: ~10 µm de diamètre",
          "**Structure**: Unicellulaire",
          "**Particularité**: Présence de mitochondries (contrairement aux bactéries)"
        ]
      },
      {
        title: "Reproduction",
        items: [
          "**Mode principal**: Bourgeonnement asexué (budding en anglais)",
          "**Processus**: La cellule mère forme un bourgeon qui se détache pour former une nouvelle cellule"
        ]
      },
      {
        title: "Utilisations de la levure",
        items: [
          "**Brasserie**: Production de bière",
          "**Vinification**: Production de vin",
          "**Distillerie**: Production d'alcools",
          "**Boulangerie**: Levée du pain",
          "**Pharmaceutique**: Production d'antibiotiques et vaccins"
        ]
      },
      {
        title: "Espèces principales en brasserie",
        items: [
          "**Saccharomyces cerevisiae**: Fermentation haute (ales)",
          "**Saccharomyces carlsbergensis (pastorianus)**: Fermentation basse (lagers)"
        ]
      },
      {
        title: "Historique",
        items: [
          "**1857**: Louis Pasteur publie 'Mémoire sur la fermentation alcoolique'",
          "**1883-1885**: Emil Hansen isole la levure basse chez Carlsberg"
        ]
      },
      {
        title: "Aspects négatifs",
        items: [
          "Certaines levures sont **pathogènes**",
          "**Candida albicans** → mycose, muguet"
        ]
      },
      {
        title: "Points à retenir",
        items: [
          "✅ La levure est un champignon unicellulaire eucaryote",
          "✅ Elle se reproduit par bourgeonnement",
          "✅ Mise en évidence scientifique par Pasteur en 1857",
          "✅ Utilisée dans de nombreuses industries alimentaires"
        ]
      }
    ],
    questions: [
      q("À quel règne appartient la levure?", ["Plantes", "Animaux", "Fungi (Champignons)", "Bactéries"], 2, "La levure appartient au règne Fungi."),
      q("Quel type de cellule est la levure?", ["Procaryote", "Eucaryote", "Virus", "Bactérie"], 1, "La levure est eucaryote avec un noyau."),
      q("Quelle est la taille approximative d'une levure?", ["1 µm", "10 µm", "100 µm", "1 mm"], 1, "Environ 10 µm de diamètre."),
      q("Quel organite la levure possède-t-elle contrairement aux bactéries?", ["Chloroplaste", "Mitochondrie", "Vacuole", "Ribosome"], 1, "Les mitochondries sont présentes dans les eucaryotes."),
      q("Quel est le mode principal de reproduction de la levure?", ["Division binaire", "Bourgeonnement", "Sporulation", "Conjugaison"], 1, "Reproduction par bourgeonnement (budding)."),
      q("Comment appelle-t-on le bourgeonnement en anglais?", ["Splitting", "Budding", "Growing", "Dividing"], 1, "Budding = bourgeonnement."),
      q("Qui a publié le 'Mémoire sur la fermentation alcoolique' en 1857?", ["Emil Hansen", "Louis Pasteur", "Carlsberg", "Darwin"], 1, "Pasteur a mis en évidence le rôle de la levure."),
      q("Qui a isolé la levure basse chez Carlsberg?", ["Louis Pasteur", "Emil Hansen", "Charles Darwin", "Robert Koch"], 1, "Emil Hansen entre 1883-1885."),
      q("Quelle espèce de levure est utilisée pour les fermentations hautes (ales)?", ["Saccharomyces pastorianus", "Saccharomyces cerevisiae", "Candida albicans", "Aspergillus"], 1, "S. cerevisiae pour les ales."),
      q("Quelle espèce est utilisée pour les fermentations basses (lagers)?", ["Saccharomyces cerevisiae", "Saccharomyces carlsbergensis", "Candida albicans", "Aspergillus"], 1, "S. carlsbergensis (pastorianus) pour les lagers."),
      q("Dans quel domaine la levure n'est-elle PAS utilisée?", ["Brasserie", "Boulangerie", "Métallurgie", "Pharmaceutique"], 2, "La métallurgie n'utilise pas de levure."),
      q("Quel est un exemple de levure pathogène?", ["Saccharomyces cerevisiae", "Candida albicans", "S. pastorianus", "Toutes"], 1, "Candida albicans cause mycoses et muguet."),
      q("La levure est-elle unicellulaire ou pluricellulaire?", ["Unicellulaire", "Pluricellulaire", "Les deux", "Ni l'un ni l'autre"], 0, "La levure est unicellulaire."),
      q("Dans quelle branche du vivant se trouvent les levures?", ["Acellulaire", "Procaryotes", "Eucaryotes", "Virus"], 2, "Les levures sont des eucaryotes."),
      q("Quelle industrie utilise la levure pour faire lever le pain?", ["Brasserie", "Boulangerie", "Distillerie", "Vinification"], 1, "La boulangerie utilise la levure pour le pain."),
      q("Quel produit les levures ne produisent-elles PAS directement?", ["Alcool", "CO2", "Antibiotiques (certaines souches)", "Acier"], 3, "L'acier n'est pas produit par levure."),
      q("En quelle année Pasteur a-t-il publié son mémoire?", ["1850", "1857", "1883", "1900"], 1, "1857 est l'année de publication."),
      q("Quelle période correspond à l'isolement de la levure basse?", ["1857-1860", "1883-1885", "1900-1910", "1950-1960"], 1, "1883-1885 par Emil Hansen."),
      q("Comment se forme une nouvelle cellule de levure?", ["Par division du noyau seul", "Par bourgeonnement de la cellule mère", "Par fusion de deux cellules", "Par fragmentation"], 1, "Bourgeonnement = formation d'un bourgeon qui se détache."),
      q("Quelle est la principale différence entre levure et bactérie?", ["Taille uniquement", "Présence d'un noyau et mitochondries", "Couleur", "Forme"], 1, "Levure = eucaryote avec noyau, bactérie = procaryote sans noyau."),
      q("Les levures font-elles partie du monde acellulaire?", ["Oui", "Non, elles sont cellulaires", "Seulement certaines", "Parfois"], 1, "Les levures sont des organismes cellulaires."),
      q("Quel est le nom scientifique complet de la levure de bière haute?", ["Saccharomyces pastorianus", "Saccharomyces cerevisiae", "Candida cerevisiae", "Fungi cerevisiae"], 1, "S. cerevisiae = levure de fermentation haute."),
      q("Que signifie 'Saccharomyces'?", ["Champignon du sucre", "Levure alcoolique", "Cellule simple", "Bourgeonnement"], 0, "Saccharo = sucre, myces = champignon."),
      q("Les levures possèdent-elles une paroi cellulaire?", ["Non", "Oui, comme les champignons", "Seulement les pathogènes", "Uniquement S. cerevisiae"], 1, "Comme tous les champignons, les levures ont une paroi."),
      q("Quelle maladie n'est PAS causée par Candida albicans?", ["Mycose", "Muguet", "Tuberculose", "Candidose"], 2, "La tuberculose est bactérienne, pas fongique."),
      q("Dans quelle industrie la levure produit-elle des vaccins?", ["Brasserie", "Boulangerie", "Pharmaceutique", "Distillerie"], 2, "L'industrie pharmaceutique utilise la levure."),
      q("Quel gaz la levure produit-elle lors de la fermentation?", ["Oxygène", "CO2 (dioxyde de carbone)", "Azote", "Hydrogène"], 1, "La fermentation produit CO2 et alcool."),
      q("Où Emil Hansen a-t-il isolé la levure basse?", ["À Paris", "Chez Carlsberg", "À Munich", "À Londres"], 1, "Hansen travaillait pour la brasserie Carlsberg."),
      q("Les virus font-ils partie de la même branche que les levures?", ["Oui", "Non, les virus sont acellulaires", "Parfois", "Seulement certains"], 1, "Virus = acellulaire, levure = cellulaire eucaryote."),
      q("Quel alcool principal la levure produit-elle?", ["Méthanol", "Éthanol", "Propanol", "Butanol"], 1, "L'éthanol est le produit principal de fermentation.")
    ]
  },
  {
    id: "theorieFermentation",
    category: "LEVURE",
    title: "26. Théorie de la fermentation",
    ficheRich: [
      {
        title: "Métabolisme de la levure - Principe fondamental",
        items: [
          "La levure peut vivre de **deux façons** selon la présence ou l'absence d'oxygène",
          "**Respiration** : en présence d'O₂ → production maximale d'énergie",
          "**Fermentation** : en absence d'O₂ → production d'alcool + CO₂"
        ]
      },
      {
        title: "Respiration aérobie (avec O₂)",
        items: [
          "**Équation** : C₆H₁₂O₆ + 6O₂ → 6CO₂ + 6H₂O + ÉNERGIE",
          "**Rendement** : Élevé (production d'énergie maximale)",
          "**Produits** : CO₂ + eau (pas d'alcool)",
          "**Usage** : Multiplication des levures (propagation)"
        ]
      },
      {
        title: "Fermentation alcoolique (sans O₂)",
        items: [
          "**Équation** : C₆H₁₂O₆ → 2C₂H₅OH + 2CO₂ + ÉNERGIE",
          "**Rendement** : ~14x moins rentable énergétiquement",
          "**Produits** : Éthanol + CO₂",
          "**Usage** : Production de bière !"
        ]
      },
      {
        title: "Facteur déterminant : concentration en sucres",
        items: [
          "La **concentration en sucres** est très importante pour orienter le métabolisme",
          "**Faible concentration + O₂** → Respiration privilégiée",
          "**Concentration élevée (même avec O₂)** → Fermentation (effet Crabtree)",
          "**Effet Crabtree** : La levure fermente même en présence d'oxygène si les sucres sont abondants"
        ]
      },
      {
        title: "Les densités - Définitions clés",
        items: [
          "**OG (Original Gravity)** : Densité primitive = quantité de sucre en début de fermentation",
          "**FG (Final Gravity)** : Densité finale = quantité de sucre en fin de fermentation",
          "**Atténuation apparente (Att)** : Capacité de la levure à dégrader les sucres"
        ]
      },
      {
        title: "Formule de l'atténuation",
        items: [
          "**Formule** : Atténuation (%) = (OG - FG) / OG × 100",
          "**Exemple** : OG = 16°P, FG = 1°P → Att = (16-1)/16 = 93.75%"
        ]
      },
      {
        title: "Échelle d'atténuation",
        items: [
          "**65-70%** : Atténuation faible",
          "**71-75%** : Atténuation moyenne",
          "**76-80%** : Atténuation élevée",
          "**100%** : Possible avec Brettanomyces (super-atténuation)"
        ]
      },
      {
        title: "Pourquoi 'apparente' ?",
        items: [
          "On mesure directement les densités sans tenir compte de l'**éthanol présent**",
          "Densité de l'éthanol = 0.8 (plus léger que l'eau)",
          "L'atténuation réelle serait légèrement différente si on corrigeait pour l'alcool"
        ]
      },
      {
        title: "Points à retenir",
        items: [
          "✅ Respiration = énergie maximale, pas d'alcool",
          "✅ Fermentation = alcool + CO₂, moins d'énergie",
          "✅ La concentration en sucres influence le métabolisme",
          "✅ L'atténuation mesure l'efficacité de la fermentation"
        ]
      }
    ],
    questions: [
      q("Avec O₂, la levure produit…?", ["Éthanol + CO₂", "CO₂ + H₂O + énergie", "Seulement CO₂", "Rien"], 1, "Respiration = CO₂ + eau + énergie."),
      q("Sans O₂, la levure produit…?", ["CO₂ + H₂O", "Éthanol + CO₂ + énergie", "Seulement éthanol", "Rien"], 1, "Fermentation = éthanol + CO₂."),
      q("Processus le plus énergétiquement rentable?", ["Fermentation", "Respiration", "Les deux pareil", "Aucun"], 1, "Respiration ~14x plus d'énergie."),
      q("CO₂ produit par 1 glucose en fermentation?", ["1", "2", "4", "6"], 1, "C₆H₁₂O₆ → 2C₂H₅OH + 2CO₂."),
      q("Éthanol produit par 1 glucose?", ["1", "2", "4", "6"], 1, "1 glucose → 2 éthanol."),
      q("Équation de la respiration?", ["C₆H₁₂O₆ → 2C₂H₅OH + 2CO₂", "C₆H₁₂O₆ + 6O₂ → 6CO₂ + 6H₂O", "C₆H₁₂O₆ → 6CO₂", "Aucune"], 1, "Glucose + O₂ → CO₂ + H₂O."),
      q("Usage principal de la respiration?", ["Production de bière", "Multiplication des levures", "Aromatisation", "Aucun"], 1, "Respiration = propagation."),
      q("Usage principal de la fermentation?", ["Multiplication", "Production d'alcool/bière", "Stockage", "Aucun"], 1, "Fermentation = alcool + CO₂."),
      q("Que signifie OG?", ["Oxygen Gas", "Original Gravity", "Organic Growth", "Old Grain"], 1, "Densité primitive."),
      q("Que signifie FG?", ["Final Grain", "Final Gravity", "Fast Growth", "Fermentation Gas"], 1, "Densité finale."),
      q("Formule de l'atténuation?", ["FG / OG", "(OG - FG) / OG × 100", "OG - FG", "FG × OG"], 1, "(OG - FG) / OG × 100."),
      q("OG=16°P, FG=4°P → atténuation?", ["25%", "50%", "75%", "100%"], 2, "(16-4)/16 = 75%."),
      q("Atténuation de 68% est…", ["Faible", "Moyenne", "Élevée", "Très élevée"], 0, "65-70% = faible."),
      q("Atténuation de 73% est…", ["Faible", "Moyenne", "Élevée", "Très élevée"], 1, "71-75% = moyenne."),
      q("Atténuation de 78% est…", ["Faible", "Moyenne", "Élevée", "Très élevée"], 2, "76-80% = élevée."),
      q("Quelle levure peut atteindre 100% d'atténuation?", ["Saccharomyces cerevisiae", "Brettanomyces", "Candida", "Aucune"], 1, "Brettanomyces."),
      q("Effet Crabtree?", ["Fermentation même avec O₂ si sucres élevés", "Respiration sans O₂", "Multiplication lente", "Aucun effet"], 0, "Sucres élevés → fermentation malgré O₂."),
      q("Densité de l'éthanol?", ["1.0", "0.8", "1.2", "0.5"], 1, "Éthanol ≈ 0.8."),
      q("Pourquoi atténuation 'apparente'?", ["C'est une estimation", "On ne corrige pas l'éthanol", "Elle varie", "C'est une erreur"], 1, "Mesure sans corriger l'alcool."),
      q("O₂ + faible sucre → la levure…", ["Fermente", "Respire", "Meurt", "Ne fait rien"], 1, "Faible sucre + O₂ → respiration."),
      q("O₂ + sucre élevé → la levure…", ["Respire uniquement", "Fermente (effet Crabtree)", "Meurt", "Ne fait rien"], 1, "Fermente même avec O₂."),
      q("Respiration plus rentable que fermentation de…", ["2x", "7x", "14x", "100x"], 2, "~14x."),
      q("Gaz produit lors de la respiration?", ["O₂", "CO₂", "N₂", "H₂"], 1, "CO₂ + H₂O."),
      q("La fermentation produit-elle de l'eau?", ["Oui", "Non", "Parfois", "En grande quantité"], 1, "Pas d'eau produite."),
      q("La respiration produit-elle de l'alcool?", ["Oui", "Non", "Parfois", "Toujours"], 1, "Pas d'alcool."),
      q("Substrat de départ des deux voies?", ["Éthanol", "Glucose", "CO₂", "Eau"], 1, "Glucose."),
      q("OG=12°P, FG=3°P → atténuation…", ["25%", "50%", "75%", "90%"], 2, "(12-3)/12 = 75%."),
      q("Levure à 82% d'atténuation est…", ["Faible", "Moyenne", "Élevée", "Exceptionnelle"], 3, ">80% = exceptionnelle (type Brett)."),
      q("Formule chimique de l'éthanol?", ["C₂H₆O", "C₂H₅OH", "CH₃OH", "C₆H₁₂O₆"], 1, "C₂H₅OH."),
      q("Pendant la propagation, on privilégie…", ["La fermentation", "La respiration", "Les deux", "Aucun"], 1, "Propagation = respiration."),
    ]
  },
  {
    id: "typesFermentation",
    category: "LEVURE",
    title: "27. Types de fermentation",
    ficheRich: [
      {
        title: "Vue d'ensemble des 4 types",
        items: [
          "**Fermentation HAUTE** : 15-25°C, S. cerevisiae, surface → Ales",
          "**Fermentation BASSE** : 12-14°C, S. pastorianus, fond → Lagers",
          "**Fermentation SPONTANÉE** : Variable, levures sauvages → Lambics, Gueuze",
          "**Fermentation MIXTE** : Variable, plusieurs micro-organismes → Bières complexes"
        ]
      },
      {
        title: "1. Fermentation SPONTANÉE",
        items: [
          "**Méthode la plus ancienne** de fermentation",
          "**Principe** : Le moût est exposé à l'air libre, ensemencement par l'environnement",
          "**Levures sauvages** : Brettanomyces bruxellensis, Brettanomyces lambicus",
          "**Saison** : Uniquement saison froide (mi-septembre à mi-mai)",
          "**Région** : Vallée de la Senne (Belgique), Pajottenland",
          "**Styles** : Lambics, Gueuzes, Krieks, Faros"
        ]
      },
      {
        title: "2. Fermentation HAUTE",
        items: [
          "**Levure** : Saccharomyces cerevisiae",
          "**Température** : 15-25°C",
          "**Comportement** : Levures remontent à la surface et forment une 'croûte'",
          "**Origine du nom** : Position haute + température haute",
          "**Arômes** : Complexes et fruités",
          "**Styles (Ales)** : Pale Ales, IPAs, Stouts, Porters, Bières belges",
          "**Consommation** : 6-12°C"
        ]
      },
      {
        title: "3. Fermentation BASSE",
        items: [
          "**Levure** : Saccharomyces pastorianus (= carlsbergensis)",
          "**Température** : 12-14°C",
          "**Comportement** : Levures sédimentent au fond",
          "**Origine du nom** : Position basse + température basse",
          "**Histoire** : Popularisation de la pils au milieu 19ᵉ siècle à Pilsen (Tchécoslovaquie)",
          "**1883-1885** : Hansen isole S. pastorianus chez Carlsberg",
          "**Hybride** : S. pastorianus = S. cerevisiae × S. eubayanus",
          "**Styles (Lager)** : Pilsners, Märzen, Bock, Helles",
          "**'Lager'** vient de l'allemand 'lagern' = stocker",
          "**Caractéristiques** : Moins fruitées, moins alcoolisées, CO₂ supérieur",
          "**Consommation** : Fraîches 4-7°C"
        ]
      },
      {
        title: "4. Fermentation MIXTE",
        items: [
          "**Définition** : Utilisation de deux types de micro-organismes",
          "**Combinaison** : Levures de fermentation haute ET bactéries",
          "**Principe** : Mélange des processus haute + spontanée",
          "**Exemples** : Bières vieillies en fûts de chêne",
          "**Effet** : Saveur plus fruitée grâce aux micro-organismes du bois",
          "**Garde** : Plusieurs mois"
        ]
      },
      {
        title: "La floculation",
        items: [
          "**Définition** : Phénomène par lequel la levure crée des agrégats multicellulaires qui sédimentent",
          "**Rapidité** : Variable selon les souches",
          "**Risque** : Floculation trop précoce → sucres résiduels élevés",
          "**Impact** : Les souches très floculentes peuvent s'arrêter avant la fin"
        ]
      },
      {
        title: "Tableau comparatif",
        items: [
          "**HAUTE** : 15-25°C, surface, fruités, ales, durée courte",
          "**BASSE** : 12-14°C, fond, propres/nets, lagers, durée longue",
          "**SPONTANÉE** : Variable, levures sauvages, funky/acides, lambics, très longue",
          "**MIXTE** : Variable, multiples organismes, arômes variés, longue"
        ]
      }
    ],
    questions: [
      q("Combien de types de fermentation majeurs?", ["2", "3", "4", "5"], 2, "4 : haute, basse, spontanée, mixte."),
      q("Levure de fermentation haute?", ["S. pastorianus", "S. cerevisiae", "Brettanomyces", "S. eubayanus"], 1, "S. cerevisiae."),
      q("Levure de fermentation basse?", ["S. cerevisiae", "S. pastorianus", "Brettanomyces", "Levures sauvages"], 1, "S. pastorianus."),
      q("Température fermentation haute?", ["4-7°C", "12-14°C", "15-25°C", "30-35°C"], 2, "15-25°C."),
      q("Température fermentation basse?", ["4-7°C", "12-14°C", "15-25°C", "30-35°C"], 1, "12-14°C."),
      q("Position des levures en fermentation haute?", ["Au fond", "À la surface", "Au milieu", "Partout"], 1, "Remontent en surface."),
      q("Position des levures en fermentation basse?", ["À la surface", "Au fond", "Au milieu", "Partout"], 1, "Sédimentent au fond."),
      q("Nom des bières de fermentation haute?", ["Lagers", "Ales", "Lambics", "Pils"], 1, "Ales."),
      q("Nom des bières de fermentation basse?", ["Ales", "Lagers", "Lambics", "Stouts"], 1, "Lagers."),
      q("'Lager' signifie?", ["Fermenter", "Stocker", "Refroidir", "Brasser"], 1, "Lagern = stocker."),
      q("Méthode de fermentation la plus ancienne?", ["Haute", "Basse", "Spontanée", "Mixte"], 2, "Spontanée."),
      q("Levures utilisées en fermentation spontanée?", ["S. cerevisiae", "S. pastorianus", "Levures sauvages", "Aucune"], 2, "Levures sauvages."),
      q("Saison de la fermentation spontanée?", ["Toute l'année", "Été uniquement", "Saison froide (sept-mai)", "Printemps"], 2, "Mi-septembre à mi-mai."),
      q("Région classique de la fermentation spontanée?", ["Munich", "Pilsen", "Vallée de la Senne (Belgique)", "Dublin"], 2, "Pajottenland, vallée de la Senne."),
      q("Style issu de fermentation spontanée?", ["IPA", "Stout", "Lambic", "Pilsner"], 2, "Lambics, gueuzes, krieks."),
      q("Ville tchèque qui a popularisé la Pils?", ["Prague", "Pilsen", "Brno", "Ostrava"], 1, "Pilsen."),
      q("Quand Hansen a-t-il isolé S. pastorianus?", ["1857", "1883-1885", "1900", "1920"], 1, "1883-1885."),
      q("S. pastorianus est un hybride de…", ["S. cerevisiae × S. eubayanus", "S. cerevisiae × Brettanomyces", "Deux bactéries", "Aucune réponse"], 0, "cerevisiae × eubayanus."),
      q("Quelle fermentation forme une croûte en surface?", ["Basse", "Haute", "Spontanée", "Mixte"], 1, "Fermentation haute."),
      q("Les ales sont généralement…", ["Moins fruitées que lagers", "Plus fruitées que lagers", "Identiques", "Sans arôme"], 1, "Ales = fruitées."),
      q("Les lagers ont généralement…", ["Moins de CO₂", "Plus de CO₂", "Pas de CO₂", "Autant"], 1, "CO₂ supérieur."),
      q("Température de service des ales?", ["0-4°C", "4-7°C", "6-12°C", "15-20°C"], 2, "6-12°C."),
      q("Température de service des lagers?", ["0-2°C", "4-7°C", "10-15°C", "15-20°C"], 1, "4-7°C."),
      q("Fermentation mixte = ?", ["Deux levures hautes", "Levures + bactéries", "Deux bactéries", "Aucun micro-organisme"], 1, "Levures + bactéries."),
      q("Vieillissement des bières mixtes?", ["Bouteilles plastique", "Fûts de chêne", "Cuves inox", "Jarres en terre"], 1, "Fûts de chêne."),
      q("Floculation = ?", ["Division cellulaire", "Formation d'agrégats qui sédimentent", "Production de CO₂", "Mort cellulaire"], 1, "Agrégats qui sédimentent."),
      q("Risque d'une floculation précoce?", ["Trop d'alcool", "Sucres résiduels élevés", "Pas de CO₂", "Bière trop amère"], 1, "Arrêt avant fin → sucres."),
      q("Quel style n'est pas une ale?", ["IPA", "Stout", "Porter", "Pilsner"], 3, "Pilsner = lager."),
      q("Quel style n'est pas un lager?", ["Pilsner", "Bock", "Märzen", "Pale Ale"], 3, "Pale Ale = ale."),
      q("Levure sauvage typique des lambics?", ["S. cerevisiae", "Brettanomyces bruxellensis", "S. pastorianus", "Aucune"], 1, "Brettanomyces bruxellensis/lambicus."),
    ]
  },
  {
    id: "terminologieLevure",
    category: "LEVURE",
    title: "28. Terminologie de la levure",
    ficheRich: [
      {
        title: "Les composés aromatiques",
        items: [
          "**Deux grandes familles** : Les ESTERS et les ALCOOLS SUPÉRIEURS",
          "Tous deux sont produits par la levure lors de la fermentation",
          "Leur concentration dépend fortement de la température de fermentation"
        ]
      },
      {
        title: "1. Les ESTERS (totaux)",
        items: [
          "**Nature** : Composés aromatiques",
          "**Composition** : Acide + Alcool",
          "**Origine** : Issus de la fermentation",
          "**Production** : Essentiellement par les levures de haute fermentation",
          "**Arômes** : Fruités (banane, ananas, pomme, solvant)"
        ]
      },
      {
        title: "Principaux esters",
        items: [
          "**Éthyl acétate** : Arôme fruit/solvant (le plus commun)",
          "**Isoamyl acétate** : Arôme banane (très reconnaissable)",
          "**Éthyl hexanoate** : Arôme ananas (fruité tropical)",
          "**Éthyl caprylate** : Arôme pomme (fruité)"
        ]
      },
      {
        title: "2. Les ALCOOLS SUPÉRIEURS (Fusel alcohols)",
        items: [
          "**Nature** : Alcools autres que l'éthanol",
          "**Concentration souhaitée** : Faible",
          "**À faible dose** : Positifs (roses, banane, complexité)",
          "**À forte dose** : Négatifs (solvant, chimique, médicinal)",
          "**Exemples** : Alcool isoamylique (banane/solvant), Isobutanol (solvant), n-Propanol (alcool)"
        ]
      },
      {
        title: "Styles recherchant les alcools supérieurs",
        items: [
          "**Triple belge** : Alcools supérieurs recherchés",
          "**Barley wine** : Complexité aromatique",
          "**Bières fortes** : Profil aromatique riche"
        ]
      },
      {
        title: "3. Température de fermentation",
        items: [
          "**T° idéale** : Fournie par le fabricant de levure",
          "**Importance** : Cruciale pour le profil aromatique",
          "**T° basse** : Moins d'esters, profil plus propre",
          "**T° haute** : Plus d'esters, profil plus fruité",
          "**Impact** : La température influence fortement les arômes"
        ]
      },
      {
        title: "4. Levures vivantes",
        items: [
          "**Concentration** : ~7 × 10⁹ cellules/gramme de levure sèche",
          "**Utilité** : Calcul des populations et ensemencements",
          "**Importance** : Connaître la quantité pour un bon ensemencement"
        ]
      },
      {
        title: "Points à retenir",
        items: [
          "✅ Les esters donnent les arômes fruités",
          "✅ Les alcools supérieurs peuvent être positifs ou négatifs selon la concentration",
          "✅ La température de fermentation influence fortement le profil aromatique",
          "✅ Connaître la concentration en levures vivantes est essentiel pour l'ensemencement"
        ]
      }
    ],
    questions: [
      q("Que sont les esters?", ["Des sucres", "Des composés aromatiques (Acide + Alcool)", "Des protéines", "Des enzymes"], 1, "Esters = Acide + Alcool = arômes."),
      q("D'où proviennent les esters?", ["Du malt", "Du houblon", "De la fermentation par les levures", "De l'eau"], 2, "Les levures produisent les esters."),
      q("Quel type de levure produit le plus d'esters?", ["Levures basses", "Levures hautes", "Levures sauvages", "Aucune"], 1, "Levures de haute fermentation = plus d'esters."),
      q("Quel est l'ester le plus commun?", ["Isoamyl acétate", "Éthyl acétate", "Éthyl hexanoate", "Éthyl caprylate"], 1, "Éthyl acétate = le plus commun."),
      q("Quel arôme donne l'isoamyl acétate?", ["Pomme", "Banane", "Ananas", "Solvant"], 1, "Isoamyl acétate = arôme banane."),
      q("Quel arôme donne l'éthyl hexanoate?", ["Banane", "Pomme", "Ananas", "Solvant"], 2, "Éthyl hexanoate = arôme ananas (tropical)."),
      q("Quel arôme donne l'éthyl caprylate?", ["Banane", "Pomme", "Ananas", "Solvant"], 1, "Éthyl caprylate = arôme pomme."),
      q("Que sont les alcools supérieurs?", ["L'éthanol uniquement", "Alcools autres que l'éthanol", "Des esters", "Des acides"], 1, "Alcools supérieurs = autres que éthanol."),
      q("Comment appelle-t-on les alcools supérieurs en anglais?", ["Higher alcohols", "Fusel alcohols", "Super alcohols", "Strong alcohols"], 1, "Fusel alcohols = alcools supérieurs."),
      q("À faible dose, les alcools supérieurs sont…", ["Positifs (roses, banane)", "Négatifs", "Neutres", "Toxiques"], 0, "Faible dose = positif (complexité)."),
      q("À forte dose, les alcools supérieurs sont…", ["Positifs", "Négatifs (solvant, chimique)", "Neutres", "Bénéfiques"], 1, "Forte dose = négatif (médicinal, solvant)."),
      q("Quel alcool supérieur donne un arôme banane/solvant?", ["Isobutanol", "n-Propanol", "Alcool isoamylique", "Méthanol"], 2, "Alcool isoamylique = banane/solvant."),
      q("Quelle concentration d'alcools supérieurs est souhaitée?", ["Très élevée", "Élevée", "Moyenne", "Faible"], 3, "Concentration faible souhaitée."),
      q("Dans quel style recherche-t-on les alcools supérieurs?", ["Pilsner", "Triple belge", "Lager légère", "Bière sans alcool"], 1, "Triple belge, barley wine, bières fortes."),
      q("Quel effet a une température de fermentation basse?", ["Plus d'esters", "Moins d'esters, profil propre", "Aucun effet", "Arrêt fermentation"], 1, "T° basse = moins d'esters, plus propre."),
      q("Quel effet a une température de fermentation haute?", ["Moins d'esters", "Plus d'esters, profil fruité", "Aucun effet", "Arrêt fermentation"], 1, "T° haute = plus d'esters, plus fruité."),
      q("Qui fournit la température idéale de fermentation?", ["Le brasseur", "Le fabricant de levure", "Le malteur", "Personne"], 1, "Le fabricant indique la T° idéale."),
      q("La température de fermentation influence…", ["Uniquement la durée", "Le profil aromatique", "Uniquement l'alcool", "Rien"], 1, "T° = impact crucial sur arômes."),
      q("Combien de cellules vivantes dans 1g de levure sèche?", ["7 × 10⁶", "7 × 10⁹", "7 × 10¹²", "7 × 10³"], 1, "~7 milliards de cellules/gramme."),
      q("Pourquoi connaître la concentration en levures vivantes?", ["Pour la couleur", "Pour l'ensemencement", "Pour l'amertume", "Pour le pH"], 1, "Calcul des populations et ensemencements."),
      q("Les esters donnent des arômes…", ["Amers", "Fruités", "Terreux", "Métalliques"], 1, "Esters = arômes fruités."),
      q("Quelle famille aromatique est produite par haute fermentation?", ["Esters", "Tannins", "Acides aminés", "Minéraux"], 0, "Levures hautes produisent beaucoup d'esters."),
      q("Un arôme de banane vient de…", ["Éthyl acétate", "Isoamyl acétate", "Éthyl hexanoate", "Éthyl caprylate"], 1, "Isoamyl acétate = banane caractéristique."),
      q("Un arôme d'ananas vient de…", ["Éthyl acétate", "Isoamyl acétate", "Éthyl hexanoate", "n-Propanol"], 2, "Éthyl hexanoate = ananas tropical."),
      q("Les alcools supérieurs à forte dose donnent un arôme…", ["Fruité agréable", "Médicinal/solvant", "Floral", "Neutre"], 1, "Forte dose = chimique, médicinal."),
      q("Dans quelle bière recherche-t-on la complexité des alcools supérieurs?", ["Lager légère", "Pilsner", "Barley wine", "Bière de table"], 2, "Barley wine = bière forte complexe."),
      q("Que faut-il contrôler pour influencer le profil aromatique?", ["La couleur du malt", "La température de fermentation", "Le pH de l'eau", "Le temps d'ébullition"], 1, "T° fermentation = profil aromatique."),
      q("Les esters sont composés de…", ["Acide + Alcool", "Sucre + Enzyme", "Protéine + Lipide", "Eau + Minéraux"], 0, "Ester = Acide + Alcool."),
      q("Un profil 'propre' et 'net' est obtenu avec…", ["T° haute", "T° basse", "T° variable", "Sans levure"], 1, "T° basse = profil propre (moins d'esters)."),
      q("Quel arôme l'éthyl acétate peut-il donner?", ["Banane", "Fruit/Solvant", "Ananas", "Rose"], 1, "Éthyl acétate = fruit ou solvant.")
    ]
  },
  {
    id: "tauxEnsemencement",
    category: "LEVURE",
    title: "29. Taux d'ensemencement",
    ficheRich: [
      {
        title: "Définition",
        items: [
          "**Taux d'ensemencement** (Yeast pitching rate) : Quantité initiale de levure introduite au début de la fermentation",
          "**Important** : On compte toujours les levures VIVANTES !"
        ]
      },
      {
        title: "Règle fondamentale",
        items: [
          "**TOUJOURS ensemencer le plus tôt possible** dès que le brassin est refroidi !",
          "**Pourquoi ?**",
          "→ Assure une fermentation complète sans blocage",
          "→ Résultat reproductible et de qualité",
          "→ Évite la colonisation par d'autres micro-organismes"
        ]
      },
      {
        title: "Règles d'ensemencement",
        items: [
          "**Règle classique** : 1 million de cellules / ml / °Plato",
          "**Fermentation basse (lager)** : 1.5 millions/ml/°P",
          "**Fermentation haute (ale)** : 0.75 millions/ml/°P",
          "**Observation** : On a 'toujours' tendance à trop peu ensemencer !"
        ]
      },
      {
        title: "Conséquences d'un ensemencement EXCESSIF (rare)",
        items: [
          "**Déséquilibre des esters** : Moins d'arômes fruités",
          "**Fermentation trop rapide** : Moins de développement aromatique",
          "Ce cas est rare en pratique"
        ]
      },
      {
        title: "Conséquences d'un ensemencement INSUFFISANT (fréquent)",
        items: [
          "**Esters excessifs** : Trop d'arômes fruités/solvant",
          "**Diacétyle** : Goût de beurre rance",
          "**H₂S** : Odeur d'œuf pourri",
          "**Côté solvant** : Arômes désagréables",
          "**Démarrage lent** : Fermentation qui traîne",
          "**Atténuation incomplète** : Sucres résiduels élevés",
          "**Risque de contamination** : Si démarrage trop lent"
        ]
      },
      {
        title: "Ensemencement pour refermentation en bouteille",
        items: [
          "**Minimum** : 100 000 cellules/ml",
          "**Recommandé** : 3 à 4 millions/ml",
          "**Objectif** : Éviter que la levure se comporte mal (Levure F2)",
          "**Attention** : Grande variabilité possible, mesurer la densité jusqu'à stabilisation"
        ]
      },
      {
        title: "Points à retenir",
        items: [
          "✅ Ensemencer dès que possible après refroidissement",
          "✅ Compter uniquement les levures VIVANTES",
          "✅ Lagers nécessitent plus de levures que les ales",
          "✅ Sous-ensemencement = problème le plus fréquent"
        ]
      }
    ],
    questions: [
      q("Que signifie 'pitching rate' en français?", ["Densité primitive", "Taux d'ensemencement", "Température de fermentation", "Atténuation"], 1, "Pitching rate = taux d'ensemencement."),
      q("Qu'est-ce que le taux d'ensemencement?", ["La température", "La quantité de levure introduite", "Le pH du moût", "La durée de fermentation"], 1, "Quantité initiale de levure au début."),
      q("Quelles levures compte-t-on?", ["Toutes les levures", "Les levures VIVANTES", "Les levures mortes", "Les bactéries"], 1, "On compte uniquement les levures vivantes."),
      q("Quand faut-il ensemencer?", ["Avant le brassage", "Le plus tôt possible après refroidissement", "Après 24h", "N'importe quand"], 1, "Dès que le brassin est refroidi !"),
      q("Pourquoi ensemencer rapidement?", ["Pour la couleur", "Pour éviter les contaminations", "Pour l'amertume", "Pour le pH"], 1, "Évite colonisation par autres micro-organismes."),
      q("Quelle est la règle classique d'ensemencement?", ["0.5 million/ml/°P", "1 million/ml/°P", "2 millions/ml/°P", "5 millions/ml/°P"], 1, "1 million de cellules/ml/°Plato."),
      q("Quel taux pour une fermentation basse (lager)?", ["0.75 million/ml/°P", "1 million/ml/°P", "1.5 millions/ml/°P", "2 millions/ml/°P"], 2, "Lagers = 1.5 millions/ml/°P."),
      q("Quel taux pour une fermentation haute (ale)?", ["0.75 million/ml/°P", "1 million/ml/°P", "1.5 millions/ml/°P", "2 millions/ml/°P"], 0, "Ales = 0.75 millions/ml/°P."),
      q("Quelle est la tendance commune en ensemencement?", ["Trop ensemencer", "Trop peu ensemencer", "Ensemencer juste", "Ne pas ensemencer"], 1, "Tendance à sous-ensemencer."),
      q("Un ensemencement excessif est…", ["Très fréquent", "Rare", "Impossible", "Normal"], 1, "L'ensemencement excessif est rare."),
      q("Un ensemencement excessif donne…", ["Plus d'esters", "Moins d'esters", "Plus de diacétyle", "Plus de H₂S"], 1, "Trop de levure = moins d'arômes fruités."),
      q("Un ensemencement insuffisant donne…", ["Moins d'esters", "Esters excessifs", "Pas d'alcool", "Bière claire"], 1, "Sous-ensemencement = trop d'esters."),
      q("Quel défaut vient d'un sous-ensemencement?", ["Trop d'amertume", "Diacétyle (beurre rance)", "Trop de CO₂", "Bière trop claire"], 1, "Diacétyle = goût beurre rance."),
      q("Que signifie H₂S?", ["Sucre résiduel", "Sulfure d'hydrogène (œuf pourri)", "Alcool supérieur", "Ester"], 1, "H₂S = odeur d'œuf pourri."),
      q("Un sous-ensemencement provoque…", ["Démarrage rapide", "Démarrage lent", "Pas de fermentation", "Trop de CO₂"], 1, "Démarrage lent de la fermentation."),
      q("Quel risque avec un démarrage lent?", ["Bière trop amère", "Contamination", "Trop d'alcool", "Bière trop claire"], 1, "Risque de contamination microbienne."),
      q("Un sous-ensemencement cause une atténuation…", ["Complète", "Incomplète", "Excessive", "Nulle"], 1, "Atténuation incomplète = sucres résiduels."),
      q("Quel type de fermentation nécessite plus de levure?", ["Fermentation haute", "Fermentation basse", "Les deux pareil", "Aucune"], 1, "Lagers = 1.5M vs Ales = 0.75M."),
      q("Pour une refermentation en bouteille, le minimum est…", ["10 000 cellules/ml", "100 000 cellules/ml", "1 million/ml", "10 millions/ml"], 1, "Minimum 100 000 cellules/ml."),
      q("Pour une refermentation en bouteille, le taux recommandé est…", ["100 000 cellules/ml", "1 million/ml", "3 à 4 millions/ml", "10 millions/ml"], 2, "Recommandé 3-4 millions/ml."),
      q("Qu'est-ce que la levure F2?", ["Levure fraîche", "Levure de deuxième génération (refermentation)", "Levure morte", "Levure sauvage"], 1, "F2 = refermentation en bouteille."),
      q("Un goût de beurre rance indique…", ["Trop de houblon", "Diacétyle", "Trop d'alcool", "Infection lactique"], 1, "Diacétyle = beurre rance."),
      q("Une odeur d'œuf pourri indique…", ["Diacétyle", "H₂S", "Esters", "Tannins"], 1, "H₂S = sulfure d'hydrogène."),
      q("Un arôme de solvant peut venir de…", ["Sur-ensemencement", "Sous-ensemencement", "Trop de malt", "Trop d'eau"], 1, "Sous-ensemencement = esters/solvant excessifs."),
      q("Pourquoi ensemencer assure la qualité?", ["Couleur uniforme", "Résultat reproductible", "Moins de houblon", "Plus d'amertume"], 1, "Résultat reproductible et fermentation complète."),
      q("Une fermentation trop rapide peut donner…", ["Plus d'arômes", "Moins de développement aromatique", "Plus d'alcool", "Moins de CO₂"], 1, "Trop rapide = moins d'arômes complexes."),
      q("Le problème le plus fréquent est…", ["Sur-ensemencement", "Sous-ensemencement", "Bonne quantité", "Aucun problème"], 1, "Tendance à trop peu ensemencer."),
      q("Pour 20L à 15°P en lager, combien de cellules faut-il?", ["150 millions", "300 millions", "450 millions", "600 millions"], 2, "1.5M × 20000ml × 15°P = 450M."),
      q("Pour 10L à 12°P en ale, combien de cellules faut-il?", ["45 millions", "90 millions", "120 millions", "180 millions"], 1, "0.75M × 10000ml × 12°P = 90M."),
      q("Quelle unité utilise-t-on pour les densités?", ["°C", "°Plato (°P)", "%", "g/L"], 1, "°Plato pour les densités.")
    ]
  },
  {
    id: "attenuationLimite",
    category: "LEVURE",
    title: "30. Atténuation limite (AL)",
    ficheRich: [
      {
        title: "Définition",
        items: [
          "**AL** : Atténuation maximale atteignable en conditions optimales",
          "**Spécifique** : Au couple moût-levure",
          "**Usage** : Décider du coup de froid/fin de fermentation"
        ]
      },
      {
        title: "Comment déterminer l'atténuation limite ?",
        items: [
          "**1.** Prélèvement stérile en pleine fermentation",
          "**2.** Ajout d'un excès de levure",
          "**3.** Température optimale de fermentation",
          "**4.** Sans agitation",
          "**5.** Mesure de densité jusqu'à stabilisation (2-3 jours)"
        ]
      },
      {
        title: "Interprétation des résultats",
        items: [
          "**AL - FG ≈ 0.2°P** : Acceptable",
          "**AL - FG ≥ 1°P** : Problème",
          "**AL** : Atténuation max théorique",
          "**FG** : Densité finale réelle"
        ]
      },
      {
        title: "Causes d'une différence importante (≥1°P)",
        items: [
          "**Sous-ensemencement**",
          "**Manque d'oxygène**",
          "**Mauvaise gestion** : Température, nutriments, stress"
        ]
      },
      {
        title: "Utilité pratique pour le brasseur",
        items: [
          "**Timing** : Fin de fermentation",
          "**Décision** : Refroidir ou transférer",
          "**Diagnostic** : Problèmes de fermentation",
          "**Référence** : Comparer AL vs FG"
        ]
      },
      {
        title: "Paramètres à surveiller",
        items: [
          "**Activité** : Dégagement de CO₂",
          "**pH** : Évolution",
          "**Sucres restants** : Densité",
          "**Stabilisation** : Densité constante 2-3 jours"
        ]
      },
      {
        title: "Points à retenir",
        items: [
          "✅ AL = atténuation max moût-levure",
          "✅ AL-FG normal ≈ 0.2°P",
          "✅ AL-FG ≥1°P = problème",
          "✅ Sert à décider de la fin"
        ]
      }
    ],
    questions: [
      q("AL = ?", ["Alcool Limite", "Atténuation Limite", "Acidité Limite", "Amertume Limite"], 1, "Atténuation Limite."),
      q("Définition de l'AL?", ["L'alcool maximum", "L'atténuation maximale théorique", "La densité finale", "Le pH final"], 1, "Atténuation max en conditions optimales."),
      q("L'AL dépend…", ["Du houblon", "Du couple moût-levure", "De l'eau", "Du temps"], 1, "Spécifique au couple moût-levure."),
      q("AL sert à…", ["Calculer l'IBU", "Finir la fermentation (coup de froid)", "Mesurer l'amertume", "Calculer la couleur"], 1, "Savoir quand arrêter/refroidir."),
      q("Prélèvement pour AL?", ["N'importe comment", "Stérile en pleine fermentation", "À la fin", "Avant la fermentation"], 1, "Prélèvement stérile en cours."),
      q("Après prélèvement AL, on…", ["Chauffe", "Ajoute un excès de levure", "Dilue", "Filtre"], 1, "Excès de levure."),
      q("Température de l'échantillon AL?", ["Ambiante", "Température optimale de fermentation", "4°C", "30°C"], 1, "T° optimale."),
      q("Agitation pour AL?", ["Oui constante", "Non, sans agitation", "Parfois", "Seulement au début"], 1, "Pas d'agitation."),
      q("Durée de mesure AL?", ["1 heure", "Jusqu'à stabilisation (2-3 jours)", "1 semaine", "1 mois"], 1, "Jusqu'à densité stable 2-3 jours."),
      q("Différence AL-FG normale?", ["0°P", "≈0.2°P", "≥1°P", "≥5°P"], 1, "≈0.2°P."),
      q("Différence AL-FG = problème?", ["0.1°P", "0.2°P", "≥1°P", "0.5°P"], 2, "≥1°P = problème."),
      q("FG signifie?", ["Fast Growth", "Final Gravity", "First Gravity", "Fermentation Goal"], 1, "Final Gravity (densité finale)."),
      q("AL-FG = 1.5°P →", ["Normal", "Problème de fermentation", "Parfait", "Trop d'alcool"], 1, "≥1°P = problème."),
      q("Cause d'un AL-FG élevé?", ["Trop de houblon", "Ensemencement insuffisant", "Trop d'eau", "Trop de couleur"], 1, "Sous-ensemencement."),
      q("Aération insuffisante →", ["Trop d'alcool", "Différence AL-FG importante", "Bière trop amère", "Bière trop claire"], 1, "Manque O₂ = fermentation incomplète."),
      q("AL sert à décider…", ["La couleur", "Quand refroidir", "L'amertume", "Le pH"], 1, "Décider du refroidissement/transfert."),
      q("AL aide à identifier…", ["La couleur du malt", "Les problèmes de fermentation", "Le type de houblon", "La source d'eau"], 1, "Diagnostic des problèmes."),
      q("À surveiller pendant fermentation?", ["Uniquement la couleur", "Activité, pH, sucre restant", "Uniquement l'amertume", "Uniquement le houblon"], 1, "Activité, pH, densité."),
      q("Densité stabilisée =", ["Après 1h", "Constante sur 2-3 jours", "Toujours changeante", "Après 1 mois"], 1, "Constante 2-3 jours."),
      q("AL est une valeur…", ["Mesurée en cuve", "Théorique maximale", "Aléatoire", "Sans importance"], 1, "Valeur théorique max."),
      q("Pour diagnostiquer, comparer…", ["AL vs OG", "AL vs FG", "FG vs OG", "pH vs T°"], 1, "Comparer AL et FG."),
      q("AL = FG (diff 0) →", ["Parfait", "Suspect, vérifier", "Normal", "Impossible"], 1, "0 est rare, vérifier."),
      q("Donner le coup de froid =", ["Chauffer", "Refroidir pour arrêter", "Ajouter de l'eau froide", "Filtrer"], 1, "Refroidir pour stopper."),
      q("AL dépend-elle uniquement de la levure?", ["Oui", "Non, du couple moût-levure", "Oui, uniquement du moût", "Elle est constante"], 1, "Couple moût-levure."),
      q("Pourquoi un excès de levure pour l'AL?", ["Pour diluer", "Assurer fermentation complète", "Pour le goût", "Pour la couleur"], 1, "Assurer conditions optimales."),
      q("L'AL mesure…", ["La densité initiale", "Le potentiel d'atténuation max", "L'amertume", "La couleur"], 1, "Potentiel d'atténuation."),
      q("Mauvaise gestion de fermentation →", ["Couleur parfaite", "Différence AL-FG élevée", "Plus de houblon", "Moins d'eau"], 1, "Gestion = impact sur AL-FG."),
      q("Paramètre non surveillé pour l'AL?", ["Activité fermentation", "pH", "Sucre restant", "Couleur du houblon"], 3, "Couleur houblon = hors sujet."),
      q("AL optimise…", ["La couleur", "Le timing de fin de fermentation", "L'amertume", "Le type de malt"], 1, "Timing fin."),
      q("AL-FG = 0.3°P →", ["Problème grave", "Acceptable (proche de 0.2)", "Très mauvais", "Impossible"], 1, "0.3°P proche de 0.2 = ok.")
    ]
  },
  {
    id: "calculRefermentation",
    category: "LEVURE",
    title: "31. Calcul de refermentation en bouteille",
    ficheRich: [
      {
        title: "Prérequis - Ce qu'il faut connaître",
        items: [
          "**Volume** : Bière à refermenter",
          "**Densité apparente** : Mesurée",
          "**Atténuation limite (AL)** : Souche",
          "**CO₂ actuel** : Mesuré/estimé",
          "**CO₂ cible** : Selon le style"
        ]
      },
      {
        title: "Niveaux de carbonatation selon le type de bière",
        items: [
          "**Sous-saturée** : 0-2.8 g/L",
          "**Stout/Porter** : 3-4.5 g/L",
          "**Pils/classiques** : 4.5-5.2 g/L",
          "**Blanches/lambics** : 5.2-8 g/L",
          "**Sur-saturée** : >8 g/L",
          "**Duvel** : 9 g/L"
        ]
      },
      {
        title: "Formule de calcul générale",
        items: [
          "**Sucre (g)** = ((CO₂ visé - CO₂ présent - CO₂ 'limite') × Volume (L) × 2) / concentration",
          "**×2** : 1g de sucre → ~0.5g CO₂",
          "**CO₂ 'limite'** : Produit par les sucres résiduels fermentescibles"
        ]
      },
      {
        title: "Exemple pratique - Calcul détaillé",
        items: [
          "**Volume** : 100 L",
          "**CO₂ visé** : 8 g/L (fort)",
          "**T° garde** : 4°C",
          "**CO₂ actuel** : ~3.8 g/L (table)",
          "**Atténuation mesurée** : 2.5°P",
          "**Atténuation limite** : 2.0°P",
          "**Reste fermentescible** : 0.5°P = 5 g/L",
          "**Facteur résidus** : 30% de 5g = 1.5g",
          "**CO₂ des résidus** : 1.5g × 0.5 = 0.75 g CO₂/L",
          "**Calcul** : ((8 - 3.8 - 0.75) × 100 × 2) / 1 = 690g",
          "**Résultat** : ~6.9 g/L de sucre à ajouter"
        ]
      },
      {
        title: "Types de sucre pour refermentation",
        items: [
          "**Sucre blanc** : 100% (référence)",
          "**Miel** : ~80% (arômes)",
          "**Sirop** : ~70% (dissolution facile)",
          "**Adapter** : Quantité selon concentration"
        ]
      },
      {
        title: "Facteurs à prendre en compte",
        items: [
          "**T° de garde** : Influence la solubilité du CO₂",
          "**Contre-pression** : Augmente la saturation",
          "**Sucres résiduels** : Fermentent partiellement (30-60%)",
          "**Table de solubilité** : Pour le CO₂ actuel"
        ]
      },
      {
        title: "Points à retenir",
        items: [
          "✅ 1g sucre → ~0.5g CO₂",
          "✅ Carbonatation dépend du style",
          "✅ Soustraire CO₂ présent + résidus",
          "✅ Adapter selon le sucre"
        ]
      }
    ],
    questions: [
      q("Prérequis du calcul?", ["Uniquement le volume", "Volume, densité, AL, CO₂ actuel/visé", "Uniquement le CO₂ visé", "Uniquement la température"], 1, "5 prérequis."),
      q("Saturation d'un Stout?", ["0-2.8 g/L", "3-4.5 g/L", "4.5-5.2 g/L", ">8 g/L"], 1, "3-4.5 g/L."),
      q("Saturation d'une Pils?", ["3-4.5 g/L", "4.5-5.2 g/L", "5.2-8 g/L", ">8 g/L"], 1, "4.5-5.2 g/L."),
      q("Saturation blanche/lambic?", ["3-4.5 g/L", "4.5-5.2 g/L", "5.2-8 g/L", ">8 g/L"], 2, "5.2-8 g/L."),
      q("Saturation d'une Duvel?", ["5 g/L", "7 g/L", "9 g/L", "12 g/L"], 2, "9 g/L."),
      q("1g de sucre produit…", ["0.25g CO₂", "0.5g CO₂", "1g CO₂", "2g CO₂"], 1, "~0.5g CO₂."),
      q("Pourquoi le facteur 2?", ["Doubler le volume", "1g sucre → 0.5g CO₂", "Sécurité", "Erreur"], 1, "Rendement 0.5."),
      q("CO₂ 'limite' =", ["Maximum possible", "CO₂ des sucres résiduels", "CO₂ minimal", "CO₂ initial"], 1, "Produit par résidus fermentescibles."),
      q("Concentration sucre blanc?", ["70%", "80%", "100%", "50%"], 2, "100%."),
      q("Concentration miel?", ["~70%", "~80%", "~100%", "~50%"], 1, "~80%."),
      q("Concentration sirop?", ["~50%", "~70%", "~80%", "~100%"], 1, "~70%."),
      q("Avantage du miel?", ["Plus concentré", "Apporte des arômes", "Moins cher", "Plus rapide"], 1, "Arômes."),
      q("Avantage du sirop?", ["Plus concentré", "Plus d'arômes", "Plus facile à dissoudre", "Plus cher"], 2, "Dissolution facile."),
      q("Volume de l'exemple?", ["50 L", "100 L", "200 L", "500 L"], 1, "100 L."),
      q("CO₂ visé de l'exemple?", ["4.5 g/L", "6 g/L", "8 g/L", "10 g/L"], 2, "8 g/L."),
      q("CO₂ actuel de l'exemple?", ["2.8 g/L", "3.8 g/L", "4.8 g/L", "5.8 g/L"], 1, "3.8 g/L."),
      q("Reste fermentescible?", ["0.5°P", "1°P", "2°P", "5°P"], 0, "0.5°P."),
      q("0.5°P =", ["2.5g sucre/L", "5g sucre/L", "10g sucre/L", "15g sucre/L"], 1, "5 g/L."),
      q("Facteur correctif résidus?", ["10-20%", "30-60%", "70-90%", "100%"], 1, "30-60%."),
      q("30% de 5g =", ["0.5g", "1.5g", "2.5g", "4.5g"], 1, "1.5g."),
      q("CO₂ produit par 1.5g sucre?", ["0.5g", "0.75g", "1g", "1.5g"], 1, "0.75g."),
      q("Résultat final de l'exemple?", ["490g", "590g", "690g", "790g"], 2, "690g."),
      q("g/L de sucre dans l'exemple?", ["4.9 g/L", "5.9 g/L", "6.9 g/L", "7.9 g/L"], 2, "6.9 g/L."),
      q("La T° de garde influence…", ["La couleur", "La saturation en CO₂", "L'amertume", "Le pH"], 1, "Solubilité du CO₂."),
      q("Table à consulter pour CO₂ actuel?", ["Table IBU", "Table de solubilité CO₂", "Table des malts", "Table des houblons"], 1, "Solubilité vs T°."),
      q("Bière sous-saturée =", ["0-2.8 g/L", "3-4.5 g/L", "4.5-5.2 g/L", ">8 g/L"], 0, "0-2.8 g/L."),
      q("Bière sur-saturée =", ["3-4.5 g/L", "4.5-5.2 g/L", "5.2-8 g/L", ">8 g/L"], 3, ">8 g/L."),
      q("Pourquoi soustraire le CO₂ présent?", ["Pour l'amertume", "Pour ne compter que le CO₂ à ajouter", "Pour la couleur", "Erreur"], 1, "On calcule le CO₂ à produire."),
      q("Ajuster le miel à 80%?", ["Diviser par 0.8", "Multiplier par 0.8", "Ne rien faire", "Diviser par 2"], 0, "Quantité / 0.8."),
      q("Bière la plus carbonatée citée?", ["Stout", "Pils", "Duvel", "Bière sous-saturée"], 2, "Duvel (9 g/L).")
    ]
  },
  {
    id: "levureSecheVsLiquide",
    category: "LEVURE",
    title: "32. Levure sèche vs liquide",
    ficheRich: [
      {
        title: "Levures SÈCHES - Marques principales",
        items: [
          "**Fermentis**, **Munton's**, **Danstar**, **Brewferm**, **Cooper's**"
        ]
      },
      {
        title: "Levures SÈCHES - Avantages",
        items: [
          "**Prix** : Bon marché",
          "**Facilité** : Pas de starter",
          "**Population** : Élevée/sachet",
          "**Viabilité** : Tenue au transport",
          "**Conservation** : BBD 1-2 ans",
          "**Simplicité** : Prêt à l'emploi"
        ]
      },
      {
        title: "Levures SÈCHES - Inconvénients",
        items: [
          "**Choix limité**",
          "**Sélection par séchage**",
          "**Profil moins précis**"
        ]
      },
      {
        title: "Levures SÈCHES - Processus de fabrication",
        items: [
          "**1.** Culture labo",
          "**2.** Fermentation",
          "**3.** Centrifugation",
          "**4.** Séchage",
          "**5.** Conditionnement"
        ]
      },
      {
        title: "Levures LIQUIDES - Marques principales",
        items: [
          "**White Labs**, **Wyeast**"
        ]
      },
      {
        title: "Levures LIQUIDES - Avantages",
        items: [
          "**Grand choix**",
          "**Profil précis**",
          "**Souches spécifiques**",
          "**Authenticité aromatique**"
        ]
      },
      {
        title: "Levures LIQUIDES - Inconvénients",
        items: [
          "**Prix** : Plus élevé",
          "**Starter** : Souvent requis",
          "**Viabilité** : Baisse au transport",
          "**Conservation** : BBD courte",
          "**Conditionnement** : Tubes/sachets multiples"
        ]
      },
      {
        title: "Tableau comparatif résumé",
        items: [
          "**Prix** : Sèche ⭐⭐⭐⭐⭐ | Liquide ⭐⭐",
          "**Choix** : Sèche ⭐⭐ | Liquide ⭐⭐⭐⭐⭐",
          "**Facilité** : Sèche ⭐⭐⭐⭐⭐ | Liquide ⭐⭐⭐",
          "**Profil** : Sèche ⭐⭐⭐ | Liquide ⭐⭐⭐⭐⭐",
          "**Conservation** : Sèche ⭐⭐⭐⭐⭐ | Liquide ⭐⭐",
          "**Viabilité transport** : Sèche ⭐⭐⭐⭐⭐ | Liquide ⭐⭐⭐"
        ]
      }
    ],
    questions: [
      q("Pas une levure sèche?", ["Fermentis", "White Labs", "Danstar", "Munton's"], 1, "White Labs = liquide."),
      q("Pas une levure liquide?", ["White Labs", "Wyeast", "Fermentis", "Aucune des deux"], 2, "Fermentis = sèche."),
      q("Avantage clé des sèches?", ["Profil aromatique", "Prix et facilité", "Grande variété", "Starter facile"], 1, "Bon marché + facile."),
      q("Avantage clé des liquides?", ["Prix", "Conservation", "Grand choix et profil précis", "Facilité"], 2, "Choix + profil précis."),
      q("Starter pour levures sèches?", ["Toujours", "Généralement non", "Toujours oui", "Parfois"], 1, "Généralement non."),
      q("Starter pour levures liquides?", ["Jamais", "Rarement", "Souvent requis", "Toujours"], 2, "Souvent requis."),
      q("BBD des sèches?", ["1-2 semaines", "1-2 mois", "1-2 ans", "10 ans"], 2, "1-2 ans."),
      q("BBD des liquides?", ["Très limitée (quelques mois)", "1-2 ans", "5 ans", "Illimitée"], 0, "Quelques mois."),
      q("Type avec plus grand choix?", ["Sèche", "Liquide", "Les deux pareil", "Aucune"], 1, "Liquide."),
      q("Type le moins cher?", ["Sèche", "Liquide", "Les deux pareil", "Variable"], 0, "Sèche."),
      q("Meilleure viabilité transport?", ["Sèche", "Liquide", "Les deux pareil", "Aucune"], 0, "Sèche."),
      q("Meilleur profil aromatique?", ["Sèche", "Liquide", "Les deux pareil", "Aucune"], 1, "Liquide."),
      q("BBD signifie?", ["Best Brewery Date", "Best Before Date", "Better Beer Date", "Begin Brewing Date"], 1, "Best Before Date."),
      q("1re étape fabrication sèches?", ["Séchage", "Laboratoire", "Conditionnement", "Centrifugation"], 1, "Laboratoire."),
      q("Étape après fermentation (sèches)?", ["Conditionnement", "Séchage", "Centrifugation", "Laboratoire"], 2, "Centrifugation."),
      q("Dernière étape fabrication?", ["Séchage", "Fermentation", "Conditionnement", "Laboratoire"], 2, "Conditionnement."),
      q("Pourquoi le séchage sélectionne?", ["Toutes survivent", "Seules les plus résistantes survivent", "Aucune ne survit", "C'est aléatoire"], 1, "Sélection naturelle."),
      q("Inconvénient des sèches?", ["Prix élevé", "Choix limité", "Pas de conservation", "Trop de starter"], 1, "Choix limité."),
      q("Inconvénient des liquides?", ["Choix limité", "Prix élevé et starter requis", "Conservation excellente", "Trop faciles"], 1, "Prix + starter."),
      q("Leader des sèches?", ["White Labs", "Wyeast", "Fermentis", "Aucune"], 2, "Fermentis."),
      q("Leader des liquides?", ["Fermentis", "Danstar", "White Labs", "Cooper's"], 2, "White Labs (avec Wyeast)."),
      q("Population/sachet (sèches)?", ["Faible", "Moyenne", "Élevée", "Variable"], 2, "Élevée."),
      q("Levures liquides sont proches de…", ["Rien", "La souche d'origine", "Les levures sèches", "Les bactéries"], 1, "Souche d'origine."),
      q("Profil aromatique précis →", ["Sèches", "Liquides", "Les deux", "Aucune"], 1, "Liquides."),
      q("Facilité d'utilisation →", ["Sèches", "Liquides", "Les deux", "Aucune"], 0, "Sèches."),
      q("Cooper's est une levure…", ["Sèche", "Liquide", "Les deux", "Ni l'une ni l'autre"], 0, "Sèche."),
      q("Wyeast est une levure…", ["Sèche", "Liquide", "Les deux", "Ni l'une ni l'autre"], 1, "Liquide."),
      q("Le séchage élimine…", ["Les levures", "L'eau", "Les arômes", "Le sucre"], 1, "L'eau."),
      q("Type qui se conserve le mieux?", ["Sèche", "Liquide", "Les deux pareil", "Aucune"], 0, "Sèche."),
      q("Souche très spécifique →", ["Sèche", "Liquide", "N'importe", "Aucune"], 1, "Liquide."),
    ]
  },
  {
    id: "diacetyle",
    category: "LEVURE",
    title: "33. Composés de fermentation - Le Diacétyle",
    ficheRich: [
      {
        title: "Identification",
        items: [
          "**Famille** : VDK",
          "**Molécule** : 2,3-Pentanedione",
          "**Flaveur** : Beurre rance/caramel",
          "**Seuil** : Très bas"
        ]
      },
      {
        title: "Acceptabilité du diacétyle",
        items: [
          "**Léger** : Parfois ok (ales anglaises)",
          "**Élevé** : Défaut majeur",
          "**Contexte** : Dépend du style"
        ]
      },
      {
        title: "Facteurs favorisant le diacétyle",
        items: [
          "**Sous-ensemencement** : Stress → VDK",
          "**Fermentation froide** : Réduction lente",
          "**Contamination bactérienne**"
        ]
      },
      {
        title: "Réduction naturelle du diacétyle",
        items: [
          "**Réduction** : Par la levure active",
          "**Contact** : Levure présente en cuve",
          "**Cycle normal** : Phase de fermentation"
        ]
      },
      {
        title: "Conditions favorables à la réduction",
        items: [
          "**T° plus élevée** : Réduction plus rapide",
          "**Fermentation haute** : Moins de résiduel",
          "**Levure active** : Population suffisante"
        ]
      },
      {
        title: "Diacetyl rest (repos diacétyle)",
        items: [
          "**Principe** : Monter légèrement la T° en fin de fermentation",
          "**Objectif** : Aider la levure à réduire les VDK",
          "**Application** : Surtout lagers",
          "**Timing** : Fin de fermentation"
        ]
      },
      {
        title: "Solutions en cas de problème",
        items: [
          "**Stripping CO₂** : Purge au CO₂",
          "**Stripping azote** : Alternative",
          "**⚠️ Pas d'air** : Risque d'oxydation",
          "**Levure fraîche** : Relancer la réduction"
        ]
      },
      {
        title: "Évolution temporelle",
        items: [
          "**0-40h** : Production",
          "**40-80h** : Pic",
          "**80-240h** : Réduction par la levure",
          "**Éthanol** : Monte progressivement"
        ]
      },
      {
        title: "Points à retenir",
        items: [
          "✅ Diacétyle = VDK = beurre rance",
          "✅ Seuil très bas",
          "✅ Sous-ensemencement + T° froide = risque",
          "✅ Levure active le réduit",
          "✅ Diacetyl rest utile (lagers)"
        ]
      }
    ],
    questions: [
      q("VDK = ?", ["Very Dark Ketones", "Vicinal DiKetones", "Volatile Dry Ketones", "Variable Diacetyl Ketones"], 1, "Vicinal DiKetones."),
      q("Molécule du diacétyle?", ["2,3-Butanedione", "2,3-Pentanedione", "2,4-Pentanedione", "Acétaldéhyde"], 1, "2,3-Pentanedione."),
      q("Goût du diacétyle?", ["Fruit", "Beurre rance", "Houblon", "Caramel sucré"], 1, "Beurre rance/caramel."),
      q("Seuil du diacétyle?", ["Très élevé", "Moyen", "Très bas", "Variable"], 2, "Très bas."),
      q("Légère touche de diacétyle?", ["Toujours un défaut", "Parfois positive (ales anglaises)", "Toujours positive", "Impossible"], 1, "Parfois acceptée."),
      q("Diacétyle élevé =", ["Positive", "Défaut majeur", "Normale", "Recherchée"], 1, "Défaut."),
      q("Facteur favorisant?", ["Sur-ensemencement", "Ensemencement insuffisant", "Trop de houblon", "Trop d'eau"], 1, "Sous-ensemencement."),
      q("Fermentation trop froide →", ["Moins de diacétyle", "Plus de diacétyle", "Pas d'effet", "Meilleure qualité"], 1, "Plus de VDK résiduel."),
      q("Contamination productrice?", ["Virale", "Bactérienne", "Fongique", "Aucune"], 1, "Certaines bactéries."),
      q("Qui réduit le diacétyle?", ["Bactéries", "Levure", "Houblon", "Malt"], 1, "Levure."),
      q("Pour réduire, la levure doit être…", ["Morte", "Présente et active", "Absente", "Congelée"], 1, "Présente et active."),
      q("T° favorable à la réduction?", ["Très froide", "Élevée", "Variable", "Gelée"], 1, "Plus chaude = plus rapide."),
      q("Fermentation avec moins de résiduel?", ["Basse", "Haute", "Spontanée", "Mixte"], 1, "Haute."),
      q("Diacetyl rest =", ["Repos de la levure", "Montée de T° en fin de fermentation", "Ajout de diacétyle", "Filtration"], 1, "Montée de T° en fin."),
      q("Diacetyl rest surtout pour…", ["Les ales", "Les lagers", "Les lambics", "Toutes les bières"], 1, "Lagers."),
      q("Quand faire le diacetyl rest?", ["Au début", "En fin de fermentation", "Avant fermentation", "Jamais"], 1, "Fin de fermentation."),
      q("Le diacetyl rest permet…", ["Augmenter VDK", "Réduire les VDK", "Arrêter la fermentation", "Ajouter des arômes"], 1, "Réduire VDK."),
      q("Stripping CO₂ =", ["Augmenter le CO₂", "Éliminer le diacétyle", "Ajouter du goût", "Refroidir"], 1, "Purge pour éliminer."),
      q("Stripping à l'air?", ["Oui toujours", "NON, risque d'oxydation", "Oui parfois", "C'est recommandé"], 1, "Pas d'air."),
      q("Alternative au stripping CO₂?", ["Air", "Azote", "Oxygène", "Vapeur"], 1, "Azote."),
      q("Solution si diacétyle présent?", ["Du houblon", "De la levure fraîche", "Du malt", "De l'eau"], 1, "Levure fraîche."),
      q("Pic de diacétyle?", ["0-20h", "40-80h", "120-160h", "200-240h"], 1, "40-80h."),
      q("Après le pic, diacétyle…", ["Augmente", "Reste stable", "Diminue", "Disparaît instantanément"], 2, "Diminue."),
      q("Quand diacétyle baisse, éthanol…", ["Diminue", "Reste stable", "Augmente", "Disparaît"], 2, "Augmente."),
      q("Production de diacétyle au…", ["Début de fermentation", "Milieu de fermentation", "Fin de fermentation", "Jamais"], 0, "Début."),
      q("Famille du diacétyle?", ["Esters", "VDK", "Alcools supérieurs", "Acides"], 1, "VDK."),
      q("Pour éviter le diacétyle, ensemencement…", ["Insuffisant", "Suffisant", "Excessif", "Aucun"], 1, "Suffisant."),
      q("Levure stressée produit…", ["Moins de VDK", "Plus de VDK", "Pas de VDK", "Aucun effet"], 1, "Plus de VDK."),
      q("Réduction du diacétyle = processus…", ["Chimique seulement", "Enzymatique par la levure", "Physique", "Impossible"], 1, "Enzymatique par levure."),
      q("Style où une touche est tolérée?", ["Pilsner", "Certaines ales anglaises", "Lagers", "Lambics"], 1, "Ales anglaises."),
    ]
  },
  {
    id: "esters",
    category: "LEVURE",
    title: "34. Composés de fermentation - Les Esters",
    ficheRich: [
      {
        title: "Définition des esters",
        items: [
          "**Nature** : Composés aromatiques",
          "**Composition** : Acide + Alcool",
          "**Origine** : Produits en fermentation",
          "**Flaveurs** : Fruité (banane, pomme, poire)",
          "**Impact** : Signature aromatique, surtout ales"
        ]
      },
      {
        title: "Principaux esters en brasserie",
        items: [
          "**Isoamyl acétate** : Banane (weizen)",
          "**Éthyl acétate** : Fruit/léger solvant (le plus abondant)",
          "**Éthyl caprylate** : Pomme"
        ]
      },
      {
        title: "Facteurs favorisant la production d'esters (↑)",
        items: [
          "**Moins d'aération**",
          "**Température plus haute**",
          "**Plus de précurseurs (alcools supérieurs)**",
          "**Densité élevée**",
          "**Plus de trub**"
        ]
      },
      {
        title: "Contrôle des esters - Pour AUGMENTER",
        items: [
          "**Fermenter plus chaud**",
          "**Aérer moins**",
          "**Choisir des souches productrices**",
          "**OG plus élevée**"
        ]
      },
      {
        title: "Contrôle des esters - Pour DIMINUER",
        items: [
          "**Fermenter plus froid**",
          "**Bien aérer**",
          "**Levures 'propres' (basses)**",
          "**Ensemencement adéquat**"
        ]
      },
      {
        title: "Relation esters et styles de bière",
        items: [
          "**Ales** : Riche en esters",
          "**Lagers** : Profil propre",
          "**Weizen** : Banane (isoamyl)",
          "**Belges** : Esters complexes"
        ]
      },
      {
        title: "Lien avec d'autres composés",
        items: [
          "**Alcools supérieurs** : Précurseurs",
          "**Température** : Facteur commun",
          "**Stress levure** : Favorise esters + alcools supérieurs"
        ]
      },
      {
        title: "Points à retenir",
        items: [
          "✅ Esters = Acide + Alcool = Fruité",
          "✅ T° haute et faible aération → esters ↑",
          "✅ T° basse et bonne aération → esters ↓",
          "✅ Ales riches, Lagers propres"
        ]
      }
    ],
    questions: [
      q("Que sont les esters?", ["Des sucres", "Des composés aromatiques (Acide + Alcool)", "Des protéines", "Des enzymes"], 1, "Esters = Acide + Alcool."),
      q("Quelle est la composition d'un ester?", ["Sucre + Enzyme", "Acide + Alcool", "Protéine + Lipide", "Eau + Minéral"], 1, "Ester = Acide + Alcool."),
      q("D'où proviennent les esters?", ["Du malt", "De la fermentation", "Du houblon", "De l'eau"], 1, "Esters produits lors de la fermentation."),
      q("Quels arômes donnent les esters?", ["Amers", "Fruités", "Terreux", "Métalliques"], 1, "Esters = arômes fruités."),
      q("Quel arôme donne l'isoamyl acétate?", ["Pomme", "Banane", "Poire", "Ananas"], 1, "Isoamyl acétate = banane."),
      q("Quel arôme donne l'éthyl caprylate?", ["Banane", "Pomme", "Solvant", "Rose"], 1, "Éthyl caprylate = pomme."),
      q("Quel est l'ester le plus abondant?", ["Isoamyl acétate", "Éthyl acétate", "Éthyl caprylate", "Aucun"], 1, "Éthyl acétate = le plus abondant."),
      q("Une diminution de l'aération provoque…", ["Moins d'esters", "Plus d'esters", "Pas d'effet", "Arrêt fermentation"], 1, "Moins O₂ → Plus d'esters."),
      q("Une augmentation de la température provoque…", ["Moins d'esters", "Plus d'esters", "Pas d'effet", "Arrêt fermentation"], 1, "T° haute → Plus d'esters."),
      q("Une densité plus élevée provoque…", ["Moins d'esters", "Plus d'esters", "Pas d'effet", "Moins d'alcool"], 1, "OG élevée → Plus d'esters."),
      q("Un trub plus important provoque…", ["Moins d'esters", "Plus d'esters", "Pas d'effet", "Clarification"], 1, "Plus de trub → Plus d'esters."),
      q("Que sont les précurseurs des esters?", ["Sucres", "Alcools supérieurs", "Enzymes", "Minéraux"], 1, "Alcools supérieurs = précurseurs."),
      q("Pour augmenter les esters, on fermente…", ["Plus froid", "Plus chaud", "À température constante", "Sans levure"], 1, "Fermenter plus chaud → Plus d'esters."),
      q("Pour augmenter les esters, on…", ["Augmente l'aération", "Réduit l'aération", "Ne change rien", "Ajoute de l'O₂"], 1, "Réduire aération → Plus d'esters."),
      q("Pour diminuer les esters, on fermente…", ["Plus chaud", "Plus froid", "À température variable", "Sans contrôle"], 1, "Fermenter plus froid → Moins d'esters."),
      q("Pour diminuer les esters, on…", ["Réduit l'aération", "Bien aère le moût", "Ne fait rien", "Enlève l'O₂"], 1, "Bien aérer → Moins d'esters."),
      q("Quel type de levure produit le plus d'esters?", ["Levures basses", "Levures hautes", "Levures sauvages", "Toutes pareil"], 1, "Levures hautes = plus d'esters."),
      q("Quel type de levure produit le moins d'esters?", ["Levures hautes", "Levures 'propres' (basses)", "Levures sauvages", "Toutes pareil"], 1, "Levures lagers = propres, peu d'esters."),
      q("Les ales ont un profil…", ["Pauvre en esters", "Riche en esters", "Sans esters", "Variable"], 1, "Ales = riches en esters."),
      q("Les lagers ont un profil…", ["Riche en esters", "Propre, peu d'esters", "Très fruité", "Variable"], 1, "Lagers = propres, peu d'esters."),
      q("Quel style est caractérisé par l'isoamyl acétate?", ["Pilsner", "Weizen/Hefeweizen", "Stout", "IPA"], 1, "Weizen = banane caractéristique."),
      q("Les bières belges ont des esters…", ["Absents", "Simples", "Complexes et fruités", "Neutres"], 2, "Belges = esters complexes."),
      q("Un ensemencement adéquat permet de…", ["Augmenter les esters", "Diminuer les esters", "Pas d'effet", "Arrêter fermentation"], 1, "Ensemencement suffisant → Moins de stress → Moins d'esters."),
      q("Le stress de la levure favorise…", ["Moins d'esters", "Plus d'esters", "Pas d'effet", "Meilleure qualité"], 1, "Stress → Plus d'esters et alcools supérieurs."),
      q("Quelle relation entre alcools supérieurs et esters?", ["Aucune", "Alcools = précurseurs des esters", "Esters = précurseurs des alcools", "Opposés"], 1, "Alcool + Acide → Ester."),
      q("Pour un profil fruité, on préfère fermenter…", ["Froid", "Chaud", "À température ambiante", "Sans contrôle"], 1, "Chaud = plus d'esters = plus fruité."),
      q("Pour un profil propre, on préfère fermenter…", ["Chaud", "Froid", "À température variable", "Sans contrôle"], 1, "Froid = moins d'esters = plus propre."),
      q("L'éthyl acétate peut donner un arôme de…", ["Banane uniquement", "Fruit ou léger solvant", "Terre", "Métal"], 1, "Éthyl acétate = fruit/solvant."),
      q("Une bonne aération favorise…", ["Fermentation avec plus d'esters", "Respiration avec moins d'esters", "Arrêt fermentation", "Plus d'alcool"], 1, "O₂ → Respiration → Moins d'esters."),
      q("Quel paramètre commun pour esters ET alcools supérieurs?", ["Le pH", "La température", "La couleur", "L'amertume"], 1, "T° influence esters ET alcools supérieurs.")
    ]
  },
  {
    id: "acetaldehyde",
    category: "LEVURE",
    title: "35. Composés de fermentation - L'Acétaldéhyde",
    ficheRich: [
      {
        title: "Identification de l'acétaldéhyde",
        items: [
          "**Flaveur** : Bière verte, herbacé, pomme verte",
          "**Nature** : Intermédiaire central",
          "**Statut** : Précurseur de l'éthanol",
          "**Temporaire** : Doit être converti"
        ]
      },
      {
        title: "Voie métabolique",
        items: [
          "**Séquence** : Glucose → ... → Acétaldéhyde → Éthanol",
          "**Intermédiaire** : Avant l'éthanol",
          "**Risque** : Accumulation si conversion incomplète",
          "**Normal** : Présent temporairement"
        ]
      },
      {
        title: "Facteurs favorisant l'accumulation",
        items: [
          "**T° plus haute** : Fermentation rapide",
          "**Oxygène élevé** : Métabolisme dévié",
          "**Sur-ensemencement** : Fermentation très active",
          "**Pression élevée** : Stress levure"
        ]
      },
      {
        title: "Conséquences de l'accumulation",
        items: [
          "**Bière verte** : Immaturité",
          "**Herbacé/pomme verte**",
          "**Signe** : Bière pas prête"
        ]
      },
      {
        title: "Réduction de l'acétaldéhyde",
        items: [
          "**Temps** : Conversion naturelle en éthanol",
          "**Levure active** : Poursuit la conversion",
          "**Maturation** : Nécessaire pour réduire",
          "**Patience** : Laisser finir"
        ]
      },
      {
        title: "Évolution temporelle",
        items: [
          "**Début** : Production",
          "**Intermédiaire** : Pic",
          "**Fin** : Réduction progressive",
          "**Maturation** : Niveau très bas",
          "**Éthanol** : Augmente tout au long"
        ]
      },
      {
        title: "Prévention",
        items: [
          "**Maturation** : Ne pas embouteiller trop tôt",
          "**Levure saine** : Conversion complète",
          "**Limiter le stress** : T°, pression, oxygénation",
          "**Temps** : Laisser aller au bout"
        ]
      },
      {
        title: "Points à retenir",
        items: [
          "✅ Acétaldéhyde = précurseur de l'éthanol",
          "✅ Goût bière verte/pomme verte",
          "✅ Favorisé par T° haute, O₂, sur-ensemencement",
          "✅ Réduction avec temps + levure active",
          "✅ Signe d'immaturité"
        ]
      }
    ],
    questions: [
      q("Quel goût donne l'acétaldéhyde?", ["Banane", "Bière verte/pomme verte", "Beurre rance", "Solvant"], 1, "Acétaldéhyde = bière verte, herbacé."),
      q("Quelle est la nature de l'acétaldéhyde?", ["Produit final", "Produit intermédiaire", "Sucre", "Enzyme"], 1, "Intermédiaire central de la fermentation."),
      q("L'acétaldéhyde est le précurseur de…", ["Glucose", "Éthanol", "CO₂", "Diacétyle"], 1, "Acétaldéhyde → Éthanol."),
      q("Quelle est la séquence métabolique correcte?", ["Éthanol → Acétaldéhyde → Glucose", "Glucose → Acétaldéhyde → Éthanol", "Glucose → Éthanol → Acétaldéhyde", "Acétaldéhyde → Glucose → Éthanol"], 1, "Glucose → Acétaldéhyde → Éthanol."),
      q("L'acétaldéhyde peut s'accumuler si…", ["La conversion est complète", "La conversion est incomplète", "Il n'y a pas de levure", "Il fait froid"], 1, "Accumulation = conversion incomplète."),
      q("Une augmentation de température provoque…", ["Moins d'acétaldéhyde", "Plus d'acétaldéhyde", "Pas d'effet", "Arrêt fermentation"], 1, "T° haute → fermentation rapide → accumulation."),
      q("Une augmentation d'oxygène provoque…", ["Moins d'acétaldéhyde", "Plus d'acétaldéhyde", "Pas d'effet", "Meilleure qualité"], 1, "Plus O₂ → dévie métabolisme → accumulation."),
      q("Un taux d'ensemencement élevé provoque…", ["Moins d'acétaldéhyde", "Plus d'acétaldéhyde", "Pas d'effet", "Fermentation lente"], 1, "Sur-ensemencement → fermentation active → accumulation."),
      q("Une pression élevée provoque…", ["Moins d'acétaldéhyde", "Plus d'acétaldéhyde", "Pas d'effet", "Meilleure qualité"], 1, "Pression → stress levure → accumulation."),
      q("Un goût de 'bière verte' indique…", ["Bière mature", "Bière immature", "Bière parfaite", "Contamination"], 1, "Bière verte = immaturité."),
      q("L'arôme de pomme verte vient de…", ["Diacétyle", "Acétaldéhyde", "Esters", "Alcools supérieurs"], 1, "Acétaldéhyde = pomme verte."),
      q("Comment réduire l'acétaldéhyde?", ["Ajouter du sucre", "Laisser du temps, levure active", "Filtrer rapidement", "Ajouter du houblon"], 1, "Temps + levure active = conversion."),
      q("L'acétaldéhyde est converti naturellement en…", ["Glucose", "Éthanol", "CO₂", "Diacétyle"], 1, "Conversion naturelle vers éthanol."),
      q("Pour la conversion, la levure doit être…", ["Morte", "Active", "Absente", "Congelée"], 1, "Levure active = conversion continue."),
      q("Une maturation suffisante permet…", ["Accumulation", "Réduction complète", "Arrêt fermentation", "Plus d'acétaldéhyde"], 1, "Maturation = réduction complète."),
      q("Quand l'acétaldéhyde atteint-il son pic?", ["Début fermentation", "Phase intermédiaire", "Fin fermentation", "Après embouteillage"], 1, "Pic en phase intermédiaire."),
      q("En fin de fermentation, l'acétaldéhyde…", ["Augmente", "Reste stable", "Diminue progressivement", "Disparaît instantanément"], 2, "Réduction progressive en fin."),
      q("L'éthanol pendant la fermentation…", ["Diminue", "Reste stable", "Augmente progressivement", "Fluctue"], 2, "Éthanol augmente tout au long."),
      q("Un défaut d'acétaldéhyde indique…", ["Sur-maturation", "Sous-maturation", "Perfection", "Contamination"], 1, "Acétaldéhyde = bière immature."),
      q("Pour éviter l'acétaldéhyde, il faut…", ["Embouteiller tôt", "Maturation adéquate", "Fermentation rapide", "Plus de pression"], 1, "Maturation adéquate = prévention."),
      q("Une levure en bonne santé assure…", ["Plus d'acétaldéhyde", "Conversion complète", "Arrêt fermentation", "Contamination"], 1, "Levure saine = conversion complète."),
      q("Il faut éviter de stresser la levure pour…", ["Plus d'acétaldéhyde", "Moins d'acétaldéhyde", "Plus d'alcool", "Plus de CO₂"], 1, "Stress levure = accumulation acétaldéhyde."),
      q("L'acétaldéhyde est-il un produit final?", ["Oui", "Non, c'est un intermédiaire", "Parfois", "Uniquement en lagers"], 1, "Intermédiaire, pas final."),
      q("L'arôme herbacé vient de…", ["Houblon uniquement", "Acétaldéhyde", "Malt", "Eau"], 1, "Acétaldéhyde = herbacé/bière verte."),
      q("Pour convertir l'acétaldéhyde en éthanol, il faut…", ["Filtrer", "Du temps", "Plus de houblon", "Plus de sucre"], 1, "Temps nécessaire pour conversion."),
      q("Embouteiller trop tôt peut causer…", ["Trop d'alcool", "Acétaldéhyde résiduel", "Trop de couleur", "Moins de CO₂"], 1, "Trop tôt = acétaldéhyde pas converti."),
      q("L'acétaldéhyde est normalement…", ["Permanent", "Temporaire pendant fermentation", "Absent", "Toujours présent"], 1, "Temporaire, doit être converti."),
      q("Quel facteur NE favorise PAS l'acétaldéhyde?", ["T° haute", "Pression haute", "Maturation longue", "Sur-ensemencement"], 2, "Maturation longue = réduction."),
      q("Pendant la maturation, l'acétaldéhyde…", ["Augmente", "Se maintient", "Est converti en éthanol", "Reste constant"], 2, "Maturation = conversion en éthanol."),
      q("Un niveau très bas d'acétaldéhyde indique…", ["Bière immature", "Bière mature", "Contamination", "Défaut majeur"], 1, "Niveau bas = bière mature.")
    ]
  },
  {
    id: "alcoolsSuperieurs",
    category: "LEVURE",
    title: "36. Composés de fermentation - Alcools supérieurs",
    ficheRich: [
      {
        title: "Définition des alcools supérieurs",
        items: [
          "**Nom anglais** : Fusel alcohols",
          "**Nature** : Alcools ≠ éthanol",
          "**Effet faible dose** : Rose, banane, complexité",
          "**Effet forte dose** : Solvant, chimique, médicinal",
          "**Cible** : Niveau faible"
        ]
      },
      {
        title: "Principaux alcools supérieurs",
        items: [
          "**Isoamyl** : Banane/solvant",
          "**Isobutanol** : Alcool/solvant",
          "**n-Propanol** : Arôme alcool",
          "**Divers** : Autres profils"
        ]
      },
      {
        title: "Facteurs favorisant la production (↑)",
        items: [
          "**Aération extrême** : Trop ou trop peu → ↑",
          "**T° haute** : ↑ alcools supérieurs",
          "**Densité haute** : OG élevée → ↑",
          "**Acides aminés** : Modulent le profil",
          "**Stress levure** : Favorise la production"
        ]
      },
      {
        title: "Effet selon la dose",
        items: [
          "**Faible** : Rose, banane, complexité",
          "**Forte** : Solvant, chimique, médicinal",
          "**Équilibre** : Trop = défaut, peu = complexité",
          "**Dose-dépendant**"
        ]
      },
      {
        title: "Flaveurs associées selon concentration",
        items: [
          "**Faible dose** : Rose, banane",
          "**Dose élevée** : Solvant, chimique, médicinal",
          "**Seuil critique** : Passage rapide"
        ]
      },
      {
        title: "Relation avec les esters",
        items: [
          "**Précurseurs d'esters**",
          "**Réaction** : Alcool supérieur + Acide → Ester",
          "**Conditions communes** : Température, stress, etc.",
          "**Lien** : Mêmes facteurs favorisent les deux"
        ]
      },
      {
        title: "Styles recherchant les alcools supérieurs",
        items: [
          "**Recherchés** : Triple belge, barley wine, bières fortes",
          "**À éviter** : Lagers, pilsners (profil propre)"
        ]
      },
      {
        title: "Contrôle des alcools supérieurs",
        items: [
          "**Diminuer** : T° modérée, aération équilibrée, ensemencement correct",
          "**Augmenter** : T° haute, densité haute, stress levure",
          "**Aération** : Équilibre, pas d'extrêmes",
          "**Levure** : Santé/population clés"
        ]
      },
      {
        title: "Points à retenir",
        items: [
          "✅ Fusel alcohols = alcools ≠ éthanol",
          "✅ Faible dose = positif, forte dose = solvant",
          "✅ Favorisés par T°/densité hautes, aération déséquilibrée",
          "✅ Précurseurs d'esters (Alcool + Acide → Ester)",
          "✅ Utiles en triples belges, barley wines"
        ]
      }
    ],
    questions: [
      q("Nom anglais des alcools supérieurs?", ["Higher alcohols", "Fusel alcohols", "Super alcohols", "Strong alcohols"], 1, "Fusel alcohols."),
      q("Que sont les alcools supérieurs?", ["L'éthanol uniquement", "Alcools autres que l'éthanol", "Des esters", "Des acides"], 1, "Tous les alcools ≠ éthanol."),
      q("À faible dose, ils sont…", ["Négatifs", "Positifs (rose/banane)", "Neutres", "Toxiques"], 1, "Faible dose = positif."),
      q("À forte dose, ils sont…", ["Positifs", "Négatifs (solvant)", "Neutres", "Bénéfiques"], 1, "Forte dose = solvant/médicinal."),
      q("Arôme de l'isoamyl?", ["Pomme", "Banane/solvant", "Rose", "Caramel"], 1, "Isoamyl = banane/solvant."),
      q("Arôme de l'isobutanol?", ["Banane", "Alcool/solvant", "Fruit", "Fleur"], 1, "Isobutanol = alcool/solvant."),
      q("Arôme du n-propanol?", ["Banane", "Alcool", "Rose", "Fruit"], 1, "n-Propanol = alcool."),
      q("Trop d'aération →", ["Moins d'alcools supérieurs", "Plus d'alcools supérieurs", "Pas d'effet", "Meilleure qualité"], 1, "Extrêmes → ↑."),
      q("Trop peu d'aération →", ["Moins d'alcools supérieurs", "Plus d'alcools supérieurs", "Pas d'effet", "Meilleure qualité"], 1, "Extrêmes → ↑."),
      q("Température élevée →", ["Moins d'alcools supérieurs", "Plus d'alcools supérieurs", "Pas d'effet", "Arrêt fermentation"], 1, "T° haute → ↑."),
      q("Densité élevée →", ["Moins d'alcools supérieurs", "Plus d'alcools supérieurs", "Pas d'effet", "Moins d'alcool"], 1, "OG haute → ↑."),
      q("Les acides aminés influencent…", ["Rien", "Le profil des alcools supérieurs", "La couleur", "L'amertume"], 1, "Profil modulé."),
      q("Le stress levure favorise…", ["Moins d'alcools supérieurs", "Plus d'alcools supérieurs", "Pas d'effet", "Meilleure qualité"], 1, "Stress → ↑."),
      q("Faible concentration perçue comme…", ["Solvant", "Rose, banane, complexité", "Médicinal", "Chimique"], 1, "Faible = agréable."),
      q("Forte concentration perçue comme…", ["Rose agréable", "Solvant, chimique, médicinal", "Fruit", "Fleur"], 1, "Forte = défaut."),
      q("Relation avec les esters?", ["Aucune", "Alcools = précurseurs", "Esters = précurseurs", "Opposés"], 1, "Précurseurs."),
      q("Réaction pour former un ester?", ["Sucre + Enzyme", "Alcool supérieur + Acide", "Protéine + Lipide", "Eau + Minéral"], 1, "Alcool + acide."),
      q("Paramètre commun alcools/esters?", ["pH", "Température élevée", "Couleur", "Amertume"], 1, "T° haute favorise les deux."),
      q("Style qui en veut?", ["Pilsner", "Triple belge", "Lager légère", "Bière sans alcool"], 1, "Triples, barley wines, fortes."),
      q("Style qui les évite?", ["Triple belge", "Barley wine", "Lagers/Pilsners", "Bières fortes"], 2, "Lagers/pilsners les évitent."),
      q("Concentration souhaitée?", ["Très élevée", "Élevée", "Moyenne", "Faible"], 3, "Faible."),
      q("L'effet est…", ["Constant", "Dose-dépendant", "Toujours positif", "Toujours négatif"], 1, "Dose-dépendant."),
      q("Passage positif → négatif…", ["Progressif", "Rapide (seuil critique)", "Impossible", "Très lent"], 1, "Seuil rapide."),
      q("Pour diminuer :", ["T° élevée", "T° modérée et aération optimale", "Stress levure", "Densité haute"], 1, "T° modérée + aération équilibrée."),
      q("Pour augmenter :", ["T° basse", "T° élevée et densité haute", "Aération parfaite", "Ensemencement adéquat"], 1, "T° haute + OG haute."),
      q("Aération idéale?", ["Excessive", "Absente", "Équilibrée (ni trop, ni trop peu)", "Variable"], 2, "Équilibrée."),
      q("Santé de la levure influe…", ["Rien", "Production d'alcools supérieurs", "Uniquement la couleur", "Uniquement l'amertume"], 1, "Production."),
      q("Arôme solvant vient de…", ["Houblon", "Alcools supérieurs à forte dose", "Malt", "Eau"], 1, "Forte dose."),
      q("Arôme rose peut venir de…", ["Houblon uniquement", "Alcools supérieurs à faible dose", "Malt", "Contamination"], 1, "Faible dose."),
      q("Ils contribuent à…", ["L'amertume", "La complexité aromatique", "La couleur", "Le pH"], 1, "Complexité."),
    ]
  },
  {
    id: "fermentationBloquee",
    category: "LEVURE",
    title: "37. Fermentation bloquée et rappels d'hygiène",
    ficheRich: [
      {
        title: "Fermentation 'bloquée' - Définition",
        items: [
          "**Définition** : Fermentation qui démarre mal",
          "**Symptôme** : Moût n'atteint pas l'atténuation limite",
          "**Gravité** : Relance souvent impossible",
          "**Importance** : Diagnostic rapide"
        ]
      },
      {
        title: "Origine possible d'une fermentation bloquée",
        items: [
          "**Salle de brassage (SDB)** : Moût en cause",
          "**Fermentation** : Levure/conditions",
          "**Deux sources** : À diagnostiquer"
        ]
      },
      {
        title: "Diagnostic d'une fermentation bloquée",
        items: [
          "**1.** Prélever un échantillon représentatif",
          "**2.** Ajouter une nouvelle dose de la même levure",
          "**3.** Fermenter l'échantillon",
          "**4.** Observer après 24h",
          "**Test simple** : Identifie la source"
        ]
      },
      {
        title: "Interprétation du diagnostic",
        items: [
          "**Densité chute** : Problème de levure",
          "**Densité stable** : Problème moût (SDB)",
          "**Action** : Adapter selon la source"
        ]
      },
      {
        title: "Rappels d'hygiène - Environnement de travail",
        items: [
          "**Espace stérile** : Zone la plus propre possible",
          "**Pièce sous désinfectant** : Pour l'ensemencement",
          "**Bacs de trempage** : Sortir le plus tard possible",
          "**Levure** : Ouvrir le plus tard possible"
        ]
      },
      {
        title: "Rappels d'hygiène - Équipements",
        items: [
          "**Cuves stériles** : Vannes désinfectées",
          "**Cuve de destination** : Fermée jusqu'au moût",
          "**Ustensiles** : Lavés AVANT désinfectant",
          "**Ordre** : Lavage puis désinfection"
        ]
      },
      {
        title: "Rappels d'hygiène - Moût",
        items: [
          "**Densité primitive** : Éviter trop haute",
          "**Refroidissement** : Ensemencer dès que refroidi",
          "**Timing** : Ensemencement immédiat = sécurité"
        ]
      },
      {
        title: "Checklist hygiène fermentation",
        items: [
          "✓ Espace de travail désinfecté",
          "✓ Levure sortie au dernier moment",
          "✓ Bacs de trempage prêts",
          "✓ Cuve de fermentation stérile et fermée",
          "✓ Vannes désinfectées",
          "✓ Ustensiles lavés puis désinfectés",
          "✓ Moût refroidi avant ensemencement",
          "✓ Ensemencement immédiat après refroidissement"
        ]
      },
      {
        title: "Message clé - Maîtrise de la levure",
        items: [
          "**Art du brasseur** : Maîtriser la levure",
          "**Trois piliers** : Métabolisme, environnement, hygiène",
          "**Résultat** : Fermentation réussie",
          "**Importance** : Hygiène fondamentale"
        ]
      }
    ],
    questions: [
      q("Qu'est-ce qu'une fermentation bloquée?", ["Fermentation normale", "Fermentation qui démarre mal", "Fermentation rapide", "Fermentation froide"], 1, "Fermentation bloquée = démarre mal."),
      q("Peut-on relancer une fermentation arrêtée?", ["Toujours", "Facilement", "Probablement impossible", "Parfois"], 2, "Probablement impossible de relancer."),
      q("Quelles sont les deux origines possibles?", ["Houblon et malt", "Salle de brassage et fermentation", "Eau et levure", "Température et pH"], 1, "SDB (moût) ou fermentation (levure)."),
      q("Première étape du diagnostic?", ["Jeter le moût", "Prélever un échantillon représentatif", "Ajouter du sucre", "Chauffer"], 1, "Prélever un échantillon."),
      q("Que fait-on après le prélèvement?", ["On filtre", "On ajoute une nouvelle dose de levure", "On chauffe", "On jette"], 1, "Ajouter nouvelle dose de levure."),
      q("Combien de temps observe-t-on?", ["1 heure", "24 heures", "1 semaine", "1 mois"], 1, "Observer après 24h."),
      q("Si la densité a chuté après 24h, le problème vient…", ["Du moût", "De la levure", "Du houblon", "De l'eau"], 1, "Densité chute = problème levure."),
      q("Si la densité est stable après 24h, le problème vient…", ["De la levure", "De la salle de brassage (moût)", "Du houblon", "De la température"], 1, "Densité stable = problème SDB (moût)."),
      q("Où doit-on travailler pour ensemencer?", ["N'importe où", "Espace le plus stérile possible", "À l'extérieur", "Dans la cave"], 1, "Espace stérile pour ensemencement."),
      q("Quand sortir les bacs de trempage?", ["Le plus tôt possible", "Le plus tard possible", "N'importe quand", "Jamais"], 1, "Sortir le plus tard possible."),
      q("Quand ouvrir la levure?", ["Au début", "Le plus tard possible", "N'importe quand", "24h avant"], 1, "Ouvrir le plus tard possible."),
      q("Comment doivent être les vannes?", ["Sales", "Préalablement désinfectées", "Humides", "Ouvertes"], 1, "Vannes passées au désinfectant."),
      q("Comment maintenir la cuve de destination?", ["Ouverte", "Fermée jusqu'à l'arrivée du moût", "À moitié ouverte", "Sans couvercle"], 1, "Maintenue fermée jusqu'au moût."),
      q("Dans quel ordre nettoyer les ustensiles?", ["Désinfectant puis lavage", "Lavage puis désinfectant", "Désinfectant uniquement", "Lavage uniquement"], 1, "TOUJOURS lavés AVANT désinfection."),
      q("Que faut-il éviter pour la densité primitive?", ["Densité trop basse", "Densité trop haute", "Densité moyenne", "Mesure de densité"], 1, "Éviter densité primitive trop haute."),
      q("Quand ensemencer le moût?", ["Le lendemain", "Dès qu'il est refroidi", "Après 24h", "Quand on veut"], 1, "Ensemencer dès refroidissement."),
      q("L'ensemencement doit être…", ["Différé", "Immédiat après refroidissement", "Le lendemain", "Après 1 semaine"], 1, "Ensemencement immédiat."),
      q("Que désinfecte-t-on en premier?", ["Rien", "Espace de travail", "Le houblon", "L'eau"], 1, "Espace de travail désinfecté."),
      q("Quand préparer les bacs de trempage?", ["Jamais", "À l'avance, prêts", "Après fermentation", "Le lendemain"], 1, "Bacs de trempage prêts."),
      q("La cuve de fermentation doit être…", ["Sale", "Stérile et fermée", "Ouverte", "Humide"], 1, "Cuve stérile et fermée."),
      q("Le moût doit être… avant ensemencement", ["Chaud", "Refroidi", "Bouillant", "Tiède"], 1, "Moût refroidi avant ensemencement."),
      q("Combien de piliers pour maîtriser la levure?", ["1", "2", "3", "5"], 2, "3 piliers : métabolisme, environnement, hygiène."),
      q("Quels sont les 3 piliers?", ["Houblon, malt, eau", "Métabolisme, environnement, hygiène", "T°, pH, densité", "Couleur, amertume, alcool"], 1, "Métabolisme + environnement + hygiène."),
      q("L'hygiène est…", ["Optionnelle", "Fondamentale", "Secondaire", "Inutile"], 1, "Hygiène = fondamentale."),
      q("La maîtrise de la levure est…", ["Un détail", "L'art du brasseur", "Facultative", "Secondaire"], 1, "Art du brasseur = maîtrise levure."),
      q("Un problème d'ensemencement indique…", ["Problème moût", "Problème levure", "Problème houblon", "Problème eau"], 1, "Ensemencement = problème levure."),
      q("Un problème de génération de levure indique…", ["Problème moût", "Problème levure", "Problème température", "Problème pH"], 1, "Génération levure = problème levure."),
      q("Pourquoi laver AVANT de désinfecter?", ["C'est plus rapide", "Le désinfectant ne fonctionne pas sur surface sale", "C'est obligatoire", "Pour l'odeur"], 1, "Désinfectant inefficace sur surface sale."),
      q("Pourquoi ensemencer immédiatement?", ["Pour la couleur", "Sécurité microbiologique", "Pour l'amertume", "C'est plus rapide"], 1, "Immédiat = évite contamination."),
      q("Le résultat d'une bonne maîtrise est…", ["Bière médiocre", "Fermentation réussie et bière de qualité", "Contamination", "Arrêt fermentation"], 1, "Maîtrise = fermentation réussie + qualité.")
    ]
  }
];

// Fusion de thèmes (sans renumérotation) pour réduire les doublons visibles
const MERGE_CONFIG = [
  {
    id: "cipFusion",
    title: "16. Système CIP/SIP, protocole fermenteur et vigilance",
    sourceIds: ["cip", "protocoleFermenteur", "bonnesPratiquesCIP"]
  },
  {
    id: "materiauxFusion",
    title: "17. Matériaux, joints et raccords",
    sourceIds: ["materiaux", "joints"]
  },
  {
    id: "agentsNettoyageDesinfection",
    title: "19. Agents de nettoyage et désinfection",
    sourceIds: ["agentsNettoyage", "agentsDesinfection"]
  },
  {
    id: "fermentationFondamentaux",
    title: "26. Théorie, types et terminologie de la fermentation",
    sourceIds: ["theorieFermentation", "typesFermentation", "terminologieLevure"]
  },
  {
    id: "ensemencementLevures",
    title: "29. Taux d'ensemencement et levures sèches vs liquides",
    sourceIds: ["tauxEnsemencement", "levureSecheVsLiquide"]
  },
  {
    id: "calculsFermentation",
    title: "30. Atténuation limite et refermentation en bouteille",
    sourceIds: ["attenuationLimite", "calculRefermentation"]
  },
  {
    id: "composesFermentationFusion",
    title: "33. Composés de fermentation - Diacétyle, Esters, Acétaldéhyde, Alcools supérieurs",
    sourceIds: ["diacetyle", "esters", "acetaldehyde", "alcoolsSuperieurs"]
  }
];

function buildMergedThemes(baseThemes, config) {
  const configByFirstId = {};
  const mergedIds = new Set();

  config.forEach(cfg => {
    if (cfg.sourceIds && cfg.sourceIds.length > 0) {
      configByFirstId[cfg.sourceIds[0]] = cfg;
      cfg.sourceIds.forEach(id => mergedIds.add(id));
    }
  });

  const result = [];

  baseThemes.forEach(theme => {
    const cfg = configByFirstId[theme.id];
    if (cfg) {
      const sources = cfg.sourceIds
        .map(id => baseThemes.find(t => t.id === id))
        .filter(Boolean);

      if (sources.length === 0) return;

      result.push({
        id: cfg.id,
        category: cfg.category || sources[0].category,
        title: cfg.title,
        ficheRich: sources.flatMap(src => src.ficheRich || []),
        questions: sources.flatMap(src => src.questions || []),
        _sourceIds: [...cfg.sourceIds]
      });
    } else if (!mergedIds.has(theme.id)) {
      result.push({ ...theme, _sourceIds: [theme.id] });
    }
  });

  return result;
}

const THEMES_VIEW = buildMergedThemes(THEMES, MERGE_CONFIG);

// Base index map pour retrouver l'ordre d'origine
const baseIndexMap = {};
THEMES.forEach((t, idx) => { baseIndexMap[t.id] = idx; });

function getBasePosition(theme) {
  const ids = theme._sourceIds || [theme.id];
  return Math.min(...ids.map(id => baseIndexMap[id] ?? Number.MAX_SAFE_INTEGER));
}

// Ordre chronologique global basé sur la position d'origine
const THEMES_ORDERED = [...THEMES_VIEW].sort((a, b) => getBasePosition(a) - getBasePosition(b));

// Renumérotation chronologique de tous les thèmes (ordre global)
THEMES_ORDERED.forEach((t, idx) => {
  const cleanTitle = (t.title || '').replace(/^\s*\d+\.\s*/, '').trim();
  t.title = `${idx + 1}. ${cleanTitle}`;
});

// Test de compatibilité localStorage (Safari en navigation privée)
function isLocalStorageAvailable() {
  // Safari private mode throws on setItem even if API exists
  if (!('localStorage' in window)) return false;
  try {
    const test = '__storage_test__';
    window.localStorage.setItem(test, test);
    window.localStorage.removeItem(test);
    return true;
  } catch (e) {
    return false;
  }
}

const storageAvailable = isLocalStorageAvailable();
const memoryStore = {}; // Fallback pour Safari privé
if (!storageAvailable) {
  console.warn('⚠️ localStorage non disponible (Safari en navigation privée ?). Les données ne seront pas sauvegardées.');
}

// Fonctions wrapper pour localStorage avec gestion d'erreurs Safari
function safeSetItem(key, value) {
  if (!storageAvailable) {
    memoryStore[key] = value;
    return true;
  }
  try {
    localStorage.setItem(key, value);
    return true;
  } catch (e) {
    console.error('Erreur localStorage:', e);
    return false;
  }
}

function safeGetItem(key, defaultValue = null) {
  if (!storageAvailable) {
    return Object.prototype.hasOwnProperty.call(memoryStore, key) ? memoryStore[key] : defaultValue;
  }
  try {
    return localStorage.getItem(key) || defaultValue;
  } catch (e) {
    console.error('Erreur localStorage:', e);
    return defaultValue;
  }
}

function safeRemoveItem(key) {
  if (!storageAvailable) {
    delete memoryStore[key];
    return true;
  }
  try {
    localStorage.removeItem(key);
    return true;
  } catch (e) {
    console.error('Erreur localStorage:', e);
    return false;
  }
}

const nav = document.getElementById("nav");
const quizContainer = document.getElementById("quizContainer");
const startQuizBtn = document.getElementById("startQuiz");
const questionCountSel = document.getElementById("questionCount");
const toggleFicheBtn = document.getElementById("toggleFiche");
const ficheEl = document.getElementById("fiche");
const ficheTitle = document.getElementById("ficheTitle");
const ficheContent = document.getElementById("ficheContent");
const progressEl = document.getElementById("progress");
const scrollNav = document.getElementById('scrollNav');
const backToFicheBtn = document.getElementById('backToFicheBtn');
const backToThemesBtn = document.getElementById('backToThemesBtn');
const globalRevisionBtn = document.getElementById('globalRevisionBtn');

let currentTheme = null;
let currentQuestions = [];
let answers = [];
let showFiche = true;
let globalRevisionActive = false;

let scrollNavHideTimer = null;
let scrollNavAutoHideInited = false;
let scrollNavLastMouseMoveAt = 0;

function isWatchLikeViewport() {
  try {
    if (document.body && document.body.classList.contains('watch-mode')) return true;
    const w = Math.min(window.innerWidth || 0, window.innerHeight || 0);
    const h = Math.max(window.innerWidth || 0, window.innerHeight || 0);
    if (w === 0 || h === 0) return false;
    const ratio = w / h;
    const nearSquare = ratio > 0.85; // ~carré
    const small = h <= 520;
    return nearSquare && small;
  } catch {
    return false;
  }
}

function shouldAutoHideScrollNav() {
  try {
    // Demande: même comportement sur PC/Mac -> auto-hide partout
    return true;
  } catch {
    return false;
  }
}

function getScrollNavAutoHideDelayMs() {
  if (isWatchLikeViewport()) return 2200;
  try {
    const fine = window.matchMedia && window.matchMedia('(pointer: fine)').matches;
    const hover = window.matchMedia && window.matchMedia('(hover: hover)').matches;
    if (fine && hover) return 4500; // desktop: un peu moins agressif
  } catch {}
  return 3500;
}

function clearScrollNavHideTimer() {
  if (scrollNavHideTimer) {
    clearTimeout(scrollNavHideTimer);
    scrollNavHideTimer = null;
  }
}

function scheduleScrollNavHide() {
  if (!scrollNav) return;
  clearScrollNavHideTimer();
  scrollNavHideTimer = setTimeout(() => {
    if (!scrollNav) return;
    if (scrollNav.style.display === 'none') return;
    if (!scrollNav.classList.contains('is-auto-hide')) return;
    scrollNav.classList.add('is-hidden');
  }, getScrollNavAutoHideDelayMs());
}

function revealScrollNavAndScheduleHide() {
  if (!scrollNav) return;
  if (scrollNav.style.display === 'none') return;
  if (!scrollNav.classList.contains('is-auto-hide')) return;
  scrollNav.classList.remove('is-hidden');
  scheduleScrollNavHide();
}

function initScrollNavAutoHideListeners() {
  if (scrollNavAutoHideInited) return;
  scrollNavAutoHideInited = true;

  window.addEventListener('scroll', () => {
    revealScrollNavAndScheduleHide();
  }, { passive: true });

  window.addEventListener('pointerdown', () => {
    revealScrollNavAndScheduleHide();
  }, { passive: true });

  window.addEventListener('keydown', () => {
    revealScrollNavAndScheduleHide();
  });

  // Desktop: réapparition naturelle au wheel / mouvement souris
  window.addEventListener('wheel', () => {
    revealScrollNavAndScheduleHide();
  }, { passive: true });

  window.addEventListener('mousemove', () => {
    const now = Date.now();
    if (now - scrollNavLastMouseMoveAt < 180) return;
    scrollNavLastMouseMoveAt = now;
    revealScrollNavAndScheduleHide();
  });

  if (scrollNav) {
    scrollNav.addEventListener('pointerdown', (e) => {
      // Interaction directe: garder visible un peu plus longtemps
      if (e && e.isPrimary === false) return;
      revealScrollNavAndScheduleHide();
    }, { passive: true });
  }
}

function refreshScrollNavAutoHide() {
  if (!scrollNav) return;
  const enable = shouldAutoHideScrollNav();
  scrollNav.classList.toggle('is-auto-hide', enable);
  if (!enable) {
    scrollNav.classList.remove('is-hidden');
    clearScrollNavHideTimer();
    return;
  }
  initScrollNavAutoHideListeners();
  // visible au départ, puis auto-hide
  scrollNav.classList.remove('is-hidden');
  scheduleScrollNavHide();
}

function updateScrollNavOffset() {
  if (!scrollNav) return;
  const rect = scrollNav.getBoundingClientRect();
  const height = Math.ceil(rect.height);
  const extra = 24; // marge pour l'ombre + safe area
  document.documentElement.style.setProperty('--scrollnav-offset', `${height + extra}px`);
}

function toggleScrollNav(show) {
  if (!scrollNav) return;
  scrollNav.style.display = show ? 'flex' : 'none';

  if (document.body) {
    document.body.classList.toggle('has-scroll-nav', !!show);
  }

  if (show) {
    requestAnimationFrame(() => {
      updateScrollNavOffset();
    });
    refreshScrollNavAutoHide();
  } else {
    document.documentElement.style.setProperty('--scrollnav-offset', '0px');
    scrollNav.classList.remove('is-auto-hide', 'is-hidden');
    clearScrollNavHideTimer();
  }
}

window.addEventListener('resize', () => {
  if (scrollNav && scrollNav.style.display !== 'none') {
    updateScrollNavOffset();
    refreshScrollNavAutoHide();
  }
});

if (backToFicheBtn) {
  backToFicheBtn.addEventListener('click', () => {
    if (ficheEl && ficheEl.scrollIntoView) {
      ficheEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  });
}

if (backToThemesBtn) {
  backToThemesBtn.addEventListener('click', () => {
    const activeBtn = document.querySelector('.theme-btn.active');
    if (activeBtn && activeBtn.scrollIntoView) {
      activeBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } else if (nav && nav.scrollIntoView) {
      nav.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  });
}

// Système de suivi des thèmes (compatible Safari)
let themeProgress = JSON.parse(safeGetItem('quizProgress', '{}'));

function saveProgress() {
  safeSetItem('quizProgress', JSON.stringify(themeProgress));
}

function updateThemeStatus(themeId, status) {
  themeProgress[themeId] = status;
  saveProgress();
  updateThemeButtons();
}

function getThemeStatus(themeId) {
  return themeProgress[themeId] || 'not-started';
}

function updateThemeButtons() {
  document.querySelectorAll('.theme-btn').forEach(btn => {
    const themeId = btn.getAttribute('data-theme-id');
    if (themeId) {
      btn.classList.remove('started', 'completed');
      const status = getThemeStatus(themeId);
      if (status === 'started') btn.classList.add('started');
      if (status === 'completed') btn.classList.add('completed');
    }
  });
}

// Actions par catégorie
function getThemesByCategory(category) {
  return THEMES_VIEW.filter(t => t.category === category);
}

// Session de quiz “en cours” par catégorie (mémoire uniquement, pas de stockage)
const CATEGORY_SUMMARY_QUIZ_SESSIONS = {};

function getCategorySummaryQuizSession(category) {
  return CATEGORY_SUMMARY_QUIZ_SESSIONS[String(category || '')] || null;
}

function setCategorySummaryQuizSession(category, session) {
  CATEGORY_SUMMARY_QUIZ_SESSIONS[String(category || '')] = session;
  updateCategorySummaryButtonVisual(category);
}

function clearCategorySummaryQuizSession(category) {
  delete CATEGORY_SUMMARY_QUIZ_SESSIONS[String(category || '')];
  updateCategorySummaryButtonVisual(category);
}

function updateCategorySummaryButtonVisual(category) {
  const cat = String(category || '');
  const all = Array.from(document.querySelectorAll('.category-action-btn.summary[data-category]'));
  const btn = all.find(b => (b.dataset && b.dataset.category) === cat);
  if (!btn) return;

  const session = getCategorySummaryQuizSession(cat);
  btn.classList.remove('has-quiz-ongoing', 'has-quiz-completed');
  btn.removeAttribute('data-quiz-progress');

  if (!session || !Array.isArray(session.questions) || session.questions.length === 0) {
    btn.title = 'Voir un resumé complet des thèmes + lancer un quiz de 50 questions';
    return;
  }

  const total = session.questions.length;
  const answered = Array.isArray(session.answers) ? session.answers.filter(a => a !== null && a !== undefined).length : 0;
  const progress = `${answered}/${total}`;
  btn.setAttribute('data-quiz-progress', progress);

  if (total > 0 && answered >= total) {
    btn.classList.add('has-quiz-completed');
    btn.title = `✅ Quiz terminé (${progress}). Ouvrir le resumé pour revoir.`;
  } else {
    btn.classList.add('has-quiz-ongoing');
    btn.title = `⏳ Quiz en cours (${progress}). Ouvrir le resumé pour reprendre.`;
  }
}

function emphasizeSummaryItem(item) {
  let html = String(item || '');
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong class="key-strong">$1</strong>');
  // Mettre en évidence des valeurs/units fréquentes sans inventer d'infos
  html = html.replace(/(\b\d+(?:[\.,]\d+)?\s?(?:°C|%|IBU|EBC|SRM|mg\/L|g\/L|ppm|min|h)\b)/g, '<span class="key-hl">$1</span>');
  // Mettre en évidence les mots de vigilance fréquents
  html = html.replace(/\b(attention|vigilance|risque|pi[eè]ge|[ée]viter|ne pas|surveiller|important|critique)\b/gi, '<span class="key-hl">$1</span>');
  return html;
}

function stripSummaryMarkup(text) {
  return String(text || '')
    .replace(/\*\*(.+?)\*\*/g, '$1')
    .replace(/<[^>]+>/g, '')
    .replace(/\s+/g, ' ')
    .trim();
}

function normalizeGlossaryKey(term) {
  return String(term || '')
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .toLowerCase()
    .replace(/[^a-z0-9\s\/\-]/g, '')
    .replace(/\s+/g, ' ')
    .trim();
}

const BREW_GLOSSARY_SEED = [
  {
    term: 'Pouvoir diastasique',
    keys: ['pouvoir diastasique', 'diastasique', 'diastatic power'],
    def: "Capacité d'un malt à fournir des enzymes (amylases) capables de convertir l'amidon en sucres fermentescibles (souvent exprimée en °Lintner ou WK)."
  },
  {
    term: 'CIP',
    keys: ['cip', 'clean in place', 'nep', 'nettoyage en place'],
    def: "Nettoyage en place d'un équipement par circulation de solutions (rinçage, soude, acide, désinfection) sans démontage."
  },
  {
    term: 'SIP',
    keys: ['sip', 'sterilization in place', 'stérilisation en place'],
    def: "Stérilisation/désinfection en place (souvent vapeur/eau chaude) réalisée après le nettoyage pour sécuriser l'hygiène."
  },
  {
    term: 'IBU',
    keys: ['ibu', 'international bitterness units'],
    def: "Unité d'amertume: estimation liée aux iso-acides alpha, approximativement en mg/L (valeur influencée par l'ébullition et le process)."
  },
  {
    term: 'Bittering (houblonnage d’amertume)',
    keys: ['bittering', 'houblonnage amerisant', 'houblonnage amérisant', 'houblonnage d amertume', 'houblonnage d’amertume', 'addition amerisante', 'addition amérisante'],
    def: "Ajout de houblon au début de l’ébullition pour apporter l’amertume (IBU) via l’isomérisation des acides alpha; très peu d’aromatique car les huiles volatiles s’évaporent."
  },
  {
    term: 'EBC',
    keys: ['ebc'],
    def: "Échelle de couleur (European Brewery Convention) utilisée pour quantifier la couleur d'une bière ou d'un malt."
  },
  {
    term: 'SRM',
    keys: ['srm'],
    def: "Échelle de couleur (Standard Reference Method), alternative à EBC."
  },
  {
    term: 'Plato (°P)',
    keys: ['plato', '°p', 'degre plato'],
    def: "Mesure de la concentration en sucres du moût: 1°P ≈ 1% (m/m) d'extrait dissous."
  },
  {
    term: 'Densité initiale (OG)',
    keys: ['og', 'original gravity', 'densite initiale'],
    def: "Densité du moût avant fermentation; sert à estimer la richesse en sucres et le potentiel alcool."
  },
  {
    term: 'Densité finale (FG)',
    keys: ['fg', 'final gravity', 'densite finale'],
    def: "Densité après fermentation; reflète les sucres résiduels et le niveau d'atténuation."
  },
  {
    term: 'Atténuation',
    keys: ['attenuation', 'atténuation'],
    def: "Part des sucres consommés par la levure entre OG et FG; plus elle est élevée, plus la bière est sèche."
  },
  {
    term: 'FAN',
    keys: ['fan', 'free amino nitrogen'],
    def: "Azote assimilable (acides aminés) disponible pour la levure; un niveau insuffisant peut ralentir la fermentation."
  },
  {
    term: 'Indice de Kolbach',
    keys: ['kolbach', 'indice de kolbach'],
    def: "Indicateur de modification du malt: rapport entre l'azote soluble/FAN et les protéines totales (plus haut = plus modifié)."
  },
  {
    term: 'Crabtree',
    keys: ['crabtree', 'effet crabtree'],
    def: "Tendance de certaines levures à fermenter même en présence d'oxygène lorsque la concentration en sucres est élevée."
  },
  {
    term: 'Hop creep',
    keys: ['hop creep', 'hopcreep'],
    def: "Reprise de fermentation après dry-hop due à des enzymes du houblon libérant des sucres fermentescibles."
  },
  {
    term: 'Iso-acides alpha',
    keys: ['iso alpha', 'iso-acides alpha', 'isoacides alpha'],
    def: "Produits isomérisés des acides alpha du houblon formés à l'ébullition; principaux contributeurs à l'amertume."
  },
  {
    term: 'Alpha-acides',
    keys: ['alpha acides', 'alpha-acides', 'acides alpha', 'aa%'],
    def: "Composés du houblon (AA%) dont l’isomérisation à l’ébullition produit les iso-acides alpha responsables de l’amertume."
  },
  {
    term: 'Utilisation (houblon)',
    keys: ['utilisation', 'utilization', 'rendement ibu'],
    def: "Fraction des acides alpha convertie/extrait (dépend du temps, densité, forme du houblon, ébullition)."
  },
  {
    term: 'BU:GU',
    keys: ['bu:gu', 'bugu', 'bu gu'],
    def: "Ratio amertume (BU≈IBU) / densité (GU) pour estimer l’équilibre entre amertume et sucrosité du moût."
  },
  {
    term: 'Gushing',
    keys: ['gushing'],
    def: "Débordement/jaillissement incontrôlé à l’ouverture (sur-moussage), souvent lié à surpression, particules/noyaux de nucléation ou refermentation."
  },
  {
    term: 'Surpression',
    keys: ['surpression', 'sur-pression'],
    def: "Pression trop élevée dans un contenant (danger de gushing/explosion), due à CO₂ excessif ou refermentation non maîtrisée."
  },
  {
    term: 'CO₂',
    keys: ['co2', 'dioxyde de carbone', 'gaz carbonique'],
    def: "Gaz produit par la fermentation; responsable de la carbonatation et de la pression en bouteille/fût."
  },
  {
    term: 'Dry hop',
    keys: ['dry hop', 'dryhop', 'dry hopping', 'dry-hopping', 'houblonnage a cru', 'houblonnage à cru', 'houblonnage a froid', 'houblonnage à froid'],
    def: "Ajout de houblon à froid (fermentation/conditionnement) pour booster l’aromatique sans augmenter fortement l’IBU; risques: oxygène, hop creep, pertes et astringence."
  },
  {
    term: 'Dry hopping',
    keys: ['dry hopping', 'dry-hopping', 'dry hop', 'dryhop', 'houblonnage à cru', 'houblonnage à froid'],
    def: "Synonyme de dry hop: ajout de houblon à froid pour l’aromatique (pendant/fin de fermentation ou en garde), avec attention à l’oxydation et au hop creep."
  },
  {
    term: 'Lupuline',
    keys: ['lupuline', 'lupulin'],
    def: "Poudre jaune dans les glandes du houblon, riche en résines (acides alpha) et huiles aromatiques."
  },
  {
    term: 'Cryo (Lupulin Powder)',
    keys: ['cryo', 'lupulin powder', 'lupulin'],
    def: "Produit de houblon concentré en lupuline (moins de matière végétale) pour booster arôme/IBU avec moins de pertes."
  },
  {
    term: 'Pellets T90 / T45',
    keys: ['pellets', 'pellet', 't90', 't45'],
    def: "Forme de houblon comprimé; T90 ≈ classique, T45 ≈ plus concentré (moins de matière végétale)."
  },
  {
    term: 'NEIPA',
    keys: ['neipa', 'new england ipa'],
    def: "Style très houblonné (aromatique intense), souvent trouble; attention à l’oxydation et aux particules en suspension."
  },
  {
    term: 'Astringence',
    keys: ['astringence', 'astringent'],
    def: "Sensation râpeuse/asséchante (polyphénols/tanins); peut augmenter avec contact prolongé de houblon ou extraction végétale."
  },
  {
    term: 'Biotransformation',
    keys: ['biotransformation', 'bio-transformation'],
    def: "Transformation de composés du houblon par la levure (surtout en fermentation active), modifiant les arômes perçus."
  },
  {
    term: 'Diacétyle',
    keys: ['diacetyle', 'diacétyle', 'diasetyle', 'diacetyl', 'diacethyl'],
    def: "Composé aromatique (note beurre/pop-corn) produit en fermentation; normalement réduit par la levure en fin (repos diacétyle)."
  },
  {
    term: 'DMS',
    keys: ['dms', 'dimethyl sulfide', 'diméthyl sulfure'],
    def: "Défaut possible (maïs cuit) issu de précurseurs du malt; réduit par ébullition vigoureuse et refroidissement rapide."
  },
  {
    term: 'Acétaldéhyde',
    keys: ['acetaldehyde', 'acétaldéhyde'],
    def: "Sous-produit de fermentation (pomme verte); diminue si la levure termine correctement la fermentation/conditionnement."
  },
  {
    term: 'Esters',
    keys: ['esters', 'ester'],
    def: "Composés aromatiques (fruité) produits par la levure; influencés par souche, température, oxygénation et nutriments."
  },
  {
    term: 'Alcools supérieurs (fusel)',
    keys: ['alcools superieurs', 'alcools supérieurs', 'fusel'],
    def: "Alcools au-delà de l'éthanol; à forte dose donnent des notes solvant/chaud. Dépendent de T°, stress levure et nutriments."
  },
  {
    term: 'Whirlpool',
    keys: ['whirlpool'],
    def: "Étape de clarification par vortex après l'ébullition pour concentrer le trub au centre et clarifier le moût soutiré."
  },
  {
    term: 'Trub',
    keys: ['trub'],
    def: "Dépôts (protéines, houblon, coagulations) formés à l'ébullition/refroidissement; impacte clarification et parfois fermentation."
  }
];

function getBrewGlossarySeedIndex() {
  return (BREW_GLOSSARY_SEED || [])
    .map(e => {
      const keys = (e.keys || []).map(k => normalizeGlossaryKey(k)).filter(Boolean);
      const primaryKey = keys[0] || normalizeGlossaryKey(e.term);
      return {
        term: e.term,
        def: e.def,
        key: primaryKey,
        keys
      };
    })
    .filter(e => e.key && e.term && e.def);
}

function extractGlossaryPairFromPlainText(plainText) {
  const t = String(plainText || '').replace(/\s+/g, ' ').trim();
  if (!t) return null;

  const isAllCapsAcronym = (s) => /^[A-ZÉÈÀÙÂÊÎÔÛÄËÏÖÜÇ0-9]{2,8}$/.test(String(s || '').trim());

  // 1) ACRONYME (Expansion) : ...  (ex: FAN (Free Amino Nitrogen): ...)
  //    ou ACRONYME (Expansion) tout seul.
  let m = t.match(/^([A-ZÉÈÀÙÂÊÎÔÛÄËÏÖÜÇ0-9]{2,8})\s*\(([^)]+)\)\s*(?:(?:\:|=|→|\s-\s|\s–\s|\s—\s)\s*(.+))?$/);
  if (m) {
    const term = (m[1] || '').trim();
    const expansion = (m[2] || '').trim();
    const tail = (m[3] || '').trim();
    const def = tail ? `${expansion} — ${tail}` : expansion;
    if (term && def && def.length >= 3) return { term, def };
  }

  // 2) Terme : définition / Terme = définition / Terme → définition / Terme - définition
  m = t.match(/^(.{2,90}?)\s*(?:\:|=|→|\s-\s|\s–\s|\s—\s)\s*(.{5,})$/);
  if (m) {
    let term = (m[1] || '').trim();
    let def = (m[2] || '').trim();

    // Ex: "1 IBU = ..." → terme = "IBU"
    if (/^\d+\s+[A-ZÉÈÀÙÂÊÎÔÛÄËÏÖÜÇ0-9]{2,8}$/.test(term)) {
      term = term.replace(/^\d+\s+/, '').trim();
    }

    // Cas “CIP - Clean In Place ... : ...” : si le terme est un acronyme court, on garde “CIP” comme terme.
    const sub = term.match(/^([A-ZÉÈÀÙÂÊÎÔÛÄËÏÖÜÇ0-9]{2,8})$/);
    if (sub) {
      term = sub[1];
    }

    // Nettoyages
    term = term.replace(/^[-–—•\s]+/, '').replace(/\s+$/, '');
    def = def.replace(/^[-–—•\s]+/, '').trim();

    if (term && def) {
      return { term, def };
    }
  }

  // 3) Phrases de définition (plus fréquentes dans les cours)
  // Ex: "Le pouvoir diastasique mesure ..." / "CIP correspond à ..." / "Un whirlpool désigne ..."
  m = t.match(/^(?:Le|La|Les|L['’]|Un|Une)\s+(.{2,70}?)\s+(désigne|correspond à|représente|mesure|est|se définit comme)\s+(.{8,})$/i);
  if (m) {
    const term = (m[1] || '').trim();
    const verb = (m[2] || '').trim();
    const rest = (m[3] || '').trim();
    if (term && rest) {
      return { term, def: `${verb} ${rest}` };
    }
  }

  // 4) Acronyme seul suivi d'une explication (rare mais utile)
  // Ex: "CIP : ..." est déjà couvert, mais "CIP correspond à ..." peut arriver.
  m = t.match(/^([A-ZÉÈÀÙÂÊÎÔÛÄËÏÖÜÇ0-9]{2,8})\s+(désigne|correspond à|signifie)\s+(.{8,})$/i);
  if (m) {
    const term = (m[1] || '').trim();
    const verb = (m[2] || '').trim();
    const rest = (m[3] || '').trim();
    if (term && rest) return { term, def: `${verb} ${rest}` };
  }

  // 5) Terme (petite explication) sans séparateur (utile pour "diacétyle (goût beurre)")
  m = t.match(/^(.{2,45}?)\s*\((.{4,180}?)\)\s*$/);
  if (m) {
    const term = (m[1] || '').trim();
    const def = (m[2] || '').trim();
    if (term && def) {
      // éviter les phrases
      if (!/[\.!?]$/.test(term) && term.split(/\s+/).filter(Boolean).length <= 8) {
        return { term, def };
      }
    }
  }

  return null;
}

function isLikelyStandaloneGlossaryTermLine(plainText) {
  const t = String(plainText || '').replace(/\s+/g, ' ').trim();
  if (!t) return false;

  // Trop long = probablement une phrase.
  if (t.length > 60) return false;

  // Déjà une définition en format "Terme: ..." etc.
  if (/(\:|=|→|\s-\s|\s–\s|\s—\s)/.test(t)) return false;

  // Éviter les phrases (verbes courants / ponctuation finale)
  if (/[\.!?]$/.test(t)) return false;
  if (/\b(est|sont|correspond|désigne|mesure|définit|se définit|signifie)\b/i.test(t)) return false;

  // Autoriser acronymes, ou 1-5 mots “nominal”
  const words = t.split(/\s+/).filter(Boolean);
  if (words.length === 0) return false;

  const isAcronym = /^[A-ZÉÈÀÙÂÊÎÔÛÄËÏÖÜÇ0-9]{2,8}$/.test(t);
  if (isAcronym) return true;

  if (words.length > 6) return false;
  if (t.length < 3) return false;

  // Éviter items trop “liste”
  if (/^[-–—•\s]+/.test(t)) return false;

  // On accepte les termes techniques qui contiennent slash ou acronymes internes
  if (/[A-Z]{2,}/.test(t)) return true;
  if (/[\/_]/.test(t)) return true;

  return true;
}

function isLikelyDefinitionLine(plainText) {
  const t = String(plainText || '').replace(/\s+/g, ' ').trim();
  if (!t) return false;
  if (t.length < 12) return false;

  // Indices de définition/explication
  if (/(désigne|correspond à|représente|mesure|se définit|signifie|c['’]est|on appelle)/i.test(t)) return true;
  if (/[\(\)]/.test(t)) return true;
  if (/\b\d+(?:[\.,]\d+)?\s?(?:°c|%|ibu|ebc|srm|mg\/l|g\/l|ppm|min|h|°p)\b/i.test(t)) return true;
  if (t.length >= 24) return true;
  return false;
}

function classifySummaryItem(plainText) {
  const t = String(plainText || '').toLowerCase();
  const hasNumbers = /\b\d+(?:[\.,]\d+)?\s?(?:°c|%|ibu|ebc|srm|mg\/l|g\/l|ppm|min|h|heure|heures|jour|jours|semaine|semaines)\b/i.test(plainText);
  if (hasNumbers) return 'Chiffres clés';
  if (/(attention|vigilance|risque|pi[eè]ge|[ée]viter|ne pas|surveiller|important|critique)/i.test(plainText)) return 'Points de vigilance';
  if (/(d[ée]finition|d[ée]signe|correspond|on appelle|c['’]est)/i.test(plainText)) return 'Définitions';
  if (/(m[ée]thode|proc[ée]dure|process|[eé]tape|mesurer|calcul|comment)/i.test(plainText)) return 'Méthode / process';
  return 'À retenir';
}

function collectThemeFicheItems(theme) {
  const out = [];
  (theme.ficheRich || []).forEach(sec => {
    (sec.items || []).forEach(item => {
      out.push({
        sectionTitle: sec.title || '',
        item
      });
    });
  });
  return out;
}
function buildStructuredBucketsFromThemes(themes, options = {}) {
  const limitPerBucket = options.limitPerBucket ?? 10;
  const includeSourceTags = options.includeSourceTags ?? false;
  const buckets = {
    'À retenir': [],
    'Chiffres clés': [],
    'Points de vigilance': [],
    'Définitions': [],
    'Méthode / process': []
  };

  const defMap = new Map(); // key -> { term, html, score }
  const defFallback = [];

  const isGenericTerm = (term) => {
    const tl = String(term || '').toLowerCase().trim();
    const generic = new Set([
      'objectif', 'exemple', 'calcul', 'résultat', 'résultats', 'note', 'nb',
      'attention', 'vigilance', 'conséquences', 'impact', 'méthode', 'process',
      'formule', 'définition', 'définitions', 'principe', 'conclusion',
      'avantage', 'inconvénient', 'important', 'remarque'
    ]);
    if (generic.has(tl)) return true;
    if (tl.length <= 1) return false; // géré ailleurs
    return false;
  };

  const isShortAcronym = (term) => /^[A-ZÉÈÀÙÂÊÎÔÛÄËÏÖÜÇ0-9]{2,8}$/.test(String(term || '').trim());

  const scoreDefinition = (term, def) => {
    const d = String(def || '');
    const len = d.length;
    let score = 0;
    if (isShortAcronym(term)) score += 2;
    if (len >= 20 && len <= 240) score += 3;
    if (len >= 10 && len < 20) score += 1;
    if (/[\(\)]/.test(d)) score += 1;
    if (/(\bibu\b|\bebc\b|\bsrm\b|mg\/l|g\/l|ppm|°c|°p|\bplato\b|\bco2\b)/i.test(d)) score += 1;
    if (len > 400) score -= 2;
    if (len < 10) score -= 2;
    return score;
  };

  const seen = new Set();
  const allTextParts = [];
  for (const theme of themes) {
    const items = collectThemeFicheItems(theme);
    const consumed = new Set();
    for (let i = 0; i < items.length; i++) {
      if (consumed.has(i)) continue;
      const entry = items[i];
      const plain = stripSummaryMarkup(entry.item);
      if (!plain) continue;

      allTextParts.push(plain);
      if (entry.sectionTitle) allTextParts.push(stripSummaryMarkup(entry.sectionTitle));

      const key = (plain + '|' + (entry.sectionTitle || '') + '|' + (includeSourceTags ? (theme.title || '') : '')).toLowerCase();
      if (seen.has(key)) continue;
      seen.add(key);

      const bucket = classifySummaryItem(plain);
      if (!buckets[bucket]) continue;

      let suffix = '';
      if (entry.sectionTitle) {
        suffix += ` <span style="color: var(--muted); font-size: 0.85em;">— ${entry.sectionTitle}</span>`;
      }
      if (includeSourceTags && theme.title) {
        suffix += ` <span style="color: var(--muted); font-size: 0.85em;">(${theme.title})</span>`;
      }

      // Glossaire “Définitions” : extraire Terme → explication, en ciblant vocabulaire technique.
      let pair = extractGlossaryPairFromPlainText(plain);

      // Support "Terme" sur une ligne puis "explication" sur la suivante (souvent dans les cours)
      if (!pair && isLikelyStandaloneGlossaryTermLine(plain)) {
        const next = items[i + 1];
        if (next && String(next.sectionTitle || '') === String(entry.sectionTitle || '')) {
          const nextPlain = stripSummaryMarkup(next.item);
          if (nextPlain && isLikelyDefinitionLine(nextPlain)) {
            // Construire un candidat simple "Terme : explication"
            pair = extractGlossaryPairFromPlainText(`${plain} : ${nextPlain}`);
            if (pair) {
              consumed.add(i + 1);
            }
          }
        }
      }

      if (pair && pair.term && pair.def) {
        const term = String(pair.term).trim();
        const def = String(pair.def).trim();

        // Filtrage anti-bruit : garder les acronymes / termes raisonnables, éviter les mots trop génériques.
        const wordCount = term.split(/\s+/).filter(Boolean).length;
        const acronym = isShortAcronym(term);
        if (!acronym && isGenericTerm(term)) {
          // ignore
        } else if (!acronym && wordCount > 10) {
          // ignore
        } else if (!acronym && term.length < 3) {
          // ignore
        } else {
          const keyTerm = normalizeGlossaryKey(term);
          if (keyTerm) {
            const termHtml = escapeHtml(term);
            const defHtml = emphasizeSummaryItem(def) + suffix;
            const html = `<div class="def-row"><div class="def-term">${termHtml}</div><div class="def-def">${defHtml}</div></div>`;
            const score = scoreDefinition(term, def);
            const prev = defMap.get(keyTerm);
            if (!prev) {
              if (defMap.size < limitPerBucket) {
                defMap.set(keyTerm, { term, html, score });
              }
            } else if (score > prev.score) {
              defMap.set(keyTerm, { term, html, score });
            }
          }
        }
      } else if (bucket === 'Définitions') {
        // Fallback: si on a classé en Définition mais pas de “Terme: …”, on garde quand même la ligne.
        if (defFallback.length < limitPerBucket) {
          defFallback.push(emphasizeSummaryItem(entry.item) + suffix);
        }
      }

      // Remplissage des autres sections
      if (bucket !== 'Définitions') {
        if (buckets[bucket].length >= limitPerBucket) continue;
        buckets[bucket].push(emphasizeSummaryItem(entry.item) + suffix);
      }
    }
  }

  // Injection glossaire (seed + définitions extraites) si un terme est présent mais pas défini explicitement
  if (defMap.size < limitPerBucket) {
    const normHaystack = normalizeGlossaryKey(allTextParts.join(' | '));
    let glossaryEntries = (GLOBAL_GLOSSARY_INDEX && GLOBAL_GLOSSARY_INDEX.length) ? GLOBAL_GLOSSARY_INDEX : [];
    if ((!glossaryEntries || glossaryEntries.length === 0) && typeof buildGlobalGlossaryIndex === 'function') {
      try {
        GLOBAL_GLOSSARY_INDEX = buildGlobalGlossaryIndex();
        glossaryEntries = GLOBAL_GLOSSARY_INDEX;
      } catch {
        glossaryEntries = [];
      }
    }

    for (const g of (glossaryEntries || [])) {
      if (defMap.size >= limitPerBucket) break;
      const key = g.key;
      if (!key) continue;

      // Match sur l'une des clés/synonymes
      const keys = (g.keys && g.keys.length) ? g.keys : [key];
      const hit = keys.some(k => {
        if (!k) return false;
        try {
          // Limites “word boundary” robustes (les clés peuvent contenir espaces / tirets / slash)
          return new RegExp(`(^|[^a-z0-9])${escapeRegExp(k)}([^a-z0-9]|$)`, 'i').test(normHaystack);
        } catch {
          return normHaystack.includes(k);
        }
      });
      if (!hit) continue;

      const normKey = key;
      const termHtml = escapeHtml(g.term);
      const defText = g.defFull || g.shortDef || '';
      const defHtml = emphasizeSummaryItem(defText);
      const html = `<div class="def-row"><div class="def-term">${termHtml}</div><div class="def-def">${defHtml}</div></div>`;

      const score = 10 + scoreDefinition(g.term, defText);
      const prev = defMap.get(normKey);
      if (!prev) {
        defMap.set(normKey, { term: g.term, html, score });
      } else if (score > prev.score) {
        defMap.set(normKey, { term: g.term, html, score });
      }
    }
  }

  // Finaliser la section Définitions (glossaire) : d'abord les paires, puis le fallback
  buckets['Définitions'] = Array.from(defMap.values())
    .sort((a, b) => (b.score || 0) - (a.score || 0))
    .map(x => x.html);
  if (buckets['Définitions'].length < limitPerBucket && defFallback.length) {
    buckets['Définitions'].push(...defFallback.slice(0, limitPerBucket - buckets['Définitions'].length));
  }

  return buckets;
}

function renderSummaryBucket(titleText, htmlItems, emptyText) {
  const secDiv = document.createElement('div');
  secDiv.className = 'cat-summary-section';

  const isDefinitions = /d[ée]finitions/i.test(String(titleText || ''));
  if (isDefinitions) secDiv.classList.add('is-definitions');

  const h5 = document.createElement('h5');
  h5.textContent = titleText;
  secDiv.appendChild(h5);

  if (!htmlItems || htmlItems.length === 0) {
    const p = document.createElement('div');
    p.style.color = 'var(--muted)';
    p.style.fontStyle = 'italic';
    p.textContent = emptyText || 'Aucun élément.';
    secDiv.appendChild(p);
    return secDiv;
  }

  const ul = document.createElement('ul');
  htmlItems.forEach(h => {
    const li = document.createElement('li');
    li.innerHTML = isDefinitions ? h : ('• ' + h);
    ul.appendChild(li);
  });
  secDiv.appendChild(ul);

  return secDiv;
}

function cloneQuestionWithShuffledOptions(base, theme, originalIndex) {
  const optionsWithIndex = (base.options || []).map((opt, idOpt) => ({ opt, idOpt }));
  const shuffledOptions = shuffle(optionsWithIndex);
  const newCorrectIndex = shuffledOptions.findIndex(item => item.idOpt === base.correctIndex);
  return {
    question: base.question,
    options: shuffledOptions.map(item => item.opt),
    correctIndex: newCorrectIndex,
    explanation: base.explanation,
    sourceThemeId: theme.id,
    sourceThemeTitle: theme.title,
    originalIndex
  };
}

function buildCategorySynthesisQuiz(category, count = 50) {
  const themes = getThemesByCategory(category);
  const pool = [];

  themes.forEach(theme => {
    (theme.questions || []).forEach((q, idx) => {
      pool.push(cloneQuestionWithShuffledOptions(q, theme, idx));
    });
  });

  if (pool.length === 0) return { questions: [], uniqueCount: 0 };

  const questions = [];
  let safety = 0;
  while (questions.length < count && safety < 1000) {
    const chunk = shuffle(pool);
    for (const q of chunk) {
      if (questions.length >= count) break;
      // re-shuffle options à chaque réutilisation pour éviter le copier/coller exact
      const theme = THEMES_VIEW.find(t => t.id === q.sourceThemeId) || { id: q.sourceThemeId, title: q.sourceThemeTitle };
      const baseTheme = THEMES_VIEW.find(t => t.id === q.sourceThemeId);
      if (baseTheme && baseTheme.questions && baseTheme.questions[q.originalIndex]) {
        questions.push(cloneQuestionWithShuffledOptions(baseTheme.questions[q.originalIndex], baseTheme, q.originalIndex));
      } else {
        questions.push({
          question: q.question,
          options: (q.options || []).slice(),
          correctIndex: q.correctIndex,
          explanation: q.explanation,
          sourceThemeId: theme.id,
          sourceThemeTitle: theme.title,
          originalIndex: q.originalIndex
        });
      }
    }
    safety++;
  }

  return { questions: questions.slice(0, count), uniqueCount: pool.length };
}

function generateCategorySummaryHtmlDocument(category) {
  const themes = getThemesByCategory(category);
  const safeCategory = String(category || '').replace(/\s+/g, '_').replace(/[^a-z0-9_\-]/gi, '');
  const dateStr = new Date().toLocaleString('fr-FR');

  const catBuckets = buildStructuredBucketsFromThemes(themes, { limitPerBucket: 50, includeSourceTags: true });
  const { questions: quizQuestions, uniqueCount } = buildCategorySynthesisQuiz(category, 50);

  const themesList = themes.map(t => escapeHtml(stripSummaryMarkup(t.title))).join(' • ');

  let html = `<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resumé — ${escapeHtml(category)}</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.8;
      padding: 40px;
      max-width: 1100px;
      margin: 0 auto;
      background: #f5f5f5;
      color: #222;
    }
    .container {
      background: white;
      padding: 45px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2c5aa0;
      font-size: 2.3em;
      border-bottom: 4px solid #2c5aa0;
      padding-bottom: 12px;
      margin-bottom: 10px;
    }
    .meta {
      color: #666;
      font-style: italic;
      margin-bottom: 28px;
      font-size: 1.05em;
    }
    .pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: #eef2ff;
      border: 1px solid #c7d2fe;
      color: #3730a3;
      font-weight: 700;
      margin-right: 8px;
      margin-top: 6px;
    }
    h2 {
      color: #3b7dd6;
      font-size: 1.9em;
      margin-top: 42px;
      margin-bottom: 18px;
      border-bottom: 3px solid #3b7dd6;
      padding-bottom: 8px;
    }
    h3 {
      color: #4a8ee0;
      font-size: 1.4em;
      margin-top: 22px;
      margin-bottom: 10px;
    }
    ul { margin: 10px 0 20px 0; padding-left: 22px; }
    li { margin: 8px 0; }
    .key-strong { background: rgba(167,139,250,0.18); border: 1px solid rgba(167,139,250,0.22); padding: 0 0.2rem; border-radius: 4px; }
    .key-hl { background: rgba(59,130,246,0.14); border: 1px solid rgba(59,130,246,0.18); padding: 0 0.2rem; border-radius: 4px; font-weight: 800; }
    .block {
      margin: 18px 0;
      padding: 18px 18px;
      background: #fafafa;
      border-left: 5px solid #58a6ff;
      border-radius: 10px;
    }
    .theme {
      margin-top: 26px;
      padding-top: 18px;
      border-top: 1px dashed #cbd5e1;
    }
    .question-block {
      margin: 18px 0;
      padding: 18px;
      background: linear-gradient(to right, #f0fdf4, #fff);
      border-left: 5px solid #3fb950;
      border-radius: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .question-title { font-weight: 700; font-size: 1.08em; color: #111827; margin-bottom: 10px; }
    .source { color: #6b7280; font-size: 0.95em; margin-bottom: 8px; }
    .correct-answer {
      color: #16a34a;
      font-weight: 700;
      margin: 10px 0;
      padding: 8px 14px;
      background: #dcfce7;
      border-radius: 8px;
      display: inline-block;
    }
    .explanation {
      color: #374151;
      font-style: italic;
      margin: 10px 0 0;
      padding: 12px 14px;
      background: #fff;
      border-left: 3px solid #e5e7eb;
      border-radius: 8px;
    }

    .def-row {
      display: grid;
      grid-template-columns: minmax(180px, 0.42fr) 1fr;
      gap: 12px;
      align-items: start;
      padding: 10px 12px;
      border-radius: 10px;
      background: #f6faff;
      border: 1px solid #dbeafe;
    }

    .def-term {
      font-weight: 900;
      color: #3730a3;
      line-height: 1.35;
    }

    .def-def {
      color: #111827;
      line-height: 1.5;
    }

    @media (max-width: 680px) {
      .def-row { grid-template-columns: 1fr; gap: 6px; }
    }
    @media print {
      body { background: white; padding: 0; }
      .container { box-shadow: none; padding: 20px; }
      .question-block { page-break-inside: avoid; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🧾 Resumé — ${escapeHtml(category)}</h1>
    <div class="meta">📅 Généré le ${escapeHtml(dateStr)} • 📂 Catégorie : ${escapeHtml(category)}</div>
    <div class="block">
      <div><span class="pill">${themes.length} thème(s)</span><span class="pill">Quiz: 50 questions</span><span class="pill">Questions uniques: ${uniqueCount}</span></div>
      <div style="margin-top:10px;color:#374151;"><strong>Thèmes inclus :</strong> ${themesList || '—'}</div>
    </div>
`;

  const orderedBuckets = [
    { key: 'À retenir', title: 'À retenir (priorité)' },
    { key: 'Chiffres clés', title: 'Chiffres clés' },
    { key: 'Points de vigilance', title: 'Points de vigilance' },
    { key: 'Définitions', title: 'Définitions' },
    { key: 'Méthode / process', title: 'Méthode / process' }
  ];

  html += `<h2>🧠 Synthèse structurée</h2>`;
  orderedBuckets.forEach(b => {
    const items = catBuckets[b.key] || [];
    html += `<h3>${escapeHtml(b.title)}</h3>`;
    if (!items.length) {
      html += `<div class="block" style="color:#6b7280;font-style:italic;">Aucun élément détecté.</div>`;
      return;
    }
    html += `<ul>`;
    items.forEach(it => {
      html += `<li>${it}</li>`;
    });
    html += `</ul>`;
  });

  html += `<h2>📚 Détails par thème (contenu complet)</h2>`;
  themes.forEach(theme => {
    html += `<div class="theme">`;
    html += `<h3>${escapeHtml(stripSummaryMarkup(theme.title))}</h3>`;
    (theme.ficheRich || []).forEach(sec => {
      html += `<div class="block">`;
      html += `<h4 style="margin:0 0 10px 0;color:#3730a3;">${escapeHtml(sec.title)}</h4>`;
      html += `<ul>`;
      (sec.items || []).forEach(item => {
        const formatted = emphasizeSummaryItem(item);
        html += `<li>${formatted}</li>`;
      });
      html += `</ul>`;
      html += `</div>`;
    });
    html += `</div>`;
  });

  html += `<h2>📝 Quiz de synthèse (50 questions)</h2>`;
  if (!quizQuestions || quizQuestions.length === 0) {
    html += `<div class="block" style="color:#6b7280;font-style:italic;">Aucune question disponible pour cette catégorie.</div>`;
  } else {
    quizQuestions.forEach((q, idx) => {
      const correctAnswer = (q.options || [])[q.correctIndex] || '';
      html += `
<div class="question-block">
  <div class="source">Thème source : ${escapeHtml(q.sourceThemeTitle || '—')}</div>
  <div class="question-title">${idx + 1}. ${escapeHtml(q.question)}</div>
  <div class="correct-answer">✓ Réponse correcte : ${escapeHtml(correctAnswer)}</div>
  <div class="explanation">💡 Explication : ${escapeHtml(q.explanation)}</div>
</div>`;
    });
  }

  html += `
  </div>
</body>
</html>`;

  return { html, safeCategory };
}

function exportCategorySummary(category) {
  const themes = getThemesByCategory(category);
  if (themes.length === 0) {
    alert(`⚠️ Aucune catégorie trouvée pour ${category}.`);
    return;
  }
  if (!confirm(`📦 Exporter le resumé complet de la catégorie ${category} (synthèse + 50 questions) en page HTML ?`)) {
    return;
  }
  try {
    const out = generateCategorySummaryHtmlDocument(category);
    const filename = `Resume_${out.safeCategory || 'Categorie'}_${new Date().toISOString().slice(0,10)}.html`;
    downloadHtmlFile(out.html, filename);
    openInNewTab(out.html);
    alert('✅ Export du resumé terminé : page HTML téléchargée + prévisualisation ouverte.');
  } catch (e) {
    console.error('Erreur export resumé', e);
    alert(`❌ Erreur lors de l'export du resumé : ${e.message}`);
  }
}

function toggleModalWindowFullscreen(backdrop, card, btn) {
  const isFullscreen = !card.classList.contains('is-fullscreen');
  card.classList.toggle('is-fullscreen', isFullscreen);
  backdrop.classList.toggle('is-fullscreen', isFullscreen);
  btn.textContent = isFullscreen ? '↩️ Réduire' : '🖥️ Plein écran';
  btn.title = isFullscreen ? 'Revenir à la taille normale' : 'Mettre cette fenêtre en plein écran';
}

function showHoublonFormulas() {
  const existing = document.querySelector('.cat-formulas-backdrop');
  if (existing) existing.remove();

  const backdrop = document.createElement('div');
  backdrop.className = 'cat-formulas-backdrop';

  const card = document.createElement('div');
  card.className = 'cat-formulas-card';

  const header = document.createElement('div');
  header.className = 'cat-formulas-header';

  const title = document.createElement('div');
  title.className = 'cat-formulas-title';
  title.textContent = 'Formules — HOUBLON (IBU / Tinseth)';

  const actions = document.createElement('div');
  actions.className = 'cat-formulas-actions';

  const fsBtn = document.createElement('button');
  fsBtn.className = 'cat-formulas-fullscreen';
  fsBtn.textContent = '🖥️ Plein écran';
  fsBtn.title = 'Mettre cette fenêtre en plein écran';

  const closeBtn = document.createElement('button');
  closeBtn.className = 'cat-formulas-close';
  closeBtn.textContent = '✖ Fermer';
  closeBtn.addEventListener('click', () => backdrop.remove());

  actions.appendChild(fsBtn);
  actions.appendChild(closeBtn);
  header.appendChild(title);
  header.appendChild(actions);

  const body = document.createElement('div');
  body.className = 'cat-formulas-body';

  const fmt = (n, digits = 1) => {
    if (!isFinite(n)) return '—';
    return Number(n).toLocaleString('fr-FR', { maximumFractionDigits: digits, minimumFractionDigits: 0 });
  };

  const makeKpi = (key, sub) => {
    const kpi = document.createElement('div');
    kpi.className = 'formula-kpi';
    const k = document.createElement('div');
    k.className = 'k';
    k.textContent = key;
    const v = document.createElement('div');
    v.className = 'v';
    v.textContent = '—';
    const s = document.createElement('div');
    s.className = 's';
    s.textContent = sub || '';
    kpi.appendChild(k);
    kpi.appendChild(v);
    if (sub) kpi.appendChild(s);
    return { kpi, v, s };
  };

  const makeNumberField = (id, label, value, step = 'any') => {
    const wrap = document.createElement('div');
    wrap.className = 'formula-field';
    const lab = document.createElement('label');
    lab.setAttribute('for', id);
    lab.textContent = label;
    const inp = document.createElement('input');
    inp.id = id;
    inp.type = 'number';
    inp.step = step;
    inp.value = String(value);
    wrap.appendChild(lab);
    wrap.appendChild(inp);
    return { wrap, inp };
  };

  const makeSelectField = (id, label, options, value) => {
    const wrap = document.createElement('div');
    wrap.className = 'formula-field';
    const lab = document.createElement('label');
    lab.setAttribute('for', id);
    lab.textContent = label;
    const sel = document.createElement('select');
    sel.id = id;
    (options || []).forEach(opt => {
      const o = document.createElement('option');
      o.value = opt.value;
      o.textContent = opt.label;
      sel.appendChild(o);
    });
    sel.value = value;
    wrap.appendChild(lab);
    wrap.appendChild(sel);
    return { wrap, sel };
  };

  const getUtilFromTable = (timeMin, form) => {
    // Valeurs “cours” (comme la capture) :
    // Temps (min): 0-9, 10-19, 20-29, 30-39, 40-59, 60-74, 75+
    const bins = [
      { max: 9, cones: 0.05, pellets: 0.06 },
      { max: 19, cones: 0.12, pellets: 0.15 },
      { max: 29, cones: 0.15, pellets: 0.19 },
      { max: 39, cones: 0.19, pellets: 0.24 },
      { max: 59, cones: 0.22, pellets: 0.27 },
      { max: 74, cones: 0.24, pellets: 0.30 },
      { max: Infinity, cones: 0.27, pellets: 0.34 }
    ];
    const t = Math.max(0, Number(timeMin) || 0);
    const f = (form === 'cones') ? 'cones' : 'pellets';
    const bin = bins.find(b => t <= b.max) || bins[bins.length - 1];
    return bin[f];
  };

  // --- Formule IBU (Tinseth “cours”) ---
  const ibuHero = document.createElement('div');
  ibuHero.className = 'formula-hero';

  const ibuTitle = document.createElement('h4');
  ibuTitle.textContent = 'IBU (Tinseth) — calcul interactif';
  ibuHero.appendChild(ibuTitle);

  const ibuEq = document.createElement('div');
  ibuEq.className = 'formula-eq';
  ibuEq.innerHTML = `IBU = (α% × masse houblon (mg) × utilisation) ÷ volume (L) × correction D`;
  ibuHero.appendChild(ibuEq);

  const ibuGrid = document.createElement('div');
  ibuGrid.className = 'formula-grid';

  const fAlpha = makeNumberField('ibu_alpha', 'Acides alpha α (%)', 13, 'any');
  const fHopsG = makeNumberField('ibu_hops_g', 'Houblon ajouté (g)', 80, 'any');
  const fVolume = makeNumberField('ibu_volume_l', 'Volume (L)', 100, 'any');

  const fUtilMode = makeSelectField(
    'ibu_util_mode',
    'Utilisation',
    [
      { value: 'table', label: 'Auto (table cours)' },
      { value: 'manual', label: 'Manuelle (en %)' }
    ],
    'table'
  );

  const fTime = makeNumberField('ibu_time', 'Temps ébullition (min)', 60, '1');
  const fForm = makeSelectField(
    'ibu_form',
    'Forme du houblon',
    [
      { value: 'pellets', label: 'Pellets' },
      { value: 'cones', label: 'Cônes' }
    ],
    'pellets'
  );

  const fUtilManual = makeNumberField('ibu_util_manual', 'Utilisation manuelle (%)', 30, 'any');
  const fCorrD = makeNumberField('ibu_corr_d', 'Correction D', 1, 'any');

  // Notes sous certains champs
  const noteUtil = document.createElement('div');
  noteUtil.className = 'formula-note';
  noteUtil.textContent = "L'utilisation correspond à la part d'acides alpha isomérisés/extraits (dépend du temps, densité, forme, etc.).";
  fUtilMode.wrap.appendChild(noteUtil);

  const noteTime = document.createElement('div');
  noteTime.className = 'formula-note';
  noteTime.textContent = "Auto: la table donne un taux d'extraction (0.05 → 0.34) selon le temps et cônes/pellets.";
  fTime.wrap.appendChild(noteTime);

  const noteD = document.createElement('div');
  noteD.className = 'formula-note';
  noteD.textContent = "D = facteur de correction (laisser à 1 si non utilisé dans ton cours).";
  fCorrD.wrap.appendChild(noteD);

  // Groupes “auto” vs “manuel”
  const autoFields = [fTime.wrap, fForm.wrap];
  const manualFields = [fUtilManual.wrap];

  [
    fAlpha.wrap, fHopsG.wrap, fVolume.wrap,
    fUtilMode.wrap,
    fTime.wrap, fForm.wrap,
    fUtilManual.wrap,
    fCorrD.wrap
  ].forEach(w => ibuGrid.appendChild(w));

  ibuHero.appendChild(ibuGrid);

  const ibuOut = document.createElement('div');
  ibuOut.className = 'formula-out';

  const kIbu = makeKpi('IBU (estimé)', '≈ mg/L iso-α');
  const kUtil = makeKpi('Utilisation retenue', '%');
  const kIso = makeKpi('Iso-α (estimé)', 'mg/L');
  [kIbu, kUtil, kIso].forEach(x => ibuOut.appendChild(x.kpi));
  ibuHero.appendChild(ibuOut);

  const setModeUi = () => {
    const mode = fUtilMode.sel.value;
    autoFields.forEach(w => w.style.display = (mode === 'table') ? '' : 'none');
    manualFields.forEach(w => w.style.display = (mode === 'manual') ? '' : 'none');
  };

  const calcIbu = () => {
    const alphaPct = parseFloat(fAlpha.inp.value) || 0;
    const hopG = parseFloat(fHopsG.inp.value) || 0;
    const volumeL = parseFloat(fVolume.inp.value) || 0;
    const corrD = parseFloat(fCorrD.inp.value) || 1;

    const alphaDec = Math.max(alphaPct, 0) / 100;
    const hopMg = Math.max(hopG, 0) * 1000;

    let utilDec = 0;
    if (fUtilMode.sel.value === 'manual') {
      utilDec = Math.max(parseFloat(fUtilManual.inp.value) || 0, 0) / 100;
    } else {
      const t = parseFloat(fTime.inp.value) || 0;
      const form = fForm.sel.value;
      utilDec = getUtilFromTable(t, form);
    }

    const V = Math.max(volumeL, 0.0001);
    const D = isFinite(corrD) && corrD > 0 ? corrD : 1;
    const isoMgPerL = (alphaDec * hopMg * utilDec) / V;
    const ibu = isoMgPerL * D;

    kIbu.v.textContent = `${fmt(ibu, 1)} IBU`;
    kUtil.v.textContent = `${fmt(utilDec * 100, 1)} %`;
    kIso.v.textContent = `${fmt(isoMgPerL, 1)} mg/L`;

    const warn = ibu >= 100;
    kIbu.kpi.classList.toggle('warn', warn);
    if (warn) {
      kIbu.s.textContent = 'Valeur très élevée : vérifie volume, masse, α% et utilisation.';
    } else {
      kIbu.s.textContent = 'Estimation (dépend aussi du process, pertes, adsorption…).';
    }
  };

  const inputs = [
    fAlpha.inp, fHopsG.inp, fVolume.inp, fTime.inp, fUtilManual.inp, fCorrD.inp,
    fUtilMode.sel, fForm.sel
  ].filter(Boolean);
  inputs.forEach(el => {
    el.addEventListener('input', () => { setModeUi(); calcIbu(); });
    el.addEventListener('change', () => { setModeUi(); calcIbu(); });
  });
  setModeUi();
  calcIbu();

  const ibuExplain = document.createElement('div');
  ibuExplain.className = 'formula-explain';
  ibuExplain.innerHTML = `
    <h4>Notion d'« utilisation »</h4>
    <div class="line"><strong>Utilisation</strong> = (iso-α dans la bière / α introduits) × 100</div>
    <div class="line"><strong>Influencée essentiellement par</strong> :</div>
    <div class="line">• T° et durée d'ébullition (+ design de la cuve, agitation)</div>
    <div class="line">• Densité du moût</div>
    <div class="line">• pH</div>
    <div class="line">• « importance » du houblonnage</div>
    <div class="line">• Cations (Mg++ & Ca++)</div>
    <div class="line">• Forme du houblon (cônes / pellets)</div>
  `;

  // Accordéon (prêt pour plusieurs formules plus tard)
  const accordion = document.createElement('div');
  accordion.className = 'formula-accordion';

  const panes = [];
  const closeAll = () => panes.forEach(p => p.classList.remove('is-open'));
  const createPane = (paneTitle, summaryHtml, contentNodes) => {
    const pane = document.createElement('div');
    pane.className = 'formula-pane';

    const head = document.createElement('div');
    head.className = 'formula-pane-header';
    head.setAttribute('role', 'button');
    head.setAttribute('tabindex', '0');

    const left = document.createElement('div');
    const t = document.createElement('div');
    t.className = 'formula-pane-title';
    t.textContent = paneTitle;
    const f = document.createElement('div');
    f.className = 'formula-pane-formula';
    f.innerHTML = summaryHtml;
    left.appendChild(t);
    left.appendChild(f);

    const right = document.createElement('div');
    right.className = 'formula-pane-right';
    const chev = document.createElement('div');
    chev.className = 'formula-pane-chevron';
    chev.textContent = '▼';
    right.appendChild(chev);

    head.appendChild(left);
    head.appendChild(right);

    const content = document.createElement('div');
    content.className = 'formula-pane-body';
    (contentNodes || []).forEach(n => content.appendChild(n));

    const toggle = () => {
      const willOpen = !pane.classList.contains('is-open');
      closeAll();
      if (willOpen) {
        pane.classList.add('is-open');
        requestAnimationFrame(() => {
          try { head.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch {}
        });
      }
    };

    head.addEventListener('click', toggle);
    head.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        toggle();
      }
    });

    pane.appendChild(head);
    pane.appendChild(content);
    panes.push(pane);
    return pane;
  };

  const paneIbu = createPane(
    'IBU (Tinseth) — calcul',
    'IBU = (α% × masse (mg) × utilisation) ÷ volume (L) × D',
    [ibuHero, ibuExplain]
  );

  accordion.appendChild(paneIbu);
  body.appendChild(accordion);

  card.appendChild(header);
  card.appendChild(body);
  backdrop.appendChild(card);
  document.body.appendChild(backdrop);

  fsBtn.addEventListener('click', () => toggleModalWindowFullscreen(backdrop, card, fsBtn));

  backdrop.addEventListener('click', (e) => {
    if (e.target === backdrop) backdrop.remove();
  });
}

function showLevureFormulas() {
  const existing = document.querySelector('.cat-formulas-backdrop');
  if (existing) existing.remove();

  const backdrop = document.createElement('div');
  backdrop.className = 'cat-formulas-backdrop';

  const card = document.createElement('div');
  card.className = 'cat-formulas-card';

  const header = document.createElement('div');
  header.className = 'cat-formulas-header';

  const title = document.createElement('div');
  title.className = 'cat-formulas-title';
  title.textContent = 'Formules — LEVURE (sucrage / CO₂)';

  const actions = document.createElement('div');
  actions.className = 'cat-formulas-actions';

  const fsBtn = document.createElement('button');
  fsBtn.className = 'cat-formulas-fullscreen';
  fsBtn.textContent = '🖥️ Plein écran';
  fsBtn.title = 'Mettre cette fenêtre en plein écran';

  const closeBtn = document.createElement('button');
  closeBtn.className = 'cat-formulas-close';
  closeBtn.textContent = '✖ Fermer';
  closeBtn.addEventListener('click', () => backdrop.remove());

  actions.appendChild(fsBtn);
  actions.appendChild(closeBtn);
  header.appendChild(title);
  header.appendChild(actions);

  const body = document.createElement('div');
  body.className = 'cat-formulas-body';

  const hero = document.createElement('div');
  hero.className = 'formula-hero';

  const heroTitle = document.createElement('h4');
  heroTitle.textContent = 'Calcul interactif (résultat en direct)';
  hero.appendChild(heroTitle);

  const eq = document.createElement('div');
  eq.className = 'formula-eq';
  eq.innerHTML = `Sucre (g) = ((CO₂ visé − CO₂ présent − CO₂ “limite”) × Volume (L) × 2) ÷ concentration`; 
  hero.appendChild(eq);

  const grid = document.createElement('div');
  grid.className = 'formula-grid';

  const makeField = (id, label, value) => {
    const wrap = document.createElement('div');
    wrap.className = 'formula-field';
    const lab = document.createElement('label');
    lab.setAttribute('for', id);
    lab.textContent = label;
    const inp = document.createElement('input');
    inp.id = id;
    inp.type = 'number';
    inp.step = 'any';
    inp.value = String(value);
    wrap.appendChild(lab);
    wrap.appendChild(inp);
    return { wrap, inp };
  };

  // Valeurs par défaut = l'exemple de ta capture
  const fVolume = makeField('f_volume', 'Volume (L)', 100);
  const fCo2Target = makeField('f_co2_target', 'CO₂ visé (g/L)', 8);
  const fTemp = makeField('f_temp', 'T° garde (°C) (info)', 4);
  const fCo2Present = makeField('f_co2_present', 'CO₂ présent (g/L)', 3.8);
  const fAttMeas = makeField('f_att_meas', 'Atténuation mesurée (°P)', 2.5);
  const fAttLimit = makeField('f_att_limit', 'Atténuation limite (°P)', 2.0);
  const fPlatoToSugar = makeField('f_plato_to_sugar', '1°P → sucre (g/L)', 10);
  const fResidPct = makeField('f_resid_pct', 'Facteur résidus (%)', 30);
  const fSugarToCo2 = makeField('f_sugar_to_co2', '1g sucre → CO₂ (g) (par L)', 0.5);
  const fConc = makeField('f_conc', 'Concentration (1 = sucre pur)', 1);

  [
    fVolume, fCo2Target, fTemp,
    fCo2Present, fAttMeas, fAttLimit,
    fPlatoToSugar, fResidPct, fSugarToCo2,
    fConc
  ].forEach(f => grid.appendChild(f.wrap));

  hero.appendChild(grid);

  const out = document.createElement('div');
  out.className = 'formula-out';

  const makeKpi = (key, sub) => {
    const kpi = document.createElement('div');
    kpi.className = 'formula-kpi';
    const k = document.createElement('div');
    k.className = 'k';
    k.textContent = key;
    const v = document.createElement('div');
    v.className = 'v';
    v.textContent = '—';
    const s = document.createElement('div');
    s.className = 's';
    s.textContent = sub || '';
    kpi.appendChild(k);
    kpi.appendChild(v);
    if (sub) kpi.appendChild(s);
    return { kpi, v, s };
  };

  const kSugarTotal = makeKpi('Sucre total à ajouter', 'g (pour tout le volume)');
  const kSugarPerL = makeKpi('Sucre par litre', 'g/L');
  const kCo2Limit = makeKpi('CO₂ “limite” (résidus)', 'g CO₂ / L');
  const kDeltaCo2 = makeKpi('ΔCO₂ à compenser', 'g CO₂ / L');
  const kResidSugar = makeKpi('Reste fermentescible', 'g/L (avant facteur résidus)');
  const kResidFactor = makeKpi('Résidus pris en compte', 'g/L (après facteur)');

  [kSugarTotal, kSugarPerL, kDeltaCo2, kCo2Limit, kResidSugar, kResidFactor].forEach(x => out.appendChild(x.kpi));
  hero.appendChild(out);

  const fmt = (n, digits = 2) => {
    if (!isFinite(n)) return '—';
    return Number(n).toLocaleString('fr-FR', { maximumFractionDigits: digits, minimumFractionDigits: 0 });
  };

  const calc = () => {
    const V = parseFloat(fVolume.inp.value) || 0;
    const co2Target = parseFloat(fCo2Target.inp.value) || 0;
    const co2Present = parseFloat(fCo2Present.inp.value) || 0;
    const attMeas = parseFloat(fAttMeas.inp.value) || 0;
    const attLimit = parseFloat(fAttLimit.inp.value) || 0;
    const platoToSugar = parseFloat(fPlatoToSugar.inp.value) || 0;
    const residPct = (parseFloat(fResidPct.inp.value) || 0) / 100;
    const sugarToCo2 = parseFloat(fSugarToCo2.inp.value) || 0.5;
    const concentration = parseFloat(fConc.inp.value) || 1;

    const deltaP = Math.max(attMeas - attLimit, 0);
    const residSugar = deltaP * platoToSugar; // g/L
    const residTaken = residSugar * residPct; // g/L
    const co2Limit = residTaken * sugarToCo2; // g CO2/L
    const deltaCo2 = co2Target - co2Present - co2Limit;

    const multiplier = sugarToCo2 > 0 ? (1 / sugarToCo2) : 0; // 2 si 0.5
    let sugarTotal = (deltaCo2 * V * multiplier) / (concentration || 1);
    if (!isFinite(sugarTotal) || sugarTotal < 0) sugarTotal = 0;
    const sugarPerL = V > 0 ? (sugarTotal / V) : 0;

    kSugarTotal.v.textContent = `${fmt(sugarTotal, 0)} g`;
    kSugarPerL.v.textContent = `${fmt(sugarPerL, 2)} g/L`;
    kCo2Limit.v.textContent = `${fmt(co2Limit, 2)} g/L`;
    kDeltaCo2.v.textContent = `${fmt(deltaCo2, 2)} g/L`;
    kResidSugar.v.textContent = `${fmt(residSugar, 2)} g/L`;
    kResidFactor.v.textContent = `${fmt(residTaken, 2)} g/L`;

    const warn = deltaCo2 <= 0;
    kDeltaCo2.kpi.classList.toggle('warn', warn);
    kSugarTotal.kpi.classList.toggle('warn', warn);
    if (warn) {
      kDeltaCo2.s.textContent = 'ΔCO₂ ≤ 0 : aucun sucrage nécessaire selon ces paramètres.';
    } else {
      kDeltaCo2.s.textContent = 'g CO₂ / L à produire via sucrage.';
    }
  };

  [
    fVolume.inp, fCo2Target.inp, fTemp.inp, fCo2Present.inp,
    fAttMeas.inp, fAttLimit.inp, fPlatoToSugar.inp,
    fResidPct.inp, fSugarToCo2.inp, fConc.inp
  ].forEach(inp => inp.addEventListener('input', calc));

  calc();

  const explain1 = document.createElement('div');
  explain1.className = 'formula-explain';
  explain1.innerHTML = `
    <h4>Formule de calcul générale</h4>
    <div class="line"><strong>Sucre (g)</strong> = ((CO₂ visé − CO₂ présent − CO₂ “limite”) × Volume (L) × 2) / concentration</div>
    <div class="line"><strong>×2</strong> : 1g de sucre → ~0.5g CO₂</div>
    <div class="line"><strong>CO₂ “limite”</strong> : produit par les sucres résiduels fermentescibles</div>
  `;

  const explain2 = document.createElement('div');
  explain2.className = 'formula-explain';
  explain2.innerHTML = `
    <h4>Exemple pratique - Calcul détaillé</h4>
    <div class="line"><strong>Volume</strong> : 100 L</div>
    <div class="line"><strong>CO₂ visé</strong> : 8 g/L (fort)</div>
    <div class="line"><strong>T° garde</strong> : 4°C</div>
    <div class="line"><strong>CO₂ actuel</strong> : ~3.8 g/L (table)</div>
    <div class="line"><strong>Atténuation mesurée</strong> : 2.5°P</div>
    <div class="line"><strong>Atténuation limite</strong> : 2.0°P</div>
    <div class="line"><strong>Reste fermentescible</strong> : 0.5°P = 5 g/L</div>
    <div class="line"><strong>Facteur résidus</strong> : 30% de 5g = 1.5g</div>
    <div class="line"><strong>CO₂ des résidus</strong> : 1.5g × 0.5 = 0.75 g CO₂/L</div>
    <div class="line"><strong>Calcul</strong> : ((8 − 3.8 − 0.75) × 100 × 2) / 1 = 690g</div>
    <div class="line"><strong>Résultat</strong> : ~6.9 g/L de sucre à ajouter</div>
  `;

  // --- Respiration vs Fermentation (2 équations dynamiques) ---
  const rfHero = document.createElement('div');
  rfHero.className = 'formula-hero';

  const rfTitle = document.createElement('h4');
  rfTitle.textContent = 'Levure : respiration vs fermentation (oxygène / sucres)';
  rfHero.appendChild(rfTitle);

  const rfEqResp = document.createElement('div');
  rfEqResp.className = 'formula-eq';
  rfEqResp.innerHTML = `Si <strong>présence d'oxygène</strong> (tendance respiration) : C₆H₁₂O₆ + 6O₂ → 6CO₂ + 6H₂O + énergie`;
  rfHero.appendChild(rfEqResp);

  const rfEqFerm = document.createElement('div');
  rfEqFerm.className = 'formula-eq';
  rfEqFerm.innerHTML = `Si <strong>absence d'oxygène</strong> (tendance fermentation) : C₆H₁₂O₆ → 2C₂H₅OH + 2CO₂ + énergie`;
  rfHero.appendChild(rfEqFerm);

  const rfGrid = document.createElement('div');
  rfGrid.className = 'formula-grid';

  const rfO2 = document.createElement('div');
  rfO2.className = 'formula-field';
  rfO2.innerHTML = `
    <label>Oxygène</label>
    <div style="display:flex; gap:0.6rem; flex-wrap:wrap; align-items:center;">
      <label style="display:inline-flex; gap:0.35rem; align-items:center; font-weight:900; color: var(--text);">
        <input type="radio" name="rf_o2" value="present" checked /> Présent
      </label>
      <label style="display:inline-flex; gap:0.35rem; align-items:center; font-weight:900; color: var(--text);">
        <input type="radio" name="rf_o2" value="absent" /> Absent
      </label>
    </div>
    <div class="formula-note">En brassage : on oxygène surtout au départ pour la croissance, puis la fermentation domine.</div>
  `;
  rfGrid.appendChild(rfO2);

  const rfSugarConc = document.createElement('div');
  rfSugarConc.className = 'formula-field';
  rfSugarConc.innerHTML = `
    <label for="rf_sugar_conc">Concentration en sucres (g/L)</label>
    <input id="rf_sugar_conc" type="number" step="any" value="120" />
    <div class="formula-note">NB : une forte concentration en sucres peut orienter vers la fermentation même si O₂ est présent (effet Crabtree).</div>
  `;
  rfGrid.appendChild(rfSugarConc);

  const rfGlucose = document.createElement('div');
  rfGlucose.className = 'formula-field';
  rfGlucose.innerHTML = `
    <label for="rf_glucose">Glucose (g) (pour estimer les produits)</label>
    <input id="rf_glucose" type="number" step="any" value="100" />
    <div class="formula-note">Sorties théoriques basées sur la stœchiométrie des équations.</div>
  `;
  rfGrid.appendChild(rfGlucose);

  rfHero.appendChild(rfGrid);

  const rfOut = document.createElement('div');
  rfOut.className = 'formula-out';

  const rfMode = makeKpi('Voie dominante (estimation)', 'selon O₂ + sucres');
  const rfCo2 = makeKpi('CO₂ produit (théorique)', 'g (pour la masse de glucose)');
  const rfEtOH = makeKpi('Éthanol produit (théorique)', 'g (pour la masse de glucose)');
  const rfEnergy = makeKpi('Énergie (ordre de grandeur)', 'respiration ≈ 14× fermentation');
  [rfMode, rfCo2, rfEtOH, rfEnergy].forEach(x => rfOut.appendChild(x.kpi));
  rfHero.appendChild(rfOut);

  const rfExplain = document.createElement('div');
  rfExplain.className = 'formula-explain';
  rfExplain.innerHTML = `
    <h4>Résumé</h4>
    <div class="line">• <strong>O₂ présent</strong> : la levure <strong>respire</strong> → plus d'énergie (croissance / biomasse).</div>
    <div class="line">• <strong>O₂ absent</strong> : la levure <strong>fermente</strong> → beaucoup moins rentable énergétiquement (≈ <strong>14× moins</strong>).</div>
    <div class="line">• <strong>NB</strong> : la <strong>concentration en sucres</strong> peut orienter la levure vers fermentation vs respiration.</div>
  `;

  const getRfInputs = () => {
    const o2 = (body.querySelector('input[name="rf_o2"]:checked') || {}).value || 'present';
    const sugarConc = parseFloat((body.querySelector('#rf_sugar_conc') || {}).value) || 0;
    const glucoseG = parseFloat((body.querySelector('#rf_glucose') || {}).value) || 0;
    return { o2, sugarConc, glucoseG };
  };

  const rfCalc = () => {
    const { o2, sugarConc, glucoseG } = getRfInputs();

    // Heuristique simple (lisible) :
    // - O2 absent => fermentation
    // - O2 présent + sucres très élevés => fermentation (Crabtree)
    // - sinon => respiration
    const highSugar = sugarConc >= 100; // seuil volontairement simple
    const mode = (o2 === 'absent' || highSugar) ? 'fermentation' : 'respiration';

    // Stœchiométrie (g produits / g glucose)
    const M_GLU = 180.156;
    const M_CO2 = 44.01;
    const M_ETOH = 46.07;

    const co2PerG_resp = (6 * M_CO2) / M_GLU;
    const co2PerG_ferm = (2 * M_CO2) / M_GLU;
    const etohPerG_ferm = (2 * M_ETOH) / M_GLU;

    const co2G = glucoseG * (mode === 'respiration' ? co2PerG_resp : co2PerG_ferm);
    const etohG = mode === 'respiration' ? 0 : glucoseG * etohPerG_ferm;

    rfMode.v.textContent = mode === 'respiration' ? 'Respiration' : 'Fermentation';
    rfCo2.v.textContent = `${fmt(co2G, 1)} g`;
    rfEtOH.v.textContent = `${fmt(etohG, 1)} g`;
    rfEnergy.v.textContent = mode === 'respiration' ? '≈ 14× (max)' : '≈ 1× (référence)';

    // Mise en avant visuelle des équations
    rfEqResp.classList.toggle('is-active', mode === 'respiration');
    rfEqResp.classList.toggle('is-muted', mode !== 'respiration');
    rfEqFerm.classList.toggle('is-active', mode === 'fermentation');
    rfEqFerm.classList.toggle('is-muted', mode !== 'fermentation');

    // Message d'aide
    if (o2 === 'present' && highSugar) {
      rfMode.s.textContent = 'O₂ présent mais sucres élevés : tendance fermentation (Crabtree).';
    } else if (o2 === 'present') {
      rfMode.s.textContent = 'O₂ présent + sucres modérés : tendance respiration.';
    } else {
      rfMode.s.textContent = 'O₂ absent : fermentation.';
    }
  };

  // Écouteurs
  const rfInputs = [
    ...Array.from(rfO2.querySelectorAll('input[name="rf_o2"]')),
    rfSugarConc.querySelector('#rf_sugar_conc'),
    rfGlucose.querySelector('#rf_glucose')
  ].filter(Boolean);
  rfInputs.forEach(el => el.addEventListener('input', rfCalc));
  rfInputs.forEach(el => el.addEventListener('change', rfCalc));
  rfCalc();

  // Accordéon : 2 formules au choix (clique pour ouvrir)
  const accordion = document.createElement('div');
  accordion.className = 'formula-accordion';

  const panes = [];
  const closeAll = () => panes.forEach(p => p.classList.remove('is-open'));
  const createPane = (paneTitle, summaryHtml, contentNodes) => {
    const pane = document.createElement('div');
    pane.className = 'formula-pane';

    const head = document.createElement('div');
    head.className = 'formula-pane-header';
    head.setAttribute('role', 'button');
    head.setAttribute('tabindex', '0');

    const left = document.createElement('div');
    const t = document.createElement('div');
    t.className = 'formula-pane-title';
    t.textContent = paneTitle;
    const f = document.createElement('div');
    f.className = 'formula-pane-formula';
    f.innerHTML = summaryHtml;
    left.appendChild(t);
    left.appendChild(f);

    const right = document.createElement('div');
    right.className = 'formula-pane-right';
    const chev = document.createElement('div');
    chev.className = 'formula-pane-chevron';
    chev.textContent = '▼';
    right.appendChild(chev);

    head.appendChild(left);
    head.appendChild(right);

    const content = document.createElement('div');
    content.className = 'formula-pane-body';
    (contentNodes || []).forEach(n => content.appendChild(n));

    const toggle = () => {
      const willOpen = !pane.classList.contains('is-open');
      closeAll();
      if (willOpen) {
        pane.classList.add('is-open');
        requestAnimationFrame(() => {
          try {
            head.scrollIntoView({ behavior: 'smooth', block: 'start' });
          } catch {}
        });
      }
    };

    head.addEventListener('click', toggle);
    head.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        toggle();
      }
    });

    pane.appendChild(head);
    pane.appendChild(content);
    panes.push(pane);
    return pane;
  };

  const paneSucrage = createPane(
    'Sucrage / CO₂ (référmentation) — calcul',
    'Sucre (g) = ((CO₂ visé − CO₂ présent − CO₂ “limite”) × V(L) × 2) ÷ concentration',
    [hero, explain1, explain2]
  );

  const paneRF = createPane(
    'Respiration vs fermentation — théorie',
    'Avec O₂ : C₆H₁₂O₆ + 6O₂ → 6CO₂ + 6H₂O · Sans O₂ : C₆H₁₂O₆ → 2C₂H₅OH + 2CO₂',
    [rfHero, rfExplain]
  );

  accordion.appendChild(paneSucrage);
  accordion.appendChild(paneRF);
  body.appendChild(accordion);

  card.appendChild(header);
  card.appendChild(body);
  backdrop.appendChild(card);
  document.body.appendChild(backdrop);

  fsBtn.addEventListener('click', () => toggleModalWindowFullscreen(backdrop, card, fsBtn));

  backdrop.addEventListener('click', (e) => {
    if (e.target === backdrop) backdrop.remove();
  });
}

function showCategorySummary(category) {
  const themes = getThemesByCategory(category);
  if (themes.length === 0) {
    alert(`⚠️ Aucune catégorie trouvée pour ${category}.`);
    return;
  }

  const existing = document.querySelector('.cat-summary-backdrop');
  if (existing) existing.remove();

  const backdrop = document.createElement('div');
  backdrop.className = 'cat-summary-backdrop';

  const card = document.createElement('div');
  card.className = 'cat-summary-card';

  const header = document.createElement('div');
  header.className = 'cat-summary-header';

  const title = document.createElement('div');
  title.className = 'cat-summary-title';
  title.textContent = `Resumé — ${category}`;

  const badge = document.createElement('div');
  badge.className = 'cat-summary-badge';
  badge.textContent = `${themes.length} thème(s)`;

  const actions = document.createElement('div');
  actions.className = 'cat-summary-actions';

  const exportBtn = document.createElement('button');
  exportBtn.className = 'cat-summary-export';
  exportBtn.textContent = '📦 Exporter';
  exportBtn.title = 'Exporter le resumé (synthèse + 50 questions) en page HTML';
  exportBtn.addEventListener('click', () => exportCategorySummary(category));

  const fsBtn = document.createElement('button');
  fsBtn.className = 'cat-summary-fullscreen';
  fsBtn.textContent = '🖥️ Plein écran';
  fsBtn.title = 'Mettre cette fenêtre en plein écran';

  const clearSessionBtn = document.createElement('button');
  clearSessionBtn.className = 'cat-summary-clear';
  clearSessionBtn.textContent = '🧹';
  clearSessionBtn.title = 'Effacer le quiz en cours (dans cette session)';
  clearSessionBtn.disabled = true;

  const startBtn = document.createElement('button');
  startBtn.className = 'cat-summary-start';
  startBtn.textContent = '▶ Lancer quiz (50 Q)';

  const closeBtn = document.createElement('button');
  closeBtn.className = 'cat-summary-close';
  closeBtn.textContent = '✖ Fermer';
  closeBtn.addEventListener('click', () => backdrop.remove());

  actions.appendChild(exportBtn);
  actions.appendChild(fsBtn);
  actions.appendChild(clearSessionBtn);
  actions.appendChild(startBtn);
  actions.appendChild(closeBtn);

  header.appendChild(title);
  header.appendChild(badge);
  header.appendChild(actions);

  const body = document.createElement('div');
  body.className = 'cat-summary-body';

  const note = document.createElement('div');
  note.className = 'cat-summary-note';

  const { questions: quizQuestions, uniqueCount } = buildCategorySynthesisQuiz(category, 50);
  if (uniqueCount < 50) {
    note.textContent = `Note : cette catégorie contient ${uniqueCount} question(s) unique(s). Le quiz de 50 questions réutilise certaines questions (avec options mélangées).`;
  } else {
    note.textContent = 'Synthèse complète des thèmes de la catégorie + quiz de 50 questions.';
  }
  body.appendChild(note);

  // Wrapper: contenu du résumé (sert aussi de “fiche” quand on lance le quiz dans le modal)
  const summaryWrap = document.createElement('div');
  summaryWrap.className = 'cat-summary-summaryWrap';
  summaryWrap.style.display = 'block';

  // Wrapper: vue quiz dans le modal (masqué par défaut)
  const quizWrap = document.createElement('div');
  quizWrap.className = 'cat-summary-quizWrap';
  quizWrap.style.display = 'none';

  const quizTools = document.createElement('div');
  quizTools.className = 'cat-summary-chips';
  quizTools.style.marginTop = '0.75rem';

  const backToSummaryBtn = document.createElement('button');
  backToSummaryBtn.className = 'cat-summary-chip';
  backToSummaryBtn.textContent = '↩️ Retour au résumé';

  const toggleFicheInModalBtn = document.createElement('button');
  toggleFicheInModalBtn.className = 'cat-summary-chip';
  toggleFicheInModalBtn.textContent = '👁️ Afficher la fiche';

  const toggleSearchInModalBtn = document.createElement('button');
  toggleSearchInModalBtn.className = 'cat-summary-chip';
  toggleSearchInModalBtn.textContent = '🔍 Afficher recherche';

  const revisionInModalBtn = document.createElement('button');
  revisionInModalBtn.className = 'cat-summary-chip';
  revisionInModalBtn.textContent = '📚 Révisions (ratées)';

  const resetInModalBtn = document.createElement('button');
  resetInModalBtn.className = 'cat-summary-chip';
  resetInModalBtn.textContent = '♻️ Réinitialiser quiz';

  quizTools.appendChild(backToSummaryBtn);
  quizTools.appendChild(revisionInModalBtn);
  quizTools.appendChild(toggleFicheInModalBtn);
  quizTools.appendChild(toggleSearchInModalBtn);
  quizTools.appendChild(resetInModalBtn);

  const modalSearchRow = document.createElement('div');
  modalSearchRow.style.display = 'none';
  modalSearchRow.style.marginTop = '0.6rem';
  const modalSearchWrap = document.createElement('div');
  modalSearchWrap.className = 'search-input-wrap';
  modalSearchWrap.style.width = '100%';
  const modalSearch = document.createElement('input');
  modalSearch.type = 'text';
  modalSearch.placeholder = '🔍 Rechercher dans la fiche (résumé)…';
  modalSearch.style.width = '100%';
  modalSearch.style.padding = '0.8rem';
  modalSearch.style.paddingRight = '2.6rem';
  modalSearch.style.background = 'var(--bg)';
  modalSearch.style.border = '2px solid rgba(88, 166, 255, 0.35)';
  modalSearch.style.color = 'var(--text)';
  modalSearch.style.borderRadius = '10px';

  const modalClearBtn = document.createElement('button');
  modalClearBtn.type = 'button';
  modalClearBtn.className = 'search-clear-btn';
  modalClearBtn.title = 'Effacer';
  modalClearBtn.setAttribute('aria-label', 'Effacer la recherche dans le résumé');
  modalClearBtn.textContent = '✕';

  const updateModalClear = () => {
    const has = String(modalSearch.value || '').trim().length > 0;
    modalClearBtn.classList.toggle('is-visible', has);
  };
  modalClearBtn.addEventListener('click', () => {
    if (!modalSearch.value) return;
    modalSearch.value = '';
    modalSearch.dispatchEvent(new Event('input', { bubbles: true }));
    try { modalSearch.focus(); } catch {}
  });
  modalSearch.addEventListener('input', updateModalClear);
  updateModalClear();

  modalSearchWrap.appendChild(modalSearch);
  modalSearchWrap.appendChild(modalClearBtn);
  modalSearchRow.appendChild(modalSearchWrap);

  const modalProgress = document.createElement('div');
  modalProgress.style.marginTop = '0.75rem';
  modalProgress.style.color = 'var(--muted)';
  modalProgress.style.fontWeight = '800';
  modalProgress.textContent = '';

  const modalQuizContainer = document.createElement('div');
  modalQuizContainer.className = 'course-content';
  modalQuizContainer.style.padding = '0';
  modalQuizContainer.style.marginTop = '0.75rem';

  quizWrap.appendChild(quizTools);
  quizWrap.appendChild(modalSearchRow);
  quizWrap.appendChild(modalProgress);
  quizWrap.appendChild(modalQuizContainer);

  // État du quiz embarqué (indépendant de la page principale)
  let embeddedRevision = false;
  let embeddedQuestions = [];
  let embeddedAnswers = [];

  const applyStartBtnState = () => {
    const session = getCategorySummaryQuizSession(category);
    const hasSession = !!(session && Array.isArray(session.questions) && session.questions.length);
    if (!hasSession) {
      startBtn.textContent = '▶ Lancer quiz (50 Q)';
      startBtn.title = 'Lancer le quiz dans cette fenêtre';
      startBtn.classList.remove('is-resume');
      clearSessionBtn.disabled = true;
      return;
    }
    const total = session.questions.length;
    const answered = Array.isArray(session.answers) ? session.answers.filter(a => a !== null && a !== undefined).length : 0;
    startBtn.textContent = '↩️ Reprendre quiz';
    startBtn.title = `Reprendre le quiz en cours (${answered}/${total}) dans cette fenêtre`;
    startBtn.classList.add('is-resume');
    clearSessionBtn.disabled = false;
  };

  const syncEmbeddedSession = () => {
    if (!embeddedQuestions || embeddedQuestions.length === 0) {
      clearCategorySummaryQuizSession(category);
      applyStartBtnState();
      return;
    }
    setCategorySummaryQuizSession(category, {
      embeddedRevision: !!embeddedRevision,
      questions: embeddedQuestions,
      answers: embeddedAnswers,
      updatedAt: Date.now()
    });
    applyStartBtnState();
  };

  // Si un quiz existe déjà pour cette catégorie, on le recharge (pour permettre “Reprendre quiz”)
  const existingSession = getCategorySummaryQuizSession(category);
  if (existingSession && Array.isArray(existingSession.questions) && existingSession.questions.length) {
    embeddedRevision = !!existingSession.embeddedRevision;
    embeddedQuestions = existingSession.questions.slice();
    if (Array.isArray(existingSession.answers) && existingSession.answers.length === embeddedQuestions.length) {
      embeddedAnswers = existingSession.answers.slice();
    } else {
      embeddedAnswers = new Array(embeddedQuestions.length).fill(null);
    }
  }

  applyStartBtnState();

  clearSessionBtn.addEventListener('click', () => {
    if (clearSessionBtn.disabled) return;
    if (!confirm('🧹 Effacer la session de quiz de cette catégorie (progrès du quiz dans le résumé) ?')) return;
    embeddedRevision = false;
    embeddedQuestions = [];
    embeddedAnswers = [];
    clearCategorySummaryQuizSession(category);

    quizWrap.style.display = 'none';
    summaryWrap.style.display = 'block';
    modalSearchRow.style.display = 'none';
    toggleSearchInModalBtn.textContent = '🔍 Afficher recherche';
    modalSearch.value = '';
    filterSummaryInModal();
    modalProgress.textContent = '';
    modalQuizContainer.innerHTML = '';
    applyStartBtnState();
  });

  const filterSummaryInModal = () => {
    const q = normalizeGlossaryKey(modalSearch.value);
    const blocks = Array.from(summaryWrap.querySelectorAll('.cat-summary-theme'));
    if (!q) {
      blocks.forEach(b => (b.style.display = ''));
      return;
    }
    blocks.forEach(b => {
      const txt = normalizeGlossaryKey(stripSummaryMarkup(b.textContent || ''));
      b.style.display = txt.includes(q) ? '' : 'none';
    });
  };

  modalSearch.addEventListener('input', filterSummaryInModal);

  const renderEmbeddedQuiz = () => {
    modalQuizContainer.innerHTML = '';
    if (!embeddedQuestions || embeddedQuestions.length === 0) {
      modalQuizContainer.innerHTML = "<p style='text-align:center;padding:1.25rem;color:var(--muted);'>Aucune question à afficher.</p>";
      modalProgress.textContent = '';
      syncEmbeddedSession();
      return;
    }

    const answered = embeddedAnswers.filter(a => a !== null).length;
    const correct = embeddedAnswers.filter((a, i) => a === embeddedQuestions[i].correctIndex).length;
    const labelPrefix = embeddedRevision ? `Révisions ${category} — ` : `Quiz ${category} — `;
    modalProgress.textContent = `${labelPrefix}Tentées: ${answered}/${embeddedQuestions.length} • Correctes: ${correct}`;

    // Met à jour le “visuel” du bouton Résumé + le bouton de lancement
    syncEmbeddedSession();

    embeddedQuestions.forEach((q, idx) => {
      const div = document.createElement('div');
      div.className = 'question';
      const h3 = document.createElement('h3');
      h3.textContent = `${idx + 1}. ${q.question}`;
      div.appendChild(h3);

      const optDiv = document.createElement('div');
      optDiv.className = 'options';
      (q.options || []).forEach((opt, optIdx) => {
        const btn = document.createElement('button');
        btn.className = 'option';
        btn.textContent = opt;
        if (embeddedAnswers[idx] !== null) {
          if (optIdx === q.correctIndex) btn.classList.add('correct');
          else if (optIdx === embeddedAnswers[idx]) btn.classList.add('incorrect');
        }
        btn.onclick = () => {
          if (embeddedAnswers[idx] === null) {
            embeddedAnswers[idx] = optIdx;

            // Suivre les questions ratées au niveau thème (pour révisions)
            const failureTheme = q.sourceThemeId;
            const failureIndex = (q.originalIndex !== undefined ? q.originalIndex : idx);
            if (failureTheme) {
              if (optIdx !== q.correctIndex) addFailedQuestion(failureTheme, failureIndex);
              else removeFailedQuestion(failureTheme, failureIndex);
            }

            renderEmbeddedQuiz();
          }
        };
        optDiv.appendChild(btn);
      });
      div.appendChild(optDiv);

      if (q.sourceThemeTitle) {
        const tag = document.createElement('div');
        tag.style.color = 'var(--muted)';
        tag.style.marginBottom = '0.5rem';
        tag.style.fontSize = '0.9em';
        tag.textContent = `Thème : ${q.sourceThemeTitle}`;
        div.prepend(tag);
      }

      if (embeddedAnswers[idx] !== null) {
        const exp = document.createElement('div');
        exp.className = 'explanation';
        exp.innerHTML = `✓ <strong>Explication:</strong> ${q.explanation}`;
        div.appendChild(exp);
      }

      modalQuizContainer.appendChild(div);
    });
  };

  const buildCategoryRevisionQuestionsForModal = () => {
    const th = getThemesByCategory(category);
    const failed = JSON.parse(safeGetItem('failedQuestions', '{}') || '{}');
    const aggregated = [];
    th.forEach(theme => {
      const indices = failed[theme.id] || [];
      indices.forEach(idx => {
        const base = theme.questions && theme.questions[idx];
        if (!base) return;
        const optionsWithIndex = base.options.map((opt, idOpt) => ({ opt, idOpt }));
        const shuffledOptions = shuffle(optionsWithIndex);
        const newCorrectIndex = shuffledOptions.findIndex(item => item.idOpt === base.correctIndex);
        aggregated.push({
          question: base.question,
          options: shuffledOptions.map(item => item.opt),
          correctIndex: newCorrectIndex,
          explanation: base.explanation,
          sourceThemeId: theme.id,
          sourceThemeTitle: theme.title,
          originalIndex: idx
        });
      });
    });
    return aggregated;
  };

  const enterQuizView = (questions, isRevision) => {
    embeddedRevision = !!isRevision;
    embeddedQuestions = Array.isArray(questions) ? questions.slice() : [];
    embeddedAnswers = new Array(embeddedQuestions.length).fill(null);

    // Par défaut: on cache la “fiche” (résumé) + la recherche pour se concentrer sur le quiz
    summaryWrap.style.display = 'none';
    toggleFicheInModalBtn.textContent = '👁️ Afficher la fiche';
    modalSearchRow.style.display = 'none';
    toggleSearchInModalBtn.textContent = '🔍 Afficher recherche';
    modalSearch.value = '';
    filterSummaryInModal();

    quizWrap.style.display = 'block';
    renderEmbeddedQuiz();
    try { modalQuizContainer.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch {}
  };

  const openExistingQuizView = () => {
    // Par défaut: on cache la “fiche” + la recherche (comme au lancement)
    summaryWrap.style.display = 'none';
    toggleFicheInModalBtn.textContent = '👁️ Afficher la fiche';
    modalSearchRow.style.display = 'none';
    toggleSearchInModalBtn.textContent = '🔍 Afficher recherche';
    quizWrap.style.display = 'block';
    renderEmbeddedQuiz();
    try { modalQuizContainer.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch {}
  };

  // Boutons flottants (comme ceux de la page principale)
  const modalScrollNav = document.createElement('div');
  modalScrollNav.className = 'scroll-nav cat-summary-scroll-nav';

  const modalBackToFicheBtn = document.createElement('button');
  modalBackToFicheBtn.id = 'backToFicheBtn_summaryModal';
  modalBackToFicheBtn.textContent = '⬆️ Revenir à la fiche';

  const modalBackToQuestionsBtn = document.createElement('button');
  modalBackToQuestionsBtn.id = 'backToThemesBtn_summaryModal';
  modalBackToQuestionsBtn.textContent = '⬆️ Revenir aux questions';

  modalScrollNav.appendChild(modalBackToFicheBtn);
  modalScrollNav.appendChild(modalBackToQuestionsBtn);

  const goToFicheInModal = () => {
    quizWrap.style.display = 'none';
    summaryWrap.style.display = 'block';
    applyStartBtnState();
    try { summaryWrap.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch {}
  };

  const goToQuestionsInModal = () => {
    // Si on a déjà un quiz en cours, on l’ouvre; sinon on le démarre
    if (embeddedQuestions && embeddedQuestions.length > 0) {
      openExistingQuizView();
      return;
    }
    if (!quizQuestions || quizQuestions.length === 0) {
      alert('⚠️ Aucune question disponible pour cette catégorie (quiz vide).');
      return;
    }
    enterQuizView(quizQuestions, false);
  };

  modalBackToFicheBtn.addEventListener('click', goToFicheInModal);
  modalBackToQuestionsBtn.addEventListener('click', goToQuestionsInModal);

  backToSummaryBtn.addEventListener('click', () => {
    quizWrap.style.display = 'none';
    summaryWrap.style.display = 'block';
    modalSearchRow.style.display = 'none';
    toggleSearchInModalBtn.textContent = '🔍 Afficher recherche';
    modalSearch.value = '';
    filterSummaryInModal();
    applyStartBtnState();
    try { body.scrollTop = 0; } catch {}
  });

  toggleFicheInModalBtn.addEventListener('click', () => {
    const willShow = summaryWrap.style.display === 'none';
    summaryWrap.style.display = willShow ? 'block' : 'none';
    toggleFicheInModalBtn.textContent = willShow ? '🙈 Masquer la fiche' : '👁️ Afficher la fiche';
    if (!willShow) {
      modalSearchRow.style.display = 'none';
      toggleSearchInModalBtn.textContent = '🔍 Afficher recherche';
      modalSearch.value = '';
      filterSummaryInModal();
    } else {
      try { summaryWrap.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch {}
    }
  });

  toggleSearchInModalBtn.addEventListener('click', () => {
    const canShow = summaryWrap.style.display !== 'none';
    if (!canShow) {
      summaryWrap.style.display = 'block';
      toggleFicheInModalBtn.textContent = '🙈 Masquer la fiche';
    }
    const open = modalSearchRow.style.display !== 'none';
    modalSearchRow.style.display = open ? 'none' : 'block';
    toggleSearchInModalBtn.textContent = open ? '🔍 Afficher recherche' : '🙈 Masquer recherche';
    if (open) {
      modalSearch.value = '';
      filterSummaryInModal();
    } else {
      setTimeout(() => { try { modalSearch.focus(); } catch {} }, 0);
    }
  });

  revisionInModalBtn.addEventListener('click', () => {
    const aggregated = buildCategoryRevisionQuestionsForModal();
    if (!aggregated || aggregated.length === 0) {
      alert('🎉 Aucune question ratée à réviser pour cette catégorie.');
      return;
    }
    enterQuizView(aggregated, true);
  });

  resetInModalBtn.addEventListener('click', () => {
    embeddedAnswers = new Array((embeddedQuestions || []).length).fill(null);
    renderEmbeddedQuiz();
  });

  // 1) Synthèse structurée (transversale) pour la catégorie
  const globalBlock = document.createElement('div');
  globalBlock.className = 'cat-summary-theme';
  const globalH4 = document.createElement('h4');
  globalH4.textContent = 'Synthèse structurée (catégorie)';
  globalBlock.appendChild(globalH4);

  const overview = document.createElement('div');
  overview.className = 'cat-summary-note';
  overview.style.marginTop = '0.5rem';
  overview.innerHTML = `Thèmes inclus : <strong>${themes.map(t => stripSummaryMarkup(t.title)).join(' • ')}</strong>`;
  globalBlock.appendChild(overview);

  const catBuckets = buildStructuredBucketsFromThemes(themes, { limitPerBucket: 12, includeSourceTags: true });
  globalBlock.appendChild(renderSummaryBucket('À retenir (priorité)', catBuckets['À retenir'], 'Pas de points “À retenir” détectés.'));
  globalBlock.appendChild(renderSummaryBucket('Chiffres clés', catBuckets['Chiffres clés'], 'Aucun chiffre clé détecté.'));
  globalBlock.appendChild(renderSummaryBucket('Points de vigilance', catBuckets['Points de vigilance'], 'Aucun point de vigilance détecté.'));
  globalBlock.appendChild(renderSummaryBucket('Définitions', catBuckets['Définitions'], 'Aucune définition détectée.'));
  globalBlock.appendChild(renderSummaryBucket('Méthode / process', catBuckets['Méthode / process'], 'Aucun point “méthode / process” détecté.'));
  summaryWrap.appendChild(globalBlock);

  // 2) Synthèse par thème (avec sélection de points clés + option "voir tout")
  themes.forEach(theme => {
    const themeBlock = document.createElement('div');
    themeBlock.className = 'cat-summary-theme';

    const h4 = document.createElement('h4');
    h4.textContent = theme.title;
    themeBlock.appendChild(h4);

    const themeBuckets = buildStructuredBucketsFromThemes([theme], { limitPerBucket: 8, includeSourceTags: false });
    themeBlock.appendChild(renderSummaryBucket('Points clés', themeBuckets['À retenir'], 'Aucun point clé détecté.'));
    themeBlock.appendChild(renderSummaryBucket('Chiffres clés', themeBuckets['Chiffres clés'], 'Aucun chiffre clé détecté.'));
    themeBlock.appendChild(renderSummaryBucket('Vigilance', themeBuckets['Points de vigilance'], 'Aucun point de vigilance détecté.'));
    themeBlock.appendChild(renderSummaryBucket('Définitions', themeBuckets['Définitions'], 'Aucune définition détectée.'));
    themeBlock.appendChild(renderSummaryBucket('Méthode / process', themeBuckets['Méthode / process'], 'Aucun point “méthode / process” détecté.'));

    const allWrap = document.createElement('div');
    allWrap.style.display = 'none';
    allWrap.style.marginTop = '0.5rem';

    (theme.ficheRich || []).forEach(sec => {
      const secDiv = document.createElement('div');
      secDiv.className = 'cat-summary-section';
      const h5 = document.createElement('h5');
      h5.textContent = `Tout — ${sec.title}`;
      secDiv.appendChild(h5);
      const ul = document.createElement('ul');
      (sec.items || []).forEach(item => {
        const li = document.createElement('li');
        li.innerHTML = '• ' + emphasizeSummaryItem(item);
        ul.appendChild(li);
      });
      secDiv.appendChild(ul);
      allWrap.appendChild(secDiv);
    });

    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'cat-summary-toggle';
    toggleBtn.textContent = 'Afficher tout le contenu du thème';
    toggleBtn.addEventListener('click', () => {
      const open = allWrap.style.display !== 'none';
      allWrap.style.display = open ? 'none' : 'block';
      toggleBtn.textContent = open ? 'Afficher tout le contenu du thème' : 'Masquer le contenu complet';
    });

    themeBlock.appendChild(toggleBtn);
    themeBlock.appendChild(allWrap);

    summaryWrap.appendChild(themeBlock);
  });

  body.appendChild(summaryWrap);
  body.appendChild(quizWrap);

  startBtn.addEventListener('click', () => {
    // Si un quiz est déjà en cours (dans cette session mémoire), on le reprend
    if (embeddedQuestions && embeddedQuestions.length > 0) {
      openExistingQuizView();
      return;
    }
    if (!quizQuestions || quizQuestions.length === 0) {
      alert('⚠️ Aucune question disponible pour cette catégorie (quiz vide).');
      return;
    }
    // Sinon, on démarre un nouveau quiz DANS le modal
    enterQuizView(quizQuestions, false);
  });

  card.appendChild(header);
  card.appendChild(body);
  card.appendChild(modalScrollNav);
  backdrop.appendChild(card);
  document.body.appendChild(backdrop);

  fsBtn.addEventListener('click', () => toggleModalWindowFullscreen(backdrop, card, fsBtn));

  backdrop.addEventListener('click', (e) => {
    if (e.target === backdrop) backdrop.remove();
  });
}

function startCategoryRevision(category) {
  const themes = getThemesByCategory(category);
  if (themes.length === 0) {
    alert(`⚠️ Aucune catégorie trouvée pour ${category}.`);
    return;
  }

  const failed = JSON.parse(safeGetItem('failedQuestions', '{}') || '{}');
  const aggregated = [];

  themes.forEach(theme => {
    const indices = failed[theme.id] || [];
    indices.forEach(idx => {
      const base = theme.questions[idx];
      if (!base) return;
      const optionsWithIndex = base.options.map((opt, idOpt) => ({ opt, idOpt }));
      const shuffledOptions = shuffle(optionsWithIndex);
      const newCorrectIndex = shuffledOptions.findIndex(item => item.idOpt === base.correctIndex);
      aggregated.push({
        question: base.question,
        options: shuffledOptions.map(item => item.opt),
        correctIndex: newCorrectIndex,
        explanation: base.explanation,
        sourceThemeId: theme.id,
        sourceThemeTitle: theme.title,
        originalIndex: idx
      });
    });
  });

  if (aggregated.length === 0) {
    alert('🎉 Aucune question ratée à réviser pour cette catégorie.');
    return;
  }

  globalRevisionActive = true;
  revisionModeActive = false;
  if (revisionBtn) {
    revisionBtn.style.background = '#a78bfa';
    revisionBtn.textContent = '🔄 Mode révision';
  }

  currentTheme = { id: `__cat_revision__${category}__`, title: `Révisions ${category}`, category };
  currentQuestions = aggregated;
  answers = new Array(aggregated.length).fill(null);
  renderQuiz();
  if (quizContainer && quizContainer.scrollIntoView) {
    quizContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

function showCategoryStats(category) {
  const themes = getThemesByCategory(category);
  if (themes.length === 0) {
    alert(`⚠️ Aucune catégorie trouvée pour ${category}.`);
    return;
  }

  const themeIds = themes.map(t => t.id);
  const started = themeIds.filter(id => getThemeStatus(id) === 'started').length;
  const completed = themeIds.filter(id => getThemeStatus(id) === 'completed').length;
  const notStarted = themeIds.length - started - completed;

  const themeStats = JSON.parse(safeGetItem('themeStats', '{}') || '{}');
  const failedQuestions = JSON.parse(safeGetItem('failedQuestions', '{}') || '{}');

  let answered = 0;
  let correct = 0;
  let failedCount = 0;

  themeIds.forEach(id => {
    const st = themeStats[id];
    if (st && st.answered !== undefined && st.correct !== undefined) {
      answered += st.answered;
      correct += st.correct;
    }
    if (Array.isArray(failedQuestions[id])) {
      failedCount += failedQuestions[id].length;
    }
  });

  const successRate = answered > 0 ? Math.round((correct / answered) * 100) : 0;
  renderCategoryStatsModal(category, {
    themesCount: themeIds.length,
    started,
    completed,
    notStarted,
    answered,
    correct,
    successRate,
    failedCount,
    themeTitles: themes.map(t => t.title)
  });
}

function exportCategoryThemes(category) {
  const themes = getThemesByCategory(category);
  if (themes.length === 0) {
    alert(`⚠️ Aucune catégorie trouvée pour ${category}.`);
    return;
  }
  if (!confirm(`📦 Exporter ${themes.length} thème(s) de la catégorie ${category} ?`)) {
    return;
  }

  let exportedCount = 0;
  const safeCategory = category.replace(/\s+/g, '_');
  themes.forEach((theme, index) => {
    setTimeout(() => {
      try {
        const html = generateThemeHtmlDocument(theme);
        const filename = `Cat_${safeCategory}_${String(index + 1).padStart(2, '0')}_${theme.id}.html`;
        downloadHtmlFile(html, filename);
        exportedCount++;
        if (exportedCount === themes.length) {
          setTimeout(() => {
            alert(`✅ Export catégorie ${category} terminé !\n\n${themes.length} page(s) HTML téléchargée(s).`);
          }, 400);
        }
      } catch(e) {
        console.error('Erreur export catégorie', e);
        alert(`❌ Erreur lors de l'export: ${e.message}`);
      }
    }, index * 120);
  });
}

function renderCategoryStatsModal(category, data) {
  const existing = document.querySelector('.cat-stats-backdrop');
  if (existing) existing.remove();

  const backdrop = document.createElement('div');
  backdrop.className = 'cat-stats-backdrop';

  const card = document.createElement('div');
  card.className = 'cat-stats-card';

  const header = document.createElement('div');
  header.className = 'cat-stats-header';

  const title = document.createElement('div');
  title.className = 'cat-stats-title';
  title.textContent = `Statistiques — ${category}`;

  const badge = document.createElement('div');
  badge.className = 'cat-stats-badge';
  badge.textContent = `${data.themesCount} thème(s)`;

  header.appendChild(title);
  header.appendChild(badge);

  const grid = document.createElement('div');
  grid.className = 'cat-stats-grid';

  const cards = [
    { label: 'Terminés', value: data.completed, sub: 'Succès', color: '#3fb950' },
    { label: 'Commencés', value: data.started, sub: 'En cours', color: '#f59e0b' },
    { label: 'Non démarrés', value: data.notStarted, sub: 'À lancer', color: '#6e7681' },
    { label: 'Réponses', value: data.answered, sub: `${data.correct} correctes`, color: '#58a6ff' },
    { label: 'Taux de réussite', value: data.successRate + '%', sub: `${data.correct}/${data.answered || 1}`, color: '#8b5cf6' },
    { label: 'Questions ratées', value: data.failedCount, sub: 'À réviser', color: '#ef4444' }
  ];

  cards.forEach(c => {
    const item = document.createElement('div');
    item.className = 'cat-stat-card';
    const lab = document.createElement('div');
    lab.className = 'cat-stat-label';
    lab.textContent = c.label;
    const val = document.createElement('div');
    val.className = 'cat-stat-value';
    val.textContent = c.value;
    const sub = document.createElement('div');
    sub.className = 'cat-stat-sub';
    sub.textContent = c.sub;

    const bar = document.createElement('div');
    bar.className = 'cat-bar';
    const fill = document.createElement('div');
    fill.className = 'cat-bar-fill';
    let pct = 0;
    if (c.label === 'Taux de réussite') {
      pct = data.successRate;
    } else if (c.label === 'Terminés') {
      pct = data.themesCount ? Math.round((data.completed / data.themesCount) * 100) : 0;
    } else if (c.label === 'Commencés') {
      pct = data.themesCount ? Math.round((data.started / data.themesCount) * 100) : 0;
    }
    fill.style.width = Math.min(100, Math.max(0, pct)) + '%';
    fill.style.background = c.color;
    bar.appendChild(fill);

    item.appendChild(lab);
    item.appendChild(val);
    item.appendChild(sub);
    item.appendChild(bar);
    grid.appendChild(item);
  });

  const list = document.createElement('div');
  list.className = 'cat-theme-list';
  list.innerHTML = data.themeTitles.map(t => `<div>• ${t}</div>`).join('');

  const footer = document.createElement('div');
  footer.className = 'cat-stats-footer';

  const closeBtn = document.createElement('button');
  closeBtn.className = 'cat-close-btn';
  closeBtn.textContent = 'Fermer';
  closeBtn.addEventListener('click', () => backdrop.remove());

  footer.appendChild(closeBtn);

  card.appendChild(header);
  card.appendChild(grid);
  card.appendChild(list);
  card.appendChild(footer);

  backdrop.appendChild(card);

  backdrop.addEventListener('click', (e) => {
    if (e.target === backdrop) backdrop.remove();
  });

  document.addEventListener('keydown', function escHandler(ev) {
    if (ev.key === 'Escape') {
      backdrop.remove();
      document.removeEventListener('keydown', escHandler);
    }
  });

  document.body.appendChild(backdrop);
}

function resetThemeQuiz(themeId) {
  // Réinitialiser le statut du thème
  delete themeProgress[themeId];
  saveProgress();
  
  // Supprimer les stats du thème
  const themeStats = JSON.parse(safeGetItem('themeStats', '{}') || '{}');
  delete themeStats[themeId];
  safeSetItem('themeStats', JSON.stringify(themeStats));
  
  // Supprimer les questions ratées du thème
  const failed = JSON.parse(safeGetItem('failedQuestions', '{}') || '{}');
  delete failed[themeId];
  safeSetItem('failedQuestions', JSON.stringify(failed));
  
  updateThemeButtons();
  updateStats();
  
  // Si c'est le thème actuel, réinitialiser aussi les questions
  if (currentTheme && currentTheme.id === themeId) {
    currentQuestions = [];
    answers = [];
    progressEl.textContent = "—";
    renderQuiz();
  }
}

// Group themes by category with fixed category order
const themesByCategory = {};
THEMES_ORDERED.forEach(t => {
  if (!themesByCategory[t.category]) themesByCategory[t.category] = [];
  themesByCategory[t.category].push(t);
});

const categoryOrder = ["MALT", "HOUBLON", "ÉPICES", "CIP", "LEVURE", "GÉNÉRAL"];

// Renumérotation finale par catégorie (ordre fixe) pour garantir des blocs consécutifs
const finalOrdered = [];
categoryOrder.forEach(cat => {
  (themesByCategory[cat] || []).forEach(t => finalOrdered.push(t));
});

finalOrdered.forEach((t, idx) => {
  const cleanTitle = (t.title || '').replace(/^\s*\d+\.\s*/, '').trim();
  t.title = `${idx + 1}. ${cleanTitle}`;
});

// Render navigation grouped by category
categoryOrder.forEach(category => {
  const themes = themesByCategory[category] || [];
  
  const catDiv = document.createElement("div");
  catDiv.className = "category-group";

  const catHeader = document.createElement("div");
  catHeader.className = "category-header";

  const catTitle = document.createElement("h3");
  catTitle.className = "category-title";
  catTitle.textContent = category;
  catHeader.appendChild(catTitle);

  const catActions = document.createElement("div");
  catActions.className = "category-actions";

  const revBtn = document.createElement("button");
  revBtn.className = "category-action-btn rev";
  revBtn.textContent = "🔄 Révisions";
  revBtn.title = "Relancer les questions ratées de cette catégorie";
  revBtn.addEventListener('click', () => startCategoryRevision(category));

  const statBtn = document.createElement("button");
  statBtn.className = "category-action-btn stats";
  statBtn.textContent = "📊 Statistiques";
  statBtn.title = "Voir les stats de cette catégorie";
  statBtn.addEventListener('click', () => showCategoryStats(category));

  const exportBtn = document.createElement("button");
  exportBtn.className = "category-action-btn export";
  exportBtn.textContent = "📦 Exporter";
  exportBtn.title = "Exporter tous les thèmes de cette catégorie";
  exportBtn.addEventListener('click', () => exportCategoryThemes(category));

  // Bouton Formules uniquement pour la catégorie LEVURE (à gauche du bouton Révisions)
  if (category === 'LEVURE') {
    const formulasBtn = document.createElement('button');
    formulasBtn.className = 'category-action-btn formulas';
    formulasBtn.textContent = '🧪 Formules';
    formulasBtn.title = 'Outils de calcul (sucrage / CO₂)';
    formulasBtn.addEventListener('click', () => showLevureFormulas());
    catActions.appendChild(formulasBtn);
  }

  // Bouton Formules pour la catégorie HOUBLON (IBU)
  if (category === 'HOUBLON') {
    const formulasBtn = document.createElement('button');
    formulasBtn.className = 'category-action-btn formulas';
    formulasBtn.textContent = '🧪 Formules';
    formulasBtn.title = 'Outils de calcul (IBU / Tinseth)';
    formulasBtn.addEventListener('click', () => showHoublonFormulas());
    catActions.appendChild(formulasBtn);
  }

  catActions.appendChild(revBtn);
  const summaryBtn = document.createElement("button");
  summaryBtn.className = "category-action-btn summary";
  summaryBtn.textContent = "🧾 Resumé";
  summaryBtn.title = "Voir un resumé complet des thèmes + lancer un quiz de 50 questions";
  summaryBtn.dataset.category = category;
  summaryBtn.addEventListener('click', () => showCategorySummary(category));
  catActions.appendChild(summaryBtn);
  updateCategorySummaryButtonVisual(category);
  catActions.appendChild(statBtn);
  catActions.appendChild(exportBtn);

  catHeader.appendChild(catActions);
  catDiv.appendChild(catHeader);

  const catThemes = document.createElement("div");
  catThemes.className = "category-themes";
  catDiv.appendChild(catThemes);
  
  if (themes.length === 0) {
    const emptyMsg = document.createElement("p");
    emptyMsg.style.color = "var(--muted)";
    emptyMsg.style.fontStyle = "italic";
    emptyMsg.style.padding = "0.5rem";
    emptyMsg.textContent = "Aucun thème pour l'instant";
    catThemes.appendChild(emptyMsg);
    nav.appendChild(catDiv);
    return;
  }
  
  themes.forEach((t, idx) => {
    const btn = document.createElement("button");
    btn.className = "theme-btn";
    btn.textContent = t.title;
    btn.setAttribute('data-theme-id', t.id);
    btn.onclick = () => selectTheme(t, btn);
    catThemes.appendChild(btn);
    
    if (THEMES_VIEW.indexOf(t) === 0 && !currentTheme) {
      currentTheme = t;
      btn.classList.add("active");
      renderFiche(t);
    }
  });
  nav.appendChild(catDiv);
});

// Appliquer les indicateurs de progression
updateThemeButtons();
toggleScrollNav(true);

function selectTheme(theme, btn) {
  currentTheme = theme;
  currentQuestions = [];
  answers = [];
  document.querySelectorAll(".theme-btn").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  // Vérification et affichage forcé pour le thème 8
  if (theme.id === "houblonIBU") {
    // Recharge la fiche enrichie à partir du tableau THEMES
    const theme8 = THEMES_VIEW.find(t => t.id === "houblonIBU");
    if (theme8 && theme8.ficheRich) {
      renderFiche(theme8);
    } else {
      renderFiche(theme);
    }
  } else {
    renderFiche(theme);
  }
  quizContainer.innerHTML = "";
  progressEl.textContent = "—";
  toggleScrollNav(true);
  // Amener la fiche en vue lors du clic sur un thème
  if (ficheEl && ficheEl.scrollIntoView) {
    ficheEl.scrollIntoView({ behavior: "smooth", block: "start" });
  }
  // Réinitialiser la recherche dans le thème
  themeSearchBar.value = '';
  themeSearchResultsDiv.style.display = 'none';
  themeSearchResultsContent.innerHTML = '';
}

function shuffle(arr) {
  const copy = arr.slice();
  for (let i = copy.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [copy[i], copy[j]] = [copy[j], copy[i]];
  }
  return copy;
}

function pickExactCount(base, n) {
  return shuffle(base).slice(0, Math.min(n, base.length));
}

function renderFiche(theme) {
  ficheTitle.textContent = theme.title;
  ficheContent.innerHTML = "";
  if (theme.ficheRich) {
    theme.ficheRich.forEach(sec => {
      const div = document.createElement("div");
      div.className = "section";
      const h3 = document.createElement("h3");
      h3.textContent = sec.title;
      div.appendChild(h3);
      const ul = document.createElement("ul");
      sec.items.forEach(item => {
        const li = document.createElement("li");
        li.innerHTML = item.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
        ul.appendChild(li);
      });
      div.appendChild(ul);
      ficheContent.appendChild(div);
    });
  }
}

function renderQuiz() {
  quizContainer.innerHTML = "";
  if (currentQuestions.length === 0) {
    quizContainer.innerHTML = "<p style='text-align:center;padding:2rem;'>Sélectionnez un thème et cliquez Démarrer.</p>";
    toggleScrollNav(true);
    return;
  }
  toggleScrollNav(true);

  let answered = answers.filter(a => a !== null).length;
  let correct = answers.filter((a, i) => a === currentQuestions[i].correctIndex).length;
  const labelPrefix = globalRevisionActive ? `${currentTheme && currentTheme.title ? currentTheme.title + ' — ' : 'Révisions totales — '}` : '';
  progressEl.textContent = `${labelPrefix}Tentées: ${answered}/${currentQuestions.length} • Correctes: ${correct}`;
  
  // Sauvegarder les statistiques du thème actuel
  if (!globalRevisionActive && currentTheme) {
    const themeStats = JSON.parse(safeGetItem('themeStats', '{}') || '{}');
    if (!themeStats[currentTheme.id]) {
      themeStats[currentTheme.id] = {};
    }
    themeStats[currentTheme.id].answered = answered;
    themeStats[currentTheme.id].correct = correct;
    safeSetItem('themeStats', JSON.stringify(themeStats));
  }
  
  // Marquer comme terminé si toutes les questions sont correctes
  if (!globalRevisionActive && currentTheme) {
    if (answered === currentQuestions.length && correct === currentQuestions.length) {
      updateThemeStatus(currentTheme.id, 'completed');
      updateThemeButtons();
      updateStats();
    } else if (answered > 0) {
      // Marquer comme démarré si au moins une question répondue
      if (getThemeStatus(currentTheme.id) === 'not-started') {
        updateThemeStatus(currentTheme.id, 'started');
        updateThemeButtons();
      }
      updateStats();
    }
  }

  currentQuestions.forEach((q, idx) => {
    const div = document.createElement("div");
    div.className = "question";
    const h3 = document.createElement("h3");
    h3.textContent = `${idx + 1}. ${q.question}`;
    div.appendChild(h3);

    const optDiv = document.createElement("div");
    optDiv.className = "options";
    q.options.forEach((opt, optIdx) => {
      const btn = document.createElement("button");
      btn.className = "option";
      btn.textContent = opt;
      if (answers[idx] !== null) {
        if (optIdx === q.correctIndex) btn.classList.add("correct");
        else if (optIdx === answers[idx]) btn.classList.add("incorrect");
      }
      btn.onclick = () => {
        if (answers[idx] === null) {
          answers[idx] = optIdx;
          
          // Suivre les questions ratées
          const failureTheme = q.sourceThemeId || (currentTheme && currentTheme.id);
          const failureIndex = (q.originalIndex !== undefined ? q.originalIndex : idx);
          if (failureTheme) {
            if (optIdx !== q.correctIndex) {
              addFailedQuestion(failureTheme, failureIndex);
            } else {
              removeFailedQuestion(failureTheme, failureIndex);
            }
          }
          
          renderQuiz();
        }
      };
      optDiv.appendChild(btn);
    });
    div.appendChild(optDiv);

    if (q.sourceThemeTitle) {
      const tag = document.createElement('div');
      tag.style.color = 'var(--muted)';
      tag.style.marginBottom = '0.5rem';
      tag.style.fontSize = '0.9em';
      tag.textContent = `Thème : ${q.sourceThemeTitle}`;
      div.prepend(tag);
    }

    if (answers[idx] !== null) {
      const exp = document.createElement("div");
      exp.className = "explanation";
      exp.innerHTML = `✓ <strong>Explication:</strong> ${q.explanation}`;
      div.appendChild(exp);
    }

    quizContainer.appendChild(div);
  });
}

// ===================== NOUVELLES FONCTIONNALITÉS =====================

// Barre de recherche
const searchBar = document.getElementById('searchBar');
const searchResultsDiv = document.getElementById('searchResults');
const searchResultsContent = document.getElementById('searchResultsContent');
searchBar.addEventListener('input', filterThemes);

const clearSearchBarBtn = document.getElementById('clearSearchBar');
if (searchBar && clearSearchBarBtn) {
  const update = () => {
    const has = String(searchBar.value || '').trim().length > 0;
    clearSearchBarBtn.classList.toggle('is-visible', has);
  };
  clearSearchBarBtn.addEventListener('click', () => {
    if (!searchBar.value) return;
    searchBar.value = '';
    searchBar.dispatchEvent(new Event('input', { bubbles: true }));
    try { searchBar.focus(); } catch {}
  });
  searchBar.addEventListener('input', update);
  update();
}

// Mode recherche (n'afficher que la recherche + résultats)
const SEARCH_ONLY_MODE_KEY = 'ui.searchOnlyMode.v1';
const searchModeToggleBtn = document.getElementById('searchModeToggle');

function setSearchOnlyMode(enabled) {
  const on = !!enabled;
  document.body.classList.toggle('search-only-mode', on);
  try { localStorage.setItem(SEARCH_ONLY_MODE_KEY, on ? '1' : '0'); } catch {}
  if (searchModeToggleBtn) {
    searchModeToggleBtn.textContent = on ? '↩️ Quitter recherche' : '🔎 Mode recherche';
    searchModeToggleBtn.title = on ? 'Revenir à l’affichage normal (Échap)' : 'Afficher uniquement la recherche (Échap pour quitter)';
  }
  if (on) {
    try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch {}
    try { searchBar.focus(); } catch {}
  }
}

if (searchModeToggleBtn) {
  searchModeToggleBtn.addEventListener('click', () => {
    const on = document.body.classList.contains('search-only-mode');
    setSearchOnlyMode(!on);
  });
}

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && document.body.classList.contains('search-only-mode')) {
    setSearchOnlyMode(false);
  }
});

// Restaurer l’état au chargement
try {
  const saved = localStorage.getItem(SEARCH_ONLY_MODE_KEY);
  if (saved === '1') setSearchOnlyMode(true);
} catch {}

const glossaryBtn = document.getElementById('glossaryBtn');
if (glossaryBtn) glossaryBtn.addEventListener('click', () => openGlossaryModal());

function escapeRegExp(s) {
  return String(s || '').replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function highlightText(text, searchTerm) {
  const safe = escapeRegExp(searchTerm);
  if (!safe) return text;
  const regex = new RegExp(`(${safe})`, 'gi');
  return text.replace(regex, '<mark style="background: #ffd700; color: #000; padding: 0 3px; border-radius: 2px; font-weight: bold;">$1</mark>');
}

function toShortClearDefinition(defText, maxLen = 180) {
  let t = stripSummaryMarkup(defText);
  t = t.replace(/^\s*(?:\-\s*)?/, '').trim();
  if (!t) return '';

  // Garder 1 phrase/clause max pour un rendu “court et clair”
  const cut = t.split(/(?<=[\.!?])\s+|\s*;\s*|\s+—\s+|\s+–\s+|\s+\|\s+|\s+\u2022\s+/).filter(Boolean);
  if (cut.length) t = cut[0].trim();

  if (t.length > maxLen) {
    t = t.slice(0, maxLen);
    t = t.replace(/\s+\S*$/, '').trim();
    t += '…';
  }
  return t;
}

// ===================== GLOSSAIRE PERSONNALISÉ (localStorage) =====================
const CUSTOM_GLOSSARY_STORAGE_KEY = 'customGlossaryEntries.v1';

function loadCustomGlossaryEntries() {
  try {
    const raw = localStorage.getItem(CUSTOM_GLOSSARY_STORAGE_KEY);
    if (!raw) return [];
    const arr = JSON.parse(raw);
    if (!Array.isArray(arr)) return [];
    return arr
      .map(e => {
        const term = String(e && e.term || '').trim();
        const def = String(e && e.def || '').trim();
        const keys = Array.isArray(e && e.keys) ? e.keys.map(k => normalizeGlossaryKey(k)).filter(Boolean) : [];
        if (!term || !def) return null;
        const key = normalizeGlossaryKey(term);
        if (!key) return null;
        const allKeys = Array.from(new Set([key, ...keys])).filter(Boolean);
        return { term, def, key, keys: allKeys };
      })
      .filter(Boolean);
  } catch {
    return [];
  }
}

function saveCustomGlossaryEntries(entries) {
  try {
    const clean = (entries || [])
      .map(e => ({
        term: String(e && e.term || '').trim(),
        def: String(e && e.def || '').trim(),
        keys: Array.isArray(e && e.keys) ? e.keys.map(k => String(k)).filter(Boolean) : []
      }))
      .filter(e => e.term && e.def);
    localStorage.setItem(CUSTOM_GLOSSARY_STORAGE_KEY, JSON.stringify(clean));
  } catch {}
}

function upsertCustomGlossaryEntry({ term, def, keys }) {
  const t = String(term || '').trim();
  const d = String(def || '').trim();
  if (!t || !d) return { ok: false, reason: 'Termes ou définition manquants.' };
  const key = normalizeGlossaryKey(t);
  if (!key) return { ok: false, reason: 'Terme invalide.' };

  const extraKeys = Array.isArray(keys) ? keys.map(k => normalizeGlossaryKey(k)).filter(Boolean) : [];
  const allKeys = Array.from(new Set([key, ...extraKeys])).filter(Boolean);

  const current = loadCustomGlossaryEntries();
  const map = new Map(current.map(e => [e.key, e]));
  map.set(key, { term: t, def: d, key, keys: allKeys });
  saveCustomGlossaryEntries(Array.from(map.values()));
  return { ok: true, key };
}

function removeCustomGlossaryEntryByKey(key) {
  const k = normalizeGlossaryKey(key);
  if (!k) return false;
  const current = loadCustomGlossaryEntries();
  const next = current.filter(e => e.key !== k);
  saveCustomGlossaryEntries(next);
  return next.length !== current.length;
}

function getGlossaryKeySet(indexEntries) {
  const set = new Set();
  (indexEntries || []).forEach(e => {
    if (!e) return;
    const k = normalizeGlossaryKey(e.key || e.term);
    if (k) set.add(k);
    const keys = Array.isArray(e.keys) ? e.keys : [];
    keys.forEach(x => {
      const nk = normalizeGlossaryKey(x);
      if (nk) set.add(nk);
    });
  });
  return set;
}

function detectMissingGlossaryTermsFromThemes(themes, glossaryKeySet, options = {}) {
  const maxItems = options.maxItems ?? 120;
  const minCount = options.minCount ?? 2;
  const aggressive = options.aggressive ?? false;

  const stop = new Set([
    'le','la','les','un','une','des','du','de','d','au','aux','en','dans','sur','sous','avec','sans','pour','par','vers','chez',
    'et','ou','mais','donc','or','ni','car','que','qui','quoi','dont','où','si','alors','ainsi',
    'est','sont','été','etre','être','fait','faire','doit','peut','peuvent','permet','permettent','donne','donner',
    'plus','moins','très','tres','souvent','parfois','toujours','jamais','afin','comme','ex','exemple','exemples',
    'attention','vigilance','risque','important','critique','conséquence','consequences','impact','méthode','process','procédure','procedure',
    'calcul','formule','résumé','resume','objectif','principe','note','remarque','valeur','valeurs'
  ]);

  const isStop = (s) => stop.has(normalizeGlossaryKey(s));
  const cleanToken = (s) => String(s || '').replace(/^[^A-Za-zÀ-ÿ0-9]+|[^A-Za-zÀ-ÿ0-9]+$/g, '').trim();

  const looksTechnical = (tok) => {
    const t = String(tok || '');
    if (!t) return false;
    if (/^[0-9]+$/.test(t)) return false;
    if (t.length < 3) return false;
    if (isStop(t)) return false;
    if (/^[A-ZÉÈÀÙÂÊÎÔÛÄËÏÖÜÇ]{2,8}$/.test(t)) return true; // acronymes
    if (/[0-9]/.test(t)) return true;
    if (/[\/:]/.test(t)) return true;
    if (/-/.test(t)) return true;
    if (/[°%₂²³]/.test(t)) return true;
    // plus agressif: capter des termes métier courts (ex: gushing, trub, whirlpool, CIP déjà capté)
    if (t.length >= (aggressive ? 6 : 8)) return true;
    // suffixes “scientifiques/métier” (aide à repérer des mots sans symboles)
    if (aggressive && /(tion|age|ment|ique|isme|logie|phage|ase|ose|one|ol|ite|ate|ide)$/i.test(t)) return true;
    return false;
  };

  const add = (map, rawTerm, rawText) => {
    const term = cleanToken(rawTerm);
    if (!term) return;
    const key = normalizeGlossaryKey(term);
    if (!key || key.length < 3) return;
    if (glossaryKeySet && glossaryKeySet.has(key)) return;
    if (isStop(term)) return;

    // filtrage minimal: on garde surtout ce qui “sonne technique”
    if (!looksTechnical(term)) return;

    const prev = map.get(key);
    if (!prev) {
      map.set(key, {
        key,
        term,
        count: 1,
        snippet: String(rawText || '').slice(0, 220).trim()
      });
    } else {
      prev.count += 1;
    }
  };

  const tokenRegex = /[A-Za-zÀ-ÿ0-9][A-Za-zÀ-ÿ0-9'’\-\/:%°₂²³]{2,}/g;

  const map = new Map();

  for (const theme of (themes || [])) {
    const items = collectThemeFicheItems(theme);
    for (const it of (items || [])) {
      const raw = stripSummaryMarkup(it && it.item);
      if (!raw) continue;
      const tokens = raw.match(tokenRegex) || [];
      tokens.forEach(tok => add(map, tok, raw));

      // bigrams simples (dry hop, hop creep, acides alpha, etc.)
      for (let i = 0; i < tokens.length - 1; i++) {
        const a = cleanToken(tokens[i]);
        const b = cleanToken(tokens[i + 1]);
        if (!a || !b) continue;
        if (isStop(a) || isStop(b)) continue;
        const phrase = `${a} ${b}`;
        const phraseKey = normalizeGlossaryKey(phrase);
        if (!phraseKey || phraseKey.length < 5) continue;
        if (glossaryKeySet && glossaryKeySet.has(phraseKey)) continue;
        if (looksTechnical(a) || looksTechnical(b) || (a.length >= 5 && b.length >= 5)) {
          add(map, phrase, raw);
        }
      }
    }

    // explications des questions
    if (theme && theme.questions) {
      for (const q of theme.questions) {
        const raw = stripSummaryMarkup(q && q.explanation);
        if (!raw) continue;
        const tokens = raw.match(tokenRegex) || [];
        tokens.forEach(tok => add(map, tok, raw));
      }
    }
  }

  const out = Array.from(map.values())
    .filter(e => (e.count || 0) >= minCount)
    .map(e => {
      let score = (e.count || 0);
      if (/^[A-ZÉÈÀÙÂÊÎÔÛÄËÏÖÜÇ]{2,8}$/.test(e.term)) score += 8;
      if (/[0-9°%₂²³]/.test(e.term)) score += 5;
      if (/[\/:\-]/.test(e.term)) score += 3;
      if (e.term.length >= 10) score += 2;
      return { ...e, score };
    })
    .sort((a, b) => (b.score - a.score) || (b.count - a.count) || String(a.term).localeCompare(String(b.term), 'fr'))
    .slice(0, maxItems);

  return out;
}

// Index “termes techniques potentiels” (mode agressif toujours activé)
var GLOBAL_TECH_TERMS_INDEX = [];
function buildGlobalTechTermsIndex() {
  const keySet = getGlossaryKeySet(GLOBAL_GLOSSARY_INDEX);
  return detectMissingGlossaryTermsFromThemes((THEMES_VIEW || []).slice(), keySet, {
    aggressive: true,
    minCount: 1,
    maxItems: 800
  });
}

function buildGlobalGlossaryIndex() {
  const map = new Map();

  const isShortAcronym = (term) => /^[A-ZÉÈÀÙÂÊÎÔÛÄËÏÖÜÇ0-9]{2,8}$/.test(String(term || '').trim());
  const scoreCandidate = (term, def) => {
    const d = String(def || '');
    const len = d.length;
    let score = 0;
    if (isShortAcronym(term)) score += 3;
    if (len >= 20 && len <= 220) score += 3;
    if (len >= 10 && len < 20) score += 1;
    if (/[\(\)]/.test(d)) score += 1;
    if (/(\bibu\b|\bebc\b|\bsrm\b|mg\/l|g\/l|ppm|°c|°p|\bplato\b|\bco2\b)/i.test(d)) score += 1;
    if (/(désigne|correspond à|se définit|signifie|c['’]est|on appelle|mesure)/i.test(d)) score += 1;
    if (len > 420) score -= 2;
    if (len < 10) score -= 2;
    return score;
  };

  // 0) Seed (glossaire brassicole) : garantit une définition courte même si le cours ne la formule pas explicitement
  for (const s of getBrewGlossarySeedIndex()) {
    const key = s.key;
    if (!key) continue;
    const shortDef = toShortClearDefinition(s.def, 180);
    if (!shortDef) continue;
    map.set(key, {
      key,
      term: s.term,
      shortDef,
      defFull: s.def,
      score: 99,
      keys: (s.keys && s.keys.length) ? s.keys : [key],
      themeTitle: `(Glossaire)` ,
      themeId: null,
      category: 'GLOSSAIRE'
    });
  }

  // 0bis) Glossaire personnalisé (localStorage) : prioritaire sur le seed
  for (const c of loadCustomGlossaryEntries()) {
    const key = c.key;
    if (!key) continue;
    const shortDef = toShortClearDefinition(c.def, 220);
    if (!shortDef) continue;
    map.set(key, {
      key,
      term: c.term,
      shortDef,
      defFull: c.def,
      score: 120,
      keys: (c.keys && c.keys.length) ? c.keys : [key],
      themeTitle: `(Perso)`,
      themeId: null,
      category: 'GLOSSAIRE'
    });
  }

  for (const theme of (THEMES_VIEW || [])) {
    const items = collectThemeFicheItems(theme);
    const consumed = new Set();

    for (let i = 0; i < items.length; i++) {
      if (consumed.has(i)) continue;
      const entry = items[i];
      const plain = stripSummaryMarkup(entry.item);
      if (!plain) continue;

      let pair = extractGlossaryPairFromPlainText(plain);

      // terme sur une ligne + explication sur la suivante
      if (!pair && isLikelyStandaloneGlossaryTermLine(plain)) {
        const next = items[i + 1];
        if (next && String(next.sectionTitle || '') === String(entry.sectionTitle || '')) {
          const nextPlain = stripSummaryMarkup(next.item);
          if (nextPlain && isLikelyDefinitionLine(nextPlain)) {
            pair = extractGlossaryPairFromPlainText(`${plain} : ${nextPlain}`);
            if (pair) consumed.add(i + 1);
          }
        }
      }

      if (!pair || !pair.term || !pair.def) continue;

      const term = String(pair.term).trim();
      const def = String(pair.def).trim();
      if (!term || !def) continue;

      const key = normalizeGlossaryKey(term);
      if (!key) continue;

      const score = scoreCandidate(term, def);
      const shortDef = toShortClearDefinition(def, 180);
      if (!shortDef) continue;

      const prev = map.get(key);
      if (!prev || score > prev.score || (score === prev.score && shortDef.length < prev.shortDef.length)) {
        map.set(key, {
          key,
          term,
          shortDef,
          defFull: def,
          score,
          keys: [key],
          themeTitle: theme.title,
          themeId: theme.id,
          category: theme.category
        });
      }
    }

    // Extraire aussi depuis les explications de questions (souvent là que se trouve la définition courte)
    if (theme.questions) {
      for (const q of theme.questions) {
        const expl = stripSummaryMarkup(q && q.explanation);
        if (!expl) continue;
        const candidate = extractGlossaryPairFromPlainText(expl);
        if (!candidate || !candidate.term || !candidate.def) continue;

        const term = String(candidate.term).trim();
        const def = String(candidate.def).trim();
        const key = normalizeGlossaryKey(term);
        if (!key) continue;
        const shortDef = toShortClearDefinition(def, 180);
        if (!shortDef) continue;
        const score = 30; // en dessous du seed mais suffisamment haut
        const prev = map.get(key);
        if (!prev) {
          map.set(key, {
            key,
            term,
            shortDef,
            defFull: def,
            score,
            keys: [key],
            themeTitle: theme.title,
            themeId: theme.id,
            category: theme.category
          });
        }
      }
    }
  }

  return Array.from(map.values());
}

var GLOBAL_GLOSSARY_INDEX = [];
try {
  GLOBAL_GLOSSARY_INDEX = buildGlobalGlossaryIndex();
} catch (e) {
  console.warn('Glossaire: index non construit', e);
  GLOBAL_GLOSSARY_INDEX = [];
}

try {
  GLOBAL_TECH_TERMS_INDEX = buildGlobalTechTermsIndex();
} catch (e) {
  console.warn('Glossaire: index termes techniques non construit', e);
  GLOBAL_TECH_TERMS_INDEX = [];
}

let GLOBAL_SUMMARY_INDEX = [];
function buildGlobalSummaryIndex() {
  const idx = [];
  const categories = Array.from(new Set((THEMES_VIEW || []).map(t => t.category))).filter(Boolean);
  const addEntry = (scope, meta, bucketTitle, htmlItem) => {
    const text = stripSummaryMarkup(htmlItem);
    const norm = normalizeGlossaryKey(text);
    if (!text || !norm) return;
    idx.push({ scope, ...meta, bucketTitle, html: htmlItem, text, norm });
  };

  // Catégories
  categories.forEach(cat => {
    const themes = getThemesByCategory(cat);
    const buckets = buildStructuredBucketsFromThemes(themes, { limitPerBucket: 30, includeSourceTags: true });
    Object.keys(buckets || {}).forEach(bucketTitle => {
      (buckets[bucketTitle] || []).forEach(html => addEntry('category', { category: cat }, bucketTitle, html));
    });
  });

  // Thèmes
  (THEMES_VIEW || []).forEach(theme => {
    const buckets = buildStructuredBucketsFromThemes([theme], { limitPerBucket: 20, includeSourceTags: false });
    Object.keys(buckets || {}).forEach(bucketTitle => {
      (buckets[bucketTitle] || []).forEach(html => addEntry('theme', { category: theme.category, themeId: theme.id, themeTitle: theme.title }, bucketTitle, html));
    });
  });

  return idx;
}

try {
  GLOBAL_SUMMARY_INDEX = buildGlobalSummaryIndex();
} catch (e) {
  console.warn('Résumé: index non construit', e);
  GLOBAL_SUMMARY_INDEX = [];
}

function openGlossaryModal(initialQuery, opts = {}) {
  const existing = document.querySelector('.glossary-backdrop');
  if (existing) existing.remove();

  // S'assurer que l'index est prêt
  if ((!GLOBAL_GLOSSARY_INDEX || GLOBAL_GLOSSARY_INDEX.length === 0) && typeof buildGlobalGlossaryIndex === 'function') {
    try { GLOBAL_GLOSSARY_INDEX = buildGlobalGlossaryIndex(); } catch {}
  }

  const backdrop = document.createElement('div');
  backdrop.className = 'glossary-backdrop';

  const card = document.createElement('div');
  card.className = 'glossary-card';

  const header = document.createElement('div');
  header.className = 'glossary-header';

  const title = document.createElement('div');
  title.className = 'glossary-title';
  title.textContent = '📚 Glossaire (définitions)';

  const actions = document.createElement('div');
  actions.className = 'glossary-actions';

  const closeBtn = document.createElement('button');
  closeBtn.className = 'glossary-close';
  closeBtn.textContent = '✖ Fermer';
  closeBtn.addEventListener('click', () => backdrop.remove());

  actions.appendChild(closeBtn);
  header.appendChild(title);
  header.appendChild(actions);

  const body = document.createElement('div');
  body.className = 'glossary-body';

  const searchRow = document.createElement('div');
  searchRow.className = 'glossary-search';

  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = 'Rechercher une définition (ex: diacétyle, CIP, IBU…)';
  input.value = initialQuery ? String(initialQuery) : '';
  input.style.paddingRight = '2.6rem';

  const inputWrap = document.createElement('div');
  inputWrap.className = 'search-input-wrap';
  inputWrap.style.width = '100%';

  const clearBtn = document.createElement('button');
  clearBtn.type = 'button';
  clearBtn.className = 'search-clear-btn';
  clearBtn.title = 'Effacer';
  clearBtn.setAttribute('aria-label', 'Effacer la recherche du glossaire');
  clearBtn.textContent = '✕';

  const updateClear = () => {
    const has = String(input.value || '').trim().length > 0;
    clearBtn.classList.toggle('is-visible', has);
  };
  clearBtn.addEventListener('click', () => {
    if (!input.value) return;
    input.value = '';
    input.dispatchEvent(new Event('input', { bubbles: true }));
    try { input.focus(); } catch {}
  });
  input.addEventListener('input', updateClear);
  updateClear();

  inputWrap.appendChild(input);
  inputWrap.appendChild(clearBtn);
  searchRow.appendChild(inputWrap);

  // Outils: ajouter une définition + détecter termes manquants
  const tools = document.createElement('div');
  tools.className = 'glossary-tools';

  const addBtn = document.createElement('button');
  addBtn.className = 'secondary';
  addBtn.textContent = '➕ Ajouter une définition';

  const missingBtn = document.createElement('button');
  missingBtn.textContent = '🕵️ Termes à définir';

  const rebuildBtn = document.createElement('button');
  rebuildBtn.className = 'secondary';
  rebuildBtn.textContent = '↻ Reconstruire index';

  // Mode agressif (visible en permanence)
  const aggressiveWrap = document.createElement('div');
  aggressiveWrap.style.display = 'flex';
  aggressiveWrap.style.gap = '0.45rem';
  aggressiveWrap.style.alignItems = 'center';
  aggressiveWrap.style.padding = '0.25rem 0.5rem';
  aggressiveWrap.style.borderRadius = '10px';
  aggressiveWrap.style.border = '1px solid rgba(88, 166, 255, 0.22)';
  aggressiveWrap.style.background = 'rgba(88, 166, 255, 0.08)';

  const aggressiveToggle = document.createElement('input');
  aggressiveToggle.type = 'checkbox';
  aggressiveToggle.checked = true;
  aggressiveToggle.id = 'glossaryAggressiveToggle';

  const aggressiveLabel = document.createElement('label');
  aggressiveLabel.setAttribute('for', 'glossaryAggressiveToggle');
  aggressiveLabel.style.cursor = 'pointer';
  aggressiveLabel.style.fontWeight = '900';
  aggressiveLabel.style.color = 'var(--text)';
  aggressiveLabel.textContent = 'Agressif';

  aggressiveWrap.title = 'Mode agressif: détecte plus de termes (mais peut ajouter du bruit).';
  aggressiveWrap.appendChild(aggressiveToggle);
  aggressiveWrap.appendChild(aggressiveLabel);

  const status = document.createElement('div');
  status.className = 'glossary-mini';
  status.textContent = '';

  tools.appendChild(addBtn);
  tools.appendChild(missingBtn);
  tools.appendChild(rebuildBtn);
  tools.appendChild(aggressiveWrap);
  tools.appendChild(status);

  const list = document.createElement('div');
  list.className = 'glossary-list';

  const panel = document.createElement('div');
  panel.className = 'glossary-panel';
  panel.style.display = 'none';

  const panelTitle = document.createElement('div');
  panelTitle.style.fontWeight = '950';
  panelTitle.textContent = '';
  panel.appendChild(panelTitle);

  const form = document.createElement('div');
  form.style.display = 'none';
  form.style.display = 'grid';
  form.style.gap = '0.6rem';

  const termRow = document.createElement('div');
  termRow.className = 'row';
  const termLabel = document.createElement('label');
  termLabel.textContent = 'Terme';
  const termInput = document.createElement('input');
  termInput.placeholder = 'Ex: Gushing, IBU, BU:GU, Hop creep…';
  termRow.appendChild(termLabel);
  termRow.appendChild(termInput);

  const keysRow = document.createElement('div');
  keysRow.className = 'row';
  const keysLabel = document.createElement('label');
  keysLabel.textContent = 'Synonymes / variantes (optionnel)';
  const keysInput = document.createElement('input');
  keysInput.placeholder = 'Ex: sur-moussage, jaillissement (séparés par des virgules)';
  keysRow.appendChild(keysLabel);
  keysRow.appendChild(keysInput);

  const defRow = document.createElement('div');
  defRow.className = 'row';
  const defLabel = document.createElement('label');
  defLabel.textContent = 'Définition (courte et claire)';
  const defInput = document.createElement('textarea');
  defInput.placeholder = 'Écris une définition simple, 1–2 phrases max.';
  defRow.appendChild(defLabel);
  defRow.appendChild(defInput);

  const formActions = document.createElement('div');
  formActions.className = 'glossary-tools';

  const saveBtn = document.createElement('button');
  saveBtn.className = 'secondary';
  saveBtn.textContent = '💾 Enregistrer';

  const deleteBtn = document.createElement('button');
  deleteBtn.className = 'danger';
  deleteBtn.textContent = '🗑 Supprimer (perso)';

  const cancelBtn = document.createElement('button');
  cancelBtn.textContent = '✖ Fermer';

  formActions.appendChild(saveBtn);
  formActions.appendChild(deleteBtn);
  formActions.appendChild(cancelBtn);

  const formHint = document.createElement('div');
  formHint.className = 'glossary-mini';
  formHint.textContent = 'Les définitions “perso” sont stockées sur ton navigateur (localStorage) et deviennent prioritaires.';

  form.appendChild(termRow);
  form.appendChild(keysRow);
  form.appendChild(defRow);
  form.appendChild(formActions);
  form.appendChild(formHint);

  panel.appendChild(form);

  const missingPanel = document.createElement('div');
  missingPanel.style.display = 'none';
  missingPanel.style.display = 'grid';
  missingPanel.style.gap = '0.6rem';

  const missingTools = document.createElement('div');
  missingTools.className = 'glossary-tools';

  const scanAllBtn = document.createElement('button');
  scanAllBtn.textContent = 'Scanner tout';
  const scanCatBtn = document.createElement('button');
  scanCatBtn.className = 'secondary';
  scanCatBtn.textContent = 'Scanner catégorie actuelle';
  const scanThemeBtn = document.createElement('button');
  scanThemeBtn.className = 'secondary';
  scanThemeBtn.textContent = 'Scanner thème actuel';

  missingTools.appendChild(scanAllBtn);
  missingTools.appendChild(scanCatBtn);
  missingTools.appendChild(scanThemeBtn);

  const missingInfo = document.createElement('div');
  missingInfo.className = 'glossary-mini';
  missingInfo.textContent = 'But: trouver les termes techniques présents dans tes cours mais absents du glossaire, puis les ajouter en 2 clics.';


  const missingList = document.createElement('div');
  missingList.className = 'glossary-list';

  missingPanel.appendChild(missingTools);
  missingPanel.appendChild(missingInfo);
  missingPanel.appendChild(missingList);

  panel.appendChild(missingPanel);

  let mode = 'browse'; // browse | add | missing

  const setMode = (m) => {
    mode = m;
    panel.style.display = (mode === 'browse') ? 'none' : 'grid';
    form.style.display = (mode === 'add') ? 'grid' : 'none';
    missingPanel.style.display = (mode === 'missing') ? 'grid' : 'none';
    list.style.display = (mode === 'browse') ? 'grid' : 'none';
    status.textContent = '';
    if (mode === 'add') {
      panelTitle.textContent = 'Ajouter / modifier une définition (perso)';
      setTimeout(() => { try { termInput.focus(); } catch {} }, 0);
    }
    if (mode === 'missing') {
      panelTitle.textContent = 'Termes détectés sans définition';
    }
  };

  const rebuildIndexes = () => {
    try { GLOBAL_GLOSSARY_INDEX = buildGlobalGlossaryIndex(); } catch {}
    try { GLOBAL_SUMMARY_INDEX = buildGlobalSummaryIndex(); } catch {}
    try { GLOBAL_TECH_TERMS_INDEX = buildGlobalTechTermsIndex(); } catch {}
  };

  const render = () => {
    const q = normalizeGlossaryKey(input.value);
    let entries = (GLOBAL_GLOSSARY_INDEX || []).slice();

    // On garde en haut les meilleures correspondances
    if (q) {
      entries = entries
        .map(e => {
          const keys = Array.isArray(e.keys) && e.keys.length ? e.keys : [e.key];
          const hit = keys.some(k => k === q || k.startsWith(q) || k.includes(q) || q.includes(k) || (q.length >= 4 && k.split(' ').some(tok => tok === q || tok.startsWith(q))));
          if (!hit) return null;
          let rank = 9;
          if (keys.some(k => k === q)) rank = 0;
          else if (keys.some(k => k.startsWith(q))) rank = 1;
          else if (keys.some(k => k.includes(q))) rank = 2;
          else if (keys.some(k => q.includes(k))) rank = 3;
          return { ...e, _rank: rank };
        })
        .filter(Boolean)
        .sort((a, b) => (a._rank - b._rank) || ((b.score || 0) - (a.score || 0)) || (String(a.term).localeCompare(String(b.term), 'fr')));
    } else {
      entries = entries.sort((a, b) => String(a.term).localeCompare(String(b.term), 'fr'));
    }

    const show = entries.slice(0, 200);
    list.innerHTML = '';
    if (show.length === 0) {
      const empty = document.createElement('div');
      empty.style.color = 'var(--muted)';
      empty.style.fontStyle = 'italic';
      empty.textContent = 'Aucune définition trouvée.';
      list.appendChild(empty);
      return;
    }

    show.forEach(e => {
      const it = document.createElement('div');
      it.className = 'glossary-item';
      it.innerHTML = `
        <div class="term">${escapeHtml(e.term || '')}</div>
        <div class="def">${highlightText(escapeHtml(e.shortDef || e.defFull || ''), input.value.trim())}</div>
        <div class="meta">${escapeHtml(e.category || '')}${e.themeTitle ? ` • ${escapeHtml(e.themeTitle)}` : ''}</div>
      `;

      it.addEventListener('click', () => {
        if (e.themeId) {
          const btn = document.querySelector(`.theme-btn[data-theme-id="${CSS.escape(e.themeId)}"]`);
          if (btn) {
            btn.click();
            backdrop.remove();
            try { btn.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch {}
          }
        }
      });

      list.appendChild(it);
    });
  };

  input.addEventListener('input', render);
  render();

  const openAddForm = (prefillTerm) => {
    rebuildIndexes();
    const term = String(prefillTerm || '').trim();
    termInput.value = term;
    keysInput.value = '';
    defInput.value = '';

    // Si déjà défini en perso, pré-remplir
    const custom = loadCustomGlossaryEntries();
    const k = normalizeGlossaryKey(term);
    const found = custom.find(e => e.key === k);
    if (found) {
      keysInput.value = (found.keys || []).filter(x => x !== found.key).join(', ');
      defInput.value = found.def || '';
      status.textContent = 'Terme déjà présent en “perso”: modification possible.';
    } else if (term) {
      status.textContent = 'Ajoute une définition courte et claire.';
    }
    setMode('add');
  };

  addBtn.addEventListener('click', () => openAddForm(input.value.trim()));
  cancelBtn.addEventListener('click', () => setMode('browse'));

  rebuildBtn.addEventListener('click', () => {
    rebuildIndexes();
    status.textContent = 'Index reconstruit.';
    if (mode === 'browse') render();
  });

  saveBtn.addEventListener('click', () => {
    const term = termInput.value.trim();
    const def = defInput.value.trim();
    const keys = keysInput.value.split(',').map(s => s.trim()).filter(Boolean);
    const res = upsertCustomGlossaryEntry({ term, def, keys });
    if (!res.ok) {
      status.textContent = res.reason || 'Impossible d’enregistrer.';
      return;
    }
    rebuildIndexes();
    status.textContent = 'Définition enregistrée. Elle est maintenant intégrée au glossaire et aux résumés.';
    setMode('browse');
    render();
  });

  deleteBtn.addEventListener('click', () => {
    const term = termInput.value.trim();
    if (!term) {
      status.textContent = 'Aucun terme à supprimer.';
      return;
    }
    const ok = removeCustomGlossaryEntryByKey(term);
    rebuildIndexes();
    status.textContent = ok ? 'Définition perso supprimée.' : 'Aucune définition perso trouvée pour ce terme.';
    setMode('browse');
    render();
  });

  const renderMissingList = (missing) => {
    missingList.innerHTML = '';
    if (!missing || missing.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'glossary-mini';
      empty.style.fontStyle = 'italic';
      empty.textContent = 'Aucun terme manquant détecté (avec les réglages actuels).';
      missingList.appendChild(empty);
      return;
    }

    missing.forEach(e => {
      const it = document.createElement('div');
      it.className = 'glossary-missing-item';
      it.innerHTML = `
        <div class="top">
          <div class="term">${escapeHtml(e.term || '')}</div>
          <div class="count">${Number(e.count || 0)} occurrence(s)</div>
        </div>
        <div class="snippet">${escapeHtml(e.snippet || '')}</div>
      `;

      const define = document.createElement('button');
      define.className = 'secondary';
      define.style.marginTop = '0.6rem';
      define.textContent = '➕ Définir ce terme';
      define.addEventListener('click', (ev) => {
        ev.stopPropagation();
        openAddForm(e.term);
      });
      it.appendChild(define);
      missingList.appendChild(it);
    });
  };

  const scan = (scope) => {
    rebuildIndexes();
    const keySet = getGlossaryKeySet(GLOBAL_GLOSSARY_INDEX);
    let themes = (THEMES_VIEW || []).slice();

    if (scope === 'category') {
      const cat = currentTheme && currentTheme.category;
      if (cat && cat !== 'GLOBAL') themes = getThemesByCategory(cat);
      else themes = (THEMES_VIEW || []).slice();
    }
    if (scope === 'theme') {
      const t = currentTheme && THEMES_VIEW && THEMES_VIEW.find(x => x.id === currentTheme.id);
      themes = t ? [t] : [];
    }

    const aggressive = !!(aggressiveToggle && aggressiveToggle.checked);
    const missing = detectMissingGlossaryTermsFromThemes(themes, keySet, {
      maxItems: aggressive ? 260 : 160,
      minCount: aggressive ? 1 : 2,
      aggressive
    });
    renderMissingList(missing);
    status.textContent = `Trouvé ${missing.length} terme(s) potentiels à définir.`;
  };

  missingBtn.addEventListener('click', () => {
    setMode('missing');
    scan('category');
  });

  scanAllBtn.addEventListener('click', () => scan('all'));
  scanCatBtn.addEventListener('click', () => scan('category'));
  scanThemeBtn.addEventListener('click', () => scan('theme'));

  body.appendChild(searchRow);
  body.appendChild(tools);
  body.appendChild(panel);
  body.appendChild(list);

  card.appendChild(header);
  card.appendChild(body);
  backdrop.appendChild(card);
  document.body.appendChild(backdrop);

  backdrop.addEventListener('click', (e) => {
    if (e.target === backdrop) backdrop.remove();
  });

  setTimeout(() => {
    try { input.focus(); input.select(); } catch {}
  }, 0);

  // Ouverture directe en mode demandé
  if (opts && opts.mode === 'add') {
    openAddForm(opts.term || initialQuery || '');
  } else if (opts && opts.mode === 'missing') {
    setMode('missing');
    scan(opts.scope || 'category');
  }
}

function filterThemes() {
  const searchTerm = searchBar.value.toLowerCase().trim();
  const themeButtons = document.querySelectorAll('.theme-btn');
  
  if (searchTerm === '') {
    // Si pas de recherche, tout afficher
    themeButtons.forEach(btn => {
      btn.parentElement.style.display = '';
    });
    document.querySelectorAll('.category-group').forEach(cat => {
      cat.style.display = '';
    });
    searchResultsDiv.style.display = 'none';
    searchResultsContent.innerHTML = '';
    return;
  }
  
  const results = [];

  // (Re)construire l'index si nécessaire (ex: ordre de chargement / modifications)
  if ((!GLOBAL_GLOSSARY_INDEX || GLOBAL_GLOSSARY_INDEX.length === 0) && typeof buildGlobalGlossaryIndex === 'function') {
    try { GLOBAL_GLOSSARY_INDEX = buildGlobalGlossaryIndex(); } catch {}
  }
  if ((!GLOBAL_SUMMARY_INDEX || GLOBAL_SUMMARY_INDEX.length === 0) && typeof buildGlobalSummaryIndex === 'function') {
    try { GLOBAL_SUMMARY_INDEX = buildGlobalSummaryIndex(); } catch {}
  }
  if ((!GLOBAL_TECH_TERMS_INDEX || GLOBAL_TECH_TERMS_INDEX.length === 0) && typeof buildGlobalTechTermsIndex === 'function') {
    try { GLOBAL_TECH_TERMS_INDEX = buildGlobalTechTermsIndex(); } catch {}
  }

  // 1) Glossaire (résumés/définitions) : afficher en premier
  const queryKey = normalizeGlossaryKey(searchTerm);
  const defMatches = [];
  if (queryKey && GLOBAL_GLOSSARY_INDEX && GLOBAL_GLOSSARY_INDEX.length) {
    for (const g of GLOBAL_GLOSSARY_INDEX) {
      if (!g || !g.key) continue;
      const keys = Array.isArray(g.keys) && g.keys.length ? g.keys : [g.key];
      // Match exact + partiel + mot contenu (utile pour "diastasique" -> "pouvoir diastasique")
      const hit = keys.some(k => (k === queryKey)
        || k.startsWith(queryKey)
        || k.includes(queryKey)
        || queryKey.includes(k)
        || (queryKey.length >= 4 && k.split(' ').some(tok => tok === queryKey || tok.startsWith(queryKey))));
      if (hit) {
        let rank = 9;
        if (keys.some(k => k === queryKey)) rank = 0;
        else if (keys.some(k => k.startsWith(queryKey))) rank = 1;
        else if (keys.some(k => k.includes(queryKey))) rank = 2;
        else if (keys.some(k => queryKey.includes(k))) rank = 3;
        defMatches.push({ ...g, rank });
      }
    }
  }

  defMatches.sort((a, b) => (a.rank - b.rank) || ((b.score || 0) - (a.score || 0)) || (a.shortDef.length - b.shortDef.length));
  const topDefs = defMatches.slice(0, 6);
  const matchedThemeIdsByDef = new Set(topDefs.map(d => d.themeId).filter(Boolean));
  topDefs.forEach(d => {
    results.push({
      theme: d.themeTitle || (d.category ? `(${d.category})` : '—'),
      type: 'Définition (Glossaire)',
      content: `${d.term} — ${d.shortDef}`,
      priority: 0
    });
  });

  // 1bis) Mode agressif en recherche globale : si pas de définition trouvée, proposer le terme technique à définir
  // (Toujours activé ici, comme demandé.)
  if (queryKey && queryKey.length >= 3 && topDefs.length === 0 && GLOBAL_TECH_TERMS_INDEX && GLOBAL_TECH_TERMS_INDEX.length) {
    const matches = (GLOBAL_TECH_TERMS_INDEX || [])
      .map(t => {
        const k = normalizeGlossaryKey(t && (t.key || t.term));
        if (!k) return null;
        const hit = (k === queryKey) || k.startsWith(queryKey) || k.includes(queryKey) || queryKey.includes(k);
        if (!hit) return null;
        let rank = 9;
        if (k === queryKey) rank = 0;
        else if (k.startsWith(queryKey)) rank = 1;
        else if (k.includes(queryKey)) rank = 2;
        else if (queryKey.includes(k)) rank = 3;
        return { ...t, _rank: rank };
      })
      .filter(Boolean)
      .sort((a, b) => (a._rank - b._rank) || ((b.count || 0) - (a.count || 0)) || (String(a.term).localeCompare(String(b.term), 'fr')))
      .slice(0, 2);

    matches.forEach(m => {
      results.push({
        theme: 'Glossaire',
        type: 'Terme technique (à définir)',
        content: `${m.term} — ${m.snippet || ''}`,
        priority: 0.5,
        action: 'define',
        actionTerm: m.term
      });
    });
  }

  // 2) Recherche dans les résumés (index)
  if (queryKey && GLOBAL_SUMMARY_INDEX && GLOBAL_SUMMARY_INDEX.length) {
    const maxSummaryHits = 18;
    let count = 0;
    for (const s of GLOBAL_SUMMARY_INDEX) {
      if (count >= maxSummaryHits) break;
      if (!s || !s.norm) continue;
      if (s.norm.includes(queryKey)) {
        count++;
        const label = s.scope === 'category' ? `Catégorie ${s.category}` : (s.themeTitle || 'Thème');
        results.push({
          theme: label,
          type: `Résumé - ${s.bucketTitle}`,
          content: s.text,
          priority: 1
        });
      }
    }
  }
  
  themeButtons.forEach(btn => {
    const themeId = btn.getAttribute('data-theme-id');
    const theme = THEMES_VIEW.find(t => t.id === themeId);
    
    if (!theme) {
      btn.parentElement.style.display = 'none';
      return;
    }
    
    // Rechercher dans le titre
    let found = theme.title.toLowerCase().includes(searchTerm);
    
    if (found) {
      results.push({
        theme: theme.title,
        type: 'Titre',
        content: theme.title
      });
    }
    
    // Rechercher dans les explications uniquement (pas les questions ni les réponses)
    if (theme.questions) {
      theme.questions.forEach((q, idx) => {
        // Chercher seulement dans les explications
        if (q.explanation.toLowerCase().includes(searchTerm)) {
          results.push({
            theme: theme.title,
            type: 'Explication',
            content: q.explanation
          });
          found = true;
        }
      });
    }
    
    // Rechercher dans la fiche
    if (theme.ficheRich) {
      theme.ficheRich.forEach(sec => {
        if (sec.title.toLowerCase().includes(searchTerm)) {
          results.push({
            theme: theme.title,
            type: 'Fiche - Section',
            content: sec.title
          });
          found = true;
        }
        
        sec.items.forEach(item => {
          if (item.toLowerCase().includes(searchTerm)) {
            results.push({
              theme: theme.title,
              type: 'Fiche - Contenu',
              content: item.replace(/\*\*(.+?)\*\*/g, '$1')
            });
            found = true;
          }
        });
      });
    }

    // Si une définition a matché ce thème, on le garde visible
    if (matchedThemeIdsByDef.has(theme.id)) {
      found = true;
    }
    
    if (found) {
      btn.parentElement.style.display = '';
    } else {
      btn.parentElement.style.display = 'none';
    }
  });
  
  // Afficher les résultats
  if (results.length > 0) {
    searchResultsDiv.style.display = 'block';
    const ordered = results
      .map((r, idx) => ({ ...r, priority: (r.priority ?? 10), _idx: idx }))
      .sort((a, b) => (a.priority - b.priority) || (a._idx - b._idx));

    searchResultsContent.innerHTML = ordered.map(r => `
      <div style="background: rgba(88, 166, 255, 0.1); padding: 1rem; margin-bottom: 0.8rem; border-radius: 6px; border-left: 3px solid var(--accent);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
          <strong style="color: var(--accent);">${r.theme}</strong>
          <span style="background: rgba(167, 139, 250, 0.3); color: #a78bfa; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.85em;">${r.type}</span>
        </div>
        <div style="color: var(--text); line-height: 1.6;">${highlightText(r.content, searchTerm)}</div>
      </div>
    `).join('');
  } else {
    searchResultsDiv.style.display = 'block';
    searchResultsContent.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 1rem;">Aucun résultat trouvé</p>';
  }
  
  // Masquer les catégories vides
  const categories = document.querySelectorAll('.category-group');
  categories.forEach(cat => {
    const visibleButtons = Array.from(cat.querySelectorAll('.theme-btn')).filter(btn => btn.parentElement.style.display !== 'none');
    if (visibleButtons.length === 0) {
      cat.style.display = 'none';
    } else {
      cat.style.display = '';
    }
  });
          // ...objet supprimé: formesHoublonComplet
}

// ===================== RECHERCHE DANS LE THÈME ACTUEL =====================
const themeSearchBar = document.getElementById('themeSearchBar');
const themeSearchResultsDiv = document.getElementById('themeSearchResults');
const themeSearchResultsContent = document.getElementById('themeSearchResultsContent');

const clearThemeSearchBarBtn = document.getElementById('clearThemeSearchBar');
if (themeSearchBar && clearThemeSearchBarBtn) {
  const update = () => {
    const has = String(themeSearchBar.value || '').trim().length > 0;
    clearThemeSearchBarBtn.classList.toggle('is-visible', has);
  };
  clearThemeSearchBarBtn.addEventListener('click', () => {
    if (!themeSearchBar.value) return;
    themeSearchBar.value = '';
    themeSearchBar.dispatchEvent(new Event('input', { bubbles: true }));
    try { themeSearchBar.focus(); } catch {}
  });
  themeSearchBar.addEventListener('input', update);
  update();
}

themeSearchBar.addEventListener('input', filterCurrentTheme);

function filterCurrentTheme() {
  const searchTerm = themeSearchBar.value.toLowerCase().trim();
  
  if (searchTerm === '') {
    themeSearchResultsDiv.style.display = 'none';
    themeSearchResultsContent.innerHTML = '';
    return;
  }
  
  if (!currentTheme) {
    themeSearchResultsDiv.style.display = 'block';
    themeSearchResultsContent.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 1rem;">⚠️ Veuillez sélectionner un thème d\'abord</p>';
    return;
  }
  
  const results = [];
  
  // Rechercher dans la fiche du thème
  if (currentTheme.ficheRich) {
    currentTheme.ficheRich.forEach(section => {
      // Recherche dans le titre de section
      if (section.title.toLowerCase().includes(searchTerm)) {
        results.push({
          type: 'Titre de section',
          content: section.title
        });
      }
      
      // Recherche dans les items de la section
      section.items.forEach(item => {
        if (item.toLowerCase().includes(searchTerm)) {
          results.push({
            type: `Section: ${section.title}`,
            content: item.replace(/\*\*(.+?)\*\*/g, '$1')
          });
        }
      });
    });
  }
  
  // Rechercher dans les explications des questions (pas les questions elles-mêmes)
  currentTheme.questions.forEach((q, idx) => {
    if (q.explanation.toLowerCase().includes(searchTerm)) {
      results.push({
        type: `Explication Q${idx + 1}`,
        content: q.explanation
      });
    }
  });
  
  // Afficher les résultats
  if (results.length > 0) {
    themeSearchResultsDiv.style.display = 'block';
    themeSearchResultsContent.innerHTML = `
      <div style="margin-bottom: 1rem; color: var(--accent); font-weight: 600;">
        ${results.length} résultat(s) trouvé(s) dans "${currentTheme.title}"
      </div>
    ` + results.map(r => `
      <div style="background: rgba(88, 166, 255, 0.1); padding: 1rem; margin-bottom: 0.8rem; border-radius: 6px; border-left: 3px solid var(--accent);">
        <div style="margin-bottom: 0.5rem;">
          <span style="background: rgba(167, 139, 250, 0.3); color: #a78bfa; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.85em;">${r.type}</span>
          <div style="display:flex; gap:0.5rem; align-items:center; flex-wrap: wrap; justify-content:flex-end;">
            <span style="background: rgba(167, 139, 250, 0.3); color: #a78bfa; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.85em;">${r.type}</span>
            ${r.action === 'define' && r.actionTerm ? `<button class="define-term-btn" data-term="${escapeHtml(String(r.actionTerm))}" style="padding:0.35rem 0.6rem; border-radius:8px; border:1px solid rgba(63,185,80,0.25); background: rgba(63,185,80,0.12); color: var(--text); font-weight: 900; cursor: pointer;">➕ Définir</button>` : ''}
          </div>
        <div style="color: var(--text); line-height: 1.6;">${highlightText(r.content, searchTerm)}</div>
      </div>
    `).join('');
  } else {

    // Bind actions (évite inline onclick)
    searchResultsContent.querySelectorAll('.define-term-btn').forEach(btn => {
      btn.addEventListener('click', (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        const term = btn.getAttribute('data-term') || '';
        if (term) openGlossaryModal(term, { mode: 'add', term });
      });
    });
    themeSearchResultsDiv.style.display = 'block';
    themeSearchResultsContent.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 1rem;">Aucun résultat trouvé dans ce thème</p>';
  }
}

// Bouton de réinitialisation complète (à côté de la recherche)
const resetAllDataBtn = document.getElementById('resetAllData');
resetAllDataBtn.addEventListener('click', () => {
  if (confirm('⚠️ ATTENTION ! Voulez-vous vraiment tout effacer ?\n\n- Tous les thèmes\n- Toutes les réponses\n- Toutes les statistiques\n- Toutes les questions ratées\n\nCette action est IRRÉVERSIBLE !')) {
    safeRemoveItem('quizProgress');
    safeRemoveItem('failedQuestions');
    safeRemoveItem('themeStats');
    themeProgress = {};
    THEMES_VIEW.forEach(t => {
      updateThemeStatus(t.id, 'not-started');
    });
    updateThemeButtons();
    updateStats();
    currentQuestions = [];
    answers = [];
    renderQuiz();
    searchBar.value = '';
    filterThemes();
    alert('✅ Toutes les données ont été effacées !');
  }
});

// Révision globale (toutes les questions ratées)
if (globalRevisionBtn) {
  globalRevisionBtn.addEventListener('click', () => {
    const failed = JSON.parse(safeGetItem('failedQuestions', '{}') || '{}');
    const aggregated = [];

    Object.entries(failed).forEach(([themeId, indices]) => {
      const theme = THEMES_VIEW.find(t => t.id === themeId);
      if (!theme || !Array.isArray(indices)) return;

      indices.forEach(idx => {
        const base = theme.questions[idx];
        if (!base) return;
        const optionsWithIndex = base.options.map((opt, idOpt) => ({ opt, idOpt }));
        const shuffledOptions = shuffle(optionsWithIndex);
        const newCorrectIndex = shuffledOptions.findIndex(item => item.idOpt === base.correctIndex);
        aggregated.push({
          question: base.question,
          options: shuffledOptions.map(item => item.opt),
          correctIndex: newCorrectIndex,
          explanation: base.explanation,
          sourceThemeId: theme.id,
          sourceThemeTitle: theme.title,
          originalIndex: idx
        });
      });
    });

    if (aggregated.length === 0) {
      alert('🎉 Aucune question ratée à réviser pour l\'ensemble des thèmes.');
      return;
    }

    globalRevisionActive = true;
    revisionModeActive = false;
    revisionBtn.style.background = '#a78bfa';
    revisionBtn.textContent = '🔄 Mode révision';

    currentTheme = { id: '__global_revision__', title: 'Révisions totales', category: 'GLOBAL' };
    currentQuestions = aggregated;
    answers = new Array(aggregated.length).fill(null);
    renderQuiz();
    if (quizContainer && quizContainer.scrollIntoView) {
      quizContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  });
}

// Mise à jour des statistiques globales
function updateStats() {
  const started = THEMES_VIEW.filter(t => getThemeStatus(t.id) === 'started').length;
  const completed = THEMES_VIEW.filter(t => getThemeStatus(t.id) === 'completed').length;
  
  // Compter le NOMBRE TOTAL de questions ratées (pas le nombre de thèmes)
  const failedQuestions = JSON.parse(safeGetItem('failedQuestions', '{}') || '{}');
  const failedCount = Object.values(failedQuestions).reduce((sum, arr) => sum + arr.length, 0);
  
  // Calculer le taux de réussite basé sur les réponses réelles
  const themeStats = JSON.parse(safeGetItem('themeStats', '{}') || '{}');
  let totalAnswered = 0;
  let totalCorrect = 0;
  
  Object.values(themeStats).forEach(stat => {
    if (stat.answered !== undefined && stat.correct !== undefined) {
      totalAnswered += stat.answered;
      totalCorrect += stat.correct;
    }
  });
  
  const successRate = totalAnswered > 0 ? Math.round((totalCorrect / totalAnswered) * 100) : 0;
  
  const statCards = document.querySelectorAll('.stat-card div:first-child');
  statCards[0].textContent = started;
  statCards[1].textContent = completed;
  statCards[2].textContent = successRate + '%';
  statCards[3].textContent = failedCount;
  
  updateCharts();
}

// Graphiques circulaires
function createCircularChart(canvasId, value, total, color) {
  const canvas = document.getElementById(canvasId);
  const ctx = canvas.getContext('2d');
  const centerX = canvas.width / 2;
  const centerY = canvas.height / 2;
  const radius = 60;
  const lineWidth = 15;
  
  // Effacer le canvas
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // Cercle de fond
  ctx.beginPath();
  ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
  ctx.strokeStyle = '#21262d';
  ctx.lineWidth = lineWidth;
  ctx.stroke();
  
  // Arc de progression
  const percentage = total > 0 ? (value / total) : 0;
  const endAngle = -0.5 * Math.PI + (2 * Math.PI * percentage);
  
  ctx.beginPath();
  ctx.arc(centerX, centerY, radius, -0.5 * Math.PI, endAngle);
  ctx.strokeStyle = color;
  ctx.lineWidth = lineWidth;
  ctx.stroke();
  
  // Texte au centre
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 28px Arial';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(value, centerX, centerY);
}

function updateCharts() {
  const completed = THEMES_VIEW.filter(t => getThemeStatus(t.id) === 'completed').length;
  const started = THEMES_VIEW.filter(t => getThemeStatus(t.id) === 'started').length;
  const notStarted = THEMES_VIEW.filter(t => getThemeStatus(t.id) === 'not-started').length;
  const total = THEMES_VIEW.length;
  
  createCircularChart('completedChart', completed, total, '#3fb950');
  createCircularChart('startedChart', started, total, '#1f6feb');
  createCircularChart('notStartedChart', notStarted, total, '#6e7681');
}

// Mode révision
let revisionModeActive = false;
const revisionBtn = document.getElementById('revisionMode');

revisionBtn.addEventListener('click', () => {
  if (!currentTheme) {
    alert('⚠️ Veuillez d\'abord sélectionner un thème.');
    return;
  }
  
  globalRevisionActive = false;
  revisionModeActive = !revisionModeActive;
  
  if (revisionModeActive) {
    // Récupérer les questions ratées pour le thème actuel
    const failed = JSON.parse(safeGetItem('failedQuestions', '{}') || '{}');
    const failedIndices = failed[currentTheme.id] || [];
    
    if (failedIndices.length === 0) {
      alert('🎉 Aucune question ratée dans ce thème !\n\nVous pouvez faire un quiz normal pour créer des questions à réviser.');
      revisionModeActive = false;
      return;
    }
    
    // Charger uniquement les questions ratées
    const failedQuestions = failedIndices.map(idx => {
      const base = currentTheme.questions[idx];
      if (!base) return null;
      const optionsWithIndex = base.options.map((opt, idOpt) => ({ opt, idOpt }));
      const shuffledOptions = shuffle(optionsWithIndex);
      const newCorrectIndex = shuffledOptions.findIndex(item => item.idOpt === base.correctIndex);
      return {
        question: base.question,
        options: shuffledOptions.map(item => item.opt),
        correctIndex: newCorrectIndex,
        explanation: base.explanation,
        sourceThemeId: currentTheme.id,
        sourceThemeTitle: currentTheme.title,
        originalIndex: idx
      };
    }).filter(Boolean);
    
    if (failedQuestions.length === 0) {
      alert('⚠️ Erreur : Questions ratées introuvables.');
      revisionModeActive = false;
      return;
    }
    
    currentQuestions = failedQuestions;
    
    const revisionLength = currentQuestions.length;
    answers = new Array(revisionLength);
    for (let i = 0; i < revisionLength; i++) {
      answers[i] = null;
    }
    renderQuiz();
    
    revisionBtn.style.background = '#f85149';
    revisionBtn.textContent = '❌ Quitter révision';
    alert(`📚 Mode révision activé !\n\n${failedQuestions.length} question(s) ratée(s) chargée(s) pour ce thème.`);
    
  } else {
    // Quitter le mode révision
    revisionBtn.style.background = '#a78bfa';
    revisionBtn.textContent = '🔄 Mode révision';
    currentQuestions = [];
    answers = [];
    toggleScrollNav(true);
    renderQuiz();
  }
});

// Gestion des questions ratées
function addFailedQuestion(themeId, questionIndex) {
  if (themeId === undefined || themeId === null) return;
  const failed = JSON.parse(safeGetItem('failedQuestions', '{}') || '{}');
  if (!failed[themeId]) {
    failed[themeId] = [];
  }
  if (!failed[themeId].includes(questionIndex)) {
    failed[themeId].push(questionIndex);
  }
  safeSetItem('failedQuestions', JSON.stringify(failed));
  updateStats();
}

function removeFailedQuestion(themeId, questionIndex) {
  if (themeId === undefined || themeId === null) return;
  const failed = JSON.parse(safeGetItem('failedQuestions', '{}') || '{}');
  if (failed[themeId]) {
    failed[themeId] = failed[themeId].filter(i => i !== questionIndex);
    if (failed[themeId].length === 0) {
      delete failed[themeId];
    }
  }
  safeSetItem('failedQuestions', JSON.stringify(failed));
  updateStats();
}

// Réinitialiser tout
const resetAllBtn = document.getElementById('resetAllBtn');
resetAllBtn.addEventListener('click', () => {
  if (confirm('⚠️ Voulez-vous vraiment réinitialiser TOUS les thèmes ? Cette action est irréversible.')) {
    safeRemoveItem('quizProgress');
    safeRemoveItem('failedQuestions');
    safeRemoveItem('themeStats');
    themeProgress = {};
    THEMES_VIEW.forEach(t => {
      updateThemeStatus(t.id, 'not-started');
    });
    updateThemeButtons();
    updateStats();
    currentQuestions = [];
    answers = [];
    renderQuiz();
    alert('✅ Tous les thèmes ont été réinitialisés.');
  }
});

// Afficher/masquer la fiche
let ficheVisible = true;

toggleFicheBtn.addEventListener('click', () => {
  ficheVisible = !ficheVisible;
  if (ficheVisible) {
    ficheEl.style.display = '';
    toggleFicheBtn.textContent = '👁️ Masquer la fiche';
  } else {
    ficheEl.style.display = 'none';
    toggleFicheBtn.textContent = '👁️ Afficher la fiche';
  }
});

// Mode plein écran (compatible Safari)
const fullscreenBtn = document.getElementById('fullscreenBtn');
fullscreenBtn.addEventListener('click', () => {
  const docEl = document.documentElement;
  
  // Vérifier si on est en plein écran (compatible Safari)
  const isFullscreen = document.fullscreenElement || 
                      document.webkitFullscreenElement || 
                      document.mozFullScreenElement || 
                      document.msFullscreenElement;
  
  if (!isFullscreen) {
    // Entrer en plein écran avec support Safari
    if (docEl.requestFullscreen) {
      docEl.requestFullscreen();
    } else if (docEl.webkitRequestFullscreen) { // Safari
      docEl.webkitRequestFullscreen();
    } else if (docEl.mozRequestFullScreen) { // Firefox
      docEl.mozRequestFullScreen();
    } else if (docEl.msRequestFullscreen) { // IE11
      docEl.msRequestFullscreen();
    }
    fullscreenBtn.textContent = '🖥️ Quitter plein écran';
  } else {
    // Sortir du plein écran avec support Safari
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.webkitExitFullscreen) { // Safari
      document.webkitExitFullscreen();
    } else if (document.mozCancelFullScreen) { // Firefox
      document.mozCancelFullScreen();
    } else if (document.msExitFullscreen) { // IE11
      document.msExitFullscreen();
    }
    fullscreenBtn.textContent = '🖥️ Plein écran';
  }
});

// Écouter les changements de plein écran (compatible Safari)
document.addEventListener('fullscreenchange', updateFullscreenButton);
document.addEventListener('webkitfullscreenchange', updateFullscreenButton); // Safari
document.addEventListener('mozfullscreenchange', updateFullscreenButton); // Firefox
document.addEventListener('MSFullscreenChange', updateFullscreenButton); // IE11

function updateFullscreenButton() {
  const isFullscreen = document.fullscreenElement || 
                      document.webkitFullscreenElement || 
                      document.mozFullScreenElement || 
                      document.msFullscreenElement;
  
  if (!isFullscreen) {
    fullscreenBtn.textContent = '🖥️ Plein écran';
  }
}

// Initialiser les statistiques et graphiques au chargement
updateStats();

startQuizBtn.onclick = () => {
  if (!currentTheme) return;
  const count = Math.min(parseInt(questionCountSel.value) || 25, currentTheme.questions.length);
  globalRevisionActive = false;
  revisionModeActive = false;
  revisionBtn.style.background = '#a78bfa';
  revisionBtn.textContent = '🔄 Mode révision';
  
  // Sélectionner les questions et mélanger les options
  const selectedQuestions = pickExactCount(currentTheme.questions, count);
  currentQuestions = selectedQuestions.map(q => {
    // Créer une copie de la question avec les options mélangées
    const optionsWithIndex = q.options.map((opt, idx) => ({ opt, idx }));
    const shuffledOptions = shuffle(optionsWithIndex);
    
    // Trouver la nouvelle position de la bonne réponse
    const newCorrectIndex = shuffledOptions.findIndex(item => item.idx === q.correctIndex);
    
    return {
      question: q.question,
      options: shuffledOptions.map(item => item.opt),
      correctIndex: newCorrectIndex,
      explanation: q.explanation
    };
  });
  
  answers = new Array(count);
  for (let i = 0; i < count; i++) {
    answers[i] = null;
  }
  
  // Marquer le thème comme commencé
  updateThemeStatus(currentTheme.id, 'started');
  updateThemeButtons();

  renderQuiz();
};

toggleFicheBtn.onclick = () => {
  showFiche = !showFiche;
  ficheEl.style.display = showFiche ? "block" : "none";
  toggleFicheBtn.textContent = showFiche ? "Masquer la fiche" : "Afficher la fiche";
};

// ===================== EXPORT EN PAGE WEB =====================

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function generateThemeHtmlDocument(theme) {
  let html = `<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${escapeHtml(theme.title)}</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.8; 
      padding: 40px;
      max-width: 900px;
      margin: 0 auto;
      background: #f5f5f5;
      color: #333;
    }
    .container {
      background: white;
      padding: 50px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { 
      color: #2c5aa0; 
      font-size: 2.5em; 
      border-bottom: 4px solid #2c5aa0; 
      padding-bottom: 15px; 
      margin-bottom: 10px; 
    }
    .category-info {
      color: #666;
      font-style: italic;
      margin-bottom: 40px;
      font-size: 1.1em;
    }
    h2 { 
      color: #3b7dd6; 
      font-size: 2em; 
      margin-top: 50px; 
      margin-bottom: 25px; 
      border-bottom: 3px solid #3b7dd6; 
      padding-bottom: 10px; 
    }
    h3 { 
      color: #4a8ee0; 
      font-size: 1.5em; 
      margin-top: 30px; 
      margin-bottom: 15px; 
    }
    ul { 
      margin: 15px 0 25px 0; 
      padding-left: 40px; 
    }
    li { 
      margin: 12px 0; 
      line-height: 1.8;
    }
    strong { 
      color: #000; 
      font-weight: 600; 
    }
    .fiche-section {
      margin-bottom: 30px;
    }
    .question-block { 
      margin: 30px 0; 
      padding: 25px; 
      background: linear-gradient(to right, #f0fdf4, #fff);
      border-left: 5px solid #3fb950;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .question-title { 
      font-weight: 600; 
      font-size: 1.2em; 
      color: #1a1a1a; 
      margin-bottom: 15px; 
    }
    .correct-answer { 
      color: #16a34a; 
      font-weight: 600; 
      margin: 12px 0; 
      padding: 10px 20px;
      background: #dcfce7;
      border-radius: 6px;
      display: inline-block;
    }
    .explanation { 
      color: #555; 
      font-style: italic; 
      margin: 15px 0; 
      padding: 15px 20px; 
      background: #fafafa; 
      border-left: 3px solid #e5e5e5;
      border-radius: 4px; 
    }
    .page-break { 
      height: 2px;
      background: linear-gradient(to right, transparent, #3b7dd6, transparent);
      margin: 60px 0;
    }
    @media print {
      body { background: white; padding: 0; }
      .container { box-shadow: none; padding: 20px; }
      .question-block { page-break-inside: avoid; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>${escapeHtml(theme.title)}</h1>
    <p class="category-info">📂 Catégorie : ${escapeHtml(theme.category)}</p>
`;

  // Ajouter la fiche complète
  if (theme.ficheRich && theme.ficheRich.length > 0) {
    html += '<h2>📚 Fiche de cours</h2>\n';
    theme.ficheRich.forEach(section => {
      html += `<div class="fiche-section">\n`;
      html += `<h3>${escapeHtml(section.title)}</h3>\n<ul>\n`;
      section.items.forEach(item => {
        let formattedItem = escapeHtml(item);
        formattedItem = formattedItem.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        html += `  <li>${formattedItem}</li>\n`;
      });
      html += '</ul>\n</div>\n';
    });
    html += '<div class="page-break"></div>\n';
  }

  // Ajouter les questions avec bonnes réponses et explications
  html += '<h2>📝 Questions et réponses</h2>\n';
  theme.questions.forEach((q, idx) => {
    const correctAnswer = q.options[q.correctIndex];
    html += `
<div class="question-block">
  <div class="question-title">${idx + 1}. ${escapeHtml(q.question)}</div>
  <div class="correct-answer">✓ Réponse correcte : ${escapeHtml(correctAnswer)}</div>
  <div class="explanation">💡 Explication : ${escapeHtml(q.explanation)}</div>
</div>
`;
  });

  html += `
  </div>
</body>
</html>`;
  return html;
}

function downloadHtmlFile(content, filename) {
  const blob = new Blob([content], {
    type: 'text/html;charset=utf-8'
  });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  link.style.display = 'none';
  document.body.appendChild(link);
  link.click();
  setTimeout(() => {
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }, 100);
}

function openInNewTab(content) {
  const blob = new Blob([content], { type: 'text/html;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  window.open(url, '_blank');
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

// Bouton exporter thème actuel
const exportThemeBtn = document.getElementById('exportThemeBtn');
if (exportThemeBtn) {
  exportThemeBtn.addEventListener('click', () => {
    if (!currentTheme) {
      alert('⚠️ Veuillez sélectionner un thème à exporter.');
      return;
    }
    try {
      const html = generateThemeHtmlDocument(currentTheme);
      const filename = `${currentTheme.id}_${currentTheme.title.replace(/[^a-z0-9]/gi, '_')}.html`;
      downloadHtmlFile(html, filename);
      // Ouvrir aussi dans un nouvel onglet pour prévisualisation
      openInNewTab(html);
      alert(`✅ Page HTML téléchargée et ouverte dans un nouvel onglet !\n\nVous pouvez maintenant :\n- Copier-coller le contenu dans Google Docs\n- Imprimer en PDF (Ctrl+P)\n- Sauvegarder la page`);
    } catch(e) {
      alert('❌ Erreur lors de l\'export : ' + e.message);
      console.error(e);
    }
  });
} else {
  console.error('Bouton exportThemeBtn non trouvé !');
}

// Bouton exporter tous les thèmes
const exportAllThemesBtn = document.getElementById('exportAllThemes');
if (exportAllThemesBtn) {
  exportAllThemesBtn.addEventListener('click', () => {
    if (!confirm(`📦 Exporter tous les ${THEMES_VIEW.length} thèmes en ${THEMES_VIEW.length} pages HTML séparées ?\n\nCela va télécharger ${THEMES_VIEW.length} fichiers HTML.`)) {
      return;
    }
    
    let exportedCount = 0;
    THEMES_VIEW.forEach((theme, index) => {
      setTimeout(() => {
        try {
          const html = generateThemeHtmlDocument(theme);
          const filename = `Theme_${String(index + 1).padStart(2, '0')}_${theme.id}.html`;
          downloadHtmlFile(html, filename);
          exportedCount++;
          
          if (exportedCount === THEMES_VIEW.length) {
            setTimeout(() => {
              alert(`✅ Export terminé !\n\n${THEMES_VIEW.length} pages HTML ont été téléchargées.\n\nVous pouvez les ouvrir dans votre navigateur\net les importer dans Google Docs.`);
            }, 500);
          }
        } catch(e) {
          console.error(`Erreur export thème ${theme.id}:`, e);
        }
      }, index * 300);
    });
  });
} else {
  console.error('Bouton exportAllThemes non trouvé !');
}

// Bouton d'accès/affichage des statistiques
(function setupStatsButton(){
  const statsBtn = document.getElementById('statsBtn');
  const statsPanel = document.getElementById('statsPanel');
  const statsChart = document.getElementById('statsChart');
  if (!statsBtn || !statsPanel || !statsChart) return;

  let statsVisible = false;

  const refresh = () => {
    statsPanel.style.display = statsVisible ? 'grid' : 'none';
    statsChart.style.display = statsVisible ? 'grid' : 'none';
    statsBtn.textContent = statsVisible ? '📊 Masquer stats' : '📊 Statistiques';
    if (statsVisible) {
      statsPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  };

  statsBtn.addEventListener('click', () => {
    statsVisible = !statsVisible;
    refresh();
  });

  refresh();
})();

// Toggle cours complet au clic sur le titre
(function setupCourseToggle(){
  const courseTitle = document.getElementById('courseTitle');
  const toggleIcon = document.getElementById('toggleIcon');
  const courseContents = document.querySelectorAll('.course-content');
  const statsPanel = document.getElementById('statsPanel');
  const statsChart = document.getElementById('statsChart');
  
  if (!courseTitle || !toggleIcon) return;
  
  let courseVisible = true;
  // Mémoriser le display original de chaque section pour une restauration correcte (ex: flex pour la barre de recherche)
  const originalDisplay = new Map();
  courseContents.forEach(el => {
    originalDisplay.set(el, getComputedStyle(el).display);
  });
  
  const toggleCourse = () => {
    courseVisible = !courseVisible;
    courseContents.forEach(el => {
      if (!courseVisible) {
        // Fermer tout: masquer toutes les sections, y compris les statistiques
        el.style.display = 'none';
        return;
      }
      // À la réouverture, ne pas forcer l'affichage des stats; elles restent gérées par le bouton
      if (el === statsPanel || el === statsChart) {
        return;
      }
      // Restaurer le display original (flex, grid, block...) pour chaque section
      const disp = originalDisplay.get(el) || '';
      el.style.display = disp;
    });
    toggleIcon.textContent = courseVisible ? '▼' : '▶';
  };
  
  courseTitle.addEventListener('click', toggleCourse);
  courseTitle.addEventListener('mouseenter', () => {
    courseTitle.style.opacity = '0.8';
  });
  courseTitle.addEventListener('mouseleave', () => {
    courseTitle.style.opacity = '1';
  });
})();

// Mode montre manuel (écran rond WearOS) :
// - URL: ?watch=1
// - ou appui long (≈650ms) sur le titre
(function setupWatchMode(){
  const courseTitle = document.getElementById('courseTitle');
  if (!courseTitle || !document.body) return;

  // Fallback si ce fichier est intégré/concaténé et que les helpers ne sont pas disponibles
  const safeGet = (typeof safeGetItem === 'function')
    ? safeGetItem
    : (key, fallback) => {
        try {
          const v = localStorage.getItem(key);
          return v == null ? fallback : v;
        } catch {
          return fallback;
        }
      };

  const safeSet = (typeof safeSetItem === 'function')
    ? safeSetItem
    : (key, value) => {
        try {
          localStorage.setItem(key, value);
          return true;
        } catch {
          return false;
        }
      };

  const STORAGE_KEY = 'watchModeEnabled';
  const params = new URLSearchParams(window.location.search || '');
  const forced = params.get('watch');
  const fromStorage = safeGet(STORAGE_KEY, '0');

  let didLongPress = false;
  let pressTimer = null;
  let toastTimer = null;

  const getEnabled = () => document.body.classList.contains('watch-mode');

  const ensureToast = () => {
    let el = document.getElementById('watchToast');
    if (el) return el;
    el = document.createElement('div');
    el.id = 'watchToast';
    el.className = 'watch-toast';
    el.textContent = '';
    document.body.appendChild(el);
    return el;
  };

  const showToast = (text) => {
    const el = ensureToast();
    el.textContent = text;
    el.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => {
      el.classList.remove('show');
    }, 1100);
  };

  const setEnabled = (enabled, { persist = true } = {}) => {
    document.body.classList.toggle('watch-mode', !!enabled);
    if (persist) safeSet(STORAGE_KEY, enabled ? '1' : '0');
    if (typeof updateScrollNavOffset === 'function') {
      requestAnimationFrame(() => updateScrollNavOffset());
    }
    if (typeof refreshScrollNavAutoHide === 'function') {
      requestAnimationFrame(() => refreshScrollNavAutoHide());
    }
  };

  // Init
  if (forced === '1' || forced === 'true' || forced === 'on') {
    setEnabled(true, { persist: false });
  } else if (fromStorage === '1') {
    setEnabled(true, { persist: false });
  }

  // Empêcher le clic (toggle cours) juste après un appui long
  courseTitle.addEventListener('click', (e) => {
    if (didLongPress) {
      didLongPress = false;
      e.preventDefault();
      e.stopImmediatePropagation();
    }
  }, true);

  const clearPress = () => {
    if (pressTimer) {
      clearTimeout(pressTimer);
      pressTimer = null;
    }
  };

  const onPressStart = () => {
    didLongPress = false;
    clearPress();
    pressTimer = setTimeout(() => {
      didLongPress = true;
      const next = !getEnabled();
      setEnabled(next);
      showToast(next ? '⌚ Mode montre activé' : '⌚ Mode montre désactivé');
    }, 650);
  };

  // Pointer (Chrome/Android/WearOS récents)
  courseTitle.addEventListener('pointerdown', onPressStart);
  courseTitle.addEventListener('pointerup', clearPress);
  courseTitle.addEventListener('pointercancel', clearPress);
  courseTitle.addEventListener('pointerleave', clearPress);

  // Touch fallback (certains WebView/Wear)
  courseTitle.addEventListener('touchstart', onPressStart, { passive: true });
  courseTitle.addEventListener('touchend', clearPress, { passive: true });
  courseTitle.addEventListener('touchcancel', clearPress, { passive: true });

  // Mouse fallback (desktop)
  courseTitle.addEventListener('mousedown', onPressStart);
  courseTitle.addEventListener('mouseup', clearPress);
  courseTitle.addEventListener('mouseleave', clearPress);
})();

// Supprimer une éventuelle bannière iOS "Ouvrir dans Safari" injectée par un webview
(function removeIosShareBanner() {
  const phrases = [
    'Ouvrir dans Safari',
    'ouvrir dans Safari',
    'Appuyez sur le bouton de partage'
  ];
  const hide = () => {
    const nodes = Array.from(document.body.querySelectorAll('*')).filter(el => {
      const text = (el.textContent || '').trim();
      return text && phrases.some(p => text.includes(p));
    });
    nodes.forEach(el => {
      const target = el.closest('[style*="position:fixed"], [style*="position: sticky"], .banner, .alert, .notice') || el;
      target.style.display = 'none';
    });
  };
  hide();
  const observer = new MutationObserver(hide);
  observer.observe(document.body, { childList: true, subtree: true });
})();

</script>
</body>
</html>
